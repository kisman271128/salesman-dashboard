<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>Location Compliance - Mobile Dashboard</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(180deg, #f8f9ff 0%, #e8ecff 100%);
            min-height: 100vh;
            color: #2c3e50;
            overflow-x: hidden;
            padding-bottom: 80px;
        }

        .mobile-container {
            max-width: 414px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        /* ===== LOGIN SCREEN ===== */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 350px;
            text-align: center;
        }

        .login-title {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .login-subtitle {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 30px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            text-align: left;
        }

        .form-label {
            font-size: 12px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            background: #fafafa;
            cursor: pointer;
        }

        .login-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* ===== HEADER ===== */
        .mobile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .header-title {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 8px;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .header-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .info-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .info-label {
            font-size: 10px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .info-value {
            font-size: 12px;
            font-weight: 600;
        }

        /* ===== USER INFO BAR ===== */
        .user-info-bar {
            background: #f8fafc;
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-details {
            font-size: 12px;
        }

        .user-name {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 2px;
        }

        .user-role {
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .salesman-selector {
            display: none;
            gap: 8px;
            align-items: center;
        }

        .salesman-selector.show {
            display: flex;
        }

        .selector-label {
            font-size: 11px;
            color: #64748b;
            font-weight: 500;
        }

        .selector-dropdown {
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 12px;
            background: white;
            min-width: 120px;
        }

        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            font-weight: 500;
        }

        /* ===== STATUS BAR ===== */
        .status-bar {
            background: white;
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .location-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-active { background: #10b981; }
        .status-warning { background: #f59e0b; }
        .status-error { background: #ef4444; }
        .status-tracking { background: #3b82f6; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .compliance-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-compliant {
            background: #ecfdf5;
            color: #10b981;
        }

        .badge-warning {
            background: #fef3c7;
            color: #f59e0b;
        }

        .badge-violation {
            background: #fef2f2;
            color: #ef4444;
        }

        /* ===== QUICK STATS ===== */
        .quick-stats {
            padding: 16px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .stat-card {
            background: white;
            padding: 12px 8px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #f1f5f9;
        }

        .stat-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 2px;
        }

        .stat-label {
            font-size: 9px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        /* ===== COMPLIANCE SECTIONS ===== */
        .compliance-section {
            margin: 16px;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-action {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
        }

        .section-content {
            padding: 16px;
        }

        /* ===== CURRENT VISIT CARD ===== */
        .current-visit {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .visit-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .visit-customer {
            font-size: 14px;
            font-weight: 600;
            color: #0369a1;
            margin-bottom: 4px;
        }

        .visit-time {
            font-size: 11px;
            color: #64748b;
        }

        .visit-distance {
            text-align: right;
        }

        .distance-value {
            font-size: 18px;
            font-weight: 700;
            color: #0369a1;
        }

        .distance-label {
            font-size: 9px;
            color: #64748b;
            text-transform: uppercase;
        }

        .visit-details {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .visit-detail {
            text-align: center;
            background: rgba(255, 255, 255, 0.5);
            padding: 8px;
            border-radius: 8px;
        }

        .detail-value {
            font-size: 12px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 2px;
        }

        .detail-label {
            font-size: 9px;
            color: #64748b;
            text-transform: uppercase;
        }

        /* ===== VISIT HISTORY ===== */
        .visit-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f8fafc;
        }

        .visit-item:last-child {
            border-bottom: none;
        }

        .visit-indicator {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 12px;
            color: white;
            font-weight: 600;
        }

        .indicator-compliant { background: #10b981; }
        .indicator-warning { background: #f59e0b; }
        .indicator-violation { background: #ef4444; }

        .visit-info {
            flex: 1;
        }

        .visit-customer-name {
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 2px;
        }

        .visit-meta {
            font-size: 11px;
            color: #64748b;
        }

        .visit-compliance {
            text-align: right;
        }

        .compliance-score {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .score-excellent { color: #10b981; }
        .score-good { color: #3b82f6; }
        .score-warning { color: #f59e0b; }
        .score-poor { color: #ef4444; }

        /* ===== MAP SECTION ===== */
        .map-section {
            height: 300px;
            margin: 16px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        #complianceMap {
            height: 100%;
            width: 100%;
        }

        .map-overlay {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 8px 12px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 11px;
        }

        .map-controls {
            position: absolute;
            bottom: 12px;
            right: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }

        .map-btn {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: none;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            color: #1e293b;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* ===== PERFORMANCE METRICS ===== */
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f8fafc;
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-size: 12px;
            color: #64748b;
        }

        .metric-value {
            font-size: 12px;
            font-weight: 600;
            color: #1e293b;
        }

        .metric-bar {
            width: 60px;
            height: 4px;
            background: #f1f5f9;
            border-radius: 2px;
            overflow: hidden;
            margin-left: 8px;
        }

        .metric-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.3s ease;
        }

        /* ===== ALERTS SECTION ===== */
        .alert-item {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .alert-item.error {
            background: #fef2f2;
            border-color: #ef4444;
        }

        .alert-item.success {
            background: #ecfdf5;
            border-color: #10b981;
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .alert-title {
            font-weight: 600;
            color: #92400e;
        }

        .alert-item.error .alert-title {
            color: #991b1b;
        }

        .alert-item.success .alert-title {
            color: #065f46;
        }

        .alert-time {
            font-size: 10px;
            opacity: 0.8;
        }

        .alert-message {
            color: #78350f;
        }

        .alert-item.error .alert-message {
            color: #7f1d1d;
        }

        .alert-item.success .alert-message {
            color: #064e3b;
        }

        /* ===== BOTTOM NAVIGATION ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 414px;
            background: white;
            border-top: 1px solid #f1f5f9;
            padding: 12px 16px;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #94a3b8;
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 12px;
            min-width: 60px;
        }

        .nav-item.active {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .nav-item:hover {
            color: #667eea;
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-label {
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        /* ===== LOADING STATES ===== */
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .fade-in {
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        /* ===== NOTIFICATION TOAST ===== */
        .toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 300px;
            text-align: center;
        }

        .toast.show {
            opacity: 1;
            top: 100px;
        }

        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        .toast.warning { background: #f59e0b; }

        /* ===== RESPONSIVE & PWA ===== */
        @media (max-width: 414px) {
            .mobile-container {
                max-width: 100vw;
                box-shadow: none;
            }

            .quick-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .stat-card {
                padding: 16px 12px;
            }

            .visit-details {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-height: 700px) {
            .map-section {
                height: 200px;
            }
        }

        /* ===== HIDDEN STATES ===== */
        .dashboard-content {
            display: none;
        }

        .dashboard-content.show {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <div class="login-title">Location Compliance</div>
            <div class="login-subtitle">Masuk untuk melihat dashboard tracking</div>
            
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select class="form-select" id="userRole" required>
                        <option value="">Pilih Role</option>
                        <option value="admin">Admin</option>
                        <option value="salesman">Salesman</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="username" placeholder="Masukkan username" required>
                </div>
                
                <div class="form-group" id="salesmanSelectGroup" style="display: none;">
                    <label class="form-label">Pilih Salesman</label>
                    <select class="form-select" id="salesmanSelect">
                        <option value="">Pilih Salesman</option>
                        <option value="salesman_001">Ahmad Rizki</option>
                        <option value="salesman_002">Budi Santoso</option>
                        <option value="salesman_003">Citra Dewi</option>
                        <option value="salesman_004">Dani Pratama</option>
                        <option value="salesman_005">Eka Sari</option>
                    </select>
                </div>
                
                <button type="submit" class="login-btn" id="loginBtn">
                    Masuk Dashboard
                </button>
            </form>
        </div>
    </div>

    <!-- Dashboard Content -->
    <div class="dashboard-content" id="dashboardContent">
        <div class="mobile-container">
            <!-- Header -->
            <div class="mobile-header">
                <div class="header-top">
                    <div class="header-title">
                        üìç Location Compliance
                    </div>
                    <div class="header-actions">
                        <button class="header-btn" onclick="refreshCompliance()">üîÑ</button>
                        <button class="header-btn" onclick="showSettings()">‚öôÔ∏è</button>
                    </div>
                </div>
                <div class="header-info">
                    <div class="info-item">
                        <div class="info-label">Today's Score</div>
                        <div class="info-value" id="todayScore">Loading...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Current Status</div>
                        <div class="info-value" id="currentStatus">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- User Info Bar -->
            <div class="user-info-bar">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Loading...</div>
                        <div class="user-role" id="userRoleDisplay">Loading...</div>
                    </div>
                </div>
                
                <div class="salesman-selector" id="salesmanSelector">
                    <div class="selector-label">Lihat:</div>
                    <select class="selector-dropdown" id="salesmanDropdown">
                        <option value="salesman_001">Ahmad Rizki</option>
                        <option value="salesman_002">Budi Santoso</option>
                        <option value="salesman_003">Citra Dewi</option>
                        <option value="salesman_004">Dani Pratama</option>
                        <option value="salesman_005">Eka Sari</option>
                    </select>
                </div>
                
                <button class="logout-btn" onclick="logout()">Keluar</button>
            </div>

            <!-- Status Bar -->
            <div class="status-bar">
                <div class="location-status">
                    <div class="status-dot status-warning" id="locationDot"></div>
                    <span id="locationText">Initializing...</span>
                </div>
                <div class="compliance-badge badge-warning" id="complianceBadge">
                    Loading...
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="quick-stats">
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-value" id="compliantVisits">-</div>
                    <div class="stat-label">Compliant</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ö†Ô∏è</div>
                    <div class="stat-value" id="warningVisits">-</div>
                    <div class="stat-label">Warning</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ùå</div>
                    <div class="stat-value" id="violationVisits">-</div>
                    <div class="stat-label">Violation</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-value" id="accuracyScore">-</div>
                    <div class="stat-label">Accuracy</div>
                </div>
            </div>

            <!-- Current Visit Section -->
            <div class="compliance-section">
                <div class="section-header">
                    <div class="section-title">üéØ Current Visit</div>
                    <button class="section-action" onclick="endCurrentVisit()" id="endVisitBtn" style="display: none;">End Visit</button>
                </div>
                <div class="section-content">
                    <div class="current-visit" id="currentVisitCard">
                        <div class="visit-header">
                            <div>
                                <div class="visit-customer" id="currentCustomer">No active visit</div>
                                <div class="visit-time" id="visitStartTime">Not started</div>
                            </div>
                            <div class="visit-distance">
                                <div class="distance-value" id="currentDistance">-</div>
                                <div class="distance-label">Distance</div>
                            </div>
                        </div>
                        <div class="visit-details">
                            <div class="visit-detail">
                                <div class="detail-value" id="visitDuration">00:00</div>
                                <div class="detail-label">Duration</div>
                            </div>
                            <div class="visit-detail">
                                <div class="detail-value" id="locationAccuracy">-</div>
                                <div class="detail-label">Accuracy</div>
                            </div>
                            <div class="visit-detail">
                                <div class="detail-value" id="complianceStatus">-</div>
                                <div class="detail-label">Status</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map Section -->
            <div class="map-section">
                <div id="complianceMap"></div>
                <div class="map-overlay" id="mapOverlay">
                    üìç Initializing location tracking...
                </div>
                <div class="map-controls">
                    <button class="map-btn" onclick="centerOnLocation()">üéØ</button>
                    <button class="map-btn" onclick="toggleMapType()">üó∫Ô∏è</button>
                </div>
            </div>

            <!-- Visit History Section -->
            <div class="compliance-section">
                <div class="section-header">
                    <div class="section-title">üìã Today's Visits</div>
                    <button class="section-action" onclick="showAllHistory()">View All</button>
                </div>
                <div class="section-content">
                    <div id="visitHistoryList">
                        <div style="text-align: center; color: #64748b; padding: 20px;">Loading visit history...</div>
                    </div>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="compliance-section">
                <div class="section-header">
                    <div class="section-title">üìà Performance Metrics</div>
                    <button class="section-action" onclick="showDetailedMetrics()">Details</button>
                </div>
                <div class="section-content" id="performanceMetrics">
                    <div style="text-align: center; color: #64748b; padding: 20px;">Loading performance data...</div>
                </div>
            </div>

            <!-- Alerts Section -->
            <div class="compliance-section">
                <div class="section-header">
                    <div class="section-title">üîî Recent Alerts</div>
                    <button class="section-action" onclick="clearAlerts()">Clear</button>
                </div>
                <div class="section-content">
                    <div id="alertsList">
                        <div style="text-align: center; color: #64748b; padding: 20px;">Loading alerts...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="showComplianceTab()">
                <div class="nav-icon">üìç</div>
                <div class="nav-label">Compliance</div>
            </div>
            <div class="nav-item" onclick="showMapTab()">
                <div class="nav-icon">üó∫Ô∏è</div>
                <div class="nav-label">Map</div>
            </div>
            <div class="nav-item" onclick="showReportsTab()">
                <div class="nav-icon">üìä</div>
                <div class="nav-label">Reports</div>
            </div>
            <div class="nav-item" onclick="showSettingsTab()">
                <div class="nav-icon">‚öôÔ∏è</div>
                <div class="nav-label">Settings</div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, push, set, update, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAoRV3qVAXQ14AEVA8Mo49HXfAyhMMm8Bs",
            authDomain: "salesman-route-tracker.firebaseapp.com",
            databaseURL: "https://salesman-route-tracker-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "salesman-route-tracker",
            storageBucket: "salesman-route-tracker.firebasestorage.app",
            messagingSenderId: "590789273516",
            appId: "1:590789273516:web:79abe0c7e4cbccfa44fc09",
            measurementId: "G-5RYSWKQ063"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const analytics = getAnalytics(app);

        // Make Firebase available globally
        window.firebaseDb = database;
        window.firebaseRef = ref;
        window.firebaseOnValue = onValue;
        window.firebasePush = push;
        window.firebaseSet = set;
        window.firebaseUpdate = update;
        window.firebaseServerTimestamp = serverTimestamp;

        console.log('üî• Firebase initialized successfully');
    </script>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

    <script>
        // ===== GLOBAL VARIABLES =====
        let complianceMap = null;
        let currentLocationMarker = null;
        let customerLocationMarker = null;
        let currentPosition = null;
        let currentCustomerCoords = null;
        let visitStartTime = null;
        let currentSalesmanId = null;
        let currentVisitId = null;
        let currentUser = null;

        // ===== USER MANAGEMENT =====
        class UserManager {
            constructor() {
                this.currentUser = null;
                this.initializeLoginForm();
            }

            initializeLoginForm() {
                const loginForm = document.getElementById('loginForm');
                const userRoleSelect = document.getElementById('userRole');
                const salesmanSelectGroup = document.getElementById('salesmanSelectGroup');

                // Show/hide salesman selector based on role
                userRoleSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'admin') {
                        salesmanSelectGroup.style.display = 'block';
                        document.getElementById('salesmanSelect').required = true;
                    } else {
                        salesmanSelectGroup.style.display = 'none';
                        document.getElementById('salesmanSelect').required = false;
                    }
                });

                // Handle login form submission
                loginForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });
            }

            handleLogin() {
                const role = document.getElementById('userRole').value;
                const username = document.getElementById('username').value;
                const selectedSalesman = document.getElementById('salesmanSelect').value;

                if (!role || !username) {
                    this.showToast('Mohon lengkapi data login', 'error');
                    return;
                }

                if (role === 'admin' && !selectedSalesman) {
                    this.showToast('Admin harus memilih salesman untuk dilihat', 'error');
                    return;
                }

                // Create user object
                this.currentUser = {
                    username: username,
                    role: role,
                    salesmanId: role === 'admin' ? selectedSalesman : this.getUserSalesmanId(username)
                };

                // Set current salesman ID
                currentSalesmanId = this.currentUser.salesmanId;
                currentUser = this.currentUser;

                // Update UI
                this.updateUserUI();
                this.showDashboard();

                // Initialize dashboard for the selected salesman
                if (window.complianceTracker) {
                    window.complianceTracker.switchSalesman(currentSalesmanId);
                }

                this.showToast(`Selamat datang, ${username}!`, 'success');
            }

            getUserSalesmanId(username) {
                // Map username to salesman ID
                const usernameMap = {
                    'ahmad': 'salesman_001',
                    'budi': 'salesman_002', 
                    'citra': 'salesman_003',
                    'dani': 'salesman_004',
                    'eka': 'salesman_005'
                };
                
                return usernameMap[username.toLowerCase()] || 'salesman_001';
            }

            getSalesmanName(salesmanId) {
                const salesmanMap = {
                    'salesman_001': 'Ahmad Rizki',
                    'salesman_002': 'Budi Santoso',
                    'salesman_003': 'Citra Dewi',
                    'salesman_004': 'Dani Pratama',
                    'salesman_005': 'Eka Sari'
                };
                
                return salesmanMap[salesmanId] || salesmanId;
            }

            updateUserUI() {
                const userAvatar = document.getElementById('userAvatar');
                const userName = document.getElementById('userName');
                const userRoleDisplay = document.getElementById('userRoleDisplay');
                const salesmanSelector = document.getElementById('salesmanSelector');
                const salesmanDropdown = document.getElementById('salesmanDropdown');
                const endVisitBtn = document.getElementById('endVisitBtn');

                // Update user info
                userAvatar.textContent = this.currentUser.username.charAt(0).toUpperCase();
                userName.textContent = this.currentUser.username;
                userRoleDisplay.textContent = this.currentUser.role;

                // Show/hide controls based on role
                if (this.currentUser.role === 'admin') {
                    salesmanSelector.classList.add('show');
                    salesmanDropdown.value = this.currentUser.salesmanId;
                    
                    // Add dropdown listener for admin
                    salesmanDropdown.addEventListener('change', (e) => {
                        this.switchViewToSalesman(e.target.value);
                    });
                    
                    // Hide end visit button for admin
                    endVisitBtn.style.display = 'none';
                } else {
                    salesmanSelector.classList.remove('show');
                    // Show end visit button for salesman
                    endVisitBtn.style.display = 'inline-block';
                }
            }

            switchViewToSalesman(salesmanId) {
                if (this.currentUser.role !== 'admin') return;
                
                currentSalesmanId = salesmanId;
                this.currentUser.salesmanId = salesmanId;
                
                // Update dashboard data
                if (window.complianceTracker) {
                    window.complianceTracker.switchSalesman(salesmanId);
                }
                
                const salesmanName = this.getSalesmanName(salesmanId);
                this.showToast(`Melihat data: ${salesmanName}`, 'success');
            }

            showDashboard() {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('dashboardContent').classList.add('show');
            }

            logout() {
                this.currentUser = null;
                currentSalesmanId = null;
                currentUser = null;
                
                // Reset UI
                document.getElementById('loginContainer').style.display = 'flex';
                document.getElementById('dashboardContent').classList.remove('show');
                document.getElementById('loginForm').reset();
                document.getElementById('salesmanSelectGroup').style.display = 'none';
                
                // Stop tracking
                if (window.complianceTracker) {
                    window.complianceTracker.stopTracking();
                }
                
                this.showToast('Berhasil keluar', 'success');
            }

            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type}`;
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            getCurrentUser() {
                return this.currentUser;
            }

            isAdmin() {
                return this.currentUser && this.currentUser.role === 'admin';
            }

            isSalesman() {
                return this.currentUser && this.currentUser.role === 'salesman';
            }
        }

        // ===== FIREBASE DATA MANAGER =====
        class FirebaseDataManager {
            constructor() {
                this.database = window.firebaseDb;
                this.ref = window.firebaseRef;
                this.onValue = window.firebaseOnValue;
                this.push = window.firebasePush;
                this.set = window.firebaseSet;
                this.update = window.firebaseUpdate;
                this.serverTimestamp = window.firebaseServerTimestamp;
                this.listeners = [];
            }

            initializeDataListeners(salesmanId) {
                // Remove existing listeners
                this.removeAllListeners();

                if (!salesmanId) {
                    this.loadSampleData();
                    return;
                }

                // Listen to daily visits data
                const today = new Date().toISOString().split('T')[0];
                const dailyVisitsRef = this.ref(this.database, `daily_visits/${salesmanId}/${today}`);
                const dailyVisitsListener = this.onValue(dailyVisitsRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        this.processDailyVisitsData(data);
                        this.updateVisitHistoryFromDaily(data);
                        this.calculateStatsFromDaily(data);
                    } else {
                        this.loadSampleData();
                    }
                });
                this.listeners.push({ ref: dailyVisitsRef, listener: dailyVisitsListener });

                // Listen to compliance data
                const complianceRef = this.ref(this.database, `compliance/${salesmanId}`);
                const complianceListener = this.onValue(complianceRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        this.updateComplianceUI(data);
                    } else {
                        this.calculateComplianceFromSample();
                    }
                });
                this.listeners.push({ ref: complianceRef, listener: complianceListener });

                // Listen to performance metrics
                const metricsRef = this.ref(this.database, `metrics/${salesmanId}/${today}`);
                const metricsListener = this.onValue(metricsRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        this.updatePerformanceMetrics(data);
                    } else {
                        this.loadSampleMetrics();
                    }
                });
                this.listeners.push({ ref: metricsRef, listener: metricsListener });

                // Listen to alerts
                const alertsRef = this.ref(this.database, `alerts/${salesmanId}`);
                const alertsListener = this.onValue(alertsRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        this.updateAlerts(data);
                    } else {
                        this.loadSampleAlerts();
                    }
                });
                this.listeners.push({ ref: alertsRef, listener: alertsListener });

                // Listen to active visit (only for salesman view)
                if (currentUser && currentUser.role === 'salesman' && currentUser.salesmanId === salesmanId) {
                    const activeVisitRef = this.ref(this.database, `activeVisits/${salesmanId}`);
                    const activeVisitListener = this.onValue(activeVisitRef, (snapshot) => {
                        const data = snapshot.val();
                        if (data && data.active) {
                            this.loadActiveVisit(data);
                        } else {
                            this.clearActiveVisit();
                        }
                    });
                    this.listeners.push({ ref: activeVisitRef, listener: activeVisitListener });
                }
            }

            loadSampleData() {
                // Load sample data when no Firebase data is available
                const sampleVisits = [
                    {
                        customerName: 'PT Maju Jaya',
                        startTime: new Date(Date.now() - 3600000).toISOString(), // 1 hour ago
                        endTime: new Date(Date.now() - 2400000).toISOString(), // 40 minutes ago
                        complianceScore: 95,
                        distance: 25
                    },
                    {
                        customerName: 'CV Berkah Abadi',
                        startTime: new Date(Date.now() - 7200000).toISOString(), // 2 hours ago
                        endTime: new Date(Date.now() - 6300000).toISOString(), // 1h 45m ago
                        complianceScore: 88,
                        distance: 45
                    },
                    {
                        customerName: 'UD Sejahtera',
                        startTime: new Date(Date.now() - 10800000).toISOString(), // 3 hours ago
                        endTime: new Date(Date.now() - 9000000).toISOString(), // 2h 30m ago
                        complianceScore: 72,
                        distance: 120
                    }
                ];

                this.updateVisitHistory(sampleVisits);
                this.calculateStats(sampleVisits);
                this.updateLocationStatusUI('active', 'Lokasi Aktif (Sample Data)');
            }

            calculateComplianceFromSample() {
                this.updateComplianceUI({
                    todayScore: 85,
                    currentStatus: 'Active - Sample Data'
                });
            }

            loadSampleMetrics() {
                const sampleMetrics = {
                    locationAccuracy: 92,
                    visitCompliance: 88,
                    timeEfficiency: 85,
                    dataQuality: 95
                };
                this.updatePerformanceMetrics(sampleMetrics);
            }

            loadSampleAlerts() {
                const sampleAlerts = [
                    {
                        type: 'success',
                        title: 'Kunjungan Selesai',
                        message: 'Kunjungan ke PT Maju Jaya berhasil diselesaikan',
                        timestamp: new Date(Date.now() - 1800000).toISOString() // 30 minutes ago
                    },
                    {
                        type: 'warning',
                        title: 'Jarak Peringatan',
                        message: 'Jarak ke customer melebihi batas normal (120m)',
                        timestamp: new Date(Date.now() - 3600000).toISOString() // 1 hour ago
                    }
                ];
                this.updateAlerts(sampleAlerts);
            }

            processDailyVisitsData(dailyData) {
                const lastUpdate = new Date(dailyData.last_updated || dailyData.firstAccess);
                const now = new Date();
                const timeDiff = now - lastUpdate;
                const minutesDiff = Math.floor(timeDiff / 60000);

                if (minutesDiff < 10) {
                    this.updateLocationStatusUI('active', `Aktif (${minutesDiff} menit lalu)`);
                } else if (minutesDiff < 60) {
                    this.updateLocationStatusUI('warning', `Update ${minutesDiff} menit lalu`);
                } else {
                    this.updateLocationStatusUI('error', `Tidak aktif (${Math.floor(minutesDiff/60)} jam lalu)`);
                }

                this.updateComplianceFromDailyData(dailyData);
            }

            updateVisitHistoryFromDaily(dailyData) {
                const historyContainer = document.getElementById('visitHistoryList');
                historyContainer.innerHTML = '';

                if (!dailyData.customers || Object.keys(dailyData.customers).length === 0) {
                    historyContainer.innerHTML = '<div style="text-align: center; color: #64748b; padding: 20px;">Belum ada kunjungan hari ini</div>';
                    return;
                }

                const customers = Object.keys(dailyData.customers);
                const totalDuration = dailyData.totalDuration || 0;
                const avgDurationPerCustomer = Math.floor(totalDuration / customers.length);

                customers.forEach((customerName) => {
                    const visitElement = this.createVisitElementFromDaily(customerName, {
                        duration: avgDurationPerCustomer,
                        accessCount: dailyData.accessCount,
                        timestamp: dailyData.last_updated || dailyData.firstAccess,
                        isCompleted: true
                    });
                    historyContainer.appendChild(visitElement);
                });
            }

            updateVisitHistory(visits) {
                const historyContainer = document.getElementById('visitHistoryList');
                historyContainer.innerHTML = '';

                if (!visits || visits.length === 0) {
                    historyContainer.innerHTML = '<div style="text-align: center; color: #64748b; padding: 20px;">Belum ada kunjungan hari ini</div>';
                    return;
                }

                visits.forEach(visit => {
                    const visitElement = this.createVisitHistoryElement(visit);
                    historyContainer.appendChild(visitElement);
                });
            }

            createVisitHistoryElement(visit) {
                const visitDiv = document.createElement('div');
                visitDiv.className = 'visit-item';
                
                const startTime = visit.startTime ? new Date(visit.startTime) : new Date();

                let indicatorClass = 'indicator-compliant';
                let indicatorIcon = '‚úì';
                let scoreClass = 'score-excellent';
                let scoreText = 'Excellent';

                if (visit.complianceScore) {
                    if (visit.complianceScore >= 90) {
                        indicatorClass = 'indicator-compliant';
                        indicatorIcon = '‚úì';
                        scoreClass = 'score-excellent';
                        scoreText = 'Excellent';
                    } else if (visit.complianceScore >= 70) {
                        indicatorClass = 'indicator-warning';
                        indicatorIcon = '‚ö†';
                        scoreClass = 'score-warning';
                        scoreText = 'Good';
                    } else {
                        indicatorClass = 'indicator-violation';
                        indicatorIcon = '‚úó';
                        scoreClass = 'score-poor';
                        scoreText = 'Poor';
                    }
                }

                visitDiv.innerHTML = `
                    <div class="visit-indicator ${indicatorClass}">${indicatorIcon}</div>
                    <div class="visit-info">
                        <div class="visit-customer-name">${visit.customerName || 'Unknown Customer'}</div>
                        <div class="visit-meta">
                            ${startTime.toLocaleTimeString()} ‚Ä¢ ${visit.distance ? Math.round(visit.distance) + 'm' : 'N/A'} distance
                        </div>
                    </div>
                    <div class="visit-compliance">
                        <div class="compliance-score ${scoreClass}">${scoreText}</div>
                    </div>
                `;

                return visitDiv;
            }

            createVisitElementFromDaily(customerName, visitData) {
                const visitDiv = document.createElement('div');
                visitDiv.className = 'visit-item';
                
                const visitTime = new Date(visitData.timestamp);
                
                let complianceScore = 85;
                if (visitData.duration > 1800) complianceScore = 95;
                else if (visitData.duration > 900) complianceScore = 90;
                else if (visitData.duration < 300) complianceScore = 70;
                
                let indicatorClass = 'indicator-compliant';
                let indicatorIcon = '‚úì';
                let scoreClass = 'score-excellent';
                let scoreText = 'Excellent';

                if (complianceScore >= 90) {
                    indicatorClass = 'indicator-compliant';
                    scoreClass = 'score-excellent';
                    scoreText = 'Excellent';
                } else if (complianceScore >= 75) {
                    indicatorClass = 'indicator-warning';
                    indicatorIcon = '‚ö†';
                    scoreClass = 'score-warning';
                    scoreText = 'Good';
                } else {
                    indicatorClass = 'indicator-violation';
                    indicatorIcon = '‚úó';
                    scoreClass = 'score-poor';
                    scoreText = 'Poor';
                }

                const durationText = this.formatDuration(visitData.duration);

                visitDiv.innerHTML = `
                    <div class="visit-indicator ${indicatorClass}">${indicatorIcon}</div>
                    <div class="visit-info">
                        <div class="visit-customer-name">${customerName}</div>
                        <div class="visit-meta">
                            ${visitTime.toLocaleTimeString()} ‚Ä¢ ${durationText} ‚Ä¢ Real Data
                        </div>
                    </div>
                    <div class="visit-compliance">
                        <div class="compliance-score ${scoreClass}">${scoreText}</div>
                    </div>
                `;

                return visitDiv;
            }

            calculateStatsFromDaily(dailyData) {
                const customerCount = dailyData.customers ? Object.keys(dailyData.customers).length : 0;
                const totalDuration = dailyData.totalDuration || 0;

                let compliantCount = 0;
                let warningCount = 0;
                let violationCount = 0;

                if (customerCount > 0) {
                    const avgDuration = totalDuration / customerCount;
                    
                    Object.keys(dailyData.customers).forEach(() => {
                        if (avgDuration > 1800) {
                            compliantCount++;
                        } else if (avgDuration > 900) {
                            warningCount++;
                        } else {
                            violationCount++;
                        }
                    });
                }

                document.getElementById('compliantVisits').textContent = compliantCount;
                document.getElementById('warningVisits').textContent = warningCount;
                document.getElementById('violationVisits').textContent = violationCount;
                
                const accuracy = customerCount > 0 ? Math.min(100, Math.round((customerCount / Math.max(dailyData.accessCount || customerCount, customerCount)) * 100)) : 0;
                document.getElementById('accuracyScore').textContent = `${accuracy}%`;
            }

            calculateStats(visits) {
                let compliantCount = 0;
                let warningCount = 0;
                let violationCount = 0;

                visits.forEach(visit => {
                    if (visit.complianceScore) {
                        if (visit.complianceScore >= 90) {
                            compliantCount++;
                        } else if (visit.complianceScore >= 70) {
                            warningCount++;
                        } else {
                            violationCount++;
                        }
                    }
                });

                document.getElementById('compliantVisits').textContent = compliantCount;
                document.getElementById('warningVisits').textContent = warningCount;
                document.getElementById('violationVisits').textContent = violationCount;
                document.getElementById('accuracyScore').textContent = '92%';
            }

            updateComplianceFromDailyData(dailyData) {
                const customerCount = dailyData.customers ? Object.keys(dailyData.customers).length : 0;
                const totalDuration = dailyData.totalDuration || 0;
                const accessCount = dailyData.accessCount || 0;

                let complianceScore = 60;
                
                if (customerCount > 0) {
                    complianceScore += customerCount * 5;
                }
                
                if (totalDuration > 3600) {
                    complianceScore += 20;
                } else if (totalDuration > 1800) {
                    complianceScore += 10;
                }

                if (accessCount > 0 && customerCount > 0) {
                    const efficiency = customerCount / accessCount;
                    if (efficiency > 0.8) complianceScore += 10;
                }

                complianceScore = Math.min(100, complianceScore);

                this.updateComplianceUI({
                    todayScore: complianceScore,
                    currentStatus: customerCount > 0 ? 'Aktif Mengunjungi' : 'Belum Ada Kunjungan'
                });
            }

            updateComplianceUI(data) {
                if (data.todayScore !== undefined) {
                    document.getElementById('todayScore').textContent = `${data.todayScore}%`;
                } else {
                    document.getElementById('todayScore').textContent = '0%';
                }
                if (data.currentStatus) {
                    document.getElementById('currentStatus').textContent = data.currentStatus;
                } else {
                    document.getElementById('currentStatus').textContent = 'No Data';
                }
            }

            updateLocationStatusUI(status, message) {
                const dot = document.getElementById('locationDot');
                const text = document.getElementById('locationText');
                const badge = document.getElementById('complianceBadge');
                
                dot.className = `status-dot status-${status}`;
                text.textContent = message;
                
                // Update compliance badge based on status
                if (status === 'active') {
                    badge.textContent = 'Compliant';
                    badge.className = 'compliance-badge badge-compliant';
                } else if (status === 'warning') {
                    badge.textContent = 'Warning';
                    badge.className = 'compliance-badge badge-warning';
                } else {
                    badge.textContent = 'Violation';
                    badge.className = 'compliance-badge badge-violation';
                }
            }

            updatePerformanceMetrics(metrics) {
                const metricsContainer = document.getElementById('performanceMetrics');
                metricsContainer.innerHTML = '';

                const metricsData = [
                    { label: 'Location Accuracy', value: metrics.locationAccuracy || 0 },
                    { label: 'Visit Compliance', value: metrics.visitCompliance || 0 },
                    { label: 'Time Efficiency', value: metrics.timeEfficiency || 0 },
                    { label: 'Data Quality', value: metrics.dataQuality || 0 }
                ];

                metricsData.forEach(metric => {
                    const metricDiv = document.createElement('div');
                    metricDiv.className = 'metric-row';
                    metricDiv.innerHTML = `
                        <div class="metric-label">${metric.label}</div>
                        <div style="display: flex; align-items: center;">
                            <div class="metric-value">${metric.value}%</div>
                            <div class="metric-bar">
                                <div class="metric-fill" style="width: ${metric.value}%;"></div>
                            </div>
                        </div>
                    `;
                    metricsContainer.appendChild(metricDiv);
                });
            }

            updateAlerts(alerts) {
                const alertsContainer = document.getElementById('alertsList');
                alertsContainer.innerHTML = '';

                if (!alerts || (Array.isArray(alerts) ? alerts.length === 0 : Object.keys(alerts).length === 0)) {
                    alertsContainer.innerHTML = '<div style="text-align: center; color: #64748b; padding: 20px;">Tidak ada alerts</div>';
                    return;
                }

                const alertArray = Array.isArray(alerts) ? alerts : Object.values(alerts);
                const sortedAlerts = alertArray.sort((a, b) => 
                    new Date(b.timestamp || 0) - new Date(a.timestamp || 0)
                ).slice(0, 5);

                sortedAlerts.forEach(alert => {
                    const alertElement = this.createAlertElement(alert);
                    alertsContainer.appendChild(alertElement);
                });
            }

            createAlertElement(alert) {
                const alertDiv = document.createElement('div');
                let alertClass = '';
                
                switch (alert.type) {
                    case 'success':
                        alertClass = 'success';
                        break;
                    case 'error':
                    case 'violation':
                        alertClass = 'error';
                        break;
                    default:
                        alertClass = '';
                }

                alertDiv.className = `alert-item ${alertClass}`;
                
                const timestamp = alert.timestamp ? new Date(alert.timestamp) : new Date();
                const timeAgo = this.getTimeAgo(timestamp);

                alertDiv.innerHTML = `
                    <div class="alert-header">
                        <div class="alert-title">${alert.title || 'Alert'}</div>
                        <div class="alert-time">${timeAgo}</div>
                    </div>
                    <div class="alert-message">${alert.message || 'No message'}</div>
                `;

                return alertDiv;
            }

            getTimeAgo(timestamp) {
                const now = new Date();
                const diff = now - timestamp;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);

                if (days > 0) return `${days} hari lalu`;
                if (hours > 0) return `${hours} jam lalu`;
                if (minutes > 0) return `${minutes} menit lalu`;
                return 'Baru saja';
            }

            formatDuration(seconds) {
                if (!seconds) return '0m';
                
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                
                if (hours > 0) {
                    return `${hours}h ${minutes}m`;
                } else {
                    return `${minutes}m`;
                }
            }

            removeAllListeners() {
                this.listeners.forEach(({ ref, listener }) => {
                    // Firebase listeners are automatically cleaned up
                });
                this.listeners = [];
            }

            async saveLocationUpdate(position) {
                if (!currentSalesmanId) return false;

                const locationData = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    accuracy: position.coords.accuracy,
                    timestamp: this.serverTimestamp(),
                    speed: position.coords.speed || 0,
                    heading: position.coords.heading || 0
                };

                try {
                    const locationsRef = this.ref(this.database, `locations/${currentSalesmanId}`);
                    await this.push(locationsRef, locationData);
                    
                    const currentLocationRef = this.ref(this.database, `currentLocation/${currentSalesmanId}`);
                    await this.set(currentLocationRef, locationData);
                    
                    return true;
                } catch (error) {
                    console.error('Failed to save location:', error);
                    return false;
                }
            }

            async startVisit(customerData) {
                if (!currentSalesmanId || !currentUser || currentUser.role !== 'salesman') return null;

                try {
                    const visitData = {
                        customerId: customerData.id,
                        customerName: customerData.name,
                        customerLocation: customerData.location,
                        startTime: this.serverTimestamp(),
                        startLocation: {
                            latitude: currentPosition.coords.latitude,
                            longitude: currentPosition.coords.longitude,
                            accuracy: currentPosition.coords.accuracy
                        },
                        active: true,
                        status: 'in_progress'
                    };

                    const activeVisitRef = this.ref(this.database, `activeVisits/${currentSalesmanId}`);
                    await this.set(activeVisitRef, visitData);

                    const today = new Date().toISOString().split('T')[0];
                    const visitsRef = this.ref(this.database, `visits/${currentSalesmanId}/${today}`);
                    const newVisitRef = this.push(visitsRef);
                    currentVisitId = newVisitRef.key;
                    
                    await this.set(newVisitRef, {
                        ...visitData,
                        visitId: currentVisitId
                    });

                    return currentVisitId;
                } catch (error) {
                    console.error('Failed to start visit:', error);
                    return null;
                }
            }

            async endVisit() {
                if (!currentVisitId || !currentSalesmanId || !currentUser || currentUser.role !== 'salesman') return false;

                try {
                    const endData = {
                        endTime: this.serverTimestamp(),
                        endLocation: {
                            latitude: currentPosition.coords.latitude,
                            longitude: currentPosition.coords.longitude,
                            accuracy: currentPosition.coords.accuracy
                        },
                        active: false,
                        status: 'completed'
                    };

                    const activeVisitRef = this.ref(this.database, `activeVisits/${currentSalesmanId}`);
                    await this.update(activeVisitRef, { ...endData, active: false });

                    const today = new Date().toISOString().split('T')[0];
                    const visitRef = this.ref(this.database, `visits/${currentSalesmanId}/${today}/${currentVisitId}`);
                    await this.update(visitRef, endData);

                    await this.calculateVisitCompliance(currentVisitId);

                    currentVisitId = null;
                    return true;
                } catch (error) {
                    console.error('Failed to end visit:', error);
                    return false;
                }
            }

            async updateVisitLocation(distance, complianceStatus) {
                if (!currentVisitId || !currentSalesmanId || !currentUser || currentUser.role !== 'salesman') return;

                try {
                    const updateData = {
                        currentDistance: distance,
                        complianceStatus: complianceStatus,
                        lastLocationUpdate: this.serverTimestamp(),
                        currentLocation: {
                            latitude: currentPosition.coords.latitude,
                            longitude: currentPosition.coords.longitude,
                            accuracy: currentPosition.coords.accuracy
                        }
                    };

                    const activeVisitRef = this.ref(this.database, `activeVisits/${currentSalesmanId}`);
                    await this.update(activeVisitRef, updateData);

                    const today = new Date().toISOString().split('T')[0];
                    const visitRef = this.ref(this.database, `visits/${currentSalesmanId}/${today}/${currentVisitId}`);
                    await this.update(visitRef, updateData);

                } catch (error) {
                    console.error('Failed to update visit location:', error);
                }
            }

            async calculateVisitCompliance(visitId) {
                const complianceScore = 95;
                
                try {
                    const today = new Date().toISOString().split('T')[0];
                    const visitRef = this.ref(this.database, `visits/${currentSalesmanId}/${today}/${visitId}`);
                    await this.update(visitRef, {
                        complianceScore: complianceScore,
                        calculatedAt: this.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Failed to calculate compliance:', error);
                }
            }

            loadActiveVisit(visitData) {
                if (visitData.active) {
                    document.getElementById('currentCustomer').textContent = visitData.customerName || 'Unknown Customer';
                    
                    const startTime = visitData.startTime ? new Date(visitData.startTime) : new Date();
                    document.getElementById('visitStartTime').textContent = `Started: ${startTime.toLocaleTimeString()}`;
                    
                    if (visitData.customerLocation) {
                        currentCustomerCoords = {
                            lat: visitData.customerLocation.latitude,
                            lng: visitData.customerLocation.longitude
                        };
                    }
                    
                    visitStartTime = startTime;
                    currentVisitId = visitData.visitId;
                }
            }

            clearActiveVisit() {
                document.getElementById('currentCustomer').textContent = 'No active visit';
                document.getElementById('visitStartTime').textContent = 'Not started';
                document.getElementById('currentDistance').textContent = '-';
                document.getElementById('visitDuration').textContent = '00:00';
                document.getElementById('complianceStatus').textContent = '-';
                
                currentCustomerCoords = null;
                visitStartTime = null;
                currentVisitId = null;
                
                if (customerLocationMarker && complianceMap) {
                    complianceMap.removeLayer(customerLocationMarker);
                    customerLocationMarker = null;
                }
            }

            async addAlert(type, title, message) {
                if (!currentSalesmanId) return;

                try {
                    const alertData = {
                        type: type,
                        title: title,
                        message: message,
                        timestamp: this.serverTimestamp(),
                        read: false
                    };

                    const alertsRef = this.ref(this.database, `alerts/${currentSalesmanId}`);
                    await this.push(alertsRef, alertData);
                } catch (error) {
                    console.error('Failed to add alert:', error);
                }
            }

            switchSalesman(salesmanId) {
                currentSalesmanId = salesmanId;
                this.initializeDataListeners(salesmanId);
            }
        }

        // ===== MOBILE COMPLIANCE TRACKER =====
        class MobileComplianceTracker {
            constructor() {
                this.isTracking = false;
                this.positionWatcher = null;
                this.complianceThreshold = 100;
                this.warningThreshold = 50;
                this.updateInterval = null;
                this.dataManager = null;
                
                this.init();
            }
            
            async init() {
                console.log('üì± Mobile Compliance Tracker initialized');
                
                await this.waitForFirebase();
                this.dataManager = new FirebaseDataManager();
                this.initializeMap();
                this.startUIUpdates();
            }

            waitForFirebase() {
                return new Promise((resolve) => {
                    const checkFirebase = () => {
                        if (window.firebaseDb) {
                            resolve();
                        } else {
                            setTimeout(checkFirebase, 100);
                        }
                    };
                    checkFirebase();
                });
            }
            
            initializeMap() {
                complianceMap = L.map('complianceMap', {
                    zoomControl: false,
                    attributionControl: false
                }).setView([-6.2088, 106.8456], 15);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 18
                }).addTo(complianceMap);
                
                console.log('üó∫Ô∏è Compliance map initialized');
            }

            startLocationTracking() {
                if (!navigator.geolocation) {
                    this.showToast('Geolocation tidak didukung', 'error');
                    return;
                }
                
                if (!currentUser || currentUser.role !== 'salesman') {
                    console.log('Location tracking only available for salesman');
                    return;
                }
                
                this.updateLocationStatus('tracking', 'Mendapatkan lokasi...');
                
                navigator.geolocation.getCurrentPosition(
                    (position) => this.handleLocationSuccess(position),
                    (error) => this.handleLocationError(error),
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 30000
                    }
                );
                
                this.positionWatcher = navigator.geolocation.watchPosition(
                    (position) => this.handleLocationUpdate(position),
                    (error) => this.handleLocationError(error),
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 60000
                    }
                );
                
                this.isTracking = true;
            }

            stopTracking() {
                if (this.positionWatcher) {
                    navigator.geolocation.clearWatch(this.positionWatcher);
                    this.positionWatcher = null;
                }
                this.isTracking = false;
            }
            
            async handleLocationSuccess(position) {
                currentPosition = position;
                this.updateLocationUI(position);
                this.updateLocationStatus('active', 'Lokasi Aktif');
                this.updateMapPosition(position);
                
                if (this.dataManager && currentUser && currentUser.role === 'salesman') {
                    await this.dataManager.saveLocationUpdate(position);
                }
                
                console.log('üìç Location acquired:', position.coords);
            }
            
            async handleLocationUpdate(position) {
                currentPosition = position;
                this.updateLocationUI(position);
                this.updateMapPosition(position);
                
                if (this.dataManager && currentUser && currentUser.role === 'salesman') {
                    await this.dataManager.saveLocationUpdate(position);
                }
                
                if (currentCustomerCoords) {
                    this.updateCurrentVisitDistance();
                }
            }
            
            handleLocationError(error) {
                let message = 'Location error';
                
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        message = 'Akses lokasi ditolak';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message = 'Lokasi tidak tersedia';
                        break;
                    case error.TIMEOUT:
                        message = 'Timeout lokasi';
                        break;
                }
                
                this.updateLocationStatus('error', message);
                this.showToast(message, 'error');
            }
            
            updateLocationUI(position) {
                const accuracy = Math.round(position.coords.accuracy);
                document.getElementById('locationAccuracy').textContent = `¬±${accuracy}m`;
                
                document.getElementById('mapOverlay').textContent = 
                    `üìç Akurasi: ¬±${accuracy}m | Update: ${new Date().toLocaleTimeString()}`;
            }
            
            updateLocationStatus(status, message) {
                const dot = document.getElementById('locationDot');
                const text = document.getElementById('locationText');
                
                dot.className = `status-dot status-${status}`;
                text.textContent = message;
            }
            
            updateMapPosition(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                
                if (currentLocationMarker) {
                    complianceMap.removeLayer(currentLocationMarker);
                }
                
                currentLocationMarker = L.circleMarker([lat, lng], {
                    radius: 8,
                    fillColor: '#3b82f6',
                    color: 'white',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(complianceMap);
                
                const accuracyCircle = L.circle([lat, lng], {
                    radius: accuracy,
                    fillColor: '#3b82f6',
                    color: '#3b82f6',
                    weight: 1,
                    opacity: 0.3,
                    fillOpacity: 0.1
                }).addTo(complianceMap);
                
                complianceMap.setView([lat, lng], complianceMap.getZoom());
            }
            
            async startCurrentVisit(customerName, customerCoords) {
                if (!this.dataManager || !currentUser || currentUser.role !== 'salesman') return;

                const customerData = {
                    id: `customer_${Date.now()}`,
                    name: customerName,
                    location: {
                        latitude: customerCoords.lat,
                        longitude: customerCoords.lng
                    }
                };

                const visitId = await this.dataManager.startVisit(customerData);
                
                if (visitId) {
                    currentCustomerCoords = customerCoords;
                    visitStartTime = new Date();
                    currentVisitId = visitId;
                    
                    document.getElementById('currentCustomer').textContent = customerName;
                    document.getElementById('visitStartTime').textContent = 
                        `Started: ${visitStartTime.toLocaleTimeString()}`;
                    
                    if (customerLocationMarker) {
                        complianceMap.removeLayer(customerLocationMarker);
                    }
                    
                    customerLocationMarker = L.circleMarker([customerCoords.lat, customerCoords.lng], {
                        radius: 6,
                        fillColor: '#10b981',
                        color: 'white',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(complianceMap);
                    
                    if (currentPosition) {
                        const group = new L.featureGroup([currentLocationMarker, customerLocationMarker]);
                        complianceMap.fitBounds(group.getBounds().pad(0.2));
                    }
                    
                    this.updateCurrentVisitDistance();
                    this.showToast(`Memulai kunjungan ke ${customerName}`, 'success');
                    
                    await this.dataManager.addAlert('success', 'Kunjungan Dimulai', `Memulai kunjungan ke ${customerName}`);
                }
            }
            
            async updateCurrentVisitDistance() {
                if (!currentPosition || !currentCustomerCoords || !this.dataManager) return;
                
                const distance = this.calculateDistance(
                    currentPosition.coords.latitude,
                    currentPosition.coords.longitude,
                    currentCustomerCoords.lat,
                    currentCustomerCoords.lng
                );
                
                document.getElementById('currentDistance').textContent = 
                    distance < 1000 ? `${Math.round(distance)}m` : `${(distance/1000).toFixed(2)}km`;
                
                const complianceStatus = this.updateComplianceStatus(distance);
                
                if (currentUser && currentUser.role === 'salesman') {
                    await this.dataManager.updateVisitLocation(distance, complianceStatus);
                }
                
                if (visitStartTime) {
                    const duration = Math.floor((Date.now() - visitStartTime.getTime()) / 1000);
                    document.getElementById('visitDuration').textContent = this.formatDuration(duration);
                }
            }
            
            updateComplianceStatus(distance) {
                let status, statusClass, badgeText, badgeClass;
                
                if (distance <= this.warningThreshold) {
                    status = 'Perfect';
                    statusClass = 'score-excellent';
                    badgeText = 'Compliant';
                    badgeClass = 'badge-compliant';
                } else if (distance <= this.complianceThreshold) {
                    status = 'Good';
                    statusClass = 'score-good';
                    badgeText = 'Compliant';
                    badgeClass = 'badge-compliant';
                } else if (distance <= 500) {
                    status = 'Warning';
                    statusClass = 'score-warning';
                    badgeText = 'Warning';
                    badgeClass = 'badge-warning';
                } else {
                    status = 'Poor';
                    statusClass = 'score-poor';
                    badgeText = 'Violation';
                    badgeClass = 'badge-violation';
                }
                
                document.getElementById('complianceStatus').textContent = status;
                document.getElementById('complianceStatus').className = `detail-value ${statusClass}`;
                
                const badge = document.getElementById('complianceBadge');
                badge.textContent = badgeText;
                badge.className = `compliance-badge ${badgeClass}`;
                
                return status;
            }
            
            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371e3;
                const œÜ1 = lat1 * Math.PI/180;
                const œÜ2 = lat2 * Math.PI/180;
                const ŒîœÜ = (lat2-lat1) * Math.PI/180;
                const ŒîŒª = (lon2-lon1) * Math.PI/180;
                
                const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                          Math.cos(œÜ1) * Math.cos(œÜ2) *
                          Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                
                return R * c;
            }
            
            formatDuration(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                
                if (hours > 0) {
                    return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                } else {
                    return `${minutes}:${secs.toString().padStart(2, '0')}`;
                }
            }
            
            startUIUpdates() {
                this.updateInterval = setInterval(() => {
                    if (visitStartTime) {
                        const duration = Math.floor((Date.now() - visitStartTime.getTime()) / 1000);
                        document.getElementById('visitDuration').textContent = this.formatDuration(duration);
                    }
                }, 1000);
            }
            
            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type}`;
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
            
            async endCurrentVisit() {
                if (!visitStartTime || !this.dataManager || !currentUser || currentUser.role !== 'salesman') {
                    this.showToast('Tidak ada kunjungan aktif untuk diakhiri', 'warning');
                    return;
                }
                
                const duration = Math.floor((Date.now() - visitStartTime.getTime()) / 1000);
                const customerName = document.getElementById('currentCustomer').textContent;
                
                const success = await this.dataManager.endVisit();
                
                if (success) {
                    this.showToast(`Kunjungan ke ${customerName} selesai (${this.formatDuration(duration)})`, 'success');
                    await this.dataManager.addAlert('success', 'Kunjungan Selesai', 
                        `Kunjungan ke ${customerName} berhasil diselesaikan`);
                } else {
                    this.showToast('Gagal mengakhiri kunjungan', 'error');
                }
            }

            switchSalesman(salesmanId) {
                if (this.dataManager) {
                    this.dataManager.switchSalesman(salesmanId);
                }
                
                currentCustomerCoords = null;
                visitStartTime = null;
                currentVisitId = null;
                
                if (customerLocationMarker && complianceMap) {
                    complianceMap.removeLayer(customerLocationMarker);
                    customerLocationMarker = null;
                }
            }
        }

        // ===== GLOBAL INSTANCES =====
        let userManager = null;
        let complianceTracker = null;

        // ===== UI FUNCTIONS =====
        function refreshCompliance() {
            if (complianceTracker) {
                complianceTracker.showToast('Data disegarkan', 'success');
                // Refresh data from Firebase
                if (complianceTracker.dataManager) {
                    complianceTracker.dataManager.switchSalesman(currentSalesmanId);
                }
            }
        }

        function showSettings() {
            alert('Panel pengaturan akan ditampilkan di sini');
        }

        function endCurrentVisit() {
            if (complianceTracker) {
                complianceTracker.endCurrentVisit();
            }
        }

        function centerOnLocation() {
            if (complianceMap && currentPosition) {
                complianceMap.setView([
                    currentPosition.coords.latitude, 
                    currentPosition.coords.longitude
                ], 16);
                
                if (complianceTracker) {
                    complianceTracker.showToast('Peta dipusatkan pada lokasi Anda', 'success');
                }
            } else if (complianceMap) {
                // Center on Jakarta if no current position
                complianceMap.setView([-6.2088, 106.8456], 12);
                if (complianceTracker) {
                    complianceTracker.showToast('Peta dipusatkan pada Jakarta', 'success');
                }
            }
        }

        function toggleMapType() {
            if (complianceTracker) {
                complianceTracker.showToast('Tipe peta diubah', 'success');
            }
        }

        function showAllHistory() {
            alert('Riwayat lengkap akan ditampilkan di sini');
        }

        function showDetailedMetrics() {
            alert('Metrik detail akan ditampilkan di sini');
        }

        async function clearAlerts() {
            const alertsList = document.getElementById('alertsList');
            alertsList.innerHTML = '<div style="text-align: center; color: #64748b; padding: 20px;">Tidak ada alerts</div>';
            
            if (complianceTracker) {
                complianceTracker.showToast('Alerts dibersihkan', 'success');
            }
        }

        function logout() {
            if (userManager) {
                userManager.logout();
            }
        }

        // ===== NAVIGATION FUNCTIONS =====
        function showComplianceTab() {
            updateActiveNav(0);
        }

        function showMapTab() {
            updateActiveNav(1);
            if (complianceMap) {
                setTimeout(() => {
                    complianceMap.invalidateSize();
                    centerOnLocation();
                }, 100);
            }
        }

        function showReportsTab() {
            updateActiveNav(2);
            alert('Bagian laporan akan ditampilkan di sini');
        }

        function showSettingsTab() {
            updateActiveNav(3);
            showSettings();
        }

        function updateActiveNav(activeIndex) {
            document.querySelectorAll('.nav-item').forEach((item, index) => {
                if (index === activeIndex) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // ===== DEMO FUNCTIONS =====
        function startDemoVisit() {
            if (complianceTracker && currentUser && currentUser.role === 'salesman') {
                const sampleCustomers = [
                    { name: 'PT Maju Jaya', lat: -6.2088, lng: 106.8456 },
                    { name: 'CV Berkah Abadi', lat: -6.2100, lng: 106.8470 },
                    { name: 'UD Sejahtera', lat: -6.2070, lng: 106.8440 }
                ];
                
                const randomCustomer = sampleCustomers[Math.floor(Math.random() * sampleCustomers.length)];
                complianceTracker.startCurrentVisit(randomCustomer.name, { lat: randomCustomer.lat, lng: randomCustomer.lng });
            }
        }

        // ===== INITIALIZATION =====
        function initializeMobileCompliance() {
            console.log('üì± Initializing Mobile Compliance Dashboard...');
            
            userManager = new UserManager();
            complianceTracker = new MobileComplianceTracker();
            
            // Make instances globally accessible
            window.userManager = userManager;
            window.complianceTracker = complianceTracker;
            
            // Auto-start location tracking if user is salesman
            setTimeout(() => {
                if (currentUser && currentUser.role === 'salesman') {
                    complianceTracker.startLocationTracking();
                }
            }, 2000);
            
            console.log('‚úÖ Mobile Compliance Dashboard ready');
        }

        // ===== PAGE LOAD =====
        window.addEventListener('load', function() {
            console.log('üì± Starting Location Compliance Dashboard...');
            console.log('üìç Features: Real-time tracking, compliance monitoring, Firebase integration');
            console.log('üî• Firebase Realtime Database connected');
            
            initializeMobileCompliance();
            
            // Initialize sample data after a delay
            setTimeout(() => {
                if (complianceTracker && complianceTracker.dataManager) {
                    complianceTracker.dataManager.initializeDataListeners(null); // This will load sample data
                }
            }, 1000);
        });

        // ===== KEYBOARD SHORTCUTS =====
        document.addEventListener('keydown', function(event) {
            // ESC key to logout
            if (event.key === 'Escape' && currentUser) {
                logout();
            }
            
            // Space key to refresh (only when logged in)
            if (event.key === ' ' && currentUser) {
                event.preventDefault();
                refreshCompliance();
            }
            
            // Enter key to start demo visit (salesman only)
            if (event.key === 'Enter' && currentUser && currentUser.role === 'salesman' && !currentVisitId) {
                event.preventDefault();
                startDemoVisit();
            }
        });

        // ===== ERROR HANDLING =====
        window.addEventListener('error', function(event) {
            console.error('Global error caught:', event.error);
            if (complianceTracker) {
                complianceTracker.showToast('Terjadi kesalahan sistem', 'error');
            }
        });

        // ===== NETWORK STATUS =====
        window.addEventListener('online', function() {
            if (complianceTracker) {
                complianceTracker.showToast('Koneksi internet pulih', 'success');
            }
        });

        window.addEventListener('offline', function() {
            if (complianceTracker) {
                complianceTracker.showToast('Koneksi internet terputus', 'warning');
            }
        });

        // ===== VISIBILITY CHANGE =====
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && complianceTracker && currentUser) {
                // Refresh data when page becomes visible again
                setTimeout(() => {
                    refreshCompliance();
                }, 500);
            }
        });

        // ===== PWA SUPPORT =====
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // Register service worker for offline functionality
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        console.log('‚úÖ Location Compliance Dashboard loaded');
        console.log('üì± Mobile-optimized tracking system');
        console.log('üî• Firebase Realtime Database integrated');
        console.log('üë§ Multi-user support (Admin/Salesman)');
        console.log('üìç Real-time location compliance monitoring');
    </script>
</body>
</html>