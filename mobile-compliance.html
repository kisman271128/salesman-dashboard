<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>Location Compliance - Admin Dashboard</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(180deg, #f8f9ff 0%, #e8ecff 100%);
            min-height: 100vh;
            color: #2c3e50;
            overflow-x: hidden;
            padding-bottom: 80px;
        }

        .mobile-container {
            max-width: 414px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        /* ===== SALESMAN SELECTOR ===== */
        .salesman-selector {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 16px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        }

        .selector-title {
            color: white;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            text-align: center;
        }

        .selector-wrapper {
            position: relative;
        }

        .salesman-select {
            width: 100%;
            padding: 14px 16px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            background: white;
            color: #1e293b;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .salesman-select:focus {
            outline: none;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }

        .selector-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            font-size: 18px;
        }

        .loading-indicator {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
        }

        /* ===== HEADER ===== */
        .mobile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 16px;
            position: sticky;
            top: 72px;
            z-index: 999;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .header-title {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 8px;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .header-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .info-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .info-label {
            font-size: 10px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .info-value {
            font-size: 12px;
            font-weight: 600;
        }

        /* ===== USER INFO BAR ===== */
        .user-info-bar {
            background: #f8fafc;
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
            font-weight: 600;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
        }

        .user-role {
            font-size: 11px;
            color: #64748b;
        }

        /* ===== TOAST NOTIFICATIONS ===== */
        .toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .toast.show {
            opacity: 1;
        }

        .toast.success {
            background: #10b981;
        }

        .toast.error {
            background: #ef4444;
        }

        .toast.warning {
            background: #f59e0b;
        }

        /* ===== STATUS BADGES ===== */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .status-success {
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .status-warning {
            background: #f59e0b;
        }

        .status-error {
            background: #ef4444;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .compliance-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success {
            background: #dcfce7;
            color: #166534;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-error {
            background: #fee2e2;
            color: #991b1b;
        }

        /* ===== QUICK STATS GRID ===== */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 16px;
            background: #f8fafc;
        }

        .stat-card {
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .stat-card:active {
            transform: scale(0.98);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .stat-icon {
            font-size: 24px;
        }

        .stat-trend {
            font-size: 11px;
            color: #10b981;
            font-weight: 600;
        }

        .stat-trend.negative {
            color: #ef4444;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: #64748b;
            font-weight: 500;
        }

        /* ===== TABS ===== */
        .tabs-container {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            padding: 0 16px;
        }

        .tab-btn {
            flex: 1;
            padding: 16px 8px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: #64748b;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ef4444;
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        /* ===== TAB CONTENT ===== */
        .tab-content {
            display: none;
            padding: 16px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== LIVE MAP ===== */
        .map-container {
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        #complianceMap {
            height: 100%;
            width: 100%;
            z-index: 1;
            position: relative;
        }

        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            display: flex;
            gap: 8px;
        }

        .map-control-btn {
            background: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .map-control-btn:active {
            transform: scale(0.95);
        }

        /* ===== VISIT HISTORY ===== */
        .history-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .history-title {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
        }

        .history-view-all {
            font-size: 12px;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .history-info {
            flex: 1;
        }

        .history-customer {
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .history-time {
            font-size: 11px;
            color: #64748b;
        }

        .history-status {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-compliant {
            background: #dcfce7;
            color: #166534;
        }

        .status-non-compliant {
            background: #fee2e2;
            color: #991b1b;
        }

        /* ===== ALERTS ===== */
        .alerts-container {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .alert-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: #fef3c7;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #f59e0b;
        }

        .alert-icon {
            font-size: 20px;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-size: 13px;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 4px;
        }

        .alert-message {
            font-size: 12px;
            color: #78350f;
        }

        .alert-time {
            font-size: 10px;
            color: #92400e;
            margin-top: 4px;
        }

        /* ===== JOURNEY MAP TAB ===== */
        .journey-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .journey-title {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
        }

        .journey-date-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .journey-date-input {
            border: none;
            background: transparent;
            font-size: 13px;
            color: #1e293b;
            font-weight: 500;
        }

        .journey-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .journey-stat-item {
            background: white;
            padding: 12px 8px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .journey-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 4px;
        }

        .journey-stat-label {
            font-size: 10px;
            color: #64748b;
            font-weight: 500;
        }

        .journey-map-container {
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
        }

        #journeyMap {
            height: 100%;
            width: 100%;
            z-index: 1;
            position: relative;
        }

        .journey-timeline {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .timeline-header {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 16px;
        }

        .timeline-list {
            position: relative;
            padding-left: 24px;
        }

        .timeline-line {
            position: absolute;
            left: 8px;
            top: 12px;
            bottom: 12px;
            width: 2px;
            background: linear-gradient(180deg, #667eea, #e2e8f0);
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }

        .timeline-item:last-child {
            margin-bottom: 0;
        }

        .timeline-marker {
            position: absolute;
            left: -18px;
            top: 4px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #667eea;
            border: 2px solid white;
            box-shadow: 0 0 0 2px #667eea;
        }

        .timeline-marker.first {
            background: #10b981;
            box-shadow: 0 0 0 2px #10b981;
        }

        .timeline-marker.last {
            background: #ef4444;
            box-shadow: 0 0 0 2px #ef4444;
        }

        .timeline-content {
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .timeline-content.first {
            border-left-color: #10b981;
        }

        .timeline-content.last {
            border-left-color: #ef4444;
        }

        .timeline-outlet {
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 6px;
        }

        .timeline-details {
            font-size: 11px;
            color: #64748b;
            margin-bottom: 4px;
        }

        .timeline-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            margin-top: 6px;
        }

        .timeline-status.order {
            background: #dcfce7;
            color: #166534;
        }

        .timeline-status.no-order {
            background: #fee2e2;
            color: #991b1b;
        }

        .no-journey-data {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .no-journey-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .no-journey-text {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .no-journey-subtext {
            font-size: 12px;
            opacity: 0.7;
        }

        /* ===== LOADING STATE ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            margin-top: 16px;
            font-size: 14px;
            color: #64748b;
            font-weight: 500;
        }

        /* ===== BOTTOM NAVIGATION ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 414px;
            background: white;
            border-top: 1px solid #e2e8f0;
            padding: 8px 0;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #64748b;
        }

        .nav-item.active {
            color: #667eea;
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-label {
            font-size: 11px;
            font-weight: 600;
        }

        /* Current position marker animation */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(102, 126, 234, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
            }
        }

        .current-position-marker {
            animation: pulse 2s infinite;
        }

                /* Hide elements by default */
        .hide {
            display: none !important;
        }

        /* Firebase status indicator */
        .firebase-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 10000;
            display: none;
        }

        .firebase-status.show {
            display: block;
            animation: fadeInDown 0.3s ease;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">Loading dashboard...</div>
    </div>

    <!-- Firebase Status -->
    <div class="firebase-status" id="firebaseStatus">
        üîÑ Connecting to Firebase...
    </div>

    <div class="mobile-container">
        <!-- Salesman Selector (Admin) -->
        <div class="salesman-selector">
            <div class="selector-title">üë§ Select Salesman to Monitor</div>
            <div class="selector-wrapper">
                <select class="salesman-select" id="salesmanSelector">
                    <option value="">-- Loading Salesman Data --</option>
                </select>
                <span class="selector-icon">‚ñº</span>
            </div>
        </div>

        <!-- Mobile Header -->
        <div class="mobile-header">
            <div class="header-top">
                <div class="header-title">
                    üìç Location Compliance
                </div>
                <div class="header-actions">
                    <button class="header-btn" onclick="refreshCompliance()" title="Refresh">
                        üîÑ
                    </button>
                </div>
            </div>
            <div class="header-info">
                <div class="info-item">
                    <div class="info-label">Today's Score</div>
                    <div class="info-value" id="todayScore">--</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Status</div>
                    <div class="info-value" id="currentStatus">--</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Active Visit</div>
                    <div class="info-value" id="activeVisit">--</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Last Sync</div>
                    <div class="info-value" id="lastSync">--</div>
                </div>
            </div>
        </div>

        <!-- User Info Bar -->
        <div class="user-info-bar" id="userInfoBar" style="display: none;">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">?</div>
                <div class="user-details">
                    <div class="user-name" id="userName">Select Salesman</div>
                    <div class="user-role" id="userRole">Sales Team</div>
                </div>
            </div>
            <div>
                <span class="status-dot" id="locationDot"></span>
                <span id="locationText" style="font-size: 12px; color: #64748b;">GPS Inactive</span>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs-container">
            <button class="tab-btn active" onclick="switchTab('overview')" id="overviewTab">
                Overview
            </button>
<button class="tab-btn" onclick="switchTab('journey')" id="journeyTab">
                Journey
            </button>
            <button class="tab-btn" onclick="switchTab('alerts')" id="alertsTab">
                Alerts
                <span class="tab-badge" id="alertsBadge">0</span>
            </button>
        </div>

        <!-- Tab Content - Overview -->
        <div class="tab-content active" id="overviewContent">
            <!-- Quick Stats in Overview -->
            <div class="quick-stats" style="margin-bottom: 16px;">
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">‚úÖ</span>
                        <span class="stat-trend">+12%</span>
                    </div>
                    <div class="stat-value" id="compliantVisits">--</div>
                    <div class="stat-label">Compliant</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">‚ö†Ô∏è</span>
                        <span class="stat-trend negative">-3%</span>
                    </div>
                    <div class="stat-value" id="warningVisits">--</div>
                    <div class="stat-label">Warnings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">‚ùå</span>
                        <span class="stat-trend negative">-2</span>
                    </div>
                    <div class="stat-value" id="violationVisits">--</div>
                    <div class="stat-label">Violations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">üéØ</span>
                        <span class="stat-trend">+5%</span>
                    </div>
                    <div class="stat-value" id="accuracyScore">--</div>
                    <div class="stat-label">Accuracy</div>
                </div>
            </div>
            
            <!-- Visit History -->
            <div class="history-card">
                <div class="history-header">
                    <div class="history-title">üìã Recent Visits</div>
                    <div class="history-view-all" onclick="showAllHistory()">View All</div>
                </div>
                <div class="history-list" id="historyList">
                    <div style="text-align: center; color: #64748b; padding: 20px;">
                        Select a salesman to view visits
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content - Live Map -->
        <div class="tab-content" id="mapContent" style="display: none;">
            <div class="map-container" style="position: relative;">
                <div id="complianceMap"></div>
                <div class="map-controls">
                    <button class="map-control-btn" onclick="centerOnLocation()" title="Center">üìç</button>
                    <button class="map-control-btn" onclick="toggleMapType()" title="Map Type">üó∫Ô∏è</button>
                </div>
            </div>
            <div style="padding: 16px; background: white; border-radius: 12px; margin-top: 16px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
                <div style="font-size: 14px; font-weight: 600; color: #1e293b; margin-bottom: 8px;">
                    Current Location
                </div>
                <div style="font-size: 12px; color: #64748b; line-height: 1.6;">
                    <div id="mapLocationInfo">Select a salesman to view location</div>
                </div>
            </div>
        </div>

        <!-- Tab Content - Journey Map -->
        <div class="tab-content" id="journeyContent">
            <div class="journey-header">
                <div class="journey-title">üó∫Ô∏è Journey Map</div>
                <div class="journey-date-selector">
                    <span>üìÖ</span>
                    <input type="date" class="journey-date-input" id="journeyDate" onchange="loadJourneyData()">
                </div>
            </div>

            <div class="journey-stats">
                <div class="journey-stat-item">
                    <div class="journey-stat-value" id="totalOutlets">--</div>
                    <div class="journey-stat-label">Outlets</div>
                </div>
                <div class="journey-stat-item">
                    <div class="journey-stat-value" id="totalDistance">--</div>
                    <div class="journey-stat-label">Distance</div>
                </div>
                <div class="journey-stat-item">
                    <div class="journey-stat-value" id="totalDuration">--</div>
                    <div class="journey-stat-label">Duration</div>
                </div>
                <div class="journey-stat-item">
                    <div class="journey-stat-value" id="ordersCount">--</div>
                    <div class="journey-stat-label">Orders</div>
                </div>
            </div>

            <div class="journey-map-container">
                <div id="journeyMap"></div>
            </div>

            <!-- Current Location Section -->
            <div style="padding: 16px; background: white; border-radius: 12px; margin-top: 16px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
                <div style="font-size: 14px; font-weight: 600; color: #1e293b; margin-bottom: 8px;">
                    üìç Current Location
                </div>
                <div style="font-size: 12px; color: #64748b; line-height: 1.6;">
                    <div id="currentLocationInfo">Select a salesman to view location</div>
                </div>
            </div>

            <div class="journey-timeline">
                <div class="timeline-header">Visit Timeline</div>
                <div id="journeyTimelineContainer">
                    <div class="no-journey-data">
                        <div class="no-journey-icon">üó∫Ô∏è</div>
                        <div class="no-journey-text">No journey data</div>
                        <div class="no-journey-subtext">Select a date to view journey</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content - Alerts -->
        <div class="tab-content" id="alertsContent">
            <div class="alerts-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div style="font-size: 14px; font-weight: 600; color: #1e293b;">
                        ‚ö†Ô∏è Active Alerts
                    </div>
                    <button onclick="clearAlerts()" style="background: none; border: none; color: #667eea; font-size: 12px; font-weight: 600; cursor: pointer;">
                        Clear All
                    </button>
                </div>
                <div id="alertsList">
                    <div style="text-align: center; color: #64748b; padding: 20px;">
                        No active alerts
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav" style="justify-content: center;">
            <div class="nav-item active" onclick="window.history.back()" style="cursor: pointer;">
                <div class="nav-icon">üè†</div>
                <div class="nav-label">Home</div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        // ===== FIREBASE INITIALIZATION =====
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAoRV3qVAXQ14AEVA8Mo49HXfAyhMMm8Bs",
            authDomain: "salesman-route-tracker.firebaseapp.com",
            databaseURL: "https://salesman-route-tracker-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "salesman-route-tracker",
            storageBucket: "salesman-route-tracker.firebasestorage.app",
            messagingSenderId: "590789273516",
            appId: "1:590789273516:web:79abe0c7e4cbccfa44fc09",
            measurementId: "G-5RYSWKQ063"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Make Firebase available globally
        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebaseOnValue = onValue;
        window.firebaseGet = get;

        console.log('üî• Firebase initialized successfully');
        
        // Update status
        const statusEl = document.getElementById('firebaseStatus');
        statusEl.textContent = '‚úÖ Firebase Connected';
        statusEl.classList.add('show');
        setTimeout(() => {
            statusEl.classList.remove('show');
        }, 3000);

        // Initialize app after Firebase is ready
        setTimeout(() => {
            window.initializeApp();
        }, 500);
    </script>

    <script>
        // ===== GLOBAL VARIABLES =====
        let currentSalesmanId = null;
        let currentSalesmanName = null;
        let salesmanData = [];
        let complianceMap = null;
        let journeyMap = null;
        let currentLocationMarker = null;
        let locationWatchId = null;

        // ===== INITIALIZE APP =====
        function initializeApp() {
            console.log('üì± Initializing Compliance Dashboard...');
            
            // Set default journey date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('journeyDate').value = today;
            
            // Initialize maps
            initializeMaps();
            
            // Load salesman data
            loadSalesmanList();
            
            // Hide loading overlay
            setTimeout(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
            }, 1000);
            
            console.log('‚úÖ App initialized');
        }

        // ===== LOAD SALESMAN LIST =====
        async function loadSalesmanList() {
            try {
                console.log('üë• Loading salesman list from Firebase...');
                console.log('üî• Firebase DB:', window.firebaseDB);
                
                let dataLoaded = false;
                
                // Load salesman master data from JSON file
                console.log('üìã Loading salesman master data from d.salesman.json...');
                let salesmanMasterData = {};
                try {
                    const response = await fetch('data/d.salesman.json');
                    if (response.ok) {
                        const text = await response.text();
                        const lines = text.trim().split('\n');
                        lines.forEach(line => {
                            if (line.trim()) {
                                const obj = JSON.parse(line.trim());
                                // Map by szEmployeeId as string
                                salesmanMasterData[obj.szEmployeeId.toString()] = obj;
                            }
                        });
                        console.log(`‚úÖ Loaded ${Object.keys(salesmanMasterData).length} salesman from JSON`);
                    }
                } catch (jsonError) {
                    console.warn('‚ö†Ô∏è Could not load d.salesman.json:', jsonError.message);
                }
                
                // Try loading from current_positions (your actual database structure)
                try {
                    console.log('üîç Reading from /current_positions');
                    const positionsRef = window.firebaseRef(window.firebaseDB, 'current_positions');
                    const positionsSnapshot = await window.firebaseGet(positionsRef);
                    
                    if (positionsSnapshot.exists()) {
                        const positionsData = positionsSnapshot.val();
                        console.log('‚úÖ Found current_positions data:', Object.keys(positionsData));
                        
                        // Get salesman IDs from current_positions
                        const salesmanIds = Object.keys(positionsData);
                        
                        // Try to get names from visits data
                        console.log('üîç Reading from /visits for salesman names');
                        const visitsRef = window.firebaseRef(window.firebaseDB, 'visits');
                        const visitsSnapshot = await window.firebaseGet(visitsRef);
                        const visitsData = visitsSnapshot.exists() ? visitsSnapshot.val() : {};
                        
                        // Build salesman data
                        salesmanData = salesmanIds.map(id => {
                            const positionData = positionsData[id];
                            
                            // Get data from JSON master
                            const masterData = salesmanMasterData[id] || {};
                            
                            // Get name from visits data or JSON
                            let salesmanName = `Salesman ${id}`;
                            if (visitsData[id]) {
                                const visits = Object.values(visitsData[id]);
                                if (visits.length > 0 && visits[0].salesman_name) {
                                    salesmanName = visits[0].salesman_name;
                                }
                            }
                            if (!salesmanName.startsWith('Salesman') && masterData.szname) {
                                salesmanName = masterData.szname;
                            }
                            
                            // Get team from JSON master data
                            let teamName = 'Unknown Team';
                            if (masterData['Tipe Salesman']) {
                                teamName = masterData['Tipe Salesman'];
                            } else if (masterData.Dept) {
                                teamName = masterData.Dept;
                            }
                            
                            return {
                                id: id,
                                name: positionData.name || salesmanName,
                                team: positionData.team || teamName,
                                lastUpdate: positionData.timestamp || null
                            };
                        });
                        
                        console.log(`‚úÖ Loaded ${salesmanData.length} salesman from Firebase`);
                        console.log('üìã Salesman list:', salesmanData);
                        showToast(`Loaded ${salesmanData.length} salesman`, 'success');
                        dataLoaded = true;
                    } else {
                        console.log('‚ö†Ô∏è No data at /current_positions');
                    }
                } catch (posError) {
                    console.error('‚ùå Error reading current_positions:', posError);
                }
                
                // If current_positions didn't work, try other paths
                if (!dataLoaded) {
                    console.log('üîç Trying alternative paths...');
                    const possiblePaths = ['salesmen', 'salesman', 'salespeople', 'users'];
                    
                    for (const path of possiblePaths) {
                        try {
                            console.log(`üîç Trying path: /${path}`);
                            const salesmanRef = window.firebaseRef(window.firebaseDB, path);
                            const snapshot = await window.firebaseGet(salesmanRef);
                            
                            if (snapshot.exists()) {
                                const data = snapshot.val();
                                console.log(`‚úÖ Data found at /${path}:`, data);
                                
                                // Handle both object and array structures
                                if (Array.isArray(data)) {
                                    salesmanData = data.map((info, index) => ({
                                        id: info.id || info.szEmployeeId || index,
                                        name: info.name || info.szname || 'Unknown',
                                        team: info.team || info['Tipe Salesman'] || 'Unknown'
                                    }));
                                } else {
                                    salesmanData = Object.entries(data).map(([id, info]) => ({
                                        id: id,
                                        name: info.name || info.szname || 'Unknown',
                                        team: info.team || info['Tipe Salesman'] || 'Unknown'
                                    }));
                                }
                                
                                console.log(`‚úÖ Loaded ${salesmanData.length} salesman from Firebase (path: /${path})`);
                                dataLoaded = true;
                                showToast(`Loaded ${salesmanData.length} salesman from Firebase`, 'success');
                                break;
                            } else {
                                console.log(`‚ö†Ô∏è No data at /${path}`);
                            }
                        } catch (pathError) {
                            console.error(`‚ùå Error reading /${path}:`, pathError);
                        }
                    }
                }
                
                if (!dataLoaded) {
                    console.log('‚ö†Ô∏è No salesman data found in Firebase');
                    console.log('üí° Available paths: /current_positions, /daily_summary');
                    console.log('üí° Make sure Firebase rules allow read access');
                    showToast('No salesman data found. Check console.', 'warning');
                    
                    // Try JSON fallback
                    await loadSalesmanFromJSON();
                }
                
                populateSalesmanDropdown();
                
            } catch (error) {
                console.error('‚ùå Error loading salesman list:', error);
                console.error('Stack trace:', error.stack);
                showToast('Error loading data. Check console.', 'error');
                
                // Fallback to JSON
                await loadSalesmanFromJSON();
            }
        }

        async function loadSalesmanFromJSON() {
            try {
                const response = await fetch('data/d.salesman.json');
                if (!response.ok) throw new Error('Failed to load salesman data');
                
                const content = await response.text();
                const jsonData = parseJSONL(content);
                
                salesmanData = jsonData.map(item => ({
                    id: item.szEmployeeId,
                    name: item.szname || 'Unknown',
                    team: item['Tipe Salesman'] || 'Unknown'
                }));
                
                console.log(`‚úÖ Loaded ${salesmanData.length} salesman from JSON`);
                populateSalesmanDropdown();
                
            } catch (error) {
                console.error('‚ùå Error loading salesman from JSON:', error);
                showToast('Failed to load salesman data', 'error');
            }
        }

        function populateSalesmanDropdown() {
            const selector = document.getElementById('salesmanSelector');
            
            if (salesmanData.length === 0) {
                selector.innerHTML = '<option value="">-- No Salesman Data --</option>';
                return;
            }
            
            let html = '<option value="">-- Select Salesman --</option>';
            salesmanData.forEach(salesman => {
                html += `<option value="${salesman.id}">${salesman.name} (${salesman.team})</option>`;
            });
            
            selector.innerHTML = html;
            
            // Add change event listener
            selector.addEventListener('change', handleSalesmanChange);
        }

        function handleSalesmanChange(event) {
            const selectedId = event.target.value;
            
            if (!selectedId) {
                currentSalesmanId = null;
                currentSalesmanName = null;
                resetDashboard();
                return;
            }
            
            const salesman = salesmanData.find(s => s.id === selectedId);
            if (salesman) {
                currentSalesmanId = salesman.id;
                currentSalesmanName = salesman.name;
                
                console.log(`üë§ Selected salesman: ${currentSalesmanName} (${currentSalesmanId})`);
                
                // Update UI
                document.getElementById('userName').textContent = currentSalesmanName;
                document.getElementById('userRole').textContent = salesman.team;
                document.getElementById('userAvatar').textContent = currentSalesmanName.charAt(0).toUpperCase();
                document.getElementById('userInfoBar').style.display = 'flex';
                
                // Load data for selected salesman
                loadSalesmanData();
                startLocationTracking();
            }
        }

        function resetDashboard() {
            document.getElementById('userInfoBar').style.display = 'none';
            document.getElementById('todayScore').textContent = '--';
            document.getElementById('currentStatus').textContent = '--';
            document.getElementById('activeVisit').textContent = '--';
            document.getElementById('compliantVisits').textContent = '--';
            document.getElementById('warningVisits').textContent = '--';
            document.getElementById('violationVisits').textContent = '--';
            document.getElementById('accuracyScore').textContent = '--';
            document.getElementById('locationText').textContent = 'GPS Inactive';
            document.getElementById('locationDot').className = 'status-dot';
            
            document.getElementById('historyList').innerHTML = `
                <div style="text-align: center; color: #64748b; padding: 20px;">
                    Select a salesman to view visits
                </div>
            `;
            
            // Clear map markers
            if (currentLocationMarker) {
                complianceMap.removeLayer(currentLocationMarker);
                currentLocationMarker = null;
            }
        }

        // ===== LOAD SALESMAN DATA =====
        async function loadSalesmanData() {
            if (!currentSalesmanId) return;
            
            console.log(`üìä Loading data for ${currentSalesmanName}...`);
            showToast('Loading salesman data...', 'success');
            
            try {
                // Listen to current position in realtime
                const positionRef = window.firebaseRef(window.firebaseDB, `current_positions/${currentSalesmanId}`);
                window.firebaseOnValue(positionRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        updateLocationDisplay(data);
                    } else {
                        console.log('‚ö†Ô∏è No current position data for this salesman');
                        document.getElementById('locationText').textContent = 'No GPS Data';
                    }
                });
                
                // Load today's visits
                await loadTodayVisits();
                
                // Load journey data
                loadJourneyData();
                
            } catch (error) {
                console.error('‚ùå Error loading salesman data:', error);
                showToast('Error loading data', 'error');
            }
        }

        function updateLocationDisplay(locationData) {
            if (!locationData || !locationData.latitude || !locationData.longitude) {
                return;
            }
            
            console.log('üìç Location updated:', locationData);
            
            // Update header info
            const lastUpdated = new Date(locationData.timestamp);
            document.getElementById('lastSync').textContent = lastUpdated.toLocaleTimeString('id-ID', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            // Update location status
            document.getElementById('locationText').textContent = 'GPS Active';
            document.getElementById('locationDot').className = 'status-dot status-success';
            
            // Update map location info
            const accuracy = Math.round(locationData.accuracy || 0);
            // Update both map location and current location info
            const locationHTML = `
                <div><strong>Latitude:</strong> ${locationData.latitude.toFixed(6)}</div>
                <div><strong>Longitude:</strong> ${locationData.longitude.toFixed(6)}</div>
                <div><strong>Accuracy:</strong> ${accuracy}m</div>
                <div><strong>Last Update:</strong> ${lastUpdated.toLocaleTimeString('id-ID')}</div>
                ${locationData.visit_session && locationData.visit_session.is_active ? 
                    `<div style="margin-top: 8px; padding: 8px; background: #dcfce7; border-radius: 6px; color: #166534; font-weight: 600;">
                        üè™ Visiting: ${locationData.visit_session.current_outlet || 'Unknown'}
                    </div>` : ''
                }
            `;
            
            document.getElementById('mapLocationInfo').innerHTML = locationHTML;
            
            // Also update current location in Journey tab
            const currentLocationElement = document.getElementById('currentLocationInfo');
            if (currentLocationElement) {
                currentLocationElement.innerHTML = locationHTML;
            }
            
            // Update active visit status
            if (locationData.visit_session && locationData.visit_session.is_active) {
                const outlet = locationData.visit_session.current_outlet || 'Unknown';
                const isPaused = locationData.visit_session.is_paused;
                document.getElementById('activeVisit').textContent = isPaused ? `‚è∏Ô∏è ${outlet}` : outlet;
            } else {
                document.getElementById('activeVisit').textContent = 'None';
            }
            
            // Update map marker
            updateMapMarker(locationData.latitude, locationData.longitude, {
                name: currentSalesmanName,
                accuracy: accuracy,
                isActive: locationData.visit_session && locationData.visit_session.is_active,
                currentOutlet: locationData.visit_session ? locationData.visit_session.current_outlet : null
            });
        }

        function updateMapMarker(lat, lng, info) {
            // Update marker on compliance map
            if (complianceMap) {
                // Remove existing marker
                if (currentLocationMarker) {
                    complianceMap.removeLayer(currentLocationMarker);
                }
                
                // Create marker icon
                const markerColor = info.isActive ? '#10b981' : '#667eea';
                const markerIcon = L.divIcon({
                    className: 'custom-marker',
                    html: `
                        <div style="
                            width: 40px;
                            height: 40px;
                            background: ${markerColor};
                            border: 3px solid white;
                            border-radius: 50%;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 18px;
                        ">
                            ${info.isActive ? 'üè™' : 'üìç'}
                        </div>
                    `,
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });
                
                // Create popup content
                let popupContent = `
                    <div style="min-width: 200px;">
                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 8px;">
                            ${info.name}
                        </div>
                        <div style="font-size: 12px; color: #64748b;">
                            Accuracy: ${info.accuracy}m
                        </div>
                `;
                
                if (info.isActive && info.currentOutlet) {
                    popupContent += `
                        <div style="margin-top: 8px; padding: 8px; background: #dcfce7; border-radius: 6px;">
                            <div style="font-weight: 600; font-size: 12px; color: #166534;">
                                üè™ Currently Visiting
                            </div>
                            <div style="font-size: 11px; color: #166534; margin-top: 4px;">
                                ${info.currentOutlet}
                            </div>
                        </div>
                    `;
                }
                
                popupContent += '</div>';
                
                // Add marker to map
                currentLocationMarker = L.marker([lat, lng], { icon: markerIcon })
                    .bindPopup(popupContent)
                    .addTo(complianceMap);
                
                // Center map on marker
                complianceMap.setView([lat, lng], 15);
                
                // Add accuracy circle
                L.circle([lat, lng], {
                    radius: info.accuracy,
                    color: markerColor,
                    fillColor: markerColor,
                    fillOpacity: 0.1,
                    weight: 2
                }).addTo(complianceMap);
            }
            
            // Also add current position marker to journey map if it exists
            if (journeyMap) {
                const currentPosIcon = L.divIcon({
                    className: 'current-position-marker',
                    html: `
                        <div style="
                            width: 24px;
                            height: 24px;
                            background: #667eea;
                            border: 3px solid white;
                            border-radius: 50%;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        "></div>
                    `,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });
                
                if (window.journeyCurrentMarker) {
                    journeyMap.removeLayer(window.journeyCurrentMarker);
                }
                
                window.journeyCurrentMarker = L.marker([lat, lng], { icon: currentPosIcon })
                    .addTo(journeyMap)
                    .bindPopup('<strong>üìç Current Position</strong><br>Lat: ' + lat.toFixed(6) + '<br>Lng: ' + lng.toFixed(6));
            }
        }

        // ===== LOAD TODAY'S VISITS =====
        async function loadTodayVisits() {
            if (!currentSalesmanId) return;
            
            try {
                const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                console.log(`üìã Loading visits for ${currentSalesmanId} on ${today}...`);
                
                // Read all visits for this salesman (path: visits/{id}/{visitId})
                const visitsRef = window.firebaseRef(window.firebaseDB, `visits/${currentSalesmanId}`);
                const snapshot = await window.firebaseGet(visitsRef);
                
                if (snapshot.exists()) {
                    const allVisits = snapshot.val();
                    const visits = [];
                    
                    // Filter visits for today based on created_at
                    Object.entries(allVisits).forEach(([visitId, visit]) => {
                        if (visit.created_at) {
                            const visitDate = visit.created_at.split('T')[0]; // Extract YYYY-MM-DD
                            if (visitDate === today) {
                                visits.push({
                                    id: visitId,
                                    ...visit
                                });
                            }
                        }
                    });
                    
                    console.log(`üìã Found ${visits.length} visits for today (${today})`);
                    
                    if (visits.length > 0) {
                        // Sort by start_time
                        visits.sort((a, b) => {
                            const timeA = new Date(a.start_time || a.created_at);
                            const timeB = new Date(b.start_time || b.created_at);
                            return timeA - timeB;
                        });
                        
                        updateVisitStats(visits);
                        displayRecentVisits(visits);
                    } else {
                        console.log('üìã No visits today - showing most recent visits');
                        // Show most recent visits instead
                        const recentVisits = Object.entries(allVisits)
                            .map(([id, visit]) => ({ id, ...visit }))
                            .sort((a, b) => {
                                const timeA = new Date(a.created_at || 0);
                                const timeB = new Date(b.created_at || 0);
                                return timeB - timeA;
                            })
                            .slice(0, 5);
                        
                        updateVisitStats(recentVisits);
                        displayRecentVisits(recentVisits);
                    }
                } else {
                    console.log('üìã No visits data for this salesman');
                    updateVisitStats([]);
                    displayRecentVisits([]);
                }
            } catch (error) {
                console.error('‚ùå Error loading visits:', error);
            }
        }

        function updateVisitStats(visits) {
            const compliant = visits.filter(v => v.visit_status === 'completed' && v.order_status).length;
            const total = visits.length;
            const accuracy = total > 0 ? Math.round((compliant / total) * 100) : 0;
            
            document.getElementById('todayScore').textContent = accuracy + '%';
            document.getElementById('currentStatus').textContent = accuracy >= 80 ? 'Good' : accuracy >= 50 ? 'Fair' : 'Poor';
            document.getElementById('compliantVisits').textContent = compliant;
            document.getElementById('warningVisits').textContent = Math.max(0, total - compliant);
            document.getElementById('violationVisits').textContent = '0';
            document.getElementById('accuracyScore').textContent = accuracy + '%';
        }

        function displayRecentVisits(visits) {
            const container = document.getElementById('historyList');
            
            if (visits.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #64748b; padding: 20px;">
                        No visits recorded today
                    </div>
                `;
                return;
            }
            
            // ‚úÖ SHOW ONLY 2 VISITS: FIRST and LAST
            let visitsToShow = [];
            
            if (visits.length === 1) {
                // Only 1 visit - show it
                visitsToShow = [visits[0]];
            } else {
                // Sort by start_time to get chronological order
                const sortedVisits = [...visits].sort((a, b) => {
                    const timeA = new Date(a.start_time || a.created_at).getTime();
                    const timeB = new Date(b.start_time || b.created_at).getTime();
                    return timeA - timeB;
                });
                
                // First visit (earliest)
                const firstVisit = sortedVisits[0];
                
                // Last visit (most recent/latest)
                const lastVisit = sortedVisits[sortedVisits.length - 1];
                
                // Show both (latest first, then earliest)
                visitsToShow = [lastVisit, firstVisit];
            }
            
            let html = '';
            visitsToShow.forEach((visit, index) => {
                const startTime = new Date(visit.start_time || visit.created_at);
                const timeStr = startTime.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                const isCompliant = visit.visit_status === 'completed';
                
                // Label untuk toko pertama atau terakhir
                const label = visits.length > 1 ? (index === 0 ? 'üÜï Latest' : 'üèÅ First') : '';
                
                html += `
                    <div class="history-item">
                        <div class="history-info">
                            <div class="history-customer">
                                ${label ? `<span style="font-size: 10px; background: #667eea; color: white; padding: 2px 6px; border-radius: 4px; margin-right: 6px;">${label}</span>` : ''}
                                ${visit.outlet_name || 'Unknown'}
                            </div>
                            <div class="history-time">${timeStr} ‚Ä¢ ${formatDuration(visit.total_duration_seconds || 0)}</div>
                        </div>
                        <div class="history-status status-${isCompliant ? 'compliant' : 'non-compliant'}">
                            ${isCompliant ? '‚úÖ COMPLETE' : getStatusBadge(visit.visit_status)}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Helper function to get status badge
        function getStatusBadge(status) {
            const badges = {
                'started': 'üü¢ STARTED',
                'paused': '‚è∏Ô∏è PAUSED',
                'resumed': '‚ñ∂Ô∏è RESUMED',
                'completed': '‚úÖ COMPLETE'
            };
            return badges[status] || '‚è≥ Pending';
        }

        // ===== JOURNEY MAP =====
        async function loadJourneyData() {
            if (!currentSalesmanId) {
                console.log('‚ö†Ô∏è No salesman selected');
                return;
            }
            
            const dateInput = document.getElementById('journeyDate');
            const selectedDate = dateInput.value;
            
            if (!selectedDate) {
                console.log('‚ö†Ô∏è No date selected');
                return;
            }
            
            console.log(`üó∫Ô∏è Loading journey data for ${selectedDate}...`);
            showToast('Loading journey data...', 'success');
            
            try {
                // Read all visits for this salesman
                const visitsRef = window.firebaseRef(window.firebaseDB, `visits/${currentSalesmanId}`);
                const snapshot = await window.firebaseGet(visitsRef);
                
                if (snapshot.exists()) {
                    const allVisits = snapshot.val();
                    const visits = [];
                    
                    // Filter visits for selected date based on created_at
                    Object.entries(allVisits).forEach(([visitId, visitData]) => {
                        if (visitData.created_at) {
                            const visitDate = visitData.created_at.split('T')[0]; // Extract YYYY-MM-DD
                            if (visitDate === selectedDate) {
                                visits.push({
                                    id: visitId,
                                    ...visitData
                                });
                            }
                        }
                    });
                    
                    console.log(`‚úÖ Found ${visits.length} visits for ${selectedDate}`);
                    
                    if (visits.length > 0) {
                        // Sort by start_time or created_at
                        visits.sort((a, b) => {
                            const timeA = new Date(a.start_time || a.created_at);
                            const timeB = new Date(b.start_time || b.created_at);
                            return timeA - timeB;
                        });
                        
                        displayJourneyMap(visits);
                        displayJourneyStats(visits);
                        displayJourneyTimeline(visits);
                    } else {
                        console.log(`üìã No visits for ${selectedDate}`);
                        displayNoJourneyData();
                    }
                } else {
                    console.log('üìã No visits data for this salesman');
                    displayNoJourneyData();
                }
            } catch (error) {
                console.error('‚ùå Error loading journey data:', error);
                showToast('Error loading journey', 'error');
                displayNoJourneyData();
            }
        }

        function displayJourneyStats(visits) {
            // Calculate stats
            const totalOutlets = visits.length;
            let totalDuration = 0;
            let ordersCount = 0;
            
            visits.forEach(visit => {
                totalDuration += visit.total_duration_seconds || 0;
                if (visit.order_status && (visit.order_status.toLowerCase().includes('ada') || visit.order_status.toLowerCase().includes('order'))) {
                    ordersCount++;
                }
            });
            
            // Calculate distance (rough estimate using Haversine formula)
            let totalDistance = 0;
            for (let i = 0; i < visits.length - 1; i++) {
                const visit1 = visits[i];
                const visit2 = visits[i + 1];
                
                if (visit1.end_location && visit2.start_location) {
                    const dist = calculateDistance(
                        visit1.end_location.latitude,
                        visit1.end_location.longitude,
                        visit2.start_location.latitude,
                        visit2.start_location.longitude
                    );
                    totalDistance += dist;
                }
            }
            
            // Update display
            document.getElementById('totalOutlets').textContent = totalOutlets;
            document.getElementById('totalDistance').textContent = totalDistance.toFixed(1) + ' km';
            document.getElementById('totalDuration').textContent = formatDurationHours(totalDuration);
            document.getElementById('ordersCount').textContent = ordersCount;
        }
        function displayJourneyMap(visits) {
            if (!journeyMap) return;
            
            // Clear existing markers and lines
            journeyMap.eachLayer((layer) => {
                if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                    journeyMap.removeLayer(layer);
                }
            });
            
            // Convert object to array if needed
            const visitsArray = Array.isArray(visits) ? visits : Object.values(visits || {});
            
            if (visitsArray.length === 0) {
                displayNoJourneyData();
                return;
            }
            
            const bounds = [];
            const routePoints = [];
            
            // Add markers for each visit
            visitsArray.forEach((visit, index) => {
                const isFirst = index === 0;
                const isLast = index === visitsArray.length - 1;
                
                if (visit.start_location && visit.start_location.latitude) {
                    const lat = visit.start_location.latitude;
                    const lng = visit.start_location.longitude;
                    
                    bounds.push([lat, lng]);
                    routePoints.push([lat, lng]);
                    
                    // Marker color based on position
                    const markerColor = isFirst ? '#10b981' : isLast ? '#ef4444' : '#667eea';
                    
                    const markerIcon = L.divIcon({
                        className: 'journey-marker',
                        html: `
                            <div style="
                                width: 32px;
                                height: 32px;
                                background: ${markerColor};
                                border: 3px solid white;
                                border-radius: 50%;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 14px;
                                font-weight: bold;
                                color: white;
                            ">
                                ${index + 1}
                            </div>
                        `,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });
                    
                    // Create popup content
                    const startTime = new Date(visit.start_time);
                    const timeStr = startTime.toLocaleTimeString('id-ID', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    let popupContent = `
                        <div style="min-width: 200px;">
                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 8px;">
                                ${index + 1}. ${visit.outlet_name || 'Unknown'}
                            </div>
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">
                                ‚è∞ ${timeStr}
                            </div>
                            <div style="font-size: 12px; color: #64748b;">
                                ‚è±Ô∏è ${formatDuration(visit.total_duration_seconds || 0)}
                            </div>
                    `;
                    
                    if (visit.order_status) {
                        const hasOrder = visit.order_status.toLowerCase().includes('ada');
                        popupContent += `
                            <div style="margin-top: 8px; padding: 6px; background: ${hasOrder ? '#dcfce7' : '#fee2e2'}; border-radius: 6px;">
                                <div style="font-size: 11px; color: ${hasOrder ? '#166534' : '#991b1b'}; font-weight: 600;">
                                    ${visit.order_status}
                                </div>
                                ${visit.so_amount ? `
                                    <div style="font-size: 10px; color: #64748b; margin-top: 2px;">
                                        üí∞ Rp ${visit.so_amount.toLocaleString('id-ID')}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                    
                    popupContent += '</div>';
                    
                    // Add marker to map
                    L.marker([lat, lng], { icon: markerIcon })
                        .bindPopup(popupContent)
                        .addTo(journeyMap);
                }
            });
            
            // Draw route line
            if (routePoints.length > 1) {
                L.polyline(routePoints, {
                    color: '#667eea',
                    weight: 3,
                    opacity: 0.7,
                    dashArray: '10, 5',
                    lineJoin: 'round'
                }).addTo(journeyMap);
            }
            
            // Fit map to show all points
            if (bounds.length > 0) {
                journeyMap.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        function displayJourneyTimeline(visits) {
            const container = document.getElementById('journeyTimelineContainer');
            
            // Convert object to array if needed
            const visitsArray = Array.isArray(visits) ? visits : Object.values(visits || {});
            
            if (visitsArray.length === 0) {
                displayNoJourneyData();
                return;
            }
            
            let html = '<div class="timeline-list"><div class="timeline-line"></div>';
            
            visitsArray.forEach((visit, index) => {
                const isFirst = index === 0;
                const isLast = index === visitsArray.length - 1;
                const markerClass = isFirst ? 'first' : isLast ? 'last' : '';
                const contentClass = isFirst ? 'first' : isLast ? 'last' : '';
                
                const hasOrder = visit.order_status && 
                    (visit.order_status.toLowerCase().includes('ada') || 
                     visit.order_status.toLowerCase().includes('order'));
                
                const startTime = new Date(visit.start_time);
                
                // ‚úÖ IMPROVED: Handle different visit statuses properly
                let timeDisplay = '';
                let statusBadge = '';
                let additionalInfo = '';
                
                // Check visit status
                const isPaused = visit.visit_status === 'paused' || (!visit.end_time && visit.pause_count > 0);
                const isCompleted = visit.visit_status === 'completed' && visit.end_time;
                const isStarted = visit.visit_status === 'started' && !visit.end_time && !visit.pause_count;
                
                if (isCompleted) {
                    // ‚úÖ Visit completed normally
                    const endTime = new Date(visit.end_time);
                    timeDisplay = `‚è∞ ${startTime.toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'})} - ${endTime.toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'})}`;
                    statusBadge = '';
                    
                } else if (isPaused) {
                    // üü° Visit paused/ditunda
                    timeDisplay = `‚è∞ ${startTime.toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'})} - <span style="color: #f59e0b; font-weight: 600;">Ditunda oleh salesman</span>`;
                    statusBadge = `<span style="display: inline-block; background: #fef3c7; color: #92400e; border: 1px solid #f59e0b; padding: 3px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; margin-left: 8px; vertical-align: middle;">üü° DITUNDA</span>`;
                    
                    // Additional info for paused visits
                    if (visit.pause_count > 0) {
                        additionalInfo = `<div class="timeline-details" style="color: #f59e0b; font-size: 11px; margin-top: 4px;">‚ÑπÔ∏è Kunjungan ditunda ${visit.pause_count} kali | Akan dilanjutkan nanti</div>`;
                    }
                    
                } else if (isStarted) {
                    // ‚ö†Ô∏è Visit started but not completed
                    timeDisplay = `‚è∞ ${startTime.toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'})} - <span style="color: #dc2626; font-weight: 600;">Tidak diselesaikan</span>`;
                    statusBadge = `<span style="display: inline-block; background: #fee2e2; color: #991b1b; border: 1px solid #dc2626; padding: 3px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; margin-left: 8px; vertical-align: middle;">‚ö†Ô∏è TIDAK SELESAI</span>`;
                    additionalInfo = `<div class="timeline-details" style="color: #dc2626; font-size: 11px; margin-top: 4px;">‚ö†Ô∏è Salesman tidak menekan "Selesai Kunjungan" atau "Tunda Kunjungan"</div>`;
                    
                } else {
                    // Unknown status - fallback
                    timeDisplay = `‚è∞ ${startTime.toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'})} - <span style="color: #64748b;">Status tidak jelas</span>`;
                    statusBadge = `<span style="display: inline-block; background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; padding: 3px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; margin-left: 8px;">‚ùì UNKNOWN</span>`;
                }
                
                html += `
                    <div class="timeline-item">
                        <div class="timeline-marker ${markerClass}"></div>
                        <div class="timeline-content ${contentClass}">
                            <div class="timeline-outlet">
                                ${index + 1}. ${visit.outlet_name || 'Unknown Outlet'}
                                ${statusBadge}
                            </div>
                            <div class="timeline-details">${timeDisplay}</div>
                            <div class="timeline-details">‚è±Ô∏è Duration: ${formatDuration(visit.total_duration_seconds || 0)}</div>
                            ${additionalInfo}
                            ${visit.order_status ? `
                                <span class="timeline-status ${hasOrder ? 'order' : 'no-order'}">
                                    ${visit.order_status}
                                </span>
                            ` : ''}
                            ${visit.so_amount ? `
                                <div class="timeline-details" style="margin-top: 4px;">üí∞ Rp ${visit.so_amount.toLocaleString('id-ID')}</div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }


        function displayNoJourneyData() {
            const container = document.getElementById('journeyTimelineContainer');
            container.innerHTML = `
                <div class="no-journey-data">
                    <div class="no-journey-icon">üó∫Ô∏è</div>
                    <div class="no-journey-text">No journey data available</div>
                    <div class="no-journey-subtext">No visits recorded for selected date</div>
                </div>
            `;
            
            // Reset stats
            document.getElementById('totalOutlets').textContent = '0';
            document.getElementById('totalDistance').textContent = '0 km';
            document.getElementById('totalDuration').textContent = '0h';
            document.getElementById('ordersCount').textContent = '0';
            
            // Clear map
            if (journeyMap) {
                journeyMap.eachLayer((layer) => {
                    if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                        journeyMap.removeLayer(layer);
                    }
                });
            }
        }

        // ===== MAPS INITIALIZATION =====
        function initializeMaps() {
            // Initialize compliance map
            complianceMap = L.map('complianceMap', {
                zoomControl: false
            }).setView([-6.2088, 106.8456], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(complianceMap);
            
            // Initialize journey map
            journeyMap = L.map('journeyMap', {
                zoomControl: false
            }).setView([-6.2088, 106.8456], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(journeyMap);
            
            console.log('üó∫Ô∏è Maps initialized');
        }

        function startLocationTracking() {
            // Location tracking is already handled by Firebase realtime listener
            console.log('üìç Location tracking enabled via Firebase');
        }

        // ===== TAB SWITCHING =====
        function switchTab(tabName) {
            // Remove active class from all tabs
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            // Add active class to selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            document.getElementById(tabName + 'Content').classList.add('active');
            
            // Update bottom nav
            const navItems = document.querySelectorAll('.nav-item');
            const tabNames = ['overview', 'journey', 'alerts'];
            const index = tabNames.indexOf(tabName);
            if (index >= 0) {
                navItems[index].classList.add('active');
            }
            
            // Invalidate map size when switching to journey tab
            setTimeout(() => {
                if (tabName === 'journey' && journeyMap) {
                    journeyMap.invalidateSize();
                    // Update current position marker if exists
                    if (window.journeyCurrentMarker && currentLocationMarker) {
                        const pos = currentLocationMarker.getLatLng();
                        window.journeyCurrentMarker.setLatLng(pos);
                    }
                }
            }, 100);
            
            console.log(`üìë Switched to tab: ${tabName}`);
        }

        // ===== UI FUNCTIONS =====
        function refreshCompliance() {
            if (!currentSalesmanId) {
                showToast('Please select a salesman first', 'warning');
                return;
            }
            
            showToast('Refreshing data...', 'success');
            loadSalesmanData();
            
            if (document.getElementById('journeyTab').classList.contains('active')) {
                loadJourneyData();
            }
        }

        function centerOnLocation() {
            if (!complianceMap || !currentLocationMarker) {
                showToast('No location available', 'warning');
                return;
            }
            
            const pos = currentLocationMarker.getLatLng();
            complianceMap.setView(pos, 15);
            showToast('Map centered', 'success');
        }

        function toggleMapType() {
            showToast('Map type toggled', 'success');
        }

        function showAllHistory() {
            showToast('Full history coming soon', 'warning');
        }

        function clearAlerts() {
            document.getElementById('alertsList').innerHTML = 
                '<div style="text-align: center; color: #64748b; padding: 20px;">No alerts</div>';
            document.getElementById('alertsBadge').textContent = '0';
            showToast('Alerts cleared', 'success');
        }

        // ===== UTILITY FUNCTIONS =====
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function formatDurationHours(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            return hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function parseJSONL(content) {
            const lines = content.trim().split('\n');
            const data = [];
            
            lines.forEach((line, index) => {
                try {
                    if (line.trim()) {
                        const obj = JSON.parse(line.trim());
                        data.push(obj);
                    }
                } catch (error) {
                    console.error(`Error parsing line ${index + 1}:`, error);
                }
            });
            
            return data;
        }


        // ===== FIREBASE CONNECTION TEST =====
        async function testFirebaseConnection() {
            try {
                showToast('Testing Firebase connection...', 'info');
                console.log('üß™ ========================================');
                console.log('üß™ FIREBASE CONNECTION TEST');
                console.log('üß™ ========================================');
                console.log('Database URL:', window.firebaseDB ? 'Connected' : 'Not connected');
                
                // Test read access
                const testRef = window.firebaseRef(window.firebaseDB, '/');
                const snapshot = await window.firebaseGet(testRef);
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const paths = Object.keys(data);
                    
                    console.log('‚úÖ Firebase connection successful!');
                    console.log('üìÅ Available paths:', paths);
                    
                    // Check current_positions
                    if (data.current_positions) {
                        const salesmanIds = Object.keys(data.current_positions);
                        console.log(`üìç current_positions/ (${salesmanIds.length} salesman):`, salesmanIds);
                        
                        // Show sample data
                        const sampleId = salesmanIds[0];
                        if (sampleId) {
                            console.log(`   Sample data (${sampleId}):`, data.current_positions[sampleId]);
                        }
                    }
                    
                    // Check daily_summary
                    if (data.daily_summary) {
                        const summaryIds = Object.keys(data.daily_summary);
                        console.log(`üìä daily_summary/ (${summaryIds.length} salesman):`, summaryIds);
                        
                        // Show sample data
                        const sampleId = summaryIds[0];
                        if (sampleId) {
                            const dates = Object.keys(data.daily_summary[sampleId] || {});
                            console.log(`   Dates for ${sampleId}:`, dates);
                            if (dates.length > 0) {
                                console.log(`   Sample (${dates[0]}):`, data.daily_summary[sampleId][dates[0]]);
                            }
                        }
                    }
                    
                    // Check visits
                    if (data.visits) {
                        const visitsIds = Object.keys(data.visits);
                        console.log(`üè™ visits/ (${visitsIds.length} salesman):`, visitsIds);
                    }
                    
                    // Check routes
                    if (data.routes) {
                        const routesIds = Object.keys(data.routes);
                        console.log(`üó∫Ô∏è routes/ (${routesIds.length} salesman):`, routesIds);
                    }
                    
                    console.log('üß™ ========================================');
                    showToast(`Firebase OK! Found: ${paths.join(', ')}`, 'success');
                } else {
                    console.log('‚ö†Ô∏è Firebase connected but database is empty');
                    console.log('üí° You need to add data to your database first');
                    console.log('üß™ ========================================');
                    showToast('Firebase connected but empty', 'warning');
                }
            } catch (error) {
                console.error('‚ùå Firebase connection test failed:', error);
                console.error('Stack trace:', error.stack);
                console.log('üí° Check Firebase Rules - make sure read is allowed');
                console.log('üß™ ========================================');
                showToast('Firebase connection failed! Check console', 'error');
            }
        }

        // Make functions available globally
        window.initializeApp = initializeApp;
        window.switchTab = switchTab;
        window.refreshCompliance = refreshCompliance;
        window.centerOnLocation = centerOnLocation;
        window.toggleMapType = toggleMapType;
        window.showAllHistory = showAllHistory;
        window.clearAlerts = clearAlerts;
        window.loadJourneyData = loadJourneyData;
        window.testFirebaseConnection = testFirebaseConnection;

        console.log('‚úÖ Mobile Compliance Dashboard loaded');
        console.log('üë§ Admin view - select salesman to monitor');
        console.log('üî• Firebase Realtime Database connected');
        console.log('üìç Real-time location tracking enabled');
        console.log('üó∫Ô∏è Journey map with full route visualization');
    </script>
</body>
</html>