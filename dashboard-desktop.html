# Debug & Fixed Version - Morning Update
import sys
import os
import logging
import json
import pandas as pd
from datetime import datetime, timedelta
import subprocess
import traceback

# Fix encoding untuk Windows console
if sys.platform == "win32":
    import codecs
    sys.stdout = codecs.getwriter('utf-8')(sys.stdout.detach())
    sys.stderr = codecs.getwriter('utf-8')(sys.stderr.detach())

class SalesmanDashboardUpdater:
    def __init__(self, excel_file="DbaseSalesmanWebApp.xlsx"):
        self.excel_file = excel_file
        self.data_dir = "data"
        
        # Setup directories
        if not os.path.exists(self.data_dir):
            os.makedirs(self.data_dir)
        
        # Setup logging dengan encoding yang aman
        log_format = '%(asctime)s - %(levelname)s - %(message)s'
        
        # Setup file handler dengan UTF-8
        file_handler = logging.FileHandler('morning_update_debug.log', encoding='utf-8')
        file_handler.setFormatter(logging.Formatter(log_format))
        
        # Setup console handler dengan fallback untuk emoji
        console_handler = logging.StreamHandler()
        console_handler.setFormatter(logging.Formatter(log_format))
        
        # Configure logger
        logging.basicConfig(
            level=logging.INFO,
            handlers=[file_handler, console_handler],
            format=log_format,
            force=True  # Force reconfiguration
        )
        
        self.logger = logging.getLogger(__name__)

    def check_excel_file(self):
        """ğŸ” STEP 1: Check if Excel file exists and is accessible"""
        print("\n" + "="*60)
        print("ğŸ” STEP 1: CHECKING EXCEL FILE")
        print("="*60)
        
        if not os.path.exists(self.excel_file):
            print(f"âŒ ERROR: Excel file tidak ditemukan: {self.excel_file}")
            print(f"ğŸ“ Current directory: {os.getcwd()}")
            print(f"ğŸ“‹ Files in current directory:")
            for file in os.listdir('.'):
                if file.endswith(('.xlsx', '.xls')):
                    print(f"   ğŸ“Š {file}")
            return False
        
        # Check file size
        file_size = os.path.getsize(self.excel_file)
        print(f"âœ… Excel file found: {self.excel_file}")
        print(f"ğŸ“ File size: {file_size:,} bytes")
        
        if file_size == 0:
            print("âŒ ERROR: Excel file is empty!")
            return False
        
        # Check file modification time
        mod_time = datetime.fromtimestamp(os.path.getmtime(self.excel_file))
        print(f"ğŸ“… Last modified: {mod_time.strftime('%Y-%m-%d %H:%M:%S')}")
        
        return True

    def check_excel_sheets(self):
        """ğŸ” STEP 2: Check Excel sheets and structure"""
        print("\n" + "="*60)
        print("ğŸ” STEP 2: CHECKING EXCEL SHEETS")
        print("="*60)
        
        try:
            # Try different engines
            engines = ['openpyxl', 'xlrd', None]
            xl_file = None
            
            for engine in engines:
                try:
                    print(f"ğŸ”§ Trying engine: {engine}")
                    xl_file = pd.ExcelFile(self.excel_file, engine=engine)
                    print(f"âœ… Success with engine: {engine}")
                    break
                except Exception as e:
                    print(f"âŒ Failed with engine {engine}: {str(e)}")
                    continue
            
            if xl_file is None:
                print("âŒ ERROR: Cannot read Excel file with any engine!")
                return False, None
            
            # Get available sheets
            available_sheets = xl_file.sheet_names
            print(f"\nğŸ“‹ Available sheets ({len(available_sheets)}):")
            for i, sheet in enumerate(available_sheets, 1):
                print(f"   {i}. {sheet}")
            
            # Check required sheets
            required_sheets = ['d.dashboard', 'd.performance', 'd.salesmanlob', 'd.salesmanproses', 'd.soharian']
            print(f"\nğŸ¯ Required sheets:")
            missing_sheets = []
            
            for sheet in required_sheets:
                if sheet in available_sheets:
                    print(f"   âœ… {sheet}")
                else:
                    print(f"   âŒ {sheet} - MISSING!")
                    missing_sheets.append(sheet)
            
            if missing_sheets:
                print(f"\nâš ï¸  WARNING: {len(missing_sheets)} required sheets missing!")
                print("ğŸ’¡ Suggestions for missing sheets:")
                for missing in missing_sheets:
                    similar = [s for s in available_sheets if missing.lower().replace('d.', '') in s.lower()]
                    if similar:
                        print(f"   {missing} -> Maybe: {similar}")
            
            return True, xl_file
            
        except Exception as e:
            print(f"âŒ ERROR checking Excel sheets: {str(e)}")
            traceback.print_exc()
            return False, None

    def inspect_sheet_data(self, xl_file, sheet_name, max_rows=5):
        """ğŸ” STEP 3: Inspect sheet data structure"""
        try:
            print(f"\nğŸ“Š INSPECTING SHEET: {sheet_name}")
            print("-" * 50)
            
            df = pd.read_excel(xl_file, sheet_name=sheet_name)
            
            print(f"ğŸ“ Dimensions: {df.shape[0]} rows x {df.shape[1]} columns")
            print(f"ğŸ“‹ Columns: {list(df.columns)}")
            
            # Check for empty data
            if df.empty:
                print("âš ï¸  Sheet is empty!")
                return df
            
            # Show sample data
            print(f"\nğŸ“ Sample data (first {min(max_rows, len(df))} rows):")
            for i in range(min(max_rows, len(df))):
                print(f"Row {i + 1}:")
                for col in df.columns:
                    value = df.iloc[i][col]
                    print(f"   {col}: {value} ({type(value).__name__})")
                print()
            
            # Check for null values
            null_counts = df.isnull().sum()
            if null_counts.any():
                print("ğŸ” Null value counts:")
                for col, count in null_counts.items():
                    if count > 0:
                        print(f"   {col}: {count}")
            
            return df
            
        except Exception as e:
            print(f"âŒ ERROR inspecting sheet {sheet_name}: {str(e)}")
            return None

    def debug_data_processing(self):
        """ğŸ” STEP 4: Debug the complete data processing"""
        print("\n" + "="*60)
        print("ğŸ” STEP 4: DEBUG DATA PROCESSING")
        print("="*60)
        
        # Check Excel file
        if not self.check_excel_file():
            return False
        
        # Check Excel sheets
        success, xl_file = self.check_excel_sheets()
        if not success:
            return False
        
        # Read and inspect each sheet
        sheets = {}
        required_sheets = ['d.dashboard', 'd.performance', 'd.salesmanlob', 'd.salesmanproses', 'd.soharian']
        
        for sheet_name in required_sheets:
            if sheet_name in xl_file.sheet_names:
                df = self.inspect_sheet_data(xl_file, sheet_name)
                if df is not None:
                    sheets[sheet_name] = df
            else:
                print(f"âš ï¸  Skipping missing sheet: {sheet_name}")
        
        if not sheets:
            print("âŒ ERROR: No sheets could be processed!")
            return False
        
        print(f"\nâœ… Successfully loaded {len(sheets)} sheets")
        return sheets

    def test_json_generation(self, sheets):
        """ğŸ” STEP 5: Test JSON generation with detailed logging"""
        print("\n" + "="*60)
        print("ğŸ” STEP 5: TESTING JSON GENERATION")
        print("="*60)
        
        try:
            # Test dashboard processing
            if 'd.dashboard' in sheets:
                print("\nğŸ¯ Testing dashboard processing...")
                dashboard_data = self.process_dashboard_data_debug(sheets)
                if dashboard_data:
                    print(f"âœ… Dashboard processed: {len(dashboard_data.get('lob_cards', []))} LOB cards")
                else:
                    print("âŒ Dashboard processing failed")
            
            # Test salesman list processing
            if 'd.performance' in sheets:
                print("\nğŸ‘¥ Testing salesman list processing...")
                salesman_list = self.process_salesman_data_debug(sheets)
                if salesman_list:
                    print(f"âœ… Salesman list processed: {len(salesman_list)} salesman")
                else:
                    print("âŒ Salesman list processing failed")
            
            # Test chart data processing
            if 'd.soharian' in sheets:
                print("\nğŸ“ˆ Testing chart data processing...")
                chart_data = self.generate_chart_data_debug(sheets)
                if chart_data:
                    print(f"âœ… Chart data processed: {len(chart_data.get('so_data', []))} data points")
                else:
                    print("âŒ Chart data processing failed")
            
            return True
            
        except Exception as e:
            print(f"âŒ ERROR in JSON generation test: {str(e)}")
            traceback.print_exc()
            return False

    def process_dashboard_data_debug(self, sheets):
        """Debug version of dashboard processing"""
        try:
            dashboard_df = sheets['d.dashboard']
            print(f"ğŸ“Š Dashboard sheet shape: {dashboard_df.shape}")
            print(f"ğŸ“‹ Dashboard columns: {list(dashboard_df.columns)}")
            
            # Show first few rows
            print("ğŸ“ First 3 rows:")
            for i in range(min(3, len(dashboard_df))):
                row = dashboard_df.iloc[i]
                lob_value = row.get('LOB', 'N/A')
                actual_value = row.get('Actual', 'N/A')
                bp_value = row.get('BP', 'N/A')
                print(f"   Row {i+1}: LOB={lob_value}, Actual={actual_value}, BP={bp_value}")
            
            # Process LOB cards
            lob_cards = []
            for index, row in dashboard_df.iterrows():
                lob_name = str(row.get('LOB', '')).strip()
                if lob_name and lob_name.upper() != 'TOTAL':
                    actual = self.safe_float(row.get('Actual', 0))
                    bp = self.safe_float(row.get('BP', 1))
                    achievement = (actual / bp * 100) if bp > 0 else 0
                    
                    lob_card = {
                        'name': lob_name,
                        'achievement': f"{int(round(achievement))}%",
                        'actual': self.format_currency_indonesia(actual),
                        'target': self.format_currency_indonesia(bp),
                        'gap': self.format_currency_indonesia(abs(actual - bp)),
                        'vs_bp': f"+{int(round(achievement))}%",
                        'vs_ly': "+0%",
                        'vs_3lm': "+0%",
                        'vs_lm': "+0%"
                    }
                    lob_cards.append(lob_card)
                    print(f"âœ… Processed LOB: {lob_name} - {achievement:.1f}%")
            
            return {
                'last_updated': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                'depo_name': 'Depo Tanjung',
                'region_name': 'Region Kalimantan',
                'lob_cards': lob_cards
            }
            
        except Exception as e:
            print(f"âŒ Error in dashboard processing: {str(e)}")
            traceback.print_exc()
            return None

    def process_salesman_data_debug(self, sheets):
        """Debug version of salesman processing"""
        try:
            performance_df = sheets['d.performance']
            print(f"ğŸ‘¥ Performance sheet shape: {performance_df.shape}")
            print(f"ğŸ“‹ Performance columns: {list(performance_df.columns)}")
            
            salesman_list = []
            for index, row in performance_df.iterrows():
                nik = str(row.get('NIK', '')).strip()
                name = str(row.get('Nama Salesman', '')).strip()
                
                if nik and name:
                    actual = self.safe_float(row.get('Actual', 0))
                    target = self.safe_float(row.get('Target', 1))
                    achievement = (actual / target * 100) if target > 0 else 0
                    
                    salesman_data = {
                        'id': nik,
                        'name': name,
                        'achievement': f"{int(round(achievement))}%",
                        'actual': self.format_currency_indonesia(actual),
                        'target': self.format_currency_indonesia(target),
                        'rank': int(row.get('Rank', 0)) if pd.notna(row.get('Rank')) else 0,
                        'type': str(row.get('Tipe Salesman', 'Sales')).strip(),
                        'status': self.determine_status(achievement)
                    }
                    salesman_list.append(salesman_data)
                    print(f"âœ… Processed salesman: {name} - {achievement:.1f}%")
            
            return salesman_list
            
        except Exception as e:
            print(f"âŒ Error in salesman processing: {str(e)}")
            traceback.print_exc()
            return []

    def generate_chart_data_debug(self, sheets):
        """Debug version of chart data generation"""
        try:
            so_df = sheets['d.soharian']
            print(f"ğŸ“ˆ SO Harian sheet shape: {so_df.shape}")
            print(f"ğŸ“‹ SO Harian columns: {list(so_df.columns)}")
            
            # Show first few rows
            print("ğŸ“ First 3 rows:")
            for i in range(min(3, len(so_df))):
                row = so_df.iloc[i]
                print(f"   Row {i+1}: {dict(row)}")
            
            # Process chart data
            so_data = []
            do_data = []
            target_data = []
            labels = []
            
            for index, row in so_df.iterrows():
                if pd.notna(row.get('Tgl')):
                    so_value = int(self.safe_float(row.get('SO', 0)))
                    do_value = int(self.safe_float(row.get('DO', 0)))
                    target_value = int(self.safe_float(row.get('Target', 0)))
                    
                    so_data.append(so_value)
                    do_data.append(do_value)
                    target_data.append(target_value)
                    
                    # Format label
                    date_val = row['Tgl']
                    if hasattr(date_val, 'strftime'):
                        day_label = date_val.strftime('%d')
                    else:
                        day_label = str(date_val).split('-')[-1] if '-' in str(date_val) else str(date_val)
                    labels.append(day_label)
            
            print(f"ğŸ“Š Processed {len(so_data)} data points")
            
            return {
                'period': 'Juli 2025',
                'so_data': so_data,
                'do_data': do_data,
                'target_data': target_data,
                'labels': labels,
                'stats': {
                    'avg_target': self.format_currency_indonesia(sum(target_data) / len(target_data)) if target_data else "0",
                    'avg_so': self.format_currency_indonesia(sum(so_data) / len(so_data)) if so_data else "0",
                    'avg_do': self.format_currency_indonesia(sum(do_data) / len(do_data)) if do_data else "0",
                    'total_hk': len(so_data),
                    'sisa_hk_do': 0,
                    'gap_total': "0"
                }
            }
            
        except Exception as e:
            print(f"âŒ Error in chart data generation: {str(e)}")
            traceback.print_exc()
            return None

    def write_json_files_debug(self, sheets):
        """ğŸ” STEP 6: Write JSON files with detailed logging"""
        print("\n" + "="*60)
        print("ğŸ” STEP 6: WRITING JSON FILES")
        print("="*60)
        
        try:
            # Process data
            dashboard_data = self.process_dashboard_data_debug(sheets)
            salesman_list = self.process_salesman_data_debug(sheets)
            chart_data = self.generate_chart_data_debug(sheets)
            
            # Write files
            files_written = []
            
            # Dashboard
            if dashboard_data:
                dashboard_file = os.path.join(self.data_dir, 'dashboard.json')
                with open(dashboard_file, 'w', encoding='utf-8') as f:
                    json.dump(dashboard_data, f, indent=2, ensure_ascii=False)
                files_written.append('dashboard.json')
                print(f"âœ… Written: dashboard.json ({len(dashboard_data.get('lob_cards', []))} LOB cards)")
            
            # Salesman list
            if salesman_list:
                list_file = os.path.join(self.data_dir, 'salesman_list.json')
                with open(list_file, 'w', encoding='utf-8') as f:
                    json.dump(salesman_list, f, indent=2, ensure_ascii=False)
                files_written.append('salesman_list.json')
                print(f"âœ… Written: salesman_list.json ({len(salesman_list)} salesman)")
            
            # Chart data
            if chart_data:
                chart_file = os.path.join(self.data_dir, 'chart_data.json')
                with open(chart_file, 'w', encoding='utf-8') as f:
                    json.dump(chart_data, f, indent=2, ensure_ascii=False)
                files_written.append('chart_data.json')
                print(f"âœ… Written: chart_data.json ({len(chart_data.get('so_data', []))} data points)")
            
            # Create minimal salesman details if needed
            details_file = os.path.join(self.data_dir, 'salesman_details.json')
            minimal_details = {}
            if salesman_list:
                for salesman in salesman_list:
                    minimal_details[salesman['id']] = {
                        'name': salesman['name'],
                        'type': salesman['type'],
                        'performance': {},
                        'TOTAL': {
                            'actual': 0,
                            'target': 1,
                            'percentage': int(salesman['achievement'].replace('%', '')),
                            'gap': 0
                        }
                    }
            
            with open(details_file, 'w', encoding='utf-8') as f:
                json.dump(minimal_details, f, indent=2, ensure_ascii=False)
            files_written.append('salesman_details.json')
            print(f"âœ… Written: salesman_details.json (minimal structure)")
            
            print(f"\nğŸ‰ Successfully written {len(files_written)} JSON files!")
            return True
            
        except Exception as e:
            print(f"âŒ ERROR writing JSON files: {str(e)}")
            traceback.print_exc()
            return False

    # Helper methods
    def safe_float(self, value):
        """Safely convert value to float"""
        try:
            if pd.isna(value):
                return 0.0
            if isinstance(value, str):
                value = value.replace(',', '').replace('(', '-').replace(')', '').replace('%', '')
            return float(value)
        except:
            return 0.0

    def format_currency_indonesia(self, value):
        """Format currency dengan format Indonesia yang benar (Rb/Jt/M)"""
        try:
            val = float(value)
            if val >= 1000000000:  # >= 1 Miliar
                return f"{val/1000000000:.1f}M"
            elif val >= 1000000:  # >= 1 Juta, < 1 Miliar  
                return f"{val/1000000:.1f}Jt"
            elif val >= 1000:  # >= 1 Ribu, < 1 Juta
                return f"{val/1000:.0f}Rb"
            else:  # < 1 Ribu
                return f"{val:.0f}"
        except:
            return "0"

    def determine_status(self, achievement):
        """Determine performance status based on achievement"""
        if achievement >= 100:
            return 'Excellent'
        elif achievement >= 90:
            return 'Very Good'
        elif achievement >= 70:
            return 'Good'
        else:
            return 'Extra Effort'

    def run_debug_update(self):
        """Run the complete debug process"""
        print("ğŸš€ MORNING UPDATE DEBUG MODE")
        print("="*80)
        print("This will help identify why JSON files are not updating")
        print("="*80)
        
        try:
            # Step-by-step debugging
            sheets = self.debug_data_processing()
            if not sheets:
                print("\nâŒ FAILED: Could not process Excel data")
                return False
            
            # Test JSON generation
            if not self.test_json_generation(sheets):
                print("\nâŒ FAILED: JSON generation test failed")
                return False
            
            # Write JSON files
            if not self.write_json_files_debug(sheets):
                print("\nâŒ FAILED: Could not write JSON files")
                return False
            
            print("\n" + "="*60)
            print("ğŸ‰ DEBUG COMPLETE - JSON FILES UPDATED!")
            print("="*60)
            print("ğŸ“ Check the data/ directory for updated JSON files")
            print("ğŸ“‹ Files should now contain the latest data from Excel")
            
            return True
            
        except Exception as e:
            print(f"\nâŒ FATAL ERROR: {str(e)}")
            traceback.print_exc()
            return False

def main():
    """Main debug function"""
    print("ğŸ”§ SALESMAN DASHBOARD UPDATER - DEBUG MODE")
    print("="*70)
    print("ğŸ¯ This will help diagnose why JSON files are not updating")
    print("="*70)
    
    updater = SalesmanDashboardUpdater()
    success = updater.run_debug_update()
    
    if success:
        print("\nâœ… DEBUG SUCCESSFUL - Try running the regular update now")
    else:
        print("\nâŒ DEBUG FAILED - Check the detailed output above")
    
    input("\nPress Enter to exit...")

if __name__ == "__main__":
    main()