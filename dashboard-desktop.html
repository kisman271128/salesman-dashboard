<!DOCTYPE html>

<html lang="en">
<head><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&amp;display=swap" rel="stylesheet"/>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Dashboard Desktop - Salesman App</title>

<!-- Leaflet.js CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
      crossorigin=""/>

<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            color: #2c3e50;
            overflow: hidden;
        }

        .desktop-container {
            display: flex;
            height: 100vh;
        }

        /* ‚úÖ SIDEBAR NAVIGATION */
        .sidebar {
            background: rgba(44, 62, 80, 0.95);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            width: 260px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 0;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
            position: fixed;
            height: 100vh;
            z-index: 1000;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .company-logo {
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 6px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .company-subtitle {
            font-size: 12px;
            opacity: 0.9;
            font-weight: 400;
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: #667eea;
            transform: translateX(3px);
        }

        .nav-item.active {
            background: rgba(102, 126, 234, 0.2);
            color: white;
            border-left-color: #667eea;
        }

        .nav-icon {
            font-size: 18px;
            margin-right: 12px;
            width: 22px;
        }

        .nav-label {
            font-size: 14px;
            font-weight: 500;
        }

        .sidebar-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: rgba(255, 255, 255, 0.9);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .user-details h4 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .user-details p {
            font-size: 11px;
            opacity: 0.7;
        }

        /* ‚úÖ MAIN CONTENT AREA */
        .main-content {
            flex: 1;
            margin-left: 260px;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .top-header {
            background: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e2e8f0;
            flex-shrink: 0;
        }

        .header-left h1 {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .header-left p {
            font-size: 14px;
            color: #7f8c8d;
            font-weight: 500;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        /* ‚úÖ TIME GONE BADGE */
        .time-gone-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 8px 16px;
        }
        .tg-label {
            font-size: 12px;
            font-weight: 700;
            color: #475569;
            white-space: nowrap;
        }
        .tg-bar-wrap {
            width: 100px;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }
        .tg-bar-fill {
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg, #10b981, #f59e0b, #ef4444);
            background-size: 300% 100%;
            transition: width 0.6s ease;
            width: 0%;
        }
        .tg-value {
            font-size: 14px;
            font-weight: 800;
            color: #1e293b;
            min-width: 40px;
            text-align: right;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #43e97b, #38f9d7);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(67, 233, 123, 0.3);
        }

        .refresh-btn:hover {
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 6px 20px rgba(67, 233, 123, 0.4);
        }

        /* ‚úÖ SALESMAN SELECTOR MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #64748b;
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        .salesman-grid {
            display: grid;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .salesman-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .salesman-option:hover {
            border-color: #667eea;
            background: #f8fafc;
        }

        .salesman-option-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        .salesman-option-info h4 {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 2px;
        }

        .salesman-option-info p {
            font-size: 12px;
            color: #64748b;
        }

        .salesman-option-achievement {
            margin-left: auto;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        /* ‚úÖ DASHBOARD CONTENT */
        .dashboard-content {
            flex: 1;
            padding: 24px 30px;
            overflow-y: auto;
            background: #f8fafc;
        }

        /* ‚úÖ METRICS CARDS ROW - 9 cards in 1 row, compact design */
        .metrics-row {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-align: center;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--indicator-color, #e2e8f0);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .metric-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 8px;
            gap: 4px;
        }

        .metric-title {
            font-size: 10px;
            color: #64748b;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1.2;
        }

        .metric-indicator {
            font-size: 12px;
        }

        .metric-value {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            line-height: 1;
        }

        .metric-status {
            display: none; /* Hidden since color already indicates status */
        }

        /* Color classes for achievement indicators */
        .indicator-green {
            --indicator-color: #059669;
        }

        .indicator-yellow {
            --indicator-color: #f59e0b;
        }

        .indicator-red {
            --indicator-color: #ef4444;
        }

        /* ‚úÖ MAIN DASHBOARD GRID - Modified for map */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            height: calc(100vh - 200px);
        }

        /* ‚úÖ LEFT COLUMN */
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* ‚úÖ RIGHT COLUMN */
        .right-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* ‚úÖ COMPACT LOB CARDS */
        .lob-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid #e2e8f0;
            overflow: hidden;
            flex: 1;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .lob-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            max-height: 350px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .lob-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .lob-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--card-color, linear-gradient(135deg, #667eea, #764ba2));
        }

        .lob-card:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        /* ‚úÖ LOB CARD COLORS */
        .lob-card.color-0 { --card-color: linear-gradient(135deg, #ff6b6b, #ee5a24); }
        .lob-card.color-1 { --card-color: linear-gradient(135deg, #4ecdc4, #44a08d); }
        .lob-card.color-2 { --card-color: linear-gradient(135deg, #45b7d1, #96c93d); }
        .lob-card.color-3 { --card-color: linear-gradient(135deg, #f9ca24, #f0932b); }
        .lob-card.color-4 { --card-color: linear-gradient(135deg, #eb4d4b, #6c5ce7); }
        .lob-card.color-5 { --card-color: linear-gradient(135deg, #a55eea, #26de81); }
        .lob-card.color-6 { --card-color: linear-gradient(135deg, #fd79a8, #fdcb6e); }
        .lob-card.color-7 { --card-color: linear-gradient(135deg, #e17055, #81ecec); }
        .lob-card.color-8 { --card-color: linear-gradient(135deg, #00b894, #00cec9); }
        .lob-card.color-total { --card-color: linear-gradient(135deg, #667eea, #764ba2); }

        .lob-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .lob-name {
            font-size: 14px;
            font-weight: 700;
            color: #1e293b;
        }

        .achievement-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .lob-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .lob-metric {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .lob-metric-label {
            font-size: 10px;
            color: #64748b;
            font-weight: 600;
            margin-bottom: 2px;
            text-transform: uppercase;
        }

        .lob-metric-value {
            font-size: 12px;
            font-weight: 700;
            color: #1e293b;
        }

        .lob-vs-metrics {
            display: flex;
            justify-content: space-between;
            gap: 6px;
        }

        .lob-vs-metric {
            flex: 1;
            text-align: center;
            padding: 6px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .lob-vs-label {
            font-size: 9px;
            color: #64748b;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .lob-vs-value {
            font-size: 11px;
            font-weight: 700;
            color: #1e293b;
        }

        /* ‚úÖ LEAFLET MAP SECTION */
        .map-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid #e2e8f0;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .map-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .map-controls {
            display: flex;
            gap: 8px;
        }

        .map-control-btn {
            padding: 6px 12px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .map-control-btn:hover {
            background: #f8fafc;
            border-color: #667eea;
        }

        .map-control-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* ‚úÖ LEAFLET MAP CONTAINER */
        #mapContainer {
            flex: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            min-height: 400px;
            position: relative;
            background: #ffffff;
        }

        /* ‚úÖ CUSTOM LEAFLET STYLES */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            border: 1px solid #e2e8f0;
        }

        .leaflet-popup-content {
            margin: 0;
            padding: 0;
            min-width: 280px;
        }

        .popup-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 16px;
            font-weight: 700;
            font-size: 14px;
            border-radius: 10px 10px 0 0;
        }

        .popup-content {
            padding: 16px;
        }

        .popup-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .popup-metric:last-child {
            border-bottom: none;
        }

        .popup-metric-label {
            font-size: 12px;
            color: #64748b;
            font-weight: 600;
        }

        .popup-metric-value {
            font-size: 12px;
            font-weight: 700;
            color: #1e293b;
        }

        .popup-metric-value.positive {
            color: #059669;
        }

        .popup-metric-value.negative {
            color: #dc2626;
        }

        /* ‚úÖ CUSTOM LEAFLET MARKERS */
        .custom-marker {
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .custom-marker:hover {
            transform: scale(1.2);
            z-index: 1000;
        }

        .marker-excellent { background: #059669; }
        .marker-good { background: #f59e0b; }
        .marker-fair { background: #fb7185; }
        .marker-poor { background: #ef4444; }
        .marker-no-data { background: #94a3b8; }

        /* ‚úÖ SALESMAN SECTION */
        .salesman-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .salesman-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .salesman-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
        }

        .salesman-count {
            background: #f1f5f9;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: #475569;
        }

        .salesman-table-container {
            flex: 1;
            overflow-y: auto;
            max-height: calc(100vh - 500px);
        }

        .salesman-table {
            width: 100%;
            border-collapse: collapse;
        }

        .salesman-table th {
            background: #f8fafc;
            color: #475569;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .salesman-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 13px;
            vertical-align: middle;
        }

        .salesman-table tr:hover td {
            background: #f8fafc;
        }

        .rank-column {
            text-align: center;
            font-weight: 700;
            color: #667eea;
            width: 50px;
        }

        .salesman-name-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .salesman-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            flex-shrink: 0;
        }

        .salesman-info h4 {
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 2px;
        }

        .salesman-info p {
            font-size: 11px;
            color: #64748b;
        }

        .achievement-cell {
            text-align: center;
        }

        .achievement-value {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 6px 10px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 12px;
            display: inline-block;
        }

        .status-cell {
            text-align: center;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-excellent {
            background: rgba(34, 197, 94, 0.1);
            color: #059669;
        }

        .status-very-good {
            background: rgba(59, 130, 246, 0.1);
            color: #2563eb;
        }

        .status-good {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }

        .status-extra-effort {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }

        .action-cell {
            text-align: center;
        }

        .view-btn {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .view-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* ‚úÖ LOADING AND ERROR STATES */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            flex-direction: column;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #dc2626;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .no-data-message {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.2);
            color: #d97706;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }

        /* ‚úÖ SCROLLBAR STYLING */
        .lob-grid::-webkit-scrollbar,
        .salesman-table-container::-webkit-scrollbar {
            width: 6px;
        }

        .lob-grid::-webkit-scrollbar-track,
        .salesman-table-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .lob-grid::-webkit-scrollbar-thumb,
        .salesman-table-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .lob-grid::-webkit-scrollbar-thumb:hover,
        .salesman-table-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* ‚úÖ ANIMATIONS */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* ‚úÖ RESPONSIVE */
        @media (max-width: 1400px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .lob-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .metrics-row {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
        }

        @media (max-width: 1200px) {
            .metrics-row {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .metrics-row {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }
            
            .metric-card {
                padding: 8px;
            }
            
            .metric-title {
                font-size: 8px;
            }
            
            .metric-value {
                font-size: 14px;
            }
            
            .lob-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="desktop-container">
<!-- ‚úÖ SIDEBAR NAVIGATION -->
<div class="sidebar">
<div class="sidebar-header">
<div class="company-logo">Monitoring Actual Sales</div>
<div class="company-subtitle">RSF App Web</div>
</div>
<nav class="sidebar-nav">
<div class="nav-item active" onclick="showDashboard()">
<div class="nav-icon">üè†</div>
<div class="nav-label">Dashboard</div>
</div>
<div class="nav-item" onclick="showActivity()">
<div class="nav-icon">üìä</div>
<div class="nav-label">Aktivitas</div>
</div>
<div class="nav-item" onclick="showPerformanceBySalesman()">
<div class="nav-icon">üìà</div>
<div class="nav-label">Perform by Salesman</div>
</div>
<div class="nav-item" onclick="showReports()">
<div class="nav-icon">üìä</div>
<div class="nav-label">Performance All</div>
</div>
<div class="nav-item" onclick="showSettings()">
<div class="nav-icon">‚öôÔ∏è</div>
<div class="nav-label">Pengaturan</div>
</div>
<div class="nav-item" onclick="logout()">
<div class="nav-icon">üö™</div>
<div class="nav-label">Keluar</div>
</div>
</nav>
<div class="sidebar-footer">
<div class="user-info">
<div class="user-avatar" id="userAvatar">A</div>
<div class="user-details">
<h4 id="userName">Pengguna Admin</h4>
<p id="userRole">Administrator</p>
</div>
</div>
</div>
</div>

<!-- ‚úÖ SALESMAN SELECTOR MODAL -->
<div class="modal-overlay" id="salesmanModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">üìà Pilih Salesman untuk Melihat Performance</h2>
            <button class="modal-close" onclick="closeSalesmanModal()">&times;</button>
        </div>
        <div class="salesman-grid" id="salesmanModalGrid">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>
</div>

<!-- ‚úÖ MAIN CONTENT -->
<div class="main-content">
<!-- ‚úÖ TOP HEADER -->
<div class="top-header">
<div class="header-left">
<h1 id="depoName">Dashboard</h1>
<p id="regionName">Memuat informasi wilayah...</p>
</div>
<div class="header-right">
<div class="time-gone-badge" id="timeGoneBadge" style="display:none;">
    <div class="tg-label">‚è± Time Gone</div>
    <div class="tg-bar-wrap">
        <div class="tg-bar-fill" id="tgBarFill"></div>
    </div>
    <div class="tg-value" id="tgValue">‚Äî</div>
</div>
<button class="refresh-btn" onclick="loadDashboardData()">
    üîÑ Perbarui
</button>
</div>
</div>
<!-- ‚úÖ DASHBOARD CONTENT -->
<div class="dashboard-content">
<!-- Loading State -->
<div class="loading-spinner" id="loadingSpinner">
<div class="spinner"></div>
<div style="font-size: 14px; font-weight: 600; color: #667eea;">Memuat data dashboard...</div>
</div>
<!-- Error State -->
<div class="error-message" id="errorMessage" style="display: none;">
<h3>üö® Kesalahan Memuat Data</h3>
<p>Tidak dapat memuat data dari folder \data\. Silakan periksa ketersediaan file JSON.</p>
<button class="refresh-btn" onclick="loadDashboardData()" style="margin-top: 12px;">Coba Lagi</button>
</div>
<!-- Main Dashboard Content -->
<div id="dashboardContent" style="display: none;">
<!-- ‚úÖ ACHIEVEMENT METRICS ROW - 9 Cards -->
<div class="metrics-row" id="metricsRow">
<!-- Will be populated by JavaScript -->
</div>
<!-- ‚úÖ DASHBOARD GRID -->
<div class="dashboard-grid">
<!-- ‚úÖ LEFT COLUMN -->
<div class="left-column">
<!-- ‚úÖ LOB SECTION -->
<div class="lob-section">
<div class="section-header">
<h3 class="section-title">
<span>üìä</span>
                                        By LOB (Principle)
                                    </h3>
</div>
<div class="lob-grid" id="lobGrid">
<!-- Will be populated by JavaScript -->
</div>
</div>
<!-- ‚úÖ SALESMAN SECTION -->
<div class="salesman-section">
<div class="salesman-header">
<h3 class="salesman-title">üë• Peringkat Salesman</h3>
<div class="salesman-count" id="salesmanCount">Memuat...</div>
</div>
<div class="salesman-table-container">
<table class="salesman-table">
<thead>
<tr>
<th>Peringkat</th>
<th>Salesman</th>
<th>Pencapaian</th>
<th>Status</th>
<th>Aksi</th>
</tr>
</thead>
<tbody id="salesmanTableBody">
<!-- Rows will be populated by JavaScript -->
</tbody>
</table>
</div>
</div>
</div>
<!-- ‚úÖ RIGHT COLUMN - LEAFLET MAP SECTION -->
<div class="right-column">
<div class="map-section">
<div class="map-header">
<h3 class="map-title">
<span>üó∫Ô∏è</span>
                                    Peta Area Kecamatan (Leaflet.js)
                                </h3>
<div class="map-controls">
<button class="map-control-btn active" data-metric="achievement">Achievement</button>
<button class="map-control-btn" data-metric="actual">Actual</button>
<button class="map-control-btn" data-metric="gap">Gap</button>
</div>
</div>
<div id="mapContainer">
<!-- Leaflet map will be initialized here -->
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- Leaflet.js JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
        crossorigin=""></script>

<script>
        // Global variables
        let dashboardData = null;
        let salesmanData = null;
        let chartData = null;
        let areaData = null;
        let depoData = null;
        let currentMapMetric = 'achievement';
        let leafletMap = null;
        let markersLayer = null;
        let tgPct = 0; // Time Gone percentage (0-100), digunakan untuk pewarnaan achievement

        // ‚úÖ FORMAT CURRENCY FUNCTION
        function formatCurrencyIndonesia(value) {
            try {
                const val = parseFloat(value);
                
                if (val >= 1000000000) {
                    return (val / 1000000000).toFixed(1) + 'M';
                } else if (val >= 1000000) {
                    return (val / 1000000).toFixed(1) + 'Jt';
                } else if (val >= 1000) {
                    return Math.round(val / 1000) + 'Rb';
                } else {
                    return Math.round(val).toString();
                }
            } catch {
                return "0";
            }
        }

        function formatCurrency(value) {
            if (typeof value === 'number') {
                return formatCurrencyIndonesia(value);
            }
            return value || "0";
        }

        function formatPercentage(value) {
            if (typeof value === 'number') {
                return (value * 100).toFixed(1) + '%';
            }
            return value || "0%";
        }

        // ‚úÖ Get achievement indicator
        function getAchievementIndicator(achievement) {
            const percentage = achievement * 100;
            if (percentage >= 100) {
                return {
                    emoji: 'üü¢',
                    class: 'indicator-green',
                    status: 'Target Tercapai'
                };
            } else if (percentage >= 80) {
                return {
                    emoji: 'üü°',
                    class: 'indicator-yellow',
                    status: 'Mendekati Target'
                };
            } else {
                return {
                    emoji: 'üî¥',
                    class: 'indicator-red',
                    status: 'Perlu Peningkatan'
                };
            }
        }

        // Check login status
        function checkLoginStatus() {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            if (!isLoggedIn) {
                window.location.href = 'index.html';
                return false;
            }
            
            const currentUser = sessionStorage.getItem('currentUser') || 'Admin';
            document.getElementById('userName').textContent = currentUser;
            document.getElementById('userAvatar').textContent = currentUser.charAt(0).toUpperCase();
            
            return true;
        }

        // ‚úÖ SHOW PERFORMANCE BY SALESMAN MODAL
        function showPerformanceBySalesman() {
            if (!salesmanData || salesmanData.length === 0) {
                alert('‚ùå Data salesman belum tersedia. Silakan tunggu hingga data terloda.');
                return;
            }

            const modal = document.getElementById('salesmanModal');
            const grid = document.getElementById('salesmanModalGrid');
            
            // Populate modal with salesman options
            grid.innerHTML = '';
            
            salesmanData.forEach(salesman => {
                const option = document.createElement('div');
                option.className = 'salesman-option';
                option.onclick = () => openSalesmanPerformance(salesman.id);
                
                option.innerHTML = `
                    <div class="salesman-option-avatar">
                        <img src="photos/${salesman.id}.jpg" 
                             alt="${salesman.name}" 
                             style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"
                             onerror="this.style.display='none'; this.parentElement.textContent='${salesman.name.charAt(0).toUpperCase()}';">
                    </div>
                    <div class="salesman-option-info">
                        <h4>${salesman.name}</h4>
                        <p>${salesman.type}</p>
                    </div>
                    <div class="salesman-option-achievement">${salesman.achievement}</div>
                `;
                
                grid.appendChild(option);
            });

            modal.style.display = 'flex';
            console.log('üìà Performance by Salesman modal opened');
        }

        // ‚úÖ CLOSE SALESMAN MODAL
        function closeSalesmanModal() {
            const modal = document.getElementById('salesmanModal');
            modal.style.display = 'none';
        }

        // ‚úÖ OPEN SALESMAN PERFORMANCE
        function openSalesmanPerformance(salesmanId) {
            console.log(`üìà Opening performance page for salesman: ${salesmanId}`);
            closeSalesmanModal();
            window.location.href = `performance_desktop.html?id=${salesmanId}`;
        }

        // ‚úÖ UPDATE TIME GONE badge from chart_data.json
        function updateTimeGone(data) {
            if (!data || !data.stats) return;
            const totalHK   = parseInt(data.stats.total_hk   || data.total_hk   || 0);
            const sisaHKDO  = parseInt(data.stats.sisa_hk_do || data.sisa_hk_do || 0);
            if (totalHK <= 0) return;

            const gone = totalHK - sisaHKDO;
            tgPct = Math.round((gone / totalHK) * 100); // simpan sebagai global

            document.getElementById('tgValue').textContent   = tgPct + '%';
            document.getElementById('tgBarFill').style.width = tgPct + '%';

            const fill  = document.getElementById('tgBarFill');
            const valEl = document.getElementById('tgValue');
            if      (tgPct >= 80) { fill.style.background = '#ef4444'; valEl.style.color = '#dc2626'; }
            else if (tgPct >= 50) { fill.style.background = '#f59e0b'; valEl.style.color = '#d97706'; }
            else                  { fill.style.background = '#10b981'; valEl.style.color = '#059669'; }

            document.getElementById('timeGoneBadge').style.display = 'flex';
            console.log(`‚è± Time Gone: ${gone}/${totalHK} HK = ${tgPct}%`);
        }

        // ‚úÖ Helper: parse JSON Lines text ‚Üí array of objects
        function parseJSONLines(text) {
            return text.trim().split('\n')
                .filter(line => line.trim())
                .map(line => { try { return JSON.parse(line); } catch(e) { return null; } })
                .filter(Boolean);
        }

        // ‚úÖ Helper: format value in Jt/Rb
        function fmtVal(v) {
            const n = Math.abs(parseFloat(v) || 0);
            const raw = parseFloat(v) || 0;
            if (n >= 1e9)  return (raw/1e9).toFixed(1) + 'M';
            if (n >= 1e6)  return (raw/1e6).toFixed(1) + 'Jt';
            if (n >= 1e3)  return Math.round(raw/1e3) + 'Rb';
            return Math.round(raw).toString();
        }

        // ‚úÖ Helper: format ratio as signed percentage string
        function fmtPct(v) {
            const pct = Math.round((parseFloat(v) || 0) * 100);
            return (pct >= 0 ? '+' : '') + pct + '%';
        }

        // ‚úÖ LOAD DASHBOARD DATA - Real data only from \data\ folder
        async function loadDashboardData() {
            try {
                showLoading(true);
                hideError();

                console.log('üîÑ Loading dashboard data from \\data\\ folder...');
                
                // Load real data from files
                const responses = await Promise.all([
                    fetch('data/d.dashboard.json'),    // LOB cards (JSONL)
                    fetch('data/d.performance.json'),  // Salesman ranking (JSONL)
                    fetch('data/chart_data.json'),
                    fetch('data/d.area.json'),
                    fetch('data/d.depoproses.json')
                ]);

                const [lobRes, perfRes, chartRes, areaRes, depoRes] = responses;

                // ‚îÄ‚îÄ d.dashboard.json (JSONL) ‚Üí LOB cards ‚îÄ‚îÄ
                if (lobRes.ok) {
                    const rawLOB = parseJSONLines(await lobRes.text());
                    const totalRow = rawLOB.find(r => r.LOB === 'TOTAL');
                    const lobRows  = rawLOB.filter(r => r.LOB !== 'TOTAL');
                    dashboardData = {
                        depo_name:   totalRow?.['Nama Depo'] || rawLOB[0]?.['Nama Depo'] || 'Dashboard',
                        region_name: '',
                        total_data: totalRow ? {
                            name:        'TOTAL',
                            achievement: Math.round((totalRow['vs BP'] || 0) * 100) + '%',
                            actual:      fmtVal(totalRow.Actual),
                            target:      fmtVal(totalRow.BP),
                            gap:         fmtVal(totalRow.Gap),
                            vs_lm:       fmtPct(totalRow['vs LM']),
                            vs_3lm:      fmtPct(totalRow['vs 3LM']),
                            vs_ly:       fmtPct(totalRow['vs LY'])
                        } : null,
                        lob_cards: lobRows.map(r => ({
                            name:        r.LOB,
                            achievement: Math.round((r['vs BP'] || 0) * 100) + '%',
                            actual:      fmtVal(r.Actual),
                            target:      fmtVal(r.BP),
                            gap:         fmtVal(r.Gap),
                            vs_lm:       fmtPct(r['vs LM']),
                            vs_3lm:      fmtPct(r['vs 3LM']),
                            vs_ly:       fmtPct(r['vs LY'])
                        }))
                    };
                    console.log('‚úÖ d.dashboard.json loaded:', rawLOB.length, 'LOB rows');
                } else {
                    console.warn('‚ö†Ô∏è d.dashboard.json failed to load');
                    dashboardData = { depo_name: 'Dashboard', region_name: '', total_data: null, lob_cards: [] };
                }

                // ‚îÄ‚îÄ d.performance.json (JSONL) ‚Üí Salesman ranking ‚îÄ‚îÄ
                if (perfRes.ok) {
                    const rawPerf = parseJSONLines(await perfRes.text());
                    const perfRows = rawPerf.filter(r => r.szEmployeeId !== 17200519965 && r.szname !== 'Total Depo');
                    perfRows.sort((a, b) => (a.Rank || 99) - (b.Rank || 99));
                    salesmanData = perfRows.map(r => {
                        const achPct = Math.round((r.Ach || 0) * 100);
                        let status = 'Extra Effort';
                        if      (achPct >= 100) status = 'Excellent';
                        else if (achPct >= 90)  status = 'Very Good';
                        else if (achPct >= 80)  status = 'Good';
                        return {
                            id:          r.szEmployeeId?.toString(),
                            name:        r.szname,
                            type:        r['Tipe Salesman'],
                            achievement: achPct + '%',
                            status:      status,
                            rank:        r.Rank
                        };
                    });
                    console.log('‚úÖ d.performance.json loaded:', salesmanData.length, 'salesman');
                } else {
                    console.warn('‚ö†Ô∏è d.performance.json failed to load');
                    salesmanData = [];
                }

                // ‚îÄ‚îÄ chart_data.json ‚îÄ‚îÄ
                if (chartRes.ok) {
                    chartData = await chartRes.json();
                    console.log('‚úÖ Chart data loaded');
                }

                // ‚îÄ‚îÄ d.area.json (JSONL) ‚îÄ‚îÄ
                if (areaRes.ok) {
                    const areaText = await areaRes.text();
                    if (areaText && areaText.trim()) {
                        areaData = parseJSONLines(areaText);
                        console.log('‚úÖ Area data loaded:', areaData.length, 'records');
                    }
                }

                // ‚îÄ‚îÄ d.depoproses.json ‚îÄ‚îÄ
                if (depoRes.ok) {
                    depoData = await depoRes.json();
                    console.log('‚úÖ Depot process data loaded:', depoData);
                }

                // Update UI with real data ‚Äî updateTimeGone HARUS dipanggil duluan
                // agar tgPct sudah tersedia saat LOB cards dan peta dirender
                updateHeader(dashboardData);
                updateTimeGone(chartData);          // ‚Üê set tgPct global dulu
                updateAchievementMetrics(depoData);
                updateLOBCards(dashboardData.lob_cards);
                updateSalesmanTable(salesmanData);
                
                // Initialize and render Leaflet map (pakai tgPct yang sudah diset)
                initializeLeafletMap();
                renderLeafletMap();

                showLoading(false);
                showMainContent(true);

            } catch (error) {
                console.error('‚ùå Error loading dashboard data:', error);
                showLoading(false);
                showError(true);
            }
        }

        // ‚úÖ UPDATE HEADER
        function updateHeader(data) {
            document.getElementById('depoName').textContent = data.depo_name || 'Dashboard';
            const regionElement = document.getElementById('regionName');
            regionElement.textContent = data.region_name || 'Memuat informasi wilayah...';
            
            // Check if we have real area data
            const hasRealData = areaData && 
                               Array.isArray(areaData) && 
                               areaData.length > 1 &&
                               areaData[0].Latitude && 
                               areaData[0].Longitude;
            
            if (hasRealData) {
                const validLocations = areaData.filter(loc => 
                    loc.Kecamatan !== 'DEPO TANJUNG' && loc.Latitude && loc.Longitude
                );
                regionElement.style.color = '#059669';
                regionElement.textContent += ` üìç (${validLocations.length} Lokasi) - Leaflet.js Interactive Map`;
            }
        }

        // ‚úÖ UPDATE ACHIEVEMENT METRICS - 9 Cards
        function updateAchievementMetrics(data) {
            const metricsRow = document.getElementById('metricsRow');
            
            if (!data || typeof data !== 'object') {
                console.error('‚ùå Depot data is not available:', data);
                metricsRow.innerHTML = `
                    <div class="no-data-message" style="grid-column: span 9;">
                        <h3>üìä Data Achievement Tidak Tersedia</h3>
                        <p>File d.depoproses.json tidak dapat dimuat atau kosong.</p>
                    </div>
                `;
                return;
            }
            
            const achievementMetrics = [
                { key: 'Ach_CR', title: 'Customer Register', shortTitle: 'CR' },
                { key: 'Ach_CA', title: 'Customer Active', shortTitle: 'CA' },
                { key: 'Ach_PC', title: 'Plan Call', shortTitle: 'PC' },
                { key: 'Ach_AC', title: 'Actual Call', shortTitle: 'AC' },
                { key: 'Ach_EC', title: 'Effective Call', shortTitle: 'EC' },
                { key: 'Ach_AvgSKU', title: 'Average SKU', shortTitle: 'Avg SKU' },
                { key: 'Ach_CAProdAll', title: 'CA Prod', shortTitle: 'CA Prod' },
                { key: 'Ach_GPFood', title: 'GP Food', shortTitle: 'GP Food' },
                { key: 'Ach_GPOthers', title: 'GP Others', shortTitle: 'GP Others' }
            ];

            let cardsHTML = '';
            
            achievementMetrics.forEach((metric, index) => {
                const achievement = data[metric.key] || 0;
                const indicator = getAchievementIndicator(achievement);
                const percentage = (achievement * 100).toFixed(1);

                cardsHTML += `
                    <div class="metric-card ${indicator.class} fade-in" style="animation-delay: ${index * 0.05}s;">
                        <div class="metric-header">
                            <div class="metric-title">${metric.shortTitle}</div>
                            <div class="metric-indicator">${indicator.emoji}</div>
                        </div>
                        <div class="metric-value">${percentage}%</div>
                    </div>
                `;
            });

            metricsRow.innerHTML = cardsHTML;
            console.log('‚úÖ Achievement metrics updated with 9 cards');
        }

        // ‚úÖ UPDATE LOB CARDS
        function updateLOBCards(lobCards) {
            const lobGrid = document.getElementById('lobGrid');
            
            if (!lobCards || !Array.isArray(lobCards)) {
                lobGrid.innerHTML = `
                    <div class="no-data-message">
                        <h3>üìä Data LOB Tidak Tersedia</h3>
                        <p>File dashboard.json tidak dapat dimuat atau tidak memiliki data lob_cards.</p>
                    </div>
                `;
                return;
            }

            lobGrid.innerHTML = '';

            const totalCard = dashboardData.total_data;
            if (totalCard) {
                const totalCardElement = createLOBCard(totalCard, 'total', true);
                lobGrid.appendChild(totalCardElement);
            }

            lobCards.forEach((lob, index) => {
                const card = createLOBCard(lob, index);
                lobGrid.appendChild(card);
            });

            console.log('‚úÖ Generated', lobCards.length + (totalCard ? 1 : 0), 'LOB cards');
        }

        // ‚úÖ CREATE LOB CARD
        function createLOBCard(lob, index, isTotal = false) {
            const card = document.createElement('div');
            card.className = `lob-card ${isTotal ? 'color-total' : `color-${index % 9}`} fade-in`;
            card.style.animationDelay = `${(isTotal ? 0 : index + 1) * 0.05}s`;

            if (isTotal) {
                card.style.order = '-1';
                card.style.background = 'linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1))';
                card.style.border = '2px solid #667eea';
            }

            // Warna badge achievement berdasarkan vs Time Gone
            const achPctNum = parseInt(lob.achievement) || 0;
            const achStyle  = getAchStyle(achPctNum);
            const badgeStyle = `background: ${achStyle.bg}; color: ${achStyle.color};`;

            card.innerHTML = `
                <div class="lob-header">
                    <div class="lob-name">${isTotal ? 'üìä ' + lob.name : lob.name}</div>
                    <div class="achievement-badge" style="${badgeStyle}">${lob.achievement}</div>
                </div>
                
                <div class="lob-metrics">
                    <div class="lob-metric">
                        <div class="lob-metric-label">Aktual</div>
                        <div class="lob-metric-value">${lob.actual}</div>
                    </div>
                    <div class="lob-metric">
                        <div class="lob-metric-label">Target</div>
                        <div class="lob-metric-value">${lob.target}</div>
                    </div>
                    <div class="lob-metric">
                        <div class="lob-metric-label">Gap</div>
                        <div class="lob-metric-value">${lob.gap}</div>
                    </div>
                </div>
                
                <div class="lob-vs-metrics">
                    <div class="lob-vs-metric">
                        <div class="lob-vs-label">vs BL</div>
                        <div class="lob-vs-value">${lob.vs_lm || '0%'}</div>
                    </div>
                    <div class="lob-vs-metric">
                        <div class="lob-vs-label">vs 3BL</div>
                        <div class="lob-vs-value">${lob.vs_3lm || '0%'}</div>
                    </div>
                    <div class="lob-vs-metric">
                        <div class="lob-vs-label">vs TL</div>
                        <div class="lob-vs-value">${lob.vs_ly || '0%'}</div>
                    </div>
                </div>
            `;

            return card;
        }

        // ‚úÖ INITIALIZE LEAFLET MAP
        function initializeLeafletMap() {
            try {
                console.log('üó∫Ô∏è Initializing Leaflet.js map...');
                
                // Clear any existing map
                if (leafletMap) {
                    leafletMap.remove();
                    leafletMap = null;
                }
                
                // Initialize Leaflet map
                leafletMap = L.map('mapContainer').setView([-2.18, 115.4], 9);
                
                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors | üó∫Ô∏è Leaflet.js Interactive Map',
                    maxZoom: 18,
                    minZoom: 7
                }).addTo(leafletMap);
                
                // Initialize markers layer
                markersLayer = L.layerGroup().addTo(leafletMap);
                
                // Add map control event listeners
                document.querySelectorAll('.map-control-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.map-control-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        
                        currentMapMetric = e.target.getAttribute('data-metric');
                        console.log(`üó∫Ô∏è Map metric changed to ${currentMapMetric}`);
                        
                        updateMapMarkers();
                    });
                });
                
                console.log('‚úÖ Leaflet map initialized successfully');
                
            } catch (error) {
                console.error('‚ùå Error initializing Leaflet map:', error);
                showMapError();
            }
        }

        // ‚úÖ RENDER LEAFLET MAP with coordinate data
        function renderLeafletMap() {
            if (!leafletMap || !areaData) {
                console.warn('‚ö†Ô∏è Map or area data not available');
                return;
            }
            
            try {
                console.log('üó∫Ô∏è Rendering Leaflet map with coordinate data...');
                
                // Filter valid locations (exclude DEPO TANJUNG and invalid coordinates)
                const validLocations = areaData.filter(location => 
                    location.Kecamatan !== 'DEPO TANJUNG' &&
                    location.Latitude && 
                    location.Longitude &&
                    typeof location.Latitude === 'number' &&
                    typeof location.Longitude === 'number'
                );
                
                if (validLocations.length === 0) {
                    console.warn('‚ö†Ô∏è No valid coordinate data found');
                    showMapError();
                    return;
                }
                
                console.log(`üìç Processing ${validLocations.length} valid locations`);
                
                // Clear existing markers
                markersLayer.clearLayers();
                
                // Calculate map bounds
                const latitudes = validLocations.map(loc => loc.Latitude);
                const longitudes = validLocations.map(loc => loc.Longitude);
                
                const southWest = L.latLng(Math.min(...latitudes), Math.min(...longitudes));
                const northEast = L.latLng(Math.max(...latitudes), Math.max(...longitudes));
                const bounds = L.latLngBounds(southWest, northEast);
                
                // Fit map to bounds with padding
                leafletMap.fitBounds(bounds, { padding: [20, 20] });
                
                // Add markers for each location
                validLocations.forEach((location, index) => {
                    createLeafletMarker(location, index);
                });
                
                console.log('‚úÖ Leaflet map rendered successfully');
                
            } catch (error) {
                console.error('‚ùå Error rendering Leaflet map:', error);
                showMapError();
            }
        }

        // ‚úÖ CREATE LEAFLET MARKER
        function createLeafletMarker(location, index) {
            try {
                const lat = location.Latitude;
                const lng = location.Longitude;
                const achievement = location.Ach || 0;
                
                // Get marker style based on achievement
                const markerStyle = getMarkerStyle(achievement);
                
                // Create custom HTML marker
                const markerHtml = `
                    <div class="custom-marker ${markerStyle.class}" 
                         style="background: ${markerStyle.color};">
                        ${markerStyle.icon}
                    </div>
                `;
                
                // Create custom icon
                const customIcon = L.divIcon({
                    html: markerHtml,
                    className: 'custom-div-icon',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12],
                    popupAnchor: [0, -12]
                });
                
                // Create marker
                const marker = L.marker([lat, lng], { icon: customIcon });
                
                // Create popup content
                const popupContent = createPopupContent(location);
                
                // Bind popup
                marker.bindPopup(popupContent, {
                    maxWidth: 300,
                    className: 'custom-popup'
                });
                
                // Add to markers layer
                marker.addTo(markersLayer);
                
                // Add hover effects
                marker.on('mouseover', function() {
                    this.openPopup();
                });
                
                return marker;
                
            } catch (error) {
                console.warn(`Error creating marker for ${location.Kecamatan}:`, error);
                return null;
            }
        }

        // ‚úÖ GET MARKER STYLE based on achievement and current metric
        function getMarkerStyle(achievement) {
            if (!achievement || typeof achievement !== 'number') {
                return { color: '#94a3b8', class: 'marker-no-data', icon: '?' };
            }

            const achPctVal = achievement * 100;

            if (currentMapMetric === 'achievement') {
                // Gunakan tgPct sebagai patokan, sama persis dengan getAchStyle
                const tg = tgPct || 0;
                if (achPctVal >= tg)            return { color: '#059669', class: 'marker-excellent', icon: '‚òÖ' };
                else if (achPctVal >= tg * 0.9) return { color: '#f59e0b', class: 'marker-good',     icon: '‚óè' };
                else                            return { color: '#ef4444', class: 'marker-poor',     icon: '‚ñ≤' };
            } else if (currentMapMetric === 'actual') {
                return { color: '#667eea', class: 'marker-actual', icon: '‚Çπ' };
            } else if (currentMapMetric === 'gap') {
                return achievement >= (tgPct / 100) ?
                    { color: '#059669', class: 'marker-positive', icon: '+' } :
                    { color: '#ef4444', class: 'marker-negative', icon: '-' };
            }

            return { color: '#667eea', class: 'marker-default', icon: '‚óè' };
        }

        // ‚úÖ CREATE POPUP CONTENT ‚Äî semua field dari d.area.json
        function createPopupContent(location) {
            const achPct  = typeof location.Ach === 'number' ? (location.Ach * 100).toFixed(1) + '%' : '‚Äî';
            const vsLY    = typeof location['vs LY']  === 'number' ? fmtPct(location['vs LY'])  : '‚Äî';
            const vs3LM   = typeof location['vs 3LM'] === 'number' ? fmtPct(location['vs 3LM']) : '‚Äî';
            const vsLM    = typeof location['vs LM']  === 'number' ? fmtPct(location['vs LM'])  : '‚Äî';

            // Warna badge Ach di tooltip: sama logika dengan getAchStyle (vs tgPct)
            const achPctNum = typeof location.Ach === 'number' ? location.Ach * 100 : null;
            let achBg = '#94a3b8', achTxt = '#ffffff';
            if (achPctNum !== null) {
                const s = getAchStyle(achPctNum);
                achBg  = s.bg;
                achTxt = s.color;
            }

            const row = (label, val, cls='') => `
                <div class="popup-metric">
                    <span class="popup-metric-label">${label}</span>
                    <span class="popup-metric-value ${cls}">${val}</span>
                </div>`;

            const gapClass = (location.Gap || 0) >= 0 ? 'positive' : 'negative';

            return `
                <div class="popup-header">
                    üìç ${location.Kecamatan}
                    <span style="font-size:10px; font-weight:400; opacity:0.85; margin-left:4px;">${location.Kabupaten}</span>
                </div>
                <div class="popup-content">
                    <!-- Achievement highlight -->
                    <div style="text-align:center; padding:8px 0 10px; border-bottom:1px solid #f1f5f9; margin-bottom:8px;">
                        <span style="background:${achBg}; color:${achTxt}; padding:4px 14px; border-radius:20px; font-size:15px; font-weight:800;">${achPct}</span>
                        <div style="font-size:10px; color:#94a3b8; margin-top:4px;">Achievement vs Target</div>
                    </div>
                    <!-- Sales metrics -->
                    ${row('Target',  fmtVal(location.Target))}
                    ${row('Aktual',  fmtVal(location.Actual))}
                    ${row('Gap',     fmtVal(location.Gap), gapClass)}
                    <!-- Historical comparison -->
                    <div style="border-top:1px solid #f1f5f9; margin:8px 0 6px; padding-top:6px;">
                        <div style="font-size:10px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:4px;">Perbandingan Historis</div>
                    </div>
                    ${row('Last Month',    fmtVal(location.LM))}
                    ${row('3 Last Month',  fmtVal(location['3LM']))}
                    ${row('Last Year',     fmtVal(location.LY))}
                    <!-- vs comparisons -->
                    <div style="border-top:1px solid #f1f5f9; margin:8px 0 6px; padding-top:6px;">
                        <div style="font-size:10px; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:4px;">vs Periode</div>
                    </div>
                    <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:4px; text-align:center;">
                        <div style="background:#f8fafc; border-radius:6px; padding:4px;">
                            <div style="font-size:9px; color:#94a3b8; font-weight:600;">vs BL</div>
                            <div style="font-size:12px; font-weight:700; color:${parseFloat(location['vs LM']||0)>=0?'#059669':'#ef4444'};">${vsLM}</div>
                        </div>
                        <div style="background:#f8fafc; border-radius:6px; padding:4px;">
                            <div style="font-size:9px; color:#94a3b8; font-weight:600;">vs 3BL</div>
                            <div style="font-size:12px; font-weight:700; color:${parseFloat(location['vs 3LM']||0)>=0?'#059669':'#ef4444'};">${vs3LM}</div>
                        </div>
                        <div style="background:#f8fafc; border-radius:6px; padding:4px;">
                            <div style="font-size:9px; color:#94a3b8; font-weight:600;">vs TL</div>
                            <div style="font-size:12px; font-weight:700; color:${parseFloat(location['vs LY']||0)>=0?'#059669':'#ef4444'};">${vsLY}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ‚úÖ UPDATE MAP MARKERS when metric changes
        function updateMapMarkers() {
            if (!markersLayer || !areaData) return;
            
            try {
                console.log(`üîÑ Updating map markers for metric: ${currentMapMetric}`);
                
                // Clear and re-render all markers with new style
                markersLayer.clearLayers();
                
                const validLocations = areaData.filter(location => 
                    location.Kecamatan !== 'DEPO TANJUNG' &&
                    location.Latitude && 
                    location.Longitude &&
                    typeof location.Latitude === 'number' &&
                    typeof location.Longitude === 'number'
                );
                
                validLocations.forEach((location, index) => {
                    createLeafletMarker(location, index);
                });
                
                console.log('‚úÖ Map markers updated successfully');
                
            } catch (error) {
                console.error('‚ùå Error updating map markers:', error);
            }
        }

        // ‚úÖ SHOW MAP ERROR
        function showMapError() {
            const mapContainer = document.getElementById('mapContainer');
            if (mapContainer) {
                mapContainer.innerHTML = `
                    <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; background: #f8fafc; color: #64748b; text-align: center; padding: 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üó∫Ô∏è</div>
                        <h3 style="color: #d97706; margin-bottom: 8px;">Map Data Tidak Tersedia</h3>
                        <p>File d.area.json tidak dapat dimuat atau tidak memiliki koordinat yang valid.</p>
                        <button onclick="loadDashboardData()" style="margin-top: 16px; padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Coba Lagi</button>
                    </div>
                `;
            }
        }

        // ‚úÖ UPDATE SALESMAN TABLE
        function updateSalesmanTable(salesmanList) {
            const tableBody = document.getElementById('salesmanTableBody');
            const salesmanCount = document.getElementById('salesmanCount');
            
            if (!salesmanList || !Array.isArray(salesmanList)) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="no-data-message">
                            <h3>üë• Data Salesman Tidak Tersedia</h3>
                            <p>File salesman_list.json tidak dapat dimuat atau kosong.</p>
                        </td>
                    </tr>
                `;
                salesmanCount.textContent = '0 Salesman';
                return;
            }
            
            tableBody.innerHTML = '';
            salesmanCount.textContent = `${salesmanList.length} Salesman`;

            salesmanList.forEach((salesman, index) => {
                const row = createSalesmanRow(salesman, index);
                tableBody.appendChild(row);
            });

            console.log('‚úÖ Tabel salesman berhasil diperbarui dengan', salesmanList.length, 'records');
        }

        // ‚úÖ CREATE SALESMAN ROW
        function createSalesmanRow(salesman, index) {
            const row = document.createElement('tr');
            row.style.animationDelay = `${index * 0.02}s`;
            row.className = 'fade-in';

            // Ambil angka dari string "45%" ‚Üí 45
            const achPct  = parseInt(salesman.achievement) || 0;
            const style   = getAchStyle(achPct);

            row.innerHTML = `
                <td class="rank-column">${salesman.rank}</td>
                <td>
                    <div class="salesman-name-cell">
                        <div class="salesman-avatar" data-nik="${salesman.id}">
                            <img src="photos/${salesman.id}.jpg" 
                                 alt="${salesman.name}" 
                                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"
                                 onerror="this.style.display='none'; this.parentElement.textContent='${salesman.name.charAt(0).toUpperCase()}';">
                        </div>
                        <div class="salesman-info">
                            <h4>${salesman.name}</h4>
                            <p>${salesman.type}</p>
                        </div>
                    </div>
                </td>
                <td class="achievement-cell">
                    <div style="background:${style.bg}; color:${style.color}; padding:6px 12px; border-radius:12px; font-weight:700; font-size:13px; display:inline-block;">
                        ${salesman.achievement}
                    </div>
                </td>
                <td class="status-cell">
                    <div style="background:${style.bg}20; color:${style.bg}; border:1px solid ${style.bg}40; padding:4px 8px; border-radius:12px; font-size:10px; font-weight:700; text-transform:uppercase; display:inline-block;">
                        ${style.label}
                    </div>
                </td>
                <td class="action-cell">
                    <button class="view-btn" onclick="openSalesmanDetail('${salesman.id}')">
                        View
                    </button>
                </td>
            `;

            return row;
        }

        // ‚úÖ Warna achievement badge berdasarkan perbandingan vs Time Gone (tgPct)
        // - achPct >= tgPct           ‚Üí Hijau  (on track)
        // - achPct >= tgPct * 0.9     ‚Üí Kuning (mendekati)
        // - achPct < tgPct * 0.9      ‚Üí Merah  (under)
        function getAchStyle(achPct) {
            const tg = tgPct || 0;
            if (achPct >= tg) {
                // >= Time Gone ‚Üí Hijau
                return { bg: '#059669', color: '#ffffff', label: 'On Track' };
            } else if (achPct >= tg * 0.9) {
                // 90%-99.99% dari Time Gone ‚Üí Kuning
                return { bg: '#f59e0b', color: '#1e293b', label: 'Mendekati' };
            } else {
                // < 90% dari Time Gone ‚Üí Merah
                return { bg: '#ef4444', color: '#ffffff', label: 'Extra Effort' };
            }
        }

        // ‚úÖ NAVIGATION FUNCTIONS
        function openSalesmanDetail(salesmanId) {
            console.log(`üöÄ Navigating to salesman detail: ${salesmanId}`);
            window.location.href = `performance_desktop.html?id=${salesmanId}`;
        }

        function showDashboard() {
            console.log('Already on dashboard');
        }

        function showActivity() {
            alert('üìú Activity module coming soon!');
        }

        function showReports() {
            window.location.href = 'performance_all_desktop.html';
        }

        function showSettings() {
            alert('üìú Settings module coming soon!');
        }

        function logout() {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                sessionStorage.removeItem('isLoggedIn');
                sessionStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            }
        }

        // ‚úÖ UI CONTROL FUNCTIONS
        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'flex' : 'none';
        }

        function showError(show) {
            document.getElementById('errorMessage').style.display = show ? 'block' : 'none';
        }

        function hideError() {
            showError(false);
        }

        function showMainContent(show) {
            document.getElementById('dashboardContent').style.display = show ? 'block' : 'none';
        }

        // ‚úÖ INITIALIZE DASHBOARD
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkLoginStatus()) {
                return;
            }

            console.log('üöÄ Initializing dashboard with Leaflet.js interactive map...');
            loadDashboardData();
        });

        // ‚úÖ CLOSE MODAL ON OUTSIDE CLICK
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('salesmanModal');
            if (event.target === modal) {
                closeSalesmanModal();
            }
        });

        console.log('‚úÖ Dashboard script loaded - Enhanced with Leaflet.js Interactive Map');
    </script>
</body>
</html>