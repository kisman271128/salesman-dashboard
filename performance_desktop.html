<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Performa Salesman - Desktop</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            color: #2c3e50;
            overflow: hidden;
        }

        .desktop-container { display: flex; height: 100vh; }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 240px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 0;
            box-shadow: 4px 0 20px rgba(0,0,0,0.1);
            position: fixed;
            height: 100vh;
            z-index: 1000;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .sidebar-header .company-logo { font-size: 16px; font-weight: 800; margin-bottom: 4px; }
        .sidebar-header .company-subtitle { font-size: 11px; opacity: 0.9; }

        .sidebar-salesman-info {
            padding: 14px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.15);
        }

        .sidebar-salesman-info .label { font-size: 10px; opacity: 0.6; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .sidebar-salesman-info .name { font-size: 13px; font-weight: 700; color: #fff; }

        .nav-section-title {
            padding: 14px 16px 6px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: rgba(255,255,255,0.4);
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 11px 16px;
            color: rgba(255,255,255,0.75);
            text-decoration: none;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
            font-size: 13px;
        }

        .nav-item:hover { background: rgba(255,255,255,0.08); color: white; border-left-color: #667eea; }

        .nav-item.active {
            background: rgba(102,126,234,0.25);
            color: white;
            border-left-color: #667eea;
            font-weight: 600;
        }

        .nav-icon { font-size: 16px; margin-right: 10px; width: 20px; text-align: center; }

        .sidebar-footer {
            margin-top: auto;
            padding: 16px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .logout-btn {
            width: 100%;
            padding: 10px;
            background: rgba(239,68,68,0.2);
            border: 1px solid rgba(239,68,68,0.3);
            color: #fca5a5;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .logout-btn:hover { background: rgba(239,68,68,0.35); color: #fff; }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            margin-left: 240px;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .top-header {
            background: white;
            padding: 16px 28px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e2e8f0;
            flex-shrink: 0;
        }

        .header-left h1 { font-size: 20px; font-weight: 700; color: #1e293b; margin-bottom: 2px; }
        .header-left p { font-size: 12px; color: #64748b; }

        .header-right { display: flex; align-items: center; gap: 12px; }

        .btn-back {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            color: #475569;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        .btn-back:hover { background: #e2e8f0; color: #1e293b; }

        /* ===== METRICS ROW ===== */
        .metrics-bar {
            background: white;
            padding: 16px 28px;
            border-bottom: 1px solid #e2e8f0;
            flex-shrink: 0;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 14px;
        }

        .metric-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 14px 16px;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s;
        }
        .metric-card:hover { transform: translateY(-1px); }
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: var(--card-color, #e2e8f0);
        }

        .metric-card.total   { --card-color: linear-gradient(90deg, #667eea, #764ba2); }
        .metric-card.ws      { --card-color: #10b981; }
        .metric-card.retail  { --card-color: #f59e0b; }
        .metric-card.mti     { --card-color: #ef4444; }

        .metric-label { font-size: 10px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .metric-value { font-size: 22px; font-weight: 700; color: #1e293b; margin-bottom: 4px; }
        .metric-sub { font-size: 11px; color: #94a3b8; display: flex; justify-content: space-between; }

        .ach-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
        }
        .ach-high   { background: rgba(16,185,129,0.1); color: #059669; }
        .ach-medium { background: rgba(245,158,11,0.1); color: #d97706; }
        .ach-low    { background: rgba(239,68,68,0.1);  color: #dc2626; }

        /* ===== PAGE CONTENT ===== */
        .page-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px 28px;
            background: #f8fafc;
        }

        .section-panel { display: none; }
        .section-panel.active { display: block; }

        /* ===== SECTION CARD ===== */
        .section-card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            overflow: hidden;
        }

        .section-card-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 15px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ===== DATA TABLE ===== */
        .table-scroll {
            overflow-x: auto;
            overflow-y: auto;
            max-height: calc(100vh - 320px);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .data-table th {
            background: #f8fafc;
            color: #475569;
            padding: 11px 14px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }

        .data-table td {
            padding: 10px 14px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
            white-space: nowrap;
        }

        .data-table tr:hover td { background: #f8faff; }

        .total-row td {
            background: #f1f5f9 !important;
            font-weight: 700;
            border-top: 2px solid #667eea;
            border-bottom: 2px solid #667eea;
            color: #1e293b;
        }

        /* Channel grouping */
        .channel-group-row td {
            background: #eef2ff !important;
            font-weight: 700;
            color: #3730a3;
            border-top: 2px solid #c7d2fe;
        }
        .channel-group-row:hover td { background: #e0e7ff !important; }

        .project-sub-row td {
            background: #fafbff !important;
            color: #374151;
        }
        .project-sub-row:hover td { background: #f0f4ff !important; }

        .val-num { text-align: right; font-family: 'Courier New', monospace; }
        .val-center { text-align: center; }

        /* ===== ALIGNMENT SEMUA TABEL ===== */

        /* --- JKS (7 kolom): 1:HariJKS=kiri, 2:CR=center, 3:Gap=kanan,
              4:Target=kanan, 5:Aktual=kanan, 6:Ach%=center, 7:vsLM=center --- */
        #sec_jks th:nth-child(2), #sec_jks td:nth-child(2),
        #sec_jks th:nth-child(6), #sec_jks td:nth-child(6),
        #sec_jks th:nth-child(7), #sec_jks td:nth-child(7) { text-align: center; }
        #sec_jks th:nth-child(3), #sec_jks td:nth-child(3),
        #sec_jks th:nth-child(4), #sec_jks td:nth-child(4),
        #sec_jks th:nth-child(5), #sec_jks td:nth-child(5) { text-align: right; }

        /* --- CHANNEL (8 kolom): 1:Channel=kiri, 2:Target=kanan, 3:Aktual=kanan,
              4:Gap=kanan, 5:Ach%=center, 6:LY=kanan, 7:3LM=kanan, 8:LM=kanan --- */
        #sec_channel th:nth-child(5), #sec_channel td:nth-child(5) { text-align: center; }
        #sec_channel th:nth-child(2), #sec_channel td:nth-child(2),
        #sec_channel th:nth-child(3), #sec_channel td:nth-child(3),
        #sec_channel th:nth-child(4), #sec_channel td:nth-child(4),
        #sec_channel th:nth-child(6), #sec_channel td:nth-child(6),
        #sec_channel th:nth-child(7), #sec_channel td:nth-child(7),
        #sec_channel th:nth-child(8), #sec_channel td:nth-child(8) { text-align: right; }

        /* --- PROJECT (8 kolom): 1:Customer=kiri, 2:ITG=center, 3:T.MTD=kanan,
              4:A.MTD=kanan, 5:Gap=kanan, 6:Ach%=center, 7:GapQrt=kanan, 8:Status=center --- */
        #sec_project th:nth-child(2), #sec_project td:nth-child(2),
        #sec_project th:nth-child(6), #sec_project td:nth-child(6),
        #sec_project th:nth-child(8), #sec_project td:nth-child(8) { text-align: center; }
        #sec_project th:nth-child(3), #sec_project td:nth-child(3),
        #sec_project th:nth-child(4), #sec_project td:nth-child(4),
        #sec_project th:nth-child(5), #sec_project td:nth-child(5),
        #sec_project th:nth-child(7), #sec_project td:nth-child(7) { text-align: right; }

        /* --- PARETO (9 kolom): 1:Rank=center, 2:Pelanggan=center,
              3-9:angka=kanan --- */
        #sec_pareto th:nth-child(1), #sec_pareto td:nth-child(1),
        #sec_pareto th:nth-child(2), #sec_pareto td:nth-child(2) { text-align: center; }
        #sec_pareto th:nth-child(3), #sec_pareto td:nth-child(3),
        #sec_pareto th:nth-child(4), #sec_pareto td:nth-child(4),
        #sec_pareto th:nth-child(5), #sec_pareto td:nth-child(5),
        #sec_pareto th:nth-child(6), #sec_pareto td:nth-child(6),
        #sec_pareto th:nth-child(7), #sec_pareto td:nth-child(7),
        #sec_pareto th:nth-child(8), #sec_pareto td:nth-child(8),
        #sec_pareto th:nth-child(9), #sec_pareto td:nth-child(9) { text-align: right; }

        /* --- CA POM (6 kolom): 1:SKU=kiri, 2:CR=center, 3:Target=kanan,
              4:Aktual=kanan, 5:Ach%=center, 6:Gap=kanan --- */
        #sec_pom th:nth-child(2), #sec_pom td:nth-child(2),
        #sec_pom th:nth-child(5), #sec_pom td:nth-child(5) { text-align: center; }
        #sec_pom th:nth-child(3), #sec_pom td:nth-child(3),
        #sec_pom th:nth-child(4), #sec_pom td:nth-child(4),
        #sec_pom th:nth-child(6), #sec_pom td:nth-child(6) { text-align: right; }

        /* --- PLAN DAP (5 kolom): 1:Tanggal=kiri, 2:PlanDAP=kanan,
              3:AktualSO=kanan, 4:Ach%=center, 5:Status=center --- */
        #sec_dap th:nth-child(4), #sec_dap td:nth-child(4),
        #sec_dap th:nth-child(5), #sec_dap td:nth-child(5) { text-align: center; }
        #sec_dap th:nth-child(2), #sec_dap td:nth-child(2),
        #sec_dap th:nth-child(3), #sec_dap td:nth-child(3) { text-align: right; }
        .gap-neg { color: #dc2626; font-weight: 600; }
        .gap-pos { color: #059669; font-weight: 600; }
        .ach-h { background: rgba(16,185,129,0.1); color: #059669; padding: 2px 8px; border-radius: 6px; font-weight: 600; display: inline-block; }
        .ach-m { background: rgba(245,158,11,0.1); color: #d97706; padding: 2px 8px; border-radius: 6px; font-weight: 600; display: inline-block; }
        .ach-l { background: rgba(239,68,68,0.1); color: #dc2626; padding: 2px 8px; border-radius: 6px; font-weight: 600; display: inline-block; }

        .status-lanjut  { background: rgba(16,185,129,0.1); color: #059669; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; }
        .status-gugur   { background: rgba(239,68,68,0.1); color: #dc2626; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; }
        .status-high    { background: rgba(16,185,129,0.1); color: #059669; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; }
        .status-low     { background: rgba(239,68,68,0.1); color: #dc2626; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; }

        .rank-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
        }

        /* DAP section */
        .dap-filter {
            padding: 16px 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .dap-filter input[type="date"] {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 13px;
            color: #1e293b;
        }
        .btn-filter {
            padding: 8px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-filter:hover { opacity: 0.9; transform: translateY(-1px); }

        .dap-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 14px;
            padding: 16px 20px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
        }
        .dap-summary-item { text-align: center; }
        .dap-summary-item .ds-label { font-size: 11px; color: #64748b; margin-bottom: 4px; }
        .dap-summary-item .ds-value { font-size: 16px; font-weight: 700; color: #1e293b; }

        /* Loading & Error */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: #64748b;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid #f1f5f9;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 0.9s linear infinite;
            margin-bottom: 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .error-state {
            background: rgba(239,68,68,0.05);
            border: 1px solid rgba(239,68,68,0.2);
            color: #dc2626;
            padding: 24px;
            border-radius: 10px;
            text-align: center;
            margin: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 48px 20px;
            color: #94a3b8;
        }
        .empty-state .icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }

        /* Scrollbar */
        .table-scroll::-webkit-scrollbar,
        .page-content::-webkit-scrollbar { width: 6px; height: 6px; }
        .table-scroll::-webkit-scrollbar-track,
        .page-content::-webkit-scrollbar-track { background: #f1f5f9; }
        .table-scroll::-webkit-scrollbar-thumb,
        .page-content::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        /* Salesman selector in sidebar */
        .salesman-select-btn {
            margin: 12px 16px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .salesman-select-btn:hover { background: rgba(255,255,255,0.2); }

        /* POM table compact */
        .pom-ach-cell { text-align: center; font-weight: 700; }
    </style>
</head>
<body>
<div class="desktop-container">

<!-- ===== SIDEBAR ===== -->
<div class="sidebar">
    <div class="sidebar-header">
        <div class="company-logo">Monitoring Actual Sales</div>
        <div class="company-subtitle">Performance By Salesman</div>
    </div>

    <div class="sidebar-salesman-info">
        <div class="label">Salesman</div>
        <div class="name" id="sidebarSalesmanName">Memuat...</div>
    </div>

    <div class="salesman-select-btn" onclick="goBack()">‚Üê Ganti Salesman</div>

    <div class="nav-section-title">Analisis Performa</div>

    <div class="nav-item active" data-section="jks" onclick="switchSection('jks', this)">
        <span class="nav-icon">üìÖ</span>Per JKS
    </div>
    <div class="nav-item" data-section="channel" onclick="switchSection('channel', this)">
        <span class="nav-icon">üìà</span>Per Channel
    </div>
    <div class="nav-item" data-section="project" onclick="switchSection('project', this)">
        <span class="nav-icon">üéØ</span>Per Project
    </div>
    <div class="nav-item" data-section="pareto" onclick="switchSection('pareto', this)">
        <span class="nav-icon">üèÜ</span>30 Pareto
    </div>
    <div class="nav-item" data-section="pom" onclick="switchSection('pom', this)">
        <span class="nav-icon">üìã</span>CA POM
    </div>
    <div class="nav-item" data-section="dap" onclick="switchSection('dap', this)">
        <span class="nav-icon">üìä</span>Plan DAP
    </div>

    <div class="nav-section-title">Navigasi</div>
    <div class="nav-item" onclick="goHome()">
        <span class="nav-icon">üè†</span>Dashboard
    </div>
    <div class="nav-item" onclick="goAllPerformance()">
        <span class="nav-icon">üë•</span>Semua Salesman
    </div>

    <div class="sidebar-footer">
        <button class="logout-btn" onclick="logout()">üö™ Keluar</button>
    </div>
</div>

<!-- ===== MAIN CONTENT ===== -->
<div class="main-content">

    <!-- Top Header -->
    <div class="top-header">
        <div class="header-left">
            <h1 id="headerSalesmanName">Detail Performa</h1>
            <p id="headerSubtitle">Analisis data penjualan MTD</p>
        </div>
        <div class="header-right">
            <a href="#" class="btn-back" id="backBtn" onclick="goBack()">‚Üê Kembali ke Daftar</a>
        </div>
    </div>

    <!-- Metrics Bar -->
    <div class="metrics-bar" id="metricsBar" style="display:none;">
        <div class="metrics-grid">
            <div class="metric-card total">
                <div class="metric-label">Total Aktual</div>
                <div class="metric-value" id="mc_totalVal">‚Äî</div>
                <div class="metric-sub">
                    <span>Target: <strong id="mc_totalTgt">‚Äî</strong></span>
                    <span class="ach-badge ach-low" id="mc_totalAch">0%</span>
                </div>
            </div>
            <div class="metric-card ws">
                <div class="metric-label">Wholesaler</div>
                <div class="metric-value" id="mc_wsVal">‚Äî</div>
                <div class="metric-sub">
                    <span>Target: <strong id="mc_wsTgt">‚Äî</strong></span>
                    <span class="ach-badge ach-low" id="mc_wsAch">0%</span>
                </div>
            </div>
            <div class="metric-card retail">
                <div class="metric-label">Retail</div>
                <div class="metric-value" id="mc_retailVal">‚Äî</div>
                <div class="metric-sub">
                    <span>Target: <strong id="mc_retailTgt">‚Äî</strong></span>
                    <span class="ach-badge ach-low" id="mc_retailAch">0%</span>
                </div>
            </div>
            <div class="metric-card mti">
                <div class="metric-label">MTI</div>
                <div class="metric-value" id="mc_mtiVal">‚Äî</div>
                <div class="metric-sub">
                    <span>Target: <strong id="mc_mtiTgt">‚Äî</strong></span>
                    <span class="ach-badge ach-low" id="mc_mtiAch">0%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div class="page-content" id="loadingPanel">
        <div class="loading-state">
            <div class="spinner"></div>
            <div>Memuat data performa...</div>
        </div>
    </div>

    <!-- Error -->
    <div class="page-content" id="errorPanel" style="display:none;">
        <div class="error-state">
            <h3>üö® Error Memuat Data</h3>
            <p id="errorMsg">Terjadi kesalahan.</p>
            <button onclick="loadPerformanceData()" style="margin-top:12px; padding:8px 20px; background:#667eea; color:white; border:none; border-radius:8px; cursor:pointer;">Coba Lagi</button>
        </div>
    </div>

    <!-- Main page content -->
    <div class="page-content" id="mainPanel" style="display:none;">

        <!-- JKS Section -->
        <div class="section-panel active" id="sec_jks">
            <div class="section-card">
                <div class="section-card-header">üìÖ Performa per JKS (Hari Kunjungan)</div>
                <div class="table-scroll">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Hari JKS</th>
                                <th>CR Pasif</th>
                                <th class="val-num">Gap MTD</th>
                                <th class="val-num">Target MTD</th>
                                <th class="val-num">Aktual MTD</th>
                                <th class="val-center">Ach%</th>
                                <th class="val-center">vs LM</th>
                            </tr>
                        </thead>
                        <tbody id="jksBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Channel Section -->
        <div class="section-panel" id="sec_channel">
            <div class="section-card">
                <div class="section-card-header">üìà Performa per Channel & Project</div>
                <div class="table-scroll">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="min-width:180px;">Channel / Project</th>
                                <th class="val-num">Target MTD</th>
                                <th class="val-num">Aktual MTD</th>
                                <th class="val-num">Gap MTD</th>
                                <th class="val-center">Ach%</th>
                                <th class="val-num">Last Year</th>
                                <th class="val-num">3 Last Month</th>
                                <th class="val-num">Last Month</th>
                            </tr>
                        </thead>
                        <tbody id="channelBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Project Section -->
        <div class="section-panel" id="sec_project">
            <div class="section-card">
                <div class="section-card-header">üéØ Performa per Project Customer</div>
                <div class="table-scroll">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="min-width:200px;">Customer</th>
                                <th>ITG</th>
                                <th class="val-num">T.MTD</th>
                                <th class="val-num">A.MTD</th>
                                <th class="val-num">Gap MTD</th>
                                <th class="val-center">Ach%</th>
                                <th class="val-num">Gap Qrt</th>
                                <th class="val-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="projectBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Pareto Section -->
        <div class="section-panel" id="sec_pareto">
            <div class="section-card">
                <div class="section-card-header">üèÜ Top 30 Pareto Outlet</div>
                <div class="table-scroll">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width:60px;">Rank</th>
                                <th style="min-width:180px;">Nama Pelanggan</th>
                                <th class="val-num">Gap MTD</th>
                                <th class="val-num">Target</th>
                                <th class="val-num">Aktual MTD</th>
                                <th class="val-num">Last Month</th>
                                <th class="val-num">Last Year</th>
                                <th class="val-num">3LM</th>
                                <th class="val-num">Max</th>
                            </tr>
                        </thead>
                        <tbody id="paretoBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- POM Section -->
        <div class="section-panel" id="sec_pom">
            <div class="section-card">
                <div class="section-card-header">üìã CA POM Performance</div>
                <div class="table-scroll">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="min-width:180px;">SKU</th>
                                <th class="val-center">CR</th>
                                <th class="val-num">Target POM</th>
                                <th class="val-num">Aktual POM</th>
                                <th class="val-center">Ach%</th>
                                <th class="val-num">Gap</th>
                            </tr>
                        </thead>
                        <tbody id="pomBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- DAP Section -->
        <div class="section-panel" id="sec_dap">
            <div class="section-card">
                <div class="dap-filter">
                    <label style="font-size:13px; font-weight:600; color:#475569;">Periode:</label>
                    <input type="date" id="dapStart">
                    <span style="color:#94a3b8; font-size:12px;">s/d</span>
                    <input type="date" id="dapEnd">
                    <button class="btn-filter" onclick="loadDAPData()">üîç Filter</button>
                </div>
                <div class="section-card-header">üìä Monitoring Plan DAP</div>
                <div class="table-scroll">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="min-width:120px;">Tanggal</th>
                                <th class="val-num">Plan DAP</th>
                                <th class="val-num">Aktual SO</th>
                                <th class="val-center">Ach%</th>
                                <th class="val-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="dapBody">
                            <tr><td colspan="5" class="empty-state"><div class="icon">üìä</div><div>Pilih rentang tanggal dan klik Filter</div></td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="dap-summary" id="dapSummaryBar" style="display:none;">
                    <div class="dap-summary-item"><div class="ds-label">Total Plan DAP</div><div class="ds-value" id="ds_plan">‚Äî</div></div>
                    <div class="dap-summary-item"><div class="ds-label">Total Aktual SO</div><div class="ds-value" id="ds_actual">‚Äî</div></div>
                    <div class="dap-summary-item"><div class="ds-label">Avg Achievement</div><div class="ds-value" id="ds_ach">‚Äî</div></div>
                    <div class="dap-summary-item"><div class="ds-label">Hari dengan Plan</div><div class="ds-value" id="ds_days">‚Äî</div></div>
                </div>
            </div>
        </div>

    </div><!-- end mainPanel -->
</div><!-- end main-content -->
</div><!-- end desktop-container -->

<script>
    // ===== GLOBAL DATA =====
    let jksData=[], channelProjData=[], projectData=[], paretoData=[], pomData=[];
    let currentSalesmanId=null, currentSalesmanName=null;

    // ===== UTILS =====
    function fc(v) {
        const n = Math.abs(parseFloat(v)||0);
        if(n>=1e9) return (n/1e9).toFixed(1)+'M';
        if(n>=1e6) return (n/1e6).toFixed(1)+'jt';
        if(n>=1e3) return (n/1e3).toFixed(0)+'rb';
        return n.toFixed(0);
    }
    function fNum(v) {
        return Math.round(parseFloat(v)||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.');
    }
    function ach(t,a) {
        const tv=parseFloat(t||0), av=parseFloat(a||0);
        if(tv===0&&av>0) return 100;
        if(tv>0) return Math.round((av/tv)*100);
        return 0;
    }
    function achClass(pct) {
        if(pct>=100) return 'ach-h';
        if(pct>=90)  return 'ach-m';
        return 'ach-l';
    }
    function gapClass(v) { return parseFloat(v)<=0 ? 'gap-neg' : 'gap-pos'; }
    function getUrlParam(n) {
        const r=new RegExp('[\\?&]'+n+'=([^&#]*)');
        const res=r.exec(location.search);
        return res ? decodeURIComponent(res[1].replace(/\+/g,' ')) : '';
    }

    // ===== SECTION SWITCH =====
    function switchSection(name, el) {
        document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
        if(el) el.classList.add('active');
        document.querySelectorAll('.section-panel').forEach(p=>p.classList.remove('active'));
        const panel=document.getElementById('sec_'+name);
        if(panel) panel.classList.add('active');
    }

    // ===== DATA LOADING =====
    async function loadJSONData() {
        const paths=['data/','./ data/','./',''];
        async function loadFile(fn) {
            for(const base of ['data/','./data/','./','']) {
                try {
                    const r=await fetch(base+fn);
                    if(r.ok) return await r.text();
                } catch(e) { continue; }
            }
            throw new Error('Cannot load '+fn);
        }
        function parseJL(txt) {
            return txt.split('\n').filter(l=>l.trim()).map(l=>{try{return JSON.parse(l);}catch{return null;}}).filter(Boolean);
        }
        try { const t=await loadFile('d.jks.json'); jksData=parseJL(t); } catch(e){}
        try { const t=await loadFile('d.channelproj.json'); channelProjData=parseJL(t); } catch(e){}
        try { const t=await loadFile('d.project.json'); projectData=parseJL(t); } catch(e){}
        try { const t=await loadFile('d.30pareto.json'); paretoData=parseJL(t); } catch(e){}
        try { const t=await loadFile('d.tpom.json'); pomData=parseJL(t); } catch(e){}
    }

    // ===== METRICS CARDS =====
    function updateMetrics(name) {
        const data = channelProjData.filter(d=>d.szname===name);
        const chMap={};
        data.forEach(d=>{
            const ch=d['Channel Group'];
            if(!chMap[ch]) chMap[ch]={t:0,a:0};
            chMap[ch].t+=parseFloat(d[' T.MTD']||0);
            chMap[ch].a+=parseFloat(d[' A.MTD']||0);
        });
        let totalT=0,totalA=0;
        ['Wholesaler','Retail','MTI'].forEach(ch=>{
            const d=chMap[ch]||{t:0,a:0};
            totalT+=d.t; totalA+=d.a;
            const key=ch==='Wholesaler'?'ws':ch.toLowerCase();
            document.getElementById(`mc_${key}Val`).textContent=fc(d.a);
            document.getElementById(`mc_${key}Tgt`).textContent=fc(d.t);
            const pct=ach(d.t,d.a);
            const el=document.getElementById(`mc_${key}Ach`);
            el.textContent=pct+'%';
            el.className='ach-badge '+achClass(pct);
        });
        document.getElementById('mc_totalVal').textContent=fc(totalA);
        document.getElementById('mc_totalTgt').textContent=fc(totalT);
        const tPct=ach(totalT,totalA);
        const tel=document.getElementById('mc_totalAch');
        tel.textContent=tPct+'%';
        tel.className='ach-badge '+achClass(tPct);
        document.getElementById('metricsBar').style.display='block';
    }

    // ===== JKS TABLE =====
    function renderJKS(name) {
        const rows=jksData.filter(d=>d.szname===name);
        const tbody=document.getElementById('jksBody');
        if(!rows.length){
            tbody.innerHTML='<tr><td colspan="7"><div class="empty-state"><div class="icon">üìÖ</div><div>Data JKS tidak tersedia</div></div></td></tr>';
            return;
        }
        let tCR=0,tT=0,tA=0,tG=0,tLM=0;
        rows.forEach(r=>{
            tCR+=parseInt(r[' CR Pasif']||0);
            tT+=parseFloat(r[' T.MTD']||0);
            tA+=parseFloat(r[' A.MTD']||0);
            tG+=parseFloat(r[' Gap MTD']||0);
            tLM+=parseFloat(r[' LM']||0);
        });
        const tPct=ach(tT,tA);
        const tVsLM=tLM>0?Math.round(((tA-tLM)/tLM)*100):0;
        let html=`<tr class="total-row">
            <td><strong>TOTAL</strong></td>
            <td class="val-center"><strong>${tCR}</strong></td>
            <td class="val-num ${gapClass(tG)}"><strong>${tG>=0?'+':''}${fc(tG)}</strong></td>
            <td class="val-num"><strong>${fc(tT)}</strong></td>
            <td class="val-num"><strong>${fc(tA)}</strong></td>
            <td class="val-center"><span class="${achClass(tPct)}">${tPct}%</span></td>
            <td class="val-center ${gapClass(tVsLM)}"><strong>${tVsLM>=0?'+':''}${tVsLM}%</strong></td>
        </tr>`;
        rows.forEach(r=>{
            const t=parseFloat(r[' T.MTD']||0),a=parseFloat(r[' A.MTD']||0);
            const g=parseFloat(r[' Gap MTD']||0);
            const lm=parseFloat(r[' LM']||0);
            const pct=ach(t,a);
            const vsLM=lm>0?Math.round(((a-lm)/lm)*100):0;
            html+=`<tr>
                <td><strong>${r['Hari JKS']||''}</strong></td>
                <td class="val-center">${r[' CR Pasif']||0}</td>
                <td class="val-num ${gapClass(g)}">${g>=0?'+':''}${fc(g)}</td>
                <td class="val-num">${fc(t)}</td>
                <td class="val-num">${fc(a)}</td>
                <td class="val-center"><span class="${achClass(pct)}">${pct}%</span></td>
                <td class="val-center ${gapClass(vsLM)}">${vsLM>=0?'+':''}${vsLM}%</td>
            </tr>`;
        });
        tbody.innerHTML=html;
    }

    // ===== CHANNEL TABLE (Grouped) =====
    function renderChannel(name) {
        const data=channelProjData.filter(d=>d.szname===name);
        const tbody=document.getElementById('channelBody');
        if(!data.length){
            tbody.innerHTML='<tr><td colspan="8"><div class="empty-state"><div class="icon">üìà</div><div>Data channel tidak tersedia</div></div></td></tr>';
            return;
        }
        const gMap={};
        data.forEach(d=>{
            const ch=d['Channel Group']||'Lainnya', proj=d['Project']||'-';
            if(!gMap[ch]) gMap[ch]={t:0,a:0,g:0,ly:0,lm3:0,lm:0,projects:{}};
            const G=gMap[ch];
            G.t+=parseFloat(d[' T.MTD']||0); G.a+=parseFloat(d[' A.MTD']||0);
            G.g+=parseFloat(d[' Gap MTD']||0); G.ly+=parseFloat(d[' LY']||0);
            G.lm3+=parseFloat(d[' 3LM']||0); G.lm+=parseFloat(d[' LM']||0);
            if(!G.projects[proj]) G.projects[proj]={t:0,a:0,g:0,ly:0,lm3:0,lm:0,cr:0,ca:0};
            const P=G.projects[proj];
            P.t+=parseFloat(d[' T.MTD']||0); P.a+=parseFloat(d[' A.MTD']||0);
            P.g+=parseFloat(d[' Gap MTD']||0); P.ly+=parseFloat(d[' LY']||0);
            P.lm3+=parseFloat(d[' 3LM']||0); P.lm+=parseFloat(d[' LM']||0);
            P.cr+=parseInt(d['CR']||0); P.ca+=parseInt(d['CA']||0);
        });
        let tT=0,tA=0,tG=0,tLY=0,tLM3=0,tLM=0;
        Object.values(gMap).forEach(g=>{tT+=g.t;tA+=g.a;tG+=g.g;tLY+=g.ly;tLM3+=g.lm3;tLM+=g.lm;});
        const tPct=ach(tT,tA);
        let html=`<tr class="total-row">
            <td><strong>TOTAL</strong></td>
            <td class="val-num"><strong>${fc(tT)}</strong></td>
            <td class="val-num"><strong>${fc(tA)}</strong></td>
            <td class="val-num ${gapClass(tG)}"><strong>${tG>=0?'+':''}${fc(tG)}</strong></td>
            <td class="val-center"><span class="${achClass(tPct)}">${tPct}%</span></td>
            <td class="val-num"><strong>${fc(tLY)}</strong></td>
            <td class="val-num"><strong>${fc(tLM3)}</strong></td>
            <td class="val-num"><strong>${fc(tLM)}</strong></td>
        </tr>`;
        Object.entries(gMap).forEach(([ch,G])=>{
            const chPct=ach(G.t,G.a);
            html+=`<tr class="channel-group-row">
                <td><strong>üìÇ ${ch}</strong></td>
                <td class="val-num"><strong>${fc(G.t)}</strong></td>
                <td class="val-num"><strong>${fc(G.a)}</strong></td>
                <td class="val-num ${gapClass(G.g)}"><strong>${G.g>=0?'+':''}${fc(G.g)}</strong></td>
                <td class="val-center"><span class="${achClass(chPct)}">${chPct}%</span></td>
                <td class="val-num"><strong>${fc(G.ly)}</strong></td>
                <td class="val-num"><strong>${fc(G.lm3)}</strong></td>
                <td class="val-num"><strong>${fc(G.lm)}</strong></td>
            </tr>`;
            Object.entries(G.projects).forEach(([proj,P])=>{
                const pPct=ach(P.t,P.a);
                html+=`<tr class="project-sub-row">
                    <td style="padding-left:28px;"><span style="color:#94a3b8;">‚Ü≥</span> <strong>${proj}</strong> <small style="color:#94a3b8; margin-left:6px;">CR:${P.cr} CA:${P.ca}</small></td>
                    <td class="val-num">${fc(P.t)}</td>
                    <td class="val-num">${fc(P.a)}</td>
                    <td class="val-num ${gapClass(P.g)}">${P.g>=0?'+':''}${fc(P.g)}</td>
                    <td class="val-center"><span class="${achClass(pPct)}">${pPct}%</span></td>
                    <td class="val-num">${fc(P.ly)}</td>
                    <td class="val-num">${fc(P.lm3)}</td>
                    <td class="val-num">${fc(P.lm)}</td>
                </tr>`;
            });
        });
        tbody.innerHTML=html;
    }

    // ===== PROJECT TABLE =====
    function renderProject(name) {
        const rows=projectData.filter(d=>d.szname===name);
        const tbody=document.getElementById('projectBody');
        if(!rows.length){
            tbody.innerHTML='<tr><td colspan="8"><div class="empty-state"><div class="icon">üéØ</div><div>Data project tidak tersedia</div></div></td></tr>';
            return;
        }
        let tT=0,tA=0,tG=0,tGQ=0;
        rows.forEach(r=>{tT+=parseFloat(r['T.MTD']||0);tA+=parseFloat(r['A.MTD']||0);tG+=parseFloat(r['Gap MTD']||0);tGQ+=parseFloat(r['Gap Qrt']||0);});
        const tPct=ach(tT,tA);
        let html=`<tr class="total-row">
            <td><strong>TOTAL</strong></td><td>‚Äî</td>
            <td class="val-num"><strong>${fc(tT)}</strong></td>
            <td class="val-num"><strong>${fc(tA)}</strong></td>
            <td class="val-num ${gapClass(tG)}"><strong>${fc(tG)}</strong></td>
            <td class="val-center"><span class="${achClass(tPct)}">${tPct}%</span></td>
            <td class="val-num ${gapClass(tGQ)}"><strong>${fc(tGQ)}</strong></td>
            <td>‚Äî</td>
        </tr>`;
        rows.forEach(r=>{
            const pct=Math.round((r['Ach MTD']||0)*100);
            const gm=parseFloat(r['Gap MTD']||0), gq=parseFloat(r['Gap Qrt']||0);
            const isITG=r.ITG==='ITG SC';
            const sc=r.Status==='Lanjut'?'status-lanjut':r.Status==='Gugur'?'status-gugur':r.Status==='> 70%'?'status-high':'status-low';
            html+=`<tr>
                <td><strong style="font-size:12px;">${(r['CUST NAME']||'').substring(0,30)}</strong></td>
                <td><span style="font-size:11px;color:#64748b;">${r.ITG||''}</span></td>
                <td class="val-num">${isITG?fNum(r['T.MTD']):fc(r['T.MTD'])}</td>
                <td class="val-num">${isITG?fNum(r['A.MTD']):fc(r['A.MTD'])}</td>
                <td class="val-num ${gapClass(gm)}">${isITG?fNum(gm):fc(gm)}</td>
                <td class="val-center"><span class="${achClass(pct)}">${pct}%</span></td>
                <td class="val-num ${gapClass(gq)}">${isITG?fNum(gq):fc(gq)}</td>
                <td class="val-center"><span class="${sc}">${r.Status||''}</span></td>
            </tr>`;
        });
        tbody.innerHTML=html;
    }

    // ===== PARETO TABLE =====
    function renderPareto(name) {
        const rows=paretoData.filter(d=>d.szname===name&&(d.Ranking||d['Rank Outlet']));
        const tbody=document.getElementById('paretoBody');
        if(!rows.length){
            tbody.innerHTML='<tr><td colspan="9"><div class="empty-state"><div class="icon">üèÜ</div><div>Data pareto tidak tersedia</div></div></td></tr>';
            return;
        }
        let tG=0,tT=0,tA=0,tLM=0,tLY=0,t3LM=0,tMX=0;
        rows.forEach(r=>{tG+=parseFloat(r[' Gap MTD']||0);tT+=parseFloat(r[' T.MTD']||0);tA+=parseFloat(r[' A.MTD']||0);tLM+=parseFloat(r[' LM']||0);tLY+=parseFloat(r[' LY']||0);t3LM+=parseFloat(r[' 3LM']||0);tMX+=parseFloat(r[' Max']||0);});
        let html=`<tr class="total-row">
            <td>‚Äî</td><td><strong>TOTAL</strong></td>
            <td class="val-num ${gapClass(tG)}"><strong>${tG>=0?'+':''}${fc(tG)}</strong></td>
            <td class="val-num"><strong>${fc(tT)}</strong></td>
            <td class="val-num"><strong>${fc(tA)}</strong></td>
            <td class="val-num"><strong>${fc(tLM)}</strong></td>
            <td class="val-num"><strong>${fc(tLY)}</strong></td>
            <td class="val-num"><strong>${fc(t3LM)}</strong></td>
            <td class="val-num"><strong>${fc(tMX)}</strong></td>
        </tr>`;
        rows.forEach(r=>{
            const g=parseFloat(r[' Gap MTD']||0);
            const rank=r.Ranking||r['Rank Outlet']||'-';
            html+=`<tr>
                <td class="val-center"><span class="rank-badge">#${rank}</span></td>
                <td><strong style="font-size:12px;">${(r['Nama Pelanggan']||'').substring(0,28)}</strong><br><small style="color:#94a3b8;font-size:10px;">${r['JKS']||r['Hari JKS']||''}</small></td>
                <td class="val-num ${gapClass(g)}">${g>=0?'+':''}${fc(g)}</td>
                <td class="val-num">${fc(r[' T.MTD'])}</td>
                <td class="val-num">${fc(r[' A.MTD'])}</td>
                <td class="val-num">${fc(r[' LM'])}</td>
                <td class="val-num">${fc(r[' LY'])}</td>
                <td class="val-num">${fc(r[' 3LM'])}</td>
                <td class="val-num">${fc(r[' Max'])}</td>
            </tr>`;
        });
        tbody.innerHTML=html;
    }

    // ===== POM TABLE =====
    function renderPOM(name) {
        const rows=pomData.filter(d=>d.szname===name);
        const tbody=document.getElementById('pomBody');
        if(!rows.length){
            tbody.innerHTML='<tr><td colspan="6"><div class="empty-state"><div class="icon">üìã</div><div>Data CA POM tidak tersedia</div></div></td></tr>';
            return;
        }
        const skuMap={};
        rows.forEach(r=>{
            const sku=r.SKU||'UNKNOWN';
            if(!skuMap[sku]) skuMap[sku]={sku,cr:0,t:0,a:0,achSum:0,cnt:0};
            const s=skuMap[sku];
            s.cr+=parseFloat(r['CR JKS']||0);
            s.t+=parseFloat(r['T.POMAdj']||0);
            s.a+=parseFloat(r['A.POM']||0);
            s.achSum+=parseFloat(r['Ach_POM']||0);
            s.cnt++;
        });
        Object.values(skuMap).forEach(s=>s.gap=s.a-s.t);
        let tT=0,tA=0,tG=0,tAS=0,tCnt=0;
        Object.values(skuMap).forEach(s=>{tT+=s.t;tA+=s.a;tG+=s.gap;tAS+=s.achSum;tCnt+=s.cnt;});
        const avgAch=tCnt>0?Math.round((tAS/tCnt)*100):0;
        let html=`<tr class="total-row">
            <td><strong>TOTAL</strong></td>
            <td class="val-center">‚Äî</td>
            <td class="val-num"><strong>${tT}</strong></td>
            <td class="val-num"><strong>${tA}</strong></td>
            <td class="val-center"><span class="${achClass(avgAch)}">${avgAch}%</span></td>
            <td class="val-num ${gapClass(tG)}"><strong>${tG>=0?'+':''}${fc(tG)}</strong></td>
        </tr>`;
        Object.values(skuMap).sort((a,b)=>b.a-a.a).forEach(s=>{
            const pct=s.cnt>0?Math.round((s.achSum/s.cnt)*100):0;
            html+=`<tr>
                <td><strong style="font-size:12px;">${s.sku}</strong></td>
                <td class="val-center">${Math.round(s.cr)}</td>
                <td class="val-num">${s.t}</td>
                <td class="val-num">${s.a}</td>
                <td class="val-center"><span class="${achClass(pct)}">${pct}%</span></td>
                <td class="val-num ${gapClass(s.gap)}">${s.gap>=0?'+':''}${fc(s.gap)}</td>
            </tr>`;
        });
        tbody.innerHTML=html;
    }

    // ===== DAP SECTION =====
    async function loadDAPData() {
        const start=document.getElementById('dapStart').value;
        const end=document.getElementById('dapEnd').value;
        if(!start||!end){alert('Pilih rentang tanggal terlebih dahulu!');return;}
        if(new Date(start)>new Date(end)){alert('Tanggal mulai harus lebih kecil dari tanggal akhir!');return;}
        const tbody=document.getElementById('dapBody');
        tbody.innerHTML='<tr><td colspan="5"><div class="loading-state"><div class="spinner"></div><div>Memuat data DAP...</div></div></td></tr>';
        try {
            const planRef=window.firebaseRef(window.firebaseDB,`plan_dap/${currentSalesmanId}`);
            const sumRef=window.firebaseRef(window.firebaseDB,`daily_summary/${currentSalesmanId}`);
            const [ps,ss]=await Promise.all([window.firebaseGet(planRef),window.firebaseGet(sumRef)]);
            const planData=ps.exists()?ps.val():{};
            const sumData=ss.exists()?ss.val():{};
            const dates=[];
            let d=new Date(start), e=new Date(end);
            while(d<=e){dates.push(d.toISOString().split('T')[0]);d.setDate(d.getDate()+1);}
            let html='',tPlan=0,tActual=0,dWPlan=0,tAchSum=0;
            const days=['Min','Sen','Sel','Rab','Kam','Jum','Sab'];
            const months=['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'];
            dates.forEach(dt=>{
                const plan=planData[dt]?.amount||0, actual=sumData[dt]?.total_so_amount||0;
                if(plan>0){dWPlan++;tPlan+=plan;tAchSum+=plan>0?Math.round((actual/plan)*100):0;}
                tActual+=actual;
                const pct=plan>0?Math.round((actual/plan)*100):(actual>0?100:0);
                const dd=new Date(dt);
                const dateStr=`${days[dd.getDay()]}, ${dd.getDate()} ${months[dd.getMonth()]}`;
                let badge='',rowStyle='';
                if(plan===0){badge='<span style="background:#94a3b8;color:white;padding:2px 8px;border-radius:4px;font-size:10px;">No Plan</span>';rowStyle='opacity:0.6;';}
                else if(pct>=100){badge='<span style="background:#10b981;color:white;padding:2px 8px;border-radius:4px;font-size:10px;">‚úÖ Tercapai</span>';rowStyle='background:#d1fae5;';}
                else if(pct>=80){badge='<span style="background:#f59e0b;color:white;padding:2px 8px;border-radius:4px;font-size:10px;">‚ö†Ô∏è Hampir</span>';rowStyle='background:#fef3c7;';}
                else{badge='<span style="background:#ef4444;color:white;padding:2px 8px;border-radius:4px;font-size:10px;">‚ùå Belum</span>';rowStyle='background:#fee2e2;';}
                html+=`<tr style="${rowStyle}"><td>${dateStr}</td><td class="val-num">${plan?fc(plan):'-'}</td><td class="val-num">${actual?fc(actual):'-'}</td><td class="val-center">${pct}%</td><td class="val-center">${badge}</td></tr>`;
            });
            tbody.innerHTML=html||'<tr><td colspan="5"><div class="empty-state"><div>Tidak ada data</div></div></td></tr>';
            const avgAch=dWPlan>0?Math.round(tAchSum/dWPlan):0;
            document.getElementById('ds_plan').textContent=fc(tPlan);
            document.getElementById('ds_actual').textContent=fc(tActual);
            document.getElementById('ds_ach').textContent=avgAch+'%';
            document.getElementById('ds_days').textContent=dWPlan+' hari';
            document.getElementById('dapSummaryBar').style.display='grid';
        } catch(e) {
            tbody.innerHTML=`<tr><td colspan="5"><div class="error-state">Error: ${e.message}</div></td></tr>`;
        }
    }

    // ===== MAIN LOAD =====
    async function loadPerformanceData() {
        try {
            document.getElementById('loadingPanel').style.display='block';
            document.getElementById('errorPanel').style.display='none';
            document.getElementById('mainPanel').style.display='none';

            currentSalesmanId=getUrlParam('id');
            if(!currentSalesmanId) throw new Error('ID salesman tidak ditemukan di URL');

            await loadJSONData();

            // Find salesman name
            let sm=jksData.find(d=>d.szEmployeeId?.toString()===currentSalesmanId.toString())
                 ||channelProjData.find(d=>d.szEmployeeId?.toString()===currentSalesmanId.toString())
                 ||projectData.find(d=>d.szEmployeeId?.toString()===currentSalesmanId.toString())
                 ||paretoData.find(d=>d.szEmployeeId?.toString()===currentSalesmanId.toString());
            if(!sm) throw new Error(`Salesman ID ${currentSalesmanId} tidak ditemukan`);
            currentSalesmanName=sm.szname;

            // Update UI labels
            document.getElementById('sidebarSalesmanName').textContent=currentSalesmanName;
            document.getElementById('headerSalesmanName').textContent=currentSalesmanName;
            document.getElementById('headerSubtitle').textContent='Analisis Data Penjualan MTD ‚Äî ID: '+currentSalesmanId;

            // Render all sections
            updateMetrics(currentSalesmanName);
            renderJKS(currentSalesmanName);
            renderChannel(currentSalesmanName);
            renderProject(currentSalesmanName);
            renderPareto(currentSalesmanName);
            renderPOM(currentSalesmanName);

            // Default DAP dates
            const today=new Date(), ago=new Date();
            ago.setDate(today.getDate()-7);
            document.getElementById('dapEnd').valueAsDate=today;
            document.getElementById('dapStart').valueAsDate=ago;

            document.getElementById('loadingPanel').style.display='none';
            document.getElementById('mainPanel').style.display='block';

        } catch(err) {
            document.getElementById('loadingPanel').style.display='none';
            document.getElementById('errorPanel').style.display='block';
            document.getElementById('errorMsg').textContent=err.message;
        }
    }

    // ===== NAVIGATION =====
    function goHome()            { window.location.href='dashboard-desktop.html'; }
    function goBack()            { window.location.href='dashboard-desktop.html'; }
    function goAllPerformance()  { window.location.href='performance_all_desktop.html'; }
    function logout() {
        sessionStorage.clear();
        window.location.href='index.html';
    }

    // ===== LOGIN CHECK & INIT =====
    document.addEventListener('DOMContentLoaded',()=>{
        const ok=sessionStorage.getItem('isLoggedIn');
        if(!ok){ window.location.href='index.html'; return; }
        loadPerformanceData();
    });
</script>
</body>
</html>