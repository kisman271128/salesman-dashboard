<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Location Monitoring - Firebase Integrated</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #2c3e50;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            height: 100vh;
            gap: 0;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            background: linear-gradient(135deg, #1e293b, #334155);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .sidebar-subtitle {
            font-size: 12px;
            opacity: 0.8;
        }

        .sidebar-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* ===== FIREBASE STATUS ===== */
        .firebase-status {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            color: #0369a1;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .firebase-status.connected {
            background: #f0fdf4;
            border-color: #10b981;
            color: #065f46;
        }

        .firebase-status.error {
            background: #fef2f2;
            border-color: #ef4444;
            color: #991b1b;
        }

        /* ===== CONTROL PANEL ===== */
        .control-panel {
            margin-bottom: 24px;
        }

        .control-title {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-item {
            margin-bottom: 12px;
        }

        .control-item label {
            display: block;
            font-size: 12px;
            color: #64748b;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .control-item select,
        .control-item input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 12px;
            background: white;
            transition: all 0.3s ease;
        }

        .control-item select:focus,
        .control-item input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .control-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(20px);
        }

        .toggle-label {
            font-size: 12px;
            font-weight: 500;
            color: #1e293b;
        }

        /* ===== SALESMAN LIST ===== */
        .salesman-list {
            margin-bottom: 24px;
        }

        .salesman-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .salesman-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .salesman-item.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #f0f4ff, #e0e7ff);
        }

        .salesman-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .salesman-name {
            font-weight: 600;
            font-size: 12px;
            color: #1e293b;
        }

        .salesman-status {
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-online {
            background: #ecfdf5;
            color: #10b981;
        }

        .status-offline {
            background: #fef2f2;
            color: #ef4444;
        }

        .status-inactive {
            background: #f8fafc;
            color: #64748b;
        }

        .salesman-details {
            font-size: 11px;
            color: #64748b;
        }

        .salesman-location {
            margin-top: 4px;
            font-size: 10px;
            color: #475569;
            font-family: 'Courier New', monospace;
        }

        /* ===== STATISTICS ===== */
        .stats-panel {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .stat-item {
            text-align: center;
            padding: 8px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 2px;
        }

        .stat-label {
            font-size: 10px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .main-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 16px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .main-title {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #ecfdf5;
            border: 1px solid #10b981;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: #065f46;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ===== MAP CONTAINER ===== */
        .map-container {
            flex: 1;
            position: relative;
        }

        #realtimeMap {
            height: 100%;
            width: 100%;
        }

        /* ===== MAP CONTROLS ===== */
        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 200px;
        }

        .map-control-item {
            margin-bottom: 12px;
        }

        .map-control-item:last-child {
            margin-bottom: 0;
        }

        .map-btn {
            width: 100%;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .map-btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .map-btn-secondary {
            background: #f1f5f9;
            color: #4a5568;
            border: 1px solid #e2e8f0;
        }

        .map-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        /* ===== NOTIFICATION PANEL ===== */
        .notification-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-width: 300px;
            display: none;
        }

        .notification-header {
            font-weight: 600;
            font-size: 14px;
            color: #1e293b;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-item {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 4px;
            padding: 4px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .notification-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        /* ===== DEBUG OUTPUT ===== */
        .debug-output {
            background: #1e293b;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-family: monospace;
            font-size: 10px;
            max-height: 150px;
            overflow-y: auto;
            display: none;
        }

        .debug-output.show {
            display: block;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1024px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }

            .sidebar {
                max-height: 300px;
            }

            .sidebar-content {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 16px;
                padding: 16px;
            }

            .map-controls {
                top: 10px;
                right: 10px;
                min-width: 150px;
                padding: 12px;
            }

            .notification-panel {
                bottom: 10px;
                left: 10px;
                max-width: 250px;
            }
        }

        @media (max-width: 768px) {
            .main-header {
                padding: 12px 16px;
            }

            .main-title {
                font-size: 16px;
            }

            .live-indicator {
                font-size: 10px;
                padding: 6px 8px;
            }

            .map-controls {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Control Center</div>
                <div class="sidebar-subtitle">Real-time Monitoring + Firebase</div>
            </div>
            
            <div class="sidebar-content">
                <!-- Firebase Status -->
                <div class="firebase-status" id="firebaseStatus">
                    Connecting to Firebase...
                </div>
                
                <!-- Debug Output -->
                <div class="debug-output" id="debugOutput">
                    <strong>Debug Information:</strong><br>
                    <div id="debugContent">Initializing...</div>
                </div>

                <!-- Control Panel -->
                <div class="control-panel">
                    <div class="control-title">Settings</div>
                    
                    <div class="control-toggle">
                        <div class="toggle-switch active" id="autoRefreshToggle" onclick="toggleAutoRefresh()">
                            <div class="toggle-slider"></div>
                        </div>
                        <div class="toggle-label">Auto Refresh (30s)</div>
                    </div>
                    
                    <div class="control-toggle">
                        <div class="toggle-switch" id="notificationsToggle" onclick="toggleNotifications()">
                            <div class="toggle-slider"></div>
                        </div>
                        <div class="toggle-label">Live Notifications</div>
                    </div>
                    
                    <div class="control-item">
                        <label>Data Source</label>
                        <select id="dataSourceFilter" onchange="updateDataSource()">
                            <option value="firebase">Firebase Database</option>
                            <option value="localStorage">Local Storage</option>
                            <option value="both">Both Sources</option>
                        </select>
                    </div>
                    
                    <div class="control-item">
                        <label>Date Filter</label>
                        <input type="date" id="monitoringDate">
                    </div>
                    
                    <div class="control-item">
                        <label>Refresh Interval</label>
                        <select id="refreshInterval" onchange="updateRefreshInterval()">
                            <option value="15000">15 seconds</option>
                            <option value="30000" selected>30 seconds</option>
                            <option value="60000">1 minute</option>
                            <option value="300000">5 minutes</option>
                        </select>
                    </div>

                    <div style="display: flex; gap: 4px; margin-top: 8px;">
                        <button class="map-btn map-btn-secondary" onclick="refreshFirebaseConnection()" style="flex: 1; font-size: 10px;">
                            Refresh Firebase
                        </button>
                        <button class="map-btn map-btn-secondary" onclick="toggleDebugOutput()" style="flex: 1; font-size: 10px;">
                            Debug
                        </button>
                    </div>
                </div>

                <!-- Active Salesman List -->
                <div class="salesman-list">
                    <div class="control-title">Active Salesman</div>
                    <div id="salesmanList">
                        <div class="salesman-item">
                            <div class="salesman-header">
                                <div class="salesman-name">Loading...</div>
                                <div class="salesman-status status-inactive">Loading</div>
                            </div>
                            <div class="salesman-details">Scanning for active salesman...</div>
                        </div>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="control-panel">
                    <div class="control-title">Live Stats</div>
                    <div class="stats-panel">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="totalOnline">-</div>
                                <div class="stat-label">Online</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="totalVisits">-</div>
                                <div class="stat-label">Visits</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="activeOutlets">-</div>
                                <div class="stat-label">Outlets</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="totalSoAmount">-</div>
                                <div class="stat-label">SO Amount</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="main-header">
                <div class="main-title">
                    Real-time Location Tracking + Firebase
                </div>
                <div class="live-indicator">
                    <div class="live-dot"></div>
                    <span>LIVE</span>
                </div>
            </div>
            
            <div class="map-container">
                <div id="realtimeMap"></div>
                
                <!-- Map Controls -->
                <div class="map-controls">
                    <div class="map-control-item">
                        <button class="map-btn map-btn-primary" onclick="refreshMapData()">
                            Refresh Now
                        </button>
                    </div>
                    <div class="map-control-item">
                        <button class="map-btn map-btn-secondary" onclick="centerMapView()">
                            Center View
                        </button>
                    </div>
                    <div class="map-control-item">
                        <button class="map-btn map-btn-secondary" onclick="toggleHeatmap()">
                            Heatmap
                        </button>
                    </div>
                    <div class="map-control-item">
                        <button class="map-btn map-btn-secondary" onclick="exportLiveData()">
                            Export Live
                        </button>
                    </div>
                </div>

                <!-- Notification Panel -->
                <div class="notification-panel" id="notificationPanel">
                    <div class="notification-header">
                        Live Alerts
                    </div>
                    <div id="notificationList">
                        <div class="notification-item">Monitoring system started</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

    <script>
        // ===== GLOBAL VARIABLES =====
        let realtimeMap = null;
        let mapMarkers = [];
        let salesmanMarkers = {};
        let autoRefreshInterval = null;
        let notificationsEnabled = false;
        let refreshIntervalMs = 30000;
        let activeSalesman = {};
        let heatmapEnabled = false;
        let firebaseDatabase = null;
        let isFirebaseConnected = false;
        let debugMessages = [];
        let currentDataSource = 'firebase';

        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyAoRV3qVAXQ14AEVA8Mo49HXfAyhMMm8Bs",
            authDomain: "salesman-route-tracker.firebaseapp.com",
            databaseURL: "https://salesman-route-tracker-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "salesman-route-tracker",
            storageBucket: "salesman-route-tracker.firebasestorage.app",
            messagingSenderId: "590789273516",
            appId: "1:590789273516:web:79abe0c7e4cbccfa44fc09",
            measurementId: "G-5RYSWKQ963"
        };

        // ===== DEBUG FUNCTIONS =====
        function addDebugMessage(message) {
            debugMessages.push(`[${new Date().toLocaleTimeString()}] ${message}`);
            if (debugMessages.length > 50) debugMessages.shift();
            updateDebugOutput();
        }

        function updateDebugOutput() {
            const debugContent = document.getElementById('debugContent');
            debugContent.innerHTML = debugMessages.slice(-20).join('<br>');
        }

        function toggleDebugOutput() {
            const debugOutput = document.getElementById('debugOutput');
            debugOutput.classList.toggle('show');
        }

        function updateFirebaseStatus(message, status) {
            const statusElement = document.getElementById('firebaseStatus');
            statusElement.textContent = message;
            statusElement.className = `firebase-status ${status}`;
            addDebugMessage('Firebase status: ' + message);
        }

        // ===== FIREBASE INITIALIZATION =====
        async function initializeFirebase() {
            try {
                addDebugMessage('Initializing Firebase...');
                updateFirebaseStatus('Initializing Firebase...', 'connecting');
                
                // Initialize Firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    addDebugMessage('Firebase app initialized');
                }
                
                firebaseDatabase = firebase.database();
                
                // Try Anonymous Authentication
                try {
                    addDebugMessage('Attempting authentication...');
                    await firebase.auth().signInAnonymously();
                    addDebugMessage('Authentication successful');
                    
                    // Test database access with actual paths
                    try {
                        addDebugMessage('Testing database access...');
                        
                        // Test daily_summary path
                        const summarySnapshot = await firebaseDatabase.ref('daily_summary').limitToFirst(1).once('value');
                        addDebugMessage('Successfully accessed daily_summary path');
                        
                        // Test visits path
                        const visitsSnapshot = await firebaseDatabase.ref('visits').limitToFirst(1).once('value');
                        addDebugMessage('Successfully accessed visits path');
                        
                        isFirebaseConnected = true;
                        updateFirebaseStatus('Firebase connected successfully', 'connected');
                        addDebugMessage('Firebase ready for real-time monitoring');
                        
                    } catch (dbError) {
                        isFirebaseConnected = false;
                        updateFirebaseStatus('Database access failed', 'error');
                        addDebugMessage('Database access test failed: ' + dbError.message);
                    }
                    
                } catch (authError) {
                    addDebugMessage('Authentication failed: ' + authError.message);
                    isFirebaseConnected = false;
                    updateFirebaseStatus('Authentication failed', 'error');
                }
                
            } catch (error) {
                addDebugMessage('Firebase initialization error: ' + error.message);
                isFirebaseConnected = false;
                updateFirebaseStatus('Firebase initialization failed', 'error');
            }
        }

        // ===== REAL-TIME MONITORING CLASS =====
        class RealtimeLocationMonitor {
            constructor() {
                this.salesmanData = {};
                this.lastUpdateTime = null;
                this.notifications = [];
                this.isInitialized = false;
                
                this.init();
            }
            
            async init() {
                if (this.isInitialized) return;
                addDebugMessage('Real-time Location Monitor initializing...');
                this.isInitialized = true;
                
                await initializeFirebase();
                this.initializeMap();
                this.startMonitoring();
            }
            
            initializeMap() {
                // Initialize map centered on Kalimantan (based on your GPS coordinates)
                realtimeMap = L.map('realtimeMap').setView([-2.2088, 115.4456], 10);
                
                // Add map tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 18
                }).addTo(realtimeMap);
                
                addDebugMessage('Real-time map initialized');
            }
            
            startMonitoring() {
                // Initial load
                this.refreshData();
                
                // Set up auto-refresh
                this.setupAutoRefresh();
                
                addDebugMessage('Real-time monitoring started');
            }
            
            setupAutoRefresh() {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                }
                
                autoRefreshInterval = setInterval(() => {
                    this.refreshData();
                }, refreshIntervalMs);
                
                addDebugMessage(`Auto-refresh set to ${refreshIntervalMs/1000} seconds`);
            }
            
            async refreshData() {
                const monitoringDate = document.getElementById('monitoringDate').value || 
                    new Date().toISOString().split('T')[0];
                
                addDebugMessage(`Refreshing data for ${monitoringDate} from ${currentDataSource}`);
                
                await this.loadSalesmanData(monitoringDate);
                this.updateSalesmanList();
                this.updateMapMarkers();
                this.updateStatistics();
                
                this.lastUpdateTime = new Date();
            }
            
            async loadSalesmanData(dateStr) {
                this.salesmanData = {};
                
                try {
                    if (currentDataSource === 'firebase' || currentDataSource === 'both') {
                        if (isFirebaseConnected) {
                            await this.loadFromFirebase(dateStr);
                        } else {
                            addDebugMessage('Firebase not connected, using localStorage fallback');
                        }
                    }
                    
                    if (currentDataSource === 'localStorage' || currentDataSource === 'both' || 
                        (currentDataSource === 'firebase' && Object.keys(this.salesmanData).length === 0)) {
                        this.loadFromLocalStorage(dateStr);
                    }
                    
                    addDebugMessage(`Loaded data for ${Object.keys(this.salesmanData).length} salesman`);
                    
                } catch (error) {
                    addDebugMessage('Error loading data: ' + error.message);
                    this.loadFromLocalStorage(dateStr);
                }
            }
            
            async loadFromFirebase(dateStr) {
                if (!isFirebaseConnected) return;
                
                addDebugMessage(`Loading Firebase data for ${dateStr}...`);
                
                try {
                    // Load daily summary data
                    const summarySnapshot = await firebaseDatabase.ref('daily_summary').once('value');
                    const summaryData = summarySnapshot.val();
                    
                    if (summaryData) {
                        Object.entries(summaryData).forEach(([salesmanId, salesmanSummary]) => {
                            if (salesmanSummary && salesmanSummary[dateStr]) {
                                const dailyData = salesmanSummary[dateStr];
                                this.processFirebaseSummary(salesmanId, dailyData);
                            }
                        });
                        addDebugMessage(`Processed ${Object.keys(summaryData).length} salesman summaries`);
                    }
                    
                    // Load visits data for location information
                    const visitsSnapshot = await firebaseDatabase.ref('visits').once('value');
                    const visitsData = visitsSnapshot.val();
                    
                    if (visitsData) {
                        Object.entries(visitsData).forEach(([salesmanId, salesmanVisits]) => {
                            if (salesmanVisits && typeof salesmanVisits === 'object') {
                                this.processFirebaseVisits(salesmanId, salesmanVisits, dateStr);
                            }
                        });
                        addDebugMessage(`Processed visits for ${Object.keys(visitsData).length} salesman`);
                    }
                    
                } catch (error) {
                    addDebugMessage('Firebase loading error: ' + error.message);
                }
            }
            
            processFirebaseSummary(salesmanId, dailyData) {
                if (!this.salesmanData[salesmanId]) {
                    this.salesmanData[salesmanId] = {
                        salesman_id: salesmanId,
                        salesman_name: dailyData.salesman_name || `Salesman ${salesmanId}`,
                        last_location: null,
                        last_update: null,
                        current_outlet: null,
                        status: 'inactive',
                        total_visits: 0,
                        visits_with_so: 0,
                        total_so_amount: 0,
                        total_duration: 0,
                        source: 'firebase'
                    };
                }
                
                const salesman = this.salesmanData[salesmanId];
                
                // Update summary statistics
                salesman.total_visits = dailyData.total_visits || 0;
                salesman.visits_with_so = dailyData.visits_with_so || 0;
                salesman.total_so_amount = dailyData.total_so_amount || 0;
                salesman.total_duration = dailyData.total_duration_seconds || 0;
                salesman.last_update = dailyData.last_updated ? new Date(dailyData.last_updated).toISOString() : null;
                
                // Determine status based on last update
                salesman.status = this.determineSalesmanStatus(salesman.last_update);
            }
            
            processFirebaseVisits(salesmanId, salesmanVisits, dateStr) {
                if (!this.salesmanData[salesmanId]) {
                    this.salesmanData[salesmanId] = {
                        salesman_id: salesmanId,
                        salesman_name: `Salesman ${salesmanId}`,
                        last_location: null,
                        last_update: null,
                        current_outlet: null,
                        status: 'inactive',
                        total_visits: 0,
                        visits_with_so: 0,
                        total_so_amount: 0,
                        total_duration: 0,
                        source: 'firebase'
                    };
                }
                
                const salesman = this.salesmanData[salesmanId];
                
                // Find visits for the specified date and get the most recent location
                let latestVisit = null;
                let todayVisits = [];
                
                Object.entries(salesmanVisits).forEach(([visitId, visitData]) => {
                    if (visitData && visitData.created_at) {
                        const visitDate = visitData.created_at.split('T')[0];
                        
                        if (visitDate === dateStr) {
                            todayVisits.push(visitData);
                            
                            // Check if this is the latest visit
                            if (!latestVisit || new Date(visitData.created_at) > new Date(latestVisit.created_at)) {
                                latestVisit = visitData;
                            }
                        }
                    }
                });
                
                // Update salesman with latest visit information
                if (latestVisit) {
                    salesman.salesman_name = latestVisit.salesman_name || salesman.salesman_name;
                    salesman.current_outlet = latestVisit.outlet_name || null;
                    salesman.last_update = latestVisit.end_time || latestVisit.created_at;
                    
                    // Use end_location if available, otherwise start_location
                    if (latestVisit.end_location) {
                        salesman.last_location = latestVisit.end_location;
                    } else if (latestVisit.start_location) {
                        salesman.last_location = latestVisit.start_location;
                    }
                    
                    salesman.status = this.determineSalesmanStatus(salesman.last_update);
                }
                
                // Update visit counts if not already set by summary
                if (salesman.total_visits === 0) {
                    salesman.total_visits = todayVisits.length;
                    salesman.visits_with_so = todayVisits.filter(v => v.order_status === 'ada_so').length;
                    salesman.total_so_amount = todayVisits.reduce((sum, v) => sum + (v.so_amount || 0), 0);
                    salesman.total_duration = todayVisits.reduce((sum, v) => sum + (v.duration_seconds || 0), 0);
                }
            }
            
            loadFromLocalStorage(dateStr) {
                addDebugMessage(`Loading localStorage data for ${dateStr}...`);
                
                const geoAnalyticsPattern = `visit_analytics_geo_${dateStr}_`;
                let localStorageCount = 0;
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    
                    if (key && key.startsWith(geoAnalyticsPattern)) {
                        const salesmanId = key.replace(geoAnalyticsPattern, '');
                        
                        try {
                            const analyticsData = JSON.parse(localStorage.getItem(key) || '[]');
                            const dailyKey = `visit_daily_geo_${dateStr}_${salesmanId}`;
                            const dailyData = JSON.parse(localStorage.getItem(dailyKey) || '{}');
                            
                            const latestLocationEvent = analyticsData
                                .filter(event => event.location)
                                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                            
                            const customerEvents = analyticsData
                                .filter(event => event.event_name === 'visit_customer_selected')
                                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                            
                            this.salesmanData[salesmanId] = {
                                salesman_id: salesmanId,
                                salesman_name: latestLocationEvent ? latestLocationEvent.salesman_name : `Salesman ${salesmanId}`,
                                last_location: latestLocationEvent ? latestLocationEvent.location : null,
                                last_update: latestLocationEvent ? latestLocationEvent.timestamp : null,
                                current_outlet: customerEvents.length > 0 ? customerEvents[0].event_data.customer_name : null,
                                status: this.determineSalesmanStatus(latestLocationEvent ? latestLocationEvent.timestamp : null),
                                total_visits: customerEvents.length,
                                visits_with_so: 0, // Can't determine from localStorage data
                                total_so_amount: 0,
                                total_duration: 0,
                                source: 'localStorage'
                            };
                            
                            localStorageCount++;
                            
                        } catch (error) {
                            addDebugMessage(`Error loading localStorage data for salesman ${salesmanId}: ${error.message}`);
                        }
                    }
                }
                
                addDebugMessage(`LocalStorage: found ${localStorageCount} records`);
            }
            
            determineSalesmanStatus(lastUpdateStr) {
                if (!lastUpdateStr) return 'inactive';
                
                const lastUpdate = new Date(lastUpdateStr);
                const now = new Date();
                const minutesAgo = (now - lastUpdate) / (1000 * 60);
                
                if (minutesAgo <= 5) return 'online';
                if (minutesAgo <= 30) return 'recent';
                return 'offline';
            }
            
            updateSalesmanList() {
                const salesmanList = document.getElementById('salesmanList');
                
                if (Object.keys(this.salesmanData).length === 0) {
                    salesmanList.innerHTML = `
                        <div class="salesman-item">
                            <div class="salesman-header">
                                <div class="salesman-name">No Active Data</div>
                                <div class="salesman-status status-inactive">Inactive</div>
                            </div>
                            <div class="salesman-details">No salesman activity detected</div>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                Object.values(this.salesmanData)
                    .sort((a, b) => {
                        const statusOrder = { online: 0, recent: 1, offline: 2, inactive: 3 };
                        return statusOrder[a.status] - statusOrder[b.status];
                    })
                    .forEach(salesman => {
                        const statusClass = `status-${salesman.status === 'recent' ? 'offline' : salesman.status}`;
                        const lastUpdate = salesman.last_update ? 
                            new Date(salesman.last_update).toLocaleTimeString() : 'Never';
                        
                        const locationText = salesman.last_location ? 
                            `${salesman.last_location.latitude.toFixed(4)}, ${salesman.last_location.longitude.toFixed(4)}` :
                            'No location data';
                        
                        const soAmountFormatted = salesman.total_so_amount ? 
                            new Intl.NumberFormat('id-ID').format(salesman.total_so_amount) : '0';
                        
                        html += `
                            <div class="salesman-item" onclick="focusOnSalesman('${salesman.salesman_id}')">
                                <div class="salesman-header">
                                    <div class="salesman-name">${salesman.salesman_name}</div>
                                    <div class="salesman-status ${statusClass}">${salesman.status}</div>
                                </div>
                                <div class="salesman-details">
                                    Current: ${salesman.current_outlet || 'No active outlet'}<br>
                                    Last: ${lastUpdate}<br>
                                    Visits: ${salesman.total_visits} | SO: ${salesman.visits_with_so}<br>
                                    Amount: Rp ${soAmountFormatted}<br>
                                    Source: ${salesman.source}
                                </div>
                                <div class="salesman-location">${locationText}</div>
                            </div>
                        `;
                    });
                
                salesmanList.innerHTML = html;
            }
            
            updateMapMarkers() {
                // Clear existing markers
                this.clearMapMarkers();
                
                Object.values(this.salesmanData).forEach(salesman => {
                    if (salesman.last_location) {
                        this.addSalesmanMarker(salesman);
                    }
                });
                
                addDebugMessage(`Updated ${Object.keys(salesmanMarkers).length} map markers`);
            }
            
            addSalesmanMarker(salesman) {
                const statusColors = {
                    online: '#10b981',    // Green
                    recent: '#f59e0b',    // Orange  
                    offline: '#ef4444',   // Red
                    inactive: '#64748b'   // Gray
                };
                
                const color = statusColors[salesman.status] || statusColors.inactive;
                
                const markerOptions = {
                    radius: salesman.status === 'online' ? 10 : 8,
                    fillColor: color,
                    color: 'white',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: salesman.status === 'online' ? 0.9 : 0.7
                };
                
                const marker = L.circleMarker([
                    salesman.last_location.latitude, 
                    salesman.last_location.longitude
                ], markerOptions);
                
                // Add pulsing animation for online salesman
                if (salesman.status === 'online') {
                    marker.on('add', function() {
                        const element = this._path;
                        if (element) {
                            element.style.animation = 'pulse 2s infinite';
                        }
                    });
                }
                
                const soAmountFormatted = salesman.total_so_amount ? 
                    new Intl.NumberFormat('id-ID').format(salesman.total_so_amount) : '0';
                
                const durationFormatted = salesman.total_duration ? 
                    Math.round(salesman.total_duration / 60) + ' min' : '0 min';
                
                const popupContent = `
                    <div style="font-family: 'Segoe UI', sans-serif; min-width: 200px;">
                        <h4 style="margin: 0 0 8px 0; color: #1e293b; font-size: 14px;">
                            ${salesman.salesman_name}
                        </h4>
                        <p style="margin: 0 0 4px 0; font-size: 12px;"><strong>Status:</strong> 
                            <span style="color: ${color}; font-weight: 600;">${salesman.status.toUpperCase()}</span>
                        </p>
                        <p style="margin: 0 0 4px 0; font-size: 12px;"><strong>Current Outlet:</strong> 
                            ${salesman.current_outlet || 'None'}
                        </p>
                        <p style="margin: 0 0 4px 0; font-size: 12px;"><strong>Location:</strong> 
                            ${salesman.last_location.latitude.toFixed(6)}, ${salesman.last_location.longitude.toFixed(6)}
                        </p>
                        <p style="margin: 0 0 4px 0; font-size: 12px;"><strong>Visits Today:</strong> 
                            ${salesman.total_visits} (${salesman.visits_with_so} with SO)
                        </p>
                        <p style="margin: 0 0 4px 0; font-size: 12px;"><strong>SO Amount:</strong> 
                            Rp ${soAmountFormatted}
                        </p>
                        <p style="margin: 0 0 4px 0; font-size: 12px;"><strong>Duration:</strong> 
                            ${durationFormatted}
                        </p>
                        <p style="margin: 0; font-size: 11px; color: #64748b;">
                            Last update: ${new Date(salesman.last_update).toLocaleString()}
                        </p>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                marker.addTo(realtimeMap);
                
                salesmanMarkers[salesman.salesman_id] = marker;
                mapMarkers.push(marker);
            }
            
            clearMapMarkers() {
                mapMarkers.forEach(marker => {
                    realtimeMap.removeLayer(marker);
                });
                mapMarkers = [];
                salesmanMarkers = {};
            }
            
            updateStatistics() {
                const stats = this.calculateStatistics();
                
                document.getElementById('totalOnline').textContent = stats.totalOnline;
                document.getElementById('totalVisits').textContent = stats.totalVisits;
                document.getElementById('activeOutlets').textContent = stats.activeOutlets;
                document.getElementById('totalSoAmount').textContent = stats.totalSoAmount;
            }
            
            calculateStatistics() {
                const salesmanList = Object.values(this.salesmanData);
                
                const totalSoAmount = salesmanList.reduce((sum, s) => sum + (s.total_so_amount || 0), 0);
                const soAmountFormatted = totalSoAmount > 1000000 ? 
                    (totalSoAmount / 1000000).toFixed(1) + 'M' : 
                    (totalSoAmount / 1000).toFixed(0) + 'K';
                
                return {
                    totalOnline: salesmanList.filter(s => s.status === 'online').length,
                    totalVisits: salesmanList.reduce((sum, s) => sum + (s.total_visits || 0), 0),
                    activeOutlets: salesmanList.filter(s => s.current_outlet).length,
                    totalSoAmount: 'Rp ' + soAmountFormatted
                };
            }
            
            focusOnSalesman(salesmanId) {
                const salesman = this.salesmanData[salesmanId];
                if (salesman && salesman.last_location) {
                    realtimeMap.setView([
                        salesman.last_location.latitude,
                        salesman.last_location.longitude
                    ], 15);
                    
                    // Open popup
                    if (salesmanMarkers[salesmanId]) {
                        salesmanMarkers[salesmanId].openPopup();
                    }
                    
                    addDebugMessage(`Focused on ${salesman.salesman_name}`);
                }
            }
            
            addNotification(message, type = 'info') {
                const notification = {
                    id: Date.now(),
                    message: message,
                    type: type,
                    timestamp: new Date()
                };
                
                this.notifications.unshift(notification);
                if (this.notifications.length > 10) {
                    this.notifications = this.notifications.slice(0, 10);
                }
                
                this.updateNotificationPanel();
                
                if (notificationsEnabled) {
                    this.showNotificationPanel();
                }
                
                addDebugMessage(`Notification: ${message}`);
            }
            
            updateNotificationPanel() {
                const notificationList = document.getElementById('notificationList');
                
                if (this.notifications.length === 0) {
                    notificationList.innerHTML = '<div class="notification-item">No notifications</div>';
                    return;
                }
                
                const html = this.notifications.map(notification => `
                    <div class="notification-item">
                        ${notification.message}
                        <br><small>${notification.timestamp.toLocaleTimeString()}</small>
                    </div>
                `).join('');
                
                notificationList.innerHTML = html;
            }
            
            showNotificationPanel() {
                const panel = document.getElementById('notificationPanel');
                panel.style.display = 'block';
                
                setTimeout(() => {
                    panel.style.display = 'none';
                }, 5000);
            }
            
            exportLiveData() {
                const data = Object.values(this.salesmanData).map(salesman => ({
                    salesman_id: salesman.salesman_id,
                    salesman_name: salesman.salesman_name,
                    status: salesman.status,
                    current_outlet: salesman.current_outlet,
                    last_location: salesman.last_location,
                    last_update: salesman.last_update,
                    total_visits: salesman.total_visits,
                    visits_with_so: salesman.visits_with_so,
                    total_so_amount: salesman.total_so_amount,
                    source: salesman.source
                }));
                
                const csvContent = this.convertToCSV(data);
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `realtime_tracking_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                this.addNotification('Live data exported successfully', 'success');
            }
            
            convertToCSV(data) {
                const headers = [
                    'Salesman_ID', 'Salesman_Name', 'Status', 'Current_Outlet',
                    'Latitude', 'Longitude', 'Location_Accuracy', 'Last_Update',
                    'Total_Visits', 'Visits_With_SO', 'Total_SO_Amount', 'Data_Source'
                ];
                
                const rows = data.map(item => [
                    item.salesman_id,
                    item.salesman_name,
                    item.status,
                    item.current_outlet || '',
                    item.last_location ? item.last_location.latitude : '',
                    item.last_location ? item.last_location.longitude : '',
                    item.last_location ? item.last_location.accuracy : '',
                    item.last_update || '',
                    item.total_visits,
                    item.visits_with_so,
                    item.total_so_amount,
                    item.source
                ]);
                
                return [headers, ...rows]
                    .map(row => row.map(cell => `"${cell}"`).join(','))
                    .join('\n');
            }
        }

        // ===== GLOBAL MONITOR INSTANCE =====
        let locationMonitor = null;

        // ===== UI CONTROL FUNCTIONS =====
        function toggleAutoRefresh() {
            const toggle = document.getElementById('autoRefreshToggle');
            toggle.classList.toggle('active');
            
            if (toggle.classList.contains('active')) {
                if (locationMonitor) {
                    locationMonitor.setupAutoRefresh();
                }
                addDebugMessage('Auto-refresh enabled');
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                addDebugMessage('Auto-refresh disabled');
            }
        }

        function toggleNotifications() {
            const toggle = document.getElementById('notificationsToggle');
            toggle.classList.toggle('active');
            notificationsEnabled = toggle.classList.contains('active');
            
            if (notificationsEnabled) {
                if (locationMonitor) {
                    locationMonitor.addNotification('Live notifications enabled', 'info');
                }
                addDebugMessage('Notifications enabled');
            } else {
                document.getElementById('notificationPanel').style.display = 'none';
                addDebugMessage('Notifications disabled');
            }
        }

        function updateDataSource() {
            const select = document.getElementById('dataSourceFilter');
            currentDataSource = select.value;
            addDebugMessage(`Data source changed to: ${currentDataSource}`);
            
            if (locationMonitor) {
                locationMonitor.addNotification(`Data source: ${currentDataSource}`, 'info');
            }
        }

        function updateRefreshInterval() {
            const select = document.getElementById('refreshInterval');
            refreshIntervalMs = parseInt(select.value);
            
            if (locationMonitor && autoRefreshInterval) {
                locationMonitor.setupAutoRefresh();
            }
            
            addDebugMessage(`Refresh interval updated to ${refreshIntervalMs/1000} seconds`);
        }

        function refreshMapData() {
            if (locationMonitor) {
                locationMonitor.refreshData();
                locationMonitor.addNotification('Data refreshed manually', 'info');
            }
        }

        function centerMapView() {
            if (realtimeMap && Object.keys(salesmanMarkers).length > 0) {
                const group = new L.featureGroup(Object.values(salesmanMarkers));
                realtimeMap.fitBounds(group.getBounds().pad(0.1));
                
                if (locationMonitor) {
                    locationMonitor.addNotification('Map view centered', 'info');
                }
            }
        }

        function toggleHeatmap() {
            heatmapEnabled = !heatmapEnabled;
            
            if (locationMonitor) {
                locationMonitor.addNotification(
                    `Heatmap ${heatmapEnabled ? 'enabled' : 'disabled'}`, 
                    'info'
                );
            }
            
            addDebugMessage(`Heatmap ${heatmapEnabled ? 'enabled' : 'disabled'}`);
        }

        function exportLiveData() {
            if (locationMonitor) {
                locationMonitor.exportLiveData();
            }
        }

        function focusOnSalesman(salesmanId) {
            if (locationMonitor) {
                locationMonitor.focusOnSalesman(salesmanId);
            }
        }

        async function refreshFirebaseConnection() {
            addDebugMessage('Refreshing Firebase connection...');
            
            try {
                if (firebase.auth().currentUser) {
                    addDebugMessage('Signing out current user...');
                    await firebase.auth().signOut();
                }
                
                await initializeFirebase();
                
                if (isFirebaseConnected) {
                    alert('Firebase connection successful!\n\nAuthentication: OK\nDatabase access: Confirmed\nYou can now use Firebase data source');
                } else {
                    alert('Firebase connection partial!\n\nAuthentication may have limitations\nlocalStorage remains available\nRecommend using localStorage data source');
                }
                
                if (locationMonitor) {
                    locationMonitor.addNotification('Firebase connection refreshed', 'info');
                }
                
            } catch (error) {
                addDebugMessage('Firebase refresh error: ' + error.message);
                alert('Firebase refresh failed!\n\n' + error.message + '\n\nContinue using localStorage data source');
            }
        }

        // ===== INITIALIZATION =====
        async function initializeRealtimeMonitoring() {
            addDebugMessage('Initializing Real-time Location Monitoring...');
            
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('monitoringDate').value = today;
            
            // Initialize monitor
            locationMonitor = new RealtimeLocationMonitor();
            
            // Setup date change listener
            document.getElementById('monitoringDate').addEventListener('change', () => {
                if (locationMonitor) {
                    locationMonitor.refreshData();
                }
            });
            
            addDebugMessage('Real-time monitoring system ready');
        }

        // ===== PAGE LOAD =====
        window.onload = function() {
            addDebugMessage('Starting Real-time Location Monitoring Dashboard...');
            initializeRealtimeMonitoring();
        };

        // Add CSS animation for pulsing markers
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0% {
                    transform: scale(1);
                    opacity: 1;
                }
                50% {
                    transform: scale(1.2);
                    opacity: 0.7;
                }
                100% {
                    transform: scale(1);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>