<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visit Outlet - Enhanced with Pause/Resume & Location Tracking</title>
	
	<script src="html2canvas.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(180deg, #f8f9ff 0%, #e8ecff 100%);
            min-height: 100vh;
            color: #2c3e50;
            padding-bottom: 100px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 0 0 30px 30px;
            color: white;
            margin-bottom: 20px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 10px;
            border-radius: 12px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(-2px);
        }

        .detail-title-container {
            text-align: center;
            flex: 1;
        }

        .detail-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .salesman-name {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 400;
        }

        .user-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 10px;
            border-radius: 12px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .user-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* ===== ENHANCED VISIT MODALS ===== */
        .visit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .visit-modal.show {
            display: flex;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .visit-modal-content {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 350px;
            width: 90%;
            text-align: center;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .visit-modal-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .visit-modal-subtitle {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 16px;
        }

        .visit-modal-customer {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
            border: 1px solid #cbd5e1;
        }

        .visit-modal-customer-name {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .visit-modal-customer-details {
            font-size: 12px;
            color: #64748b;
        }

        /* ===== PAUSE/RESUME SPECIFIC STYLES ===== */
        .visit-modal-pause {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 1px solid #f59e0b;
        }

        .visit-modal-resume {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            border: 1px solid #10b981;
        }

        .pause-info {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
            text-align: left;
        }

        .pause-info-item {
            font-size: 12px;
            color: #92400e;
            margin: 4px 0;
        }

        .pause-info-item strong {
            color: #78350f;
        }

        .resume-info {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
            text-align: left;
        }

        .resume-info-item {
            font-size: 12px;
            color: #065f46;
            margin: 4px 0;
        }

        .resume-info-item strong {
            color: #047857;
        }

        /* ===== ORDER STATUS SELECTION ===== */
        .order-status-section {
            margin: 16px 0;
            text-align: left;
        }

        .order-status-label {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
            display: block;
        }

        .order-status-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            color: #2d3748;
            margin-bottom: 12px;
        }

        .order-status-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .so-amount-section {
            display: none;
            margin-top: 12px;
        }

        .so-amount-section.show {
            display: block;
            animation: fadeInDown 0.3s ease;
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .so-amount-label {
            font-size: 13px;
            font-weight: 600;
            color: #059669;
            margin-bottom: 6px;
            display: block;
        }

        .so-amount-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #10b981;
            border-radius: 8px;
            font-size: 14px;
            background: #f0fdf4;
            color: #065f46;
            font-weight: 600;
        }

        .so-amount-input:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .visit-modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .visit-modal-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .visit-modal-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .visit-modal-btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .visit-modal-btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .visit-modal-btn-secondary {
            background: #f1f5f9;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }

        .visit-modal-btn-secondary:hover {
            background: #e2e8f0;
        }

        .visit-modal-btn-pause {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .visit-modal-btn-pause:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }

        .visit-modal-btn-resume {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .visit-modal-btn-resume:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        /* ===== FIREBASE SYNC STATUS ===== */
        .firebase-status {
            position: fixed;
            top: 80px;
            right: 10px;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            z-index: 1001;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            display: none;
        }

        .firebase-status.syncing {
            background: rgba(245, 158, 11, 0.9);
            display: block;
        }

        .firebase-status.success {
            background: rgba(16, 185, 129, 0.9);
            display: block;
        }

        .firebase-status.error {
            background: rgba(239, 68, 68, 0.9);
            display: block;
        }

        /* ===== ENHANCED VISIT SESSION STATUS ===== */
        .visit-session-status {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(16, 185, 129, 0.95);
            color: white;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            min-width: 140px;
        }

        .visit-session-status.active {
            display: block;
            animation: pulse 2s infinite;
        }

        .visit-session-status.paused {
            background: rgba(245, 158, 11, 0.95);
            display: block;
            animation: pausePulse 3s infinite;
        }

        .visit-session-customer {
            font-size: 10px;
            opacity: 0.9;
            margin-bottom: 2px;
        }

        .visit-session-timer {
            font-size: 12px;
            font-weight: 700;
        }

        .visit-session-status-text {
            font-size: 9px;
            opacity: 0.8;
            margin-top: 2px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.95; }
            50% { opacity: 1; }
        }

        @keyframes pausePulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        /* ===== ENHANCED LOCATION STATUS ===== */
        .location-status-enhanced {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(245, 158, 11, 0.95);
            color: white;
            padding: 8px 12px;
            border-radius: 16px;
            font-size: 10px;
            font-weight: 600;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.2);
            min-width: 100px;
        }

        .location-status-enhanced.success {
            background: rgba(16, 185, 129, 0.95);
        }

        .location-status-enhanced.error {
            background: rgba(239, 68, 68, 0.95);
        }

        .location-accuracy {
            font-size: 8px;
            opacity: 0.8;
        }

        .location-last-sync {
            font-size: 8px;
            opacity: 0.9;
            margin-top: 2px;
        }

        /* ===== LOCATION TRACKING STATUS ===== */
        .location-tracking-status {
            position: fixed;
            top: 110px;
            right: 10px;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 9px;
            font-weight: 600;
            z-index: 1001;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            min-width: 120px;
            text-align: center;
        }

        .location-tracking-status.active {
            background: rgba(16, 185, 129, 0.9);
            animation: trackingPulse 3s infinite;
        }

        .location-tracking-status.syncing {
            background: rgba(245, 158, 11, 0.9);
        }

        .location-tracking-status.success {
            background: rgba(16, 185, 129, 0.9);
        }

        .location-tracking-status.error {
            background: rgba(239, 68, 68, 0.9);
        }

        .location-tracking-status.stopped {
            background: rgba(107, 114, 128, 0.9);
        }

        @keyframes trackingPulse {
            0%, 100% { opacity: 0.9; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.02); }
        }

        /* ===== DAY INDICATOR ===== */
        .day-indicator {
            position: fixed;
            top: 50px;
            right: 10px;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            z-index: 1001;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        /* Admin position monitoring button */
        .admin-location-btn {
            position: fixed;
            bottom: 120px;
            left: 15px;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 998;
        }

        .admin-location-btn:hover {
            background: rgba(59, 130, 246, 1);
            transform: translateY(-1px);
        }

        .admin-location-btn.show {
            display: block;
        }

        /* Continue with rest of existing styles... */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            flex-direction: column;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
            color: #e74c3c;
            padding: 16px;
            border-radius: 12px;
            margin: 20px;
            text-align: center;
        }

        .content-section {
            padding: 0 16px;
            margin-bottom: 20px;
        }

        .frames-container {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .frame {
            flex: 1;
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .frame-title {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 12px;
            text-align: center;
        }

        .filter-item {
            position: relative;
            margin-bottom: 12px;
        }

        .filter-item:last-child {
            margin-bottom: 0;
        }

        .filter-item select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 12px;
            background: white;
            color: #2d3748;
            appearance: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-item select:disabled {
            background: #f7fafc;
            color: #a0aec0;
            cursor: not-allowed;
            border-color: #e2e8f0;
        }

        .filter-item select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .summary-item {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px;
            text-align: center;
        }

        .summary-label {
            font-size: 10px;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-value {
            font-size: 14px;
            font-weight: 700;
            color: #1e293b;
        }

        .summary-value.positive {
            color: #10b981;
        }

        .summary-value.negative {
            color: #ef4444;
        }

        .summary-value.neutral {
            color: #64748b;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 400px;
            background: white;
            border-top: 1px solid #f1f2f6;
            padding: 15px 0;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #bdc3c7;
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 8px 6px;
            border-radius: 12px;
            min-width: 50px;
        }

        .nav-item.active {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .nav-item:hover {
            color: #667eea;
            transform: translateY(-2px);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 4px;
            font-size: 12px;
        }

        .nav-icon.home { background: #3b82f6; color: white; }
        .nav-icon.visit { background: #ef4444; color: white; }
        .nav-icon.incentive { background: #f59e0b; color: white; }
        .nav-icon.profile { background: #10b981; color: white; }

        .nav-label {
            font-size: 10px;
            font-weight: 500;
        }

        /* Customer Info Display */
        .customer-info {
            margin-top: 8px;
            padding: 6px 8px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            display: none;
        }

        .customer-info-label {
            font-size: 10px;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .customer-info-value {
            font-size: 11px;
            color: #1e293b;
            font-weight: 600;
        }

        .customer-info-row {
            margin-bottom: 4px;
        }

        .customer-info-row:last-child {
            margin-bottom: 0;
        }

        .sku-zero-list {
            font-size: 10px;
            color: #ef4444;
            font-weight: 500;
            background: #fef2f2;
            padding: 2px 4px;
            border-radius: 4px;
            border: 1px solid #fecaca;
        }
        
        /* ===== TAB SYSTEM ===== */
        .tab-navigation {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            padding: 0 16px;
        }

        .tab-button {
            flex: 1;
            padding: 12px 16px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative; /* ‚úÖ DITAMBAHKAN! */
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .tab-button:hover:not(.active) {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

        /* ===== BADGE COUNTER FOR TAB ===== */
        .tab-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 12px;
            min-width: 20px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(245, 158, 11, 0.4);
            animation: badgePulse 2s ease-in-out infinite;
        }

        .tab-button.active .tab-badge {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
        }

        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* ===== GAP MSS BADGE ON LEFT ===== */
        .gap-badge-left {
            position: absolute;
            top: -8px;
            left: -8px;
            background: #ffffff;                /* ‚Üê Background putih */
            border: 1px solid #ff9800;          /* ‚Üê Border orange */
            font-size: 12px;                    /* ‚Üê SAMA dengan .tab-badge */
            font-weight: 700;                   /* ‚Üê SAMA dengan .tab-badge */
            padding: 4px 8px;                   /* ‚Üê SAMA dengan .tab-badge */
            border-radius: 12px;                /* ‚Üê SAMA dengan .tab-badge */
            min-width: 24px;                    /* ‚Üê SAMA dengan .tab-badge */
            text-align: center;   
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            animation: badgePulse 2s ease-in-out infinite;
            z-index: 100;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .gap-badge-left.negative {
            color: #dc2626;                     /* ‚Üê TEXT MERAH untuk < 0 */
        }

        .gap-badge-left.positive {
            color: #059669;                     /* ‚Üê TEXT HIJAU untuk >= 0 */
        }

        .gap-mss-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            color: white;
            margin-bottom: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .gap-mss-badge.negative {
            background: linear-gradient(135deg, #ef4444, #dc2626); /* üî¥ MERAH */
        }

        .gap-mss-badge.positive {
            background: linear-gradient(135deg, #10b981, #059669); /* üü¢ HIJAU */
        }

        .tab-content-panel {
            display: none;
        }

        .tab-content-panel.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ===== SKU MSS GRID ===== */
        .mss-container {
            padding: 16px;
        }

        .mss-team-section {
            margin-bottom: 16px;
        }

        .mss-team-section:last-child {
            margin-bottom: 0;
        }

        .mss-team-header {
            display: inline-block;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .mss-sku-list {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: 700;
            color: #dc2626;
            line-height: 1.8;
            word-wrap: break-word;
        }

        .mss-empty {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .mss-grid {
            display: none; /* Hide old grid style */
        }

        @media (max-width: 400px) {
            .mss-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        /* ===== FLOATING ACTION BUTTONS ===== */
        .floating-actions {
            position: fixed;
            bottom: 90px;
            right: 15px;
            z-index: 999;
            display: none;
            flex-direction: column;
            gap: 10px;
        }

        .floating-actions.show {
            display: flex;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .floating-btn {
            border: none;
            padding: 12px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .floating-btn:hover {
            transform: translateY(-1px);
        }

        .btn-pause-visit {
            background: #f59e0b;
            color: white;
        }

        .btn-pause-visit:hover {
            background: #d97706;
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4);
        }

        .btn-end-visit {
            background: #ef4444;
            color: white;
        }

        .btn-end-visit:hover {
            background: #dc2626;
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }

        .btn-manual-sync {
            background: #3b82f6;
            color: white;
        }

        .btn-manual-sync:hover {
            background: #2563eb;
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }

        /* Pause indicator for customer list */
        .customer-paused {
            color: #f59e0b !important;
            background: #fef3c7 !important;
            font-style: italic;
        }

        /* Table styles - keeping existing styles */
        .table-section {
            padding: 0 16px;
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 16px;
        }

        .table-wrapper {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .table-container {
            overflow-x: auto;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            position: relative;
            max-height: calc(100vh - 500px);
            width: 100%;
            scroll-behavior: smooth;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            table-layout: auto;
        }

        #dataTable {
            min-width: auto;
        }

        #dataTable th {
            background: #6b7280;
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            position: sticky;
            top: 0;
            z-index: 50;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .sortable-header {
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            position: relative;
        }

        .sortable-header:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
            transform: translateY(-1px);
        }

        #dataTable td {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
            font-size: 11px;
        }

        .positive {
            color: #10b981;
            font-weight: 600;
        }

        .negative {
            color: #ef4444;
            font-weight: 600;
        }

        .neutral {
            color: #64748b;
        }

        .sku-code {
            font-family: 'Courier New', monospace;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }
        
        /* ===== SKU MSS STATUS STYLING ===== */
        .sku-mss-inactive {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #78350f;
            border: 1px solid #f59e0b;
            padding: 3px 6px;
            border-radius: 6px;
            font-weight: 700;
        }

        .sku-mss-active {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            color: #065f46;
            border: 1px solid #10b981;
            padding: 3px 6px;
            border-radius: 6px;
            font-weight: 700;
        }

        /* ===== PROMO TAG STYLING ===== */
        .promo-tag {
            font-weight: 600;
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 4px;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .promo-biscuit, .promo-bisc { 
            background: linear-gradient(135deg, #dc2626, #ef4444);
        }
        .promo-snack, .promo-snackfood { 
            background: linear-gradient(135deg, #7c3aed, #8b5cf6);
        }
        .promo-bev { 
            background: linear-gradient(135deg, #059669, #10b981);
        }
        .promo-others, .promo-sf, .promo-gen, .promo-go { 
            background: linear-gradient(135deg, #0369a1, #0284c7);
        }
        .promo-gbs { 
            background: linear-gradient(135deg, #7c2d12, #ea580c);
        }
        .promo-solmed { 
            background: linear-gradient(135deg, #d97706, #f59e0b);
        }
        .promo-rans, .promo-gbev, .promo-mbr { 
            background: linear-gradient(135deg, #23A0AD, #CBE030);
        }

        /* ===== GAP BADGE STYLING ===== */
        .gap-badge {
            padding: 2px 4px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .gap-positive {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .gap-negative {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .gap-neutral {
            background: linear-gradient(135deg, #64748b, #475569);
        }

        /* ===== TABLE ROW STYLING ===== */
        .summary-row {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-top: 2px solid #667eea;
        }

        .summary-row td {
            font-weight: 700;
            color: #1e293b;
            padding: 12px 6px;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        }

        tr:hover {
            background-color: #f8fafc;
        }

        .metric-value {
            font-weight: 600;
            font-size: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Project Cards Styling */
        .project-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 8px;
        }

        .project-card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 8px;
            text-align: center;
        }

        .project-label {
            font-size: 9px;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .project-value {
            font-size: 11px;
            font-weight: 700;
            color: #1e293b;
        }

        .project-value.positive {
            color: #10b981;
        }

        .project-value.negative {
            color: #ef4444;
        }

        .project-value.neutral {
            color: #64748b;
        }

        .project-header {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
            padding: 6px 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(14, 165, 233, 0.3);
        }

        .project-group {
            margin-bottom: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px;
            background: #fafbfc;
        }

        .project-section {
            margin-top: 16px;
            padding: 0;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .project-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            cursor: pointer;
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            transition: all 0.2s ease;
            border-radius: 12px 12px 0 0;
        }

        .project-section-header:hover {
            background: linear-gradient(135deg, #0284c7, #0369a1);
            transform: translateY(-1px);
        }

        .project-section-header:active {
            transform: translateY(0);
        }

        .project-section-title {
            font-size: 14px;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }

        .project-toggle-icon {
            font-size: 14px;
            font-weight: bold;
            color: white;
            transition: transform 0.3s ease;
            user-select: none;
        }

        .project-toggle-icon.collapsed {
            transform: rotate(-90deg);
        }

        .project-content-collapsible {
            padding: 0 12px 12px 12px;
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .project-content-collapsible.collapsed {
            max-height: 0;
            padding: 0 12px;
        }

        .achievement-badge {
            padding: 1px 4px;
            border-radius: 4px;
            font-size: 8px;
            font-weight: 600;
        }

        .ach-high {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }

        .ach-medium {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }

        .ach-low {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }

        .status-badge {
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-lanjut {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
            border: 1px solid #10b981;
        }

        .status-gugur {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border: 1px solid #ef4444;
        }

        .status-unknown {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
            border: 1px solid #f59e0b;
        }


        /* ===== SKU POM HORIZONTAL FRAME ===== */
        .sku-pom-frame {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .sku-pom-frame-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .sku-pom-frame-title {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sku-pom-frame-count {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }
        .sku-pom-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .sku-pom-chip:hover {
            background: #fef3c7;
            border-color: #f59e0b;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(245,158,11,0.2);
        }
        .sku-pom-chip.checked {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border-color: #10b981;
        }
        .sku-pom-chip-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #10b981;
            margin: 0;
        }
        .sku-pom-chip-code {
            font-family: 'Courier New', monospace;
            font-weight: 700;
            color: #78350f;
            font-size: 13px;
        }
        .sku-pom-chip.checked .sku-pom-chip-code {
            color: #065f46;
        }
            font-size: 12px;
            color: #64748b;
            font-weight: 500;
            margin-left: auto;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            white-space: nowrap;
        }

        /* HASIL VISIT - SIMPLE */
        .hasil-value { font-size: 13px; font-weight: 600; color: #1e293b; }

        /* HASIL VISIT - MOBILE OPTIMIZED */
        .hasil-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.75);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .hasil-modal.show { 
            display: flex !important;
        }
        .hasil-box {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 420px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            animation: popupIn 0.3s ease-out;
            position: relative;
        }
        
        @keyframes popupIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .hasil-header {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 20px;
            border-radius: 16px 16px 0 0;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .hasil-title { 
            font-size: 18px; 
            font-weight: 700;
            margin-bottom: 4px;
        }
        .hasil-date { 
            font-size: 12px; 
            opacity: 0.95;
        }
        .hasil-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.25);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .hasil-close:hover,
        .hasil-close:active {
            background: rgba(255,255,255,0.35);
            transform: scale(1.1);
        }
        .hasil-body { 
            padding: 20px;
        }
        .hasil-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .hasil-item:last-of-type {
            border-bottom: none;
        }
        .hasil-label { 
            font-size: 13px; 
            color: #64748b;
            font-weight: 500;
        }
        .hasil-value { 
            font-size: 14px; 
            font-weight: 700; 
            color: #1e293b;
        }
        .hasil-big {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            padding: 16px;
            border-radius: 12px;
            margin: 16px 0;
            text-align: center;
            border: 2px solid #3b82f6;
        }
        .hasil-big-label { 
            font-size: 12px; 
            color: #1e40af;
            font-weight: 600;
            margin-bottom: 6px;
        }
        .hasil-big-value { 
            font-size: 24px; 
            font-weight: 800; 
            color: #1e3a8a;
        }
        .hasil-share {
            width: 100%;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            transition: all 0.2s;
        }
        .hasil-share:active {
            transform: scale(0.97);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
        }
        
        .hasil-share:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .hasil-copy-text {
            width: 100%;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            transition: all 0.2s;
        }
        .hasil-copy-text:active {
            transform: scale(0.97);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }
        .hasil-copy-text:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        /* Mobile optimizations */
        @media (max-width: 480px) {
            .hasil-modal {
                padding: 12px;
            }
            .hasil-box {
                max-width: 100%;
                max-height: 90vh;
            }
            .hasil-header {
                padding: 16px;
            }
            .hasil-body {
                padding: 16px;
            }
            .hasil-title {
                font-size: 16px;
            }
            .hasil-big-value {
                font-size: 20px;
            }
        }
        .hasil-big {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            text-align: center;
            border: 1px solid #3b82f6;
        }
        .hasil-big-label { font-size: 11px; color: #1e40af; }
        .hasil-big-value { font-size: 20px; font-weight: 800; color: #1e3a8a; margin-top: 4px; }
        .hasil-share {
            width: 100%;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
        }

        /* SKU POM Breakdown */
        .hasil-section-divider {
            height: 1px;
            background: linear-gradient(to right, transparent, #e5e7eb, transparent);
            margin: 20px 0;
        }
        .hasil-section-header {
            font-size: 14px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sku-breakdown-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .sku-breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border-radius: 8px;
            border: 1px solid #86efac;
        }
        .sku-breakdown-code {
            font-size: 13px;
            font-weight: 700;
            color: #166534;
            font-family: 'Courier New', monospace;
        }
        .sku-breakdown-count {
            font-size: 14px;
            font-weight: 700;
            color: #15803d;
            background: white;
            padding: 4px 10px;
            border-radius: 6px;
        }
        .sku-breakdown-empty {
            text-align: center;
            padding: 20px;
            color: #94a3b8;
            font-size: 13px;
            font-style: italic;
        }

        /* Hasil Visit Text View - Full Screen */
        .hasil-text-view {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f8fafc;
            z-index: 10000;
            flex-direction: column;
        }
        .hasil-text-view.active {
            display: flex;
        }
        
        .hasil-text-header {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .hasil-text-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }
        .hasil-text-close:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .hasil-text-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
        }
        
        .hasil-text-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .report-preview {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 24px;
            font-family: 'Courier New', Consolas, monospace;
            font-size: 13px;
            line-height: 1.8;
            color: #1e293b;
            white-space: pre-wrap;
            word-wrap: break-word;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin: 0 auto;
            max-width: 800px;
        }
        
        .hasil-text-actions {
            background: white;
            padding: 16px 20px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 12px;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
        }
        
        .action-btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .copy-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .copy-btn:active {
            transform: scale(0.98);
        }
        
        .whatsapp-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        .whatsapp-btn:active {
            transform: scale(0.98);
        }
        
        @media (max-width: 600px) {
            .hasil-text-actions {
                flex-direction: column;
            }
            .report-preview {
                padding: 16px;
                font-size: 12px;
            }
        }

        /* ===== PLAN DAP POPUP ===== */
        .plan-dap-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }

        .plan-dap-overlay.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .plan-dap-modal {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 420px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            animation: slideUp 0.3s ease;
            overflow: hidden;
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .plan-dap-header {
            background: linear-gradient(135deg, #10b981, #059669);
            padding: 24px;
            text-align: center;
            color: white;
        }

        .plan-dap-header h3 {
            font-size: 20px;
            font-weight: 700;
            margin: 0 0 6px 0;
        }

        .plan-dap-subtitle {
            font-size: 13px;
            opacity: 0.9;
            margin: 0;
        }

        .plan-dap-body {
            padding: 24px;
        }

        .plan-dap-body .input-group {
            margin-bottom: 16px;
        }

        .plan-dap-body label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #334155;
            margin-bottom: 8px;
        }

        .plan-dap-body input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.2s;
            font-weight: 600;
        }

        .plan-dap-body input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
        }

        .plan-dap-note {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 2px solid #fbbf24;
            padding: 14px;
            border-radius: 10px;
            font-size: 13px;
            color: #92400e;
            line-height: 1.6;
        }

        .plan-dap-note strong {
            display: block;
            margin-bottom: 4px;
            color: #78350f;
        }

        .plan-dap-footer {
            padding: 20px 24px;
            border-top: 2px solid #f1f5f9;
            background: #f8fafc;
        }

        .btn-submit-plan {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-submit-plan:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-submit-plan:active {
            transform: translateY(0);
        }

        /* ===== PELANGGAN TIDAK AKTIF STYLES ===== */
        .customer-inactive-option {
            color: #dc2626 !important;
            background-color: #fee2e2 !important;
            font-weight: 600 !important;
        }

        #pelanggan option.customer-inactive-option {
            color: #dc2626 !important;
            background-color: #fee2e2 !important;
        }
		
		/* Style WAJIB untuk Report/Preview Laporan agar mudah dikonversi ke gambar */
        #reportPreview {
            white-space: pre-wrap; /* Penting untuk menjaga format baris/spasi */
            font-family: 'Courier New', Consolas, monospace; /* Font monospasi membuat alignment lurus */
            font-size: 13px;
            padding: 15px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            margin-top: 10px;
            border-radius: 8px;
            text-align: left;
            overflow-x: auto;
            /* Pastikan kontainer ini visible saat Anda klik tombol endVisitSession */
        }
        
        /* Style untuk tombol-tombol Anda */
        .action-btn {
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            flex: 1;
            margin: 0 5px;
        }

        .whatsapp-image-btn {
            background-color: #25d366;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Enhanced Location Status -->
        <div class="location-status-enhanced" id="locationStatusEnhanced">
            <div class="location-main">üìç Getting location...</div>
            <div class="location-accuracy" id="locationAccuracy">Accuracy: --</div>
            <div class="location-last-sync" id="locationLastSync">Last sync: --</div>
        </div>

        <!-- Day Indicator -->
        <div class="day-indicator" id="dayIndicator">
            üìÖ Loading...
        </div>

        <!-- Firebase Sync Status -->
        <div class="firebase-status" id="firebaseStatus">
            üîÑ Syncing...
        </div>

        <!-- Location Tracking Status -->
        <div class="location-tracking-status" id="locationTrackingStatus">
            üìç Initializing tracking...
        </div>

        <!-- Enhanced Visit Session Status -->
        <div class="visit-session-status" id="visitSessionStatus">
            <div class="visit-session-customer" id="sessionCustomerName">No Active Visit</div>
            <div class="visit-session-timer" id="sessionTimer">00:00:00</div>
            <div class="visit-session-status-text" id="sessionStatusText"></div>
        </div>

        <!-- Admin Position Monitoring Button -->
        <button class="admin-location-btn" id="adminLocationBtn" onclick="showAllSalesmanPositions()">
            üë• View All Positions
        </button>

        <div class="detail-header">
            <a href="dashboard.html" class="back-btn">‚Üê</a>
            <div class="detail-title-container">
                <div class="detail-title">Visit Outlet</div>
                <div class="salesman-name" id="salesmanName">Loading...</div>
            </div>
            <button class="user-btn" onclick="forceSyncLocation()">üìç</button>
        </div>

        <!-- Loading State -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
            <div>Loading data...</div>
        </div>

        <!-- Error State -->
        <div class="error-message" id="errorMessage" style="display: none;">
            <h3>üö® Data Loading Error</h3>
            <p>Unable to load visit data. Please check your connection.</p>
            <button onclick="initializeData()" style="margin-top: 10px; padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Retry</button>
        </div>

        <!-- Main Content -->
        <div id="mainContent" style="display: none;">
            <!-- Visit Tab Content -->
            <div id="visitTab" class="tab-content">
                <!-- Two Frame Layout -->
                <div class="content-section">
                    <div class="frames-container">
                        <!-- Left Frame - Filters -->
                        <div class="frame">
                            <div class="frame-title">üîç Select Filters</div>
                            <div class="filter-item">
                                <select id="hari">
                                    <option value="">üìÖ Pilih Hari JKS</option>
                                </select>
                            </div>
                            
                            <div class="filter-item">
                                <select id="pelanggan">
                                    <option value="">üè™ Pilih Outlet</option>
                                </select>
                            </div>
                            
                            <!-- Customer Info Display -->
                            <div id="customerInfo" class="customer-info">
                                <div class="customer-info-row">
                                    <div class="customer-info-label">Outlet Type:</div>
                                    <div id="customerType" class="customer-info-value"></div>
                                </div>
                                <div class="customer-info-row">
                                    <div class="customer-info-label">SKU POM (Belum CA):</div>
                                    <div id="skuZeroList" class="customer-info-value sku-zero-list"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Frame - Summary -->
                        <div class="frame">
                            <div class="frame-title">üìä Summary</div>
                            <div class="summary-grid">
                                <div class="summary-item">
                                    <div class="summary-label">Target</div>
                                    <div class="summary-value" id="summaryTarget">-</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-label">Actual</div>
                                    <div class="summary-value" id="summaryActual">-</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-label">Gap</div>
                                    <div class="summary-value" id="summaryGap">-</div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>

                <!-- Project Info Display (shown only for project outlets) -->
                            <div id="projectInfo" class="project-section" style="display: none;">
                                <div class="project-section-header" onclick="toggleProjectInfo()">
                                    <div class="project-section-title">
                                        üéØ Project Information
                                    </div>
                                    <div class="project-toggle-icon" id="projectToggleIcon">
                                        ‚ñº
                                    </div>
                                </div>
                                <div id="projectContent" class="project-content-collapsible"></div>
                            </div>
                            
                <!-- Visit Data Table -->
                <div class="content-section">
                    <!-- Tab Navigation -->
                <div id="skuPomFrame" class="content-section" style="display: none;">
                    <div class="sku-pom-frame">
                        <div class="sku-pom-frame-header">
                            <div class="sku-pom-frame-title">
                                üéØ SKU POM (Belum CA)
                                <span class="sku-pom-frame-count" id="skuPomFrameCount">0</span>
                            </div>
                        </div>
                        <div class="sku-pom-chips-container" id="skuPomChipsContainer">
                            <!-- Chips will be inserted here -->
                        </div>
                    </div>
                </div>
                    <div class="tab-navigation">
                        <button class="tab-button active" onclick="switchTab('dataSku')">
                            üìä Data SKU
                        </button>
                        <button class="tab-button" onclick="switchTab('mssBelumAktif')" id="mssTabButton">
                            <span class="gap-badge-left" id="gapMssBadge" style="visibility: hidden; opacity: 0;">0</span>
                            ‚ö†Ô∏è SKU MSS Belum Aktif
                            <span class="tab-badge" id="mssBadge" style="display: none;">0</span>
                        </button>
                    </div>

                    <!-- Tab Content: Data SKU -->
                    <div id="dataSku" class="tab-content-panel active">
                        <div class="table-section">
                            <div class="section-title">üìä Visit Data:</div>
                            <div class="table-wrapper">
                                <div class="table-container">
                                    <table id="dataTable">
                                        <thead>
                                            <tr>
                                                <th>No</th>
                                                <th class="sortable-header" onclick="sortTable('promo')">Promo</th>
                                                <th>SKU</th>
                                                <th>Gap</th>
                                                <th>Plan</th>
                                                <th>MTD</th>
                                                <th>3LM</th>
                                                <th>LM</th>
                                                <th>Rec</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tableBody">
                                            <tr>
                                                <td colspan="9">
                                                    <div class="empty-state">
                                                        <div class="empty-state-icon">üìä</div>
                                                        <div>Pilih filter untuk melihat data</div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                <!-- SKU POM Frame (Horizontal) -->
                        </div>
                    </div>

                    <!-- Tab Content: SKU MSS Belum Aktif -->
                    <div id="mssBelumAktif" class="tab-content-panel">
                        <div class="table-section">
                            <div id="mssGridContainer" class="mss-container">
                                <div class="mss-empty">
                                    <div class="empty-state-icon">‚ö†Ô∏è</div>
                                    <div>Pilih outlet untuk melihat SKU MSS yang belum aktif</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Visit Start Confirmation Modal -->
        <div class="visit-modal" id="visitStartModal">
            <div class="visit-modal-content">
                <div class="visit-modal-title">üè™ Mulai Kunjungan?</div>
                <div class="visit-modal-subtitle">Anda akan memulai kunjungan ke outlet berikut:</div>
                <div class="visit-modal-customer">
                    <div class="visit-modal-customer-name" id="startModalCustomerName">Outlet Name</div>
                    <div class="visit-modal-customer-details" id="startModalCustomerDetails">Details</div>
                </div>
                <div class="visit-modal-buttons">
                    <button class="visit-modal-btn visit-modal-btn-secondary" onclick="cancelVisitStart()">
                        ‚ùå Tidak
                    </button>
                    <button class="visit-modal-btn visit-modal-btn-primary" onclick="confirmVisitStart()">
                        ‚úÖ Ya, Mulai
                    </button>
                </div>
            </div>
        </div>

        <!-- Resume Visit Modal -->
        <div class="visit-modal" id="visitResumeModal">
            <div class="visit-modal-content">
                <div class="visit-modal-title">üîÑ Lanjutkan Kunjungan?</div>
                <div class="visit-modal-subtitle">Outlet ini memiliki kunjungan yang tertunda:</div>
                <div class="visit-modal-customer visit-modal-resume">
                    <div class="visit-modal-customer-name" id="resumeModalCustomerName">Outlet Name</div>
                    <div class="visit-modal-customer-details" id="resumeModalCustomerDetails">Details</div>
                </div>
                <div class="resume-info" id="resumeInfo">
                    <div class="resume-info-item"><strong>Waktu Mulai:</strong> <span id="resumeStartTime">-</span></div>
                    <div class="resume-info-item"><strong>Waktu Tunda:</strong> <span id="resumePauseTime">-</span></div>
                    <div class="resume-info-item"><strong>Durasi Sebelumnya:</strong> <span id="resumePrevDuration">-</span></div>
                </div>
                <div class="visit-modal-buttons">
                    <button class="visit-modal-btn visit-modal-btn-secondary" onclick="startNewVisit()">
                        üÜï Mulai Baru
                    </button>
                    <button class="visit-modal-btn visit-modal-btn-resume" onclick="confirmResumeVisit()">
                        ‚ñ∂Ô∏è Lanjutkan
                    </button>
                </div>
            </div>
        </div>

        <!-- Pause Visit Modal -->
        <div class="visit-modal" id="visitPauseModal">
            <div class="visit-modal-content">
                <div class="visit-modal-title">‚è∏Ô∏è Tunda Kunjungan?</div>
                <div class="visit-modal-subtitle">Anda akan menunda kunjungan ke:</div>
                <div class="visit-modal-customer visit-modal-pause">
                    <div class="visit-modal-customer-name" id="pauseModalCustomerName">Current Outlet</div>
                    <div class="visit-modal-customer-details" id="pauseModalCustomerDetails">Duration: 00:00:00</div>
                </div>
                <div class="pause-info">
                    <div class="pause-info-item"><strong>Alasan:</strong> Pemilik toko tidak ada / sibuk</div>
                    <div class="pause-info-item"><strong>Durasi saat ini:</strong> <span id="pauseCurrentDuration">0 menit</span></div>
                    <div class="pause-info-item"><strong>Status:</strong> Kunjungan akan disimpan dan dapat dilanjutkan nanti</div>
                </div>
                <div class="visit-modal-buttons">
                    <button class="visit-modal-btn visit-modal-btn-secondary" onclick="cancelPauseVisit()">
                        ‚ùå Lanjutkan
                    </button>
                    <button class="visit-modal-btn visit-modal-btn-pause" onclick="confirmPauseVisit()">
                        ‚è∏Ô∏è Ya, Tunda
                    </button>
                </div>
            </div>
        </div>

        <!-- Enhanced Visit End Modal with Order Status -->
        <div class="visit-modal" id="visitEndModal">
            <div class="visit-modal-content">
                <div class="visit-modal-title">üèÅ Akhiri Kunjungan?</div>
                <div class="visit-modal-subtitle">Anda sedang mengunjungi outlet:</div>
                <div class="visit-modal-customer">
                    <div class="visit-modal-customer-name" id="endModalCustomerName">Current Outlet</div>
                    <div class="visit-modal-customer-details" id="endModalCustomerDetails">Duration: 00:00:00</div>
                </div>
                
                <!-- Order Status Selection -->
                <div class="order-status-section">
                    <label class="order-status-label">Status Kunjungan:</label>
                    <select class="order-status-select" id="orderStatusSelect" onchange="toggleSOAmountInput()">
                        <option value="">Pilih status kunjungan...</option>
                        <option value="ada_so">Ada SO (Sales Order)</option>
                        <option value="toko_tidak_order">Toko Tidak Order</option>
                        <option value="toko_tutup">Toko Tutup</option>
                    </select>
                    
                    <!-- SO Amount Input (shown only when "Ada SO" is selected) -->
                    <div class="so-amount-section" id="soAmountSection">
                        <label class="so-amount-label">Nominal Sales Order (Rp):</label>
                        <input type="text" class="so-amount-input" id="soAmountInput" 
                               placeholder="Masukkan nominal SO..." inputmode="numeric">
                    </div>
                </div>
                
                <div class="visit-modal-buttons">
                    <button class="visit-modal-btn visit-modal-btn-secondary" onclick="cancelVisitEnd()">
                        ‚ùå Lanjutkan
                    </button>
                    <button class="visit-modal-btn visit-modal-btn-primary" id="endVisitBtn" onclick="confirmVisitEnd()" disabled>
                        ‚úÖ Ya, Akhiri
                    </button>
                </div>
            </div>
        </div>

        <!-- Floating Action Buttons -->
        <div class="floating-actions" id="floatingActions">
            <button class="floating-btn btn-pause-visit" onclick="showPauseVisitModal()">
                ‚è∏Ô∏è Tunda Kunjungan
            </button>
            <button class="floating-btn btn-end-visit" onclick="showVisitEndModal()">
                üèÅ Akhiri Kunjungan
            </button>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item" onclick="goHome()">
                <div class="nav-icon home">üè†</div>
                <div class="nav-label">Home</div>
            </div>
            <div class="nav-item active" onclick="showVisitOutlet()">
                <div class="nav-icon visit">üè™</div>
                <div class="nav-label">Visit</div>
            </div>
            <div class="nav-item" onclick="window.showHasilVisit()">
                <div class="nav-icon hasil-visit">üìä</div>
                <div class="nav-label">Hasil Visit</div>
            </div>
        </div>
    </div>


        <!-- Hasil Visit Modal -->
    <!-- Firebase SDK -->

        <!-- Hasil Visit Full Screen Text View -->
        <div class="hasil-text-view" id="hasilTextView">
            <div class="hasil-text-header">
                <button class="hasil-text-close" onclick="window.closeHasilText()">
                    ‚Üê Kembali
                </button>
                <h2>üìä Report Visit Salesman</h2>
            </div>
            
            <div class="hasil-text-content">
                <pre id="reportTextContent" class="report-preview">Loading...</pre>
            </div>
            
            <div class="hasil-text-actions">
                <button class="action-btn copy-btn" onclick="window.copyReportText()">
                    üìã Copy Report Text
                </button>
                <button class="action-btn whatsapp-image-btn" onclick="window.shareReportImageWhatsApp()">
					üñºÔ∏è Share Gambar WhatsApp
				</button>
            </div>
        </div>

    <!-- Plan DAP Popup -->
    <div class="plan-dap-overlay" id="planDapOverlay" onclick="event.target === this && (function(){})()">
        <div class="plan-dap-modal">
            <div class="plan-dap-header">
                <h3>üìä Plan DAP Hari Ini</h3>
                <p class="plan-dap-subtitle">Target penjualan untuk kunjungan hari ini</p>
            </div>
            <div class="plan-dap-body">
                <div class="input-group">
                    <label>Plan DAP (Rp)</label>
                    <input type="text" id="planDapInput" placeholder="Contoh: 5.000.000" autocomplete="off">
                </div>
                <div class="plan-dap-note">
                    <strong>‚ö†Ô∏è Wajib Diisi</strong><br>
                    Anda harus mengisi Plan DAP sebelum memulai kunjungan hari ini
                </div>
            </div>
            <div class="plan-dap-footer">
                <button class="btn-submit-plan" onclick="submitPlanDAP()">
                    ‚úÖ Simpan Plan DAP
                </button>
            </div>
        </div>
    </div>

    <script>
        // HASIL VISIT - GLOBAL FUNCTIONS
        (function() {
        })();
            window.showHasilVisit = function() {
                try {
                    // Generate report text
                    var reportText = generateReportText();
                    
                    // Display in preview
                    var previewEl = document.getElementById('reportTextContent');
                    if (previewEl) {
                        previewEl.textContent = reportText;
                    }
                    
                    // Store for later use
                    window.currentReportText = reportText;
                    
                    // Show text view
                    var view = document.getElementById('hasilTextView');
                    if (view) {
                        view.classList.add('active');
                    }
                    
                } catch (error) {
                    console.error('Error showing hasil visit:', error);
                    alert('Gagal menampilkan hasil visit: ' + error.message);
                }
            };
            
            window.closeHasilText = function() {
                var view = document.getElementById('hasilTextView');
                if (view) {
                    view.classList.remove('active');
                }
            };
            
            window.copyReportText = function() {
                var text = window.currentReportText;
                if (!text) {
                    alert('Report tidak tersedia');
                    return;
                }
                
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).then(function() {
                        alert('‚úÖ Report berhasil di-copy!\n\nSilakan paste di WhatsApp atau aplikasi lain.');
                    }).catch(function(err) {
                        fallbackCopy(text);
                    });
                } else {
                    fallbackCopy(text);
                }
            };
            
            window.shareReportWhatsApp = function() {
                var text = window.currentReportText;
                if (!text) {
                    alert('Report tidak tersedia');
                    return;
                }
                
                // Share via WhatsApp with text
                var url = 'https://wa.me/?text=' + encodeURIComponent(text);
                window.open(url, '_blank');
            };
            
            function generateReportText() {
                var today = new Date();
                var dateStr = today.toLocaleDateString('id-ID', { 
                    day: 'numeric',
                    month: 'long', 
                    year: 'numeric'
                });
                var todayYMD = fmtDate(today);
                var todayDay = getDayOfWeekIndo();
                var weekNum = getWeekOfMonth();
                
                console.log('üìä Generating Hasil Visit Report');
                console.log('   Date:', todayYMD, '(' + todayDay + ', Week ' + weekNum + ')');
                console.log('   Salesman:', window.currentSalesman, '(' + window.currentSalesmanId + ')');
                
                // ========================================
                // 1. PC CALCULATION (Weekly + Biweekly)
                // ========================================
                var uniqueOutlets = new Set();
                var pcOutlets = []; // Store for Gap calculation
                
                if (window.pelangganData && window.pelangganData.length > 0) {
                    window.pelangganData.forEach(function(item) {
                        if (item.szname === window.currentSalesman && item.Nama_Pelanggan) {
                            var hariKunjungan = (item.Hari_Kunjungan || '').toUpperCase().trim();
                            var outletName = item.Nama_Pelanggan;
                            var isMatch = false;
                            
                            // Match weekly (exact day)
                            if (hariKunjungan === todayDay) {
                                isMatch = true;
                            }
                            // Match biweekly (include ALL biweekly for this day, regardless of week)
                            else if (hariKunjungan.includes('2&4') && hariKunjungan.includes(todayDay)) {
                                isMatch = true;
                            }
                            
                            if (isMatch) {
                                uniqueOutlets.add(outletName);
                                pcOutlets.push(outletName);
                            }
                        }
                    });
                }
                
                var PC = uniqueOutlets.size;
                console.log('   PC (Weekly + Biweekly for ' + todayDay + '):', PC);
                
                // ========================================
                // 2. AC, EC, TOKO TUTUP, TOKO TIDAK ORDER
                // ========================================
                var visited = new Set();
                var ordered = new Set(); // EC = orderStatus === 'ada_so'
                var tokoTutupList = [];
                var tokoTidakOrderList = [];
                var actual = 0;
                
                // Load from localStorage
                var visitKey = 'visited_' + window.currentSalesmanId + '_' + todayYMD;
                var storedVisits = localStorage.getItem(visitKey);
                
                console.log('   Loading visits from localStorage...');
                console.log('   Key:', visitKey);
                
                if (storedVisits) {
                    try {
                        var visits = JSON.parse(storedVisits);
                        console.log('   Found visits in localStorage:', visits.length);
                        
                        // Debug: Show all visits
                        visits.forEach(function(visit, index) {
                            console.log('   Visit', index + 1, ':', {
                                outlet: visit.outlet_name,
                                completed: visit.visit_completed,
                                status: visit.order_status,
                                amount: visit.so_amount
                            });
                        });
                        
                        visits.forEach(function(visit) {
                            if (visit.outlet_name && visit.visit_completed) {
                                visited.add(visit.outlet_name);
                                
                                var orderStatus = visit.order_status;
                                var soAmount = Number(visit.so_amount || 0);
                                
                                if (orderStatus === 'ada_so') {
                                    ordered.add(visit.outlet_name);
                                    actual += soAmount;
                                    console.log('   ‚úì EC outlet:', visit.outlet_name, '‚Üí Rp', soAmount);
                                } else if (orderStatus === 'toko_tutup') {
                                    tokoTutupList.push(visit.outlet_name);
                                } else if (orderStatus === 'toko_tidak_order') {
                                    tokoTidakOrderList.push(visit.outlet_name);
                                }
                            }
                        });
                    } catch (e) {
                        console.error('   ‚ùå Error parsing visits:', e);
                    }
                } else {
                    console.log('   ‚ö†Ô∏è No visits found in localStorage for key:', visitKey);
                }
                
                var AC = visited.size;
                var EC = ordered.size;
                
                console.log('   AC (Actual Call):', AC);
                console.log('   EC (Ada SO only):', EC);
                console.log('   Toko Tutup:', tokoTutupList.length);
                console.log('   Toko Tidak Order:', tokoTidakOrderList.length);
                console.log('   Actual SO:', actual);
                
                // ========================================
                // 3. TOTAL GAP JKS (Gap MTD for PC outlets only)
                // ========================================
                var gap = 0;
                var dap = 0;
                
                if (window.detailsData && window.detailsData.length > 0) {
                    window.detailsData.forEach(function(item) {
                        if (item.szname === window.currentSalesman) {
                            var outlet = item['Nama Pelanggan'];
                            
                            // Only sum Gap MTD if outlet is in PC list
                            if (pcOutlets.includes(outlet)) {
                                // Safe parsing - handle both string and number
                                var gapValue = item['Gap MTD'] || item.Gap || 0;
                                var dapValue = item.DAP || item.Plan || 0;
                                
                                // Clean and parse Gap value
                                if (typeof gapValue === 'string') {
                                    // Remove Rp, dots, commas, spaces
                                    gapValue = gapValue.replace(/[Rp\s\.,]/g, '');
                                }
                                var gapMTD = parseFloat(gapValue) || 0;
                                
                                // Clean and parse DAP value
                                if (typeof dapValue === 'string') {
                                    dapValue = dapValue.replace(/[Rp\s\.,]/g, '');
                                }
                                var dapNum = parseFloat(dapValue) || 0;
                                
                                gap += gapMTD;
                                dap += dapNum;
                            }
                        }
                    });
                }
                
                console.log('   Total Gap JKS (from PC outlets only):', gap);
                console.log('   Total DAP:', dap);
                
                // ========================================
                // 4. PLAN DAP
                // ========================================
                var planDAP = getPlanDAP();
                console.log('   Plan DAP:', planDAP);
                
                // ========================================
                // 5. CALCULATIONS
                // ========================================
                var ECvsPC = PC > 0 ? Math.round((EC / PC) * 100) : 0;
                var achSO = planDAP > 0 ? Math.round((actual / planDAP) * 100) : (actual > 0 ? 100 : 0);
                
                console.log('   EC vs PC:', ECvsPC + '%');
                console.log('   Ach SO:', achSO + '%');
                
                // ========================================
                // 6. SKU POM BREAKDOWN
                // ========================================
                var skuPomData = {};
                visited.forEach(function(outletName) {
                    try {
                        var storageKey = 'sku_pom_checklist_' + window.currentSalesmanId + '_' + outletName + '_' + todayYMD;
                        var saved = localStorage.getItem(storageKey);
                        if (saved) {
                            var checklist = JSON.parse(saved);
                            Object.keys(checklist).forEach(function(sku) {
                                if (checklist[sku] === true) {
                                    if (!skuPomData[sku]) {
                                        skuPomData[sku] = 0;
                                    }
                                    skuPomData[sku]++;
                                }
                            });
                        }
                    } catch (e) {
                        console.error('Error loading SKU for ' + outletName, e);
                    }
                });
                
                console.log('   SKU POM items:', Object.keys(skuPomData).length);
                
                // ========================================
                // 7. SALESMAN TYPE
                // ========================================
                var salesmanType = '-';
                
                // Try to get from window (already exposed during initialization)
                if (window.currentSalesmanType) {
                    salesmanType = window.currentSalesmanType;
                    console.log('   Tipe Salesman (from window):', salesmanType);
                }
                // Fallback: Get from salesmanData
                else if (window.salesmanData && window.salesmanData.length > 0) {
                    var salesmanRecord = window.salesmanData.find(function(item) {
                        return item.szEmployeeId && item.szEmployeeId.toString() === window.currentSalesmanId;
                    });
                    if (salesmanRecord && salesmanRecord['Tipe Salesman']) {
                        salesmanType = salesmanRecord['Tipe Salesman'];
                        console.log('   Tipe Salesman (from salesmanData):', salesmanType);
                    } else {
                        console.log('   ‚ö†Ô∏è Tipe Salesman not found in salesmanData');
                    }
                } else {
                    console.log('   ‚ö†Ô∏è salesmanData not available');
                }
                
                // ========================================
                // 8. BUILD REPORT TEXT
                // ========================================
                var report = '';
                report += 'REPORT VISIT SALESMAN\n';
                report += '='.repeat(21) + '\n';
                report += 'Tanggal Visit : ' + dateStr + '\n';
                report += 'Nama Salesman : ' + (window.currentSalesman || '-') + '\n';
                report += 'Tipe Salesman : ' + salesmanType + '\n\n';
                
                report += 'HASIL KUNJUNGAN\n';
                report += '-'.repeat(15) + '\n';
                report += 'PC (Plan Call)     : ' + PC + '\n';
                report += 'AC (Actual Call)   : ' + AC + '\n';
                report += 'EC (Effective Call): ' + EC + '\n';
                report += 'EC vs PC           : ' + ECvsPC + '%\n\n';
                
                report += 'PERFORMA PENJUALAN\n';
                report += '-'.repeat(18) + '\n';
                report += 'Total Gap JKS : ' + formatRp(gap) + '\n';
                report += 'Plan DAP      : ' + formatRp(planDAP) + '\n';
                report += 'Actual SO     : ' + formatRp(actual) + '\n';
                report += 'Ach SO        : ' + achSO + '%\n\n';
                
                report += 'SKU POM YANG DIPESAN\n';
                report += '-'.repeat(20) + '\n';
                var skuList = Object.keys(skuPomData);
                if (skuList.length > 0) {
                    skuList.sort(function(a, b) {
                        return skuPomData[b] - skuPomData[a];
                    });
                    skuList.forEach(function(sku) {
                        report += sku + ' : ' + skuPomData[sku] + ' outlet\n';
                    });
                } else {
                    report += '(Belum ada SKU POM yang dipesan)\n';
                }
                report += '\n';
                
                // ========================================
                // 9. REASON OUTLET TIDAK ORDER (with statistics)
                // ========================================
                
                // Calculate counts and percentages
                var tokoTutupCount = tokoTutupList.length;
                var tokoTutupPct = PC > 0 ? Math.round((tokoTutupCount / PC) * 100) : 0;
                var tokoTidakOrderCount = tokoTidakOrderList.length;
                var tokoTidakOrderPct = PC > 0 ? Math.round((tokoTidakOrderCount / PC) * 100) : 0;
                
                report += 'REASON OUTLET TIDAK ORDER\n';
                report += '-'.repeat(25) + '\n';
                
                // Toko Tutup with count and percentage
                report += '1. Toko Tutup : ' + tokoTutupCount + ' outlet - ' + tokoTutupPct + '%\n';
                if (tokoTutupList.length > 0) {
                    report += '   ' + tokoTutupList.join(', ') + '\n';
                } else {
                    report += '   (Tidak ada)\n';
                }
                report += '\n';
                
                // Toko Tidak Order with count and percentage
                report += '2. Toko Tidak Order : ' + tokoTidakOrderCount + ' outlet - ' + tokoTidakOrderPct + '%\n';
                if (tokoTidakOrderList.length > 0) {
                    report += '   ' + tokoTidakOrderList.join(', ') + '\n';
                } else {
                    report += '   (Tidak ada)\n';
                }
                
                report += '\n' + '='.repeat(35) + '\n';
                report += 'Report otomatis Sales Dashboard WebApp\n';
                
                console.log('‚úÖ Report generated successfully');
                return report;
            }
            
			function shareReportImageWhatsApp() {
				// *** PERUBAHAN UTAMA: Target diubah ke ID yang ada di Full Screen View Anda ***
				const reportElement = document.getElementById('reportTextContent'); 
				
				// Teks caption untuk WhatsApp
				const selectedPelanggan = 'Outlet Kunjungan'; // Ganti jika Anda memiliki logic untuk mengambil nama pelanggan
				const whatsappCaption = `üìù Laporan Kunjungan Salesman ${window.currentSalesman || 'Salesman'} (${selectedPelanggan}) pada ${new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'})}.`;
				
				if (typeof html2canvas === 'undefined') {
					alert('‚ö†Ô∏è ERROR: Library html2canvas tidak ditemukan! Pastikan file html2canvas.min.js sudah berada di folder yang sama.');
					return;
				}

				const shareButton = document.querySelector('.whatsapp-image-btn');
				const originalButtonText = shareButton.innerHTML;
				shareButton.innerHTML = '‚è≥ Mengkonversi...';
				shareButton.disabled = true;

				// html2canvas akan memotret elemen reportElement (reportTextContent)
				html2canvas(reportElement, {
					scale: 2, 
					useCORS: true,
					allowTaint: true,
					backgroundColor: '#f9f9f9' // Gunakan warna background dari elemen Anda
				}).then(canvas => {
					shareButton.innerHTML = originalButtonText;
					shareButton.disabled = false;
					
					canvas.toBlob((blob) => {
						const file = new File([blob], 'report_visit.png', { type: 'image/png' });
						
						if (navigator.canShare && navigator.canShare({ files: [file] })) {
							navigator.share({
								files: [file],
								title: 'Laporan Kunjungan Salesman',
								text: whatsappCaption
							}).then(() => {
								console.log('‚úÖ Berbagi gambar berhasil');
							}).catch((error) => {
								// Fallback jika Share API gagal
								const reportText = generateReportText();
								window.open('whatsapp://send?text=' + encodeURIComponent(reportText), '_blank');
							});
						} else {
							// Fallback jika browser tidak mendukung Web Share API
							const reportText = generateReportText();
							alert('‚ö†Ô∏è Browser tidak mendukung fitur Share Gambar langsung.\n\nLaporan akan dibagikan sebagai TEKS.');
							window.open('whatsapp://send?text=' + encodeURIComponent(reportText), '_blank');
						}
					}, 'image/png');
				}).catch(error => {
					shareButton.innerHTML = originalButtonText;
					shareButton.disabled = false;
					console.error('‚ùå html2canvas gagal:', error);
					alert('‚ùå Gagal mengkonversi laporan ke gambar. Akan dibagikan sebagai TEKS.');
					const reportText = generateReportText();
					window.open('whatsapp://send?text=' + encodeURIComponent(reportText), '_blank');
				});
			}
			
            function fallbackCopy(text) {
                var textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    alert('‚úÖ Report berhasil di-copy!\n\nSilakan paste di WhatsApp atau aplikasi lain.');
                } catch (err) {
                    alert('Gagal copy. Silakan copy manual.');
                }
                document.body.removeChild(textarea);
            }
            
            function fmtDate(d) {
                var y = d.getFullYear();
                var m = String(d.getMonth()+1).padStart(2,'0');
                var day = String(d.getDate()).padStart(2,'0');
                return y+'-'+m+'-'+day;
            }
            
            function formatRp(value) {
                // Handle null, undefined, empty
                if (!value && value !== 0) return 'Rp 0';
                
                // Convert to number if string
                var num = value;
                if (typeof value === 'string') {
                    // Remove any existing formatting
                    num = value.replace(/[Rp\s\.,\(\)]/g, '');
                    // Handle negative in parentheses: "(123)" -> -123
                    if (value.includes('(') && value.includes(')')) {
                        num = '-' + num;
                    }
                    num = parseFloat(num);
                }
                
                // Validate number
                if (isNaN(num) || !isFinite(num)) return 'Rp 0';
                
                // Round to avoid floating point issues
                num = Math.round(num);
                
                // Format
                var abs = Math.abs(num);
                var formatted = abs.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                
                // Return with proper negative format: Rp (xxx) instead of -Rp xxx
                return num < 0 ? 'Rp (' + formatted + ')' : 'Rp ' + formatted;
            }
            
            // ===== HELPER FUNCTIONS FOR REQUIREMENT IMPLEMENTATION =====
            function getDayOfWeekIndo() {
                var days = ['MINGGU', 'SENIN', 'SELASA', 'RABU', 'KAMIS', 'JUMAT', 'SABTU'];
                return days[new Date().getDay()];
            }

            function getWeekOfMonth() {
                var d = new Date();
                var date = d.getDate();
                return Math.ceil(date / 7);
            }

            function formatRupiah(angka) {
                if (!angka || angka === 0) return '0';
                var number = angka.toString().replace(/[^0-9]/g, '');
                return number.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            }

            function getPlanDAP() {
                var todayYMD = new Date().toISOString().split('T')[0];
                var planKey = 'plan_dap_' + window.currentSalesmanId + '_' + todayYMD;
                var planData = localStorage.getItem(planKey);
                
                if (planData) {
                    try {
                        var plan = JSON.parse(planData);
                        return Number(plan.amount || 0);
                    } catch (e) {
                        return 0;
                    }
                }
                return 0;
            }

            function checkPlanDAP() {
                return getPlanDAP() > 0;
            }

            function showPlanDAPPopup() {
                document.getElementById('planDapOverlay').classList.add('show');
                document.getElementById('planDapInput').focus();
            }

            function submitPlanDAP() {
                var amountInput = document.getElementById('planDapInput').value;
                
                // Remove dots to get pure number
                var amount = amountInput.replace(/\./g, '');
                
                if (!amount || parseFloat(amount) <= 0) {
                    alert('‚ö†Ô∏è Masukkan Plan DAP yang valid!\n\nContoh: 5.000.000');
                    return;
                }
                
                var todayYMD = new Date().toISOString().split('T')[0];
                var planKey = 'plan_dap_' + window.currentSalesmanId + '_' + todayYMD;
                
                var planData = {
                    amount: parseFloat(amount),
                    timestamp: new Date().toISOString(),
                    salesman_id: window.currentSalesmanId,
                    salesman_name: window.currentSalesman
                };
                
                localStorage.setItem(planKey, JSON.stringify(planData));
                
                console.log('‚úÖ Plan DAP saved:', amount, '(Rp ' + formatRupiah(amount) + ')');
                
                // Close modal
                document.getElementById('planDapOverlay').classList.remove('show');
                document.getElementById('planDapInput').value = '';
                
                // After saving Plan DAP, trigger updatePelangganOptions again to show outlets
                setTimeout(function() {
                    updatePelangganOptions();
                }, 100);
            }

            // Make functions global
            window.getDayOfWeekIndo = getDayOfWeekIndo;
            window.getWeekOfMonth = getWeekOfMonth;
            window.formatRupiah = formatRupiah;
            window.getPlanDAP = getPlanDAP;
            window.checkPlanDAP = checkPlanDAP;
            window.showPlanDAPPopup = showPlanDAPPopup;
            window.submitPlanDAP = submitPlanDAP;

            // ===== FORMAT CURRENCY INPUT FOR PLAN DAP =====
            document.addEventListener('DOMContentLoaded', function() {
                var planDapInput = document.getElementById('planDapInput');
                
                if (planDapInput) {
                    // Format on input (real-time)
                    planDapInput.addEventListener('input', function(e) {
                        var value = e.target.value;
                        
                        // Remove non-digits
                        var numbers = value.replace(/\D/g, '');
                        
                        // Format with dots
                        if (numbers) {
                            var formatted = numbers.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                            e.target.value = formatted;
                        }
                    });
                    
                    // Remove formatting on focus (easier to edit)
                    planDapInput.addEventListener('focus', function(e) {
                        var value = e.target.value;
                        if (value) {
                            e.target.value = value.replace(/\./g, '');
                        }
                    });
                    
                    // Re-format on blur
                    planDapInput.addEventListener('blur', function(e) {
                        var value = e.target.value;
                        var numbers = value.replace(/\D/g, '');
                        if (numbers) {
                            e.target.value = numbers.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                        }
                    });
                }
            });
    </script>

    <!-- html2canvas for screenshot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script type="module">
        // Firebase configuration and initialization
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, get, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAoRV3qVAXQ14AEVA8Mo49HXfAyhMMm8Bs",
            authDomain: "salesman-route-tracker.firebaseapp.com",
            databaseURL: "https://salesman-route-tracker-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "salesman-route-tracker",
            storageBucket: "salesman-route-tracker.firebasestorage.app",
            messagingSenderId: "590789273516",
            appId: "1:590789273516:web:79abe0c7e4cbccfa44fc09",
            measurementId: "G-5RYSWKQ063"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const analytics = getAnalytics(app);

        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebasePush = push;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseServerTimestamp = serverTimestamp;

        console.log('üî• Firebase initialized successfully');
    </script>

    <script>
        // ===== GLOBAL VARIABLES =====
        let currentSalesman = '';
        let currentSalesmanId = null;
        let hariData = [];
        let pelangganData = [];
        let detailsData = [];
        let salesmanData = [];
        let projectData = [];
        let tpomData = [];
        let salesmanTeam = '';
        let skuData = [];
        
        // ===== LOCAL STORAGE FOR VISITS =====
        let todayVisitedCustomers = new Set();

        // ===== LOCATION TRACKING VARIABLES =====
        let currentLocation = {
            latitude: null,
            longitude: null,
            accuracy: null,
            timestamp: null
        };

        let watchId = null;
        
        // ===== PERIODIC LOCATION TRACKING VARIABLES =====
        let locationTrackingTimer = null;
        let lastLocationSync = null;
        let isLocationTrackingActive = false;

        // ===== ENHANCED VISIT SESSION WITH PAUSE/RESUME =====
        let visitSession = {
            isActive: false,
            isPaused: false,
            outletId: null,
            outletName: null,
            startTime: null,
            endTime: null,
            duration: 0,
            accumulatedDuration: 0, // Total time spent in store
            pauseTime: null,
            resumeTime: null,
            sessionId: null,
            startLocation: null,
            endLocation: null,
            orderStatus: null,
            soAmount: null,
            pendingOutlet: null,
            pendingHari: null,
            pauseHistory: [], // Track all pause/resume events
            firebaseKey: null // Store Firebase key for updates
        };

        let sessionTimer = null;

        // ===== PAUSE/RESUME MANAGEMENT =====
        let pausedVisits = new Map(); // Store paused visits by outlet name

        // ===== PERIODIC LOCATION SYNC FUNCTIONS =====
        function startPeriodicLocationTracking() {
            if (!currentSalesmanId) {
                console.warn('üö´ Cannot start location tracking - no salesman ID');
                return;
            }

            if (locationTrackingTimer) {
                clearInterval(locationTrackingTimer);
            }

            isLocationTrackingActive = true;
            console.log('üìç Starting periodic location tracking (10 minute intervals)');
            
            // Sync immediately on start
            syncCurrentLocationToFirebase();
            
            // Then sync every 10 minutes
            locationTrackingTimer = setInterval(() => {
                if (isLocationTrackingActive && currentSalesmanId) {
                    syncCurrentLocationToFirebase();
                }
            }, 10 * 60 * 1000); // 10 minutes in milliseconds
            
            updateLocationTrackingStatus('active', 'üìç Position tracking active');
        }

        function stopPeriodicLocationTracking() {
            if (locationTrackingTimer) {
                clearInterval(locationTrackingTimer);
                locationTrackingTimer = null;
            }
            
            isLocationTrackingActive = false;
            console.log('üìç Stopped periodic location tracking');
            updateLocationTrackingStatus('stopped', 'üìç Position tracking stopped');
        }

        async function syncCurrentLocationToFirebase() {
            if (!window.firebaseDB || !currentSalesmanId || !currentLocation.latitude) {
                console.warn('üìç Cannot sync location - missing requirements');
                return false;
            }

            try {
                updateLocationTrackingStatus('syncing', 'üìç Syncing position...');
                
                const now = new Date();
                const locationData = {
                    salesman_id: currentSalesmanId,
                    salesman_name: currentSalesman,
                    latitude: currentLocation.latitude,
                    longitude: currentLocation.longitude,
                    accuracy: currentLocation.accuracy,
                    timestamp: now.toISOString(),
                    last_updated: window.firebaseServerTimestamp(),
                    device_info: {
                        user_agent: navigator.userAgent,
                        platform: navigator.platform,
                        online: navigator.onLine
                    },
                    // Additional context
                    visit_session: {
                        is_active: visitSession.isActive,
                        is_paused: visitSession.isPaused,
                        current_outlet: visitSession.outletName || null,
                        session_duration: visitSession.isActive ? visitSession.duration : 0
                    }
                };

                // Store in Firebase - this will overwrite previous data for this salesman
                const positionRef = window.firebaseRef(window.firebaseDB, `current_positions/${currentSalesmanId}`);
                await window.firebaseSet(positionRef, locationData);
                
                lastLocationSync = now;
                console.log('üìç Location synced to Firebase:', {
                    lat: currentLocation.latitude.toFixed(6),
                    lng: currentLocation.longitude.toFixed(6),
                    accuracy: Math.round(currentLocation.accuracy),
                    time: now.toLocaleTimeString('id-ID')
                });
                
                updateLocationTrackingStatus('success', `üìç Position synced at ${now.toLocaleTimeString('id-ID')}`);
                
                // Also save to local storage as backup
                saveLocationToLocalStorage(locationData);
                
                return true;
                
            } catch (error) {
                console.error('üìç Firebase location sync error:', error);
                updateLocationTrackingStatus('error', '‚ùå Position sync failed');
                return false;
            }
        }

        function saveLocationToLocalStorage(locationData) {
            try {
                const locationKey = `current_location_${currentSalesmanId}`;
                localStorage.setItem(locationKey, JSON.stringify(locationData));
                
                // Keep location history (last 24 hours only)
                const historyKey = `location_history_${currentSalesmanId}`;
                const existingHistory = JSON.parse(localStorage.getItem(historyKey) || '[]');
                
                // Add current location to history
                existingHistory.push(locationData);
                
                // Remove entries older than 24 hours
                const cutoffTime = new Date(Date.now() - 24 * 60 * 60 * 1000);
                const filteredHistory = existingHistory.filter(entry => 
                    new Date(entry.timestamp) > cutoffTime
                );
                
                // Keep maximum 144 entries (24 hours * 6 per hour = 144)
                const trimmedHistory = filteredHistory.slice(-144);
                localStorage.setItem(historyKey, JSON.stringify(trimmedHistory));
                
                console.log('üíæ Location saved to localStorage');
                
            } catch (error) {
                console.error('üíæ Error saving location to localStorage:', error);
            }
        }

        function updateLocationTrackingStatus(status, message) {
            // Update existing location status element
            const statusElement = document.getElementById('locationStatusEnhanced');
            if (statusElement) {
                statusElement.classList.remove('success', 'error');
                statusElement.classList.add(status);
                const mainElement = statusElement.querySelector('.location-main');
                if (mainElement) {
                    mainElement.textContent = message;
                }
            }
            
            // Also update tracking indicator
            const trackingElement = document.getElementById('locationTrackingStatus');
            if (trackingElement) {
                trackingElement.textContent = message;
                trackingElement.className = `location-tracking-status ${status}`;
            }
            
            // Auto-hide success/error messages after 5 seconds
            if (status === 'success' || status === 'error') {
                setTimeout(() => {
                    if (statusElement) {
                        statusElement.classList.remove('success', 'error');
                    }
                    if (trackingElement) {
                        trackingElement.classList.remove('success', 'error');
                    }
                }, 5000);
            }
        }

        // ===== LOCATION TRACKING MANAGEMENT =====
        function initializeLocationTracking() {
            // Enhanced geolocation initialization
            if ("geolocation" in navigator) {
                console.log('üìç Geolocation is available');
                getCurrentLocationEnhanced();
                startLocationTracking();
                
                // Start periodic tracking after initial location is obtained
                setTimeout(() => {
                    if (currentLocation.latitude) {
                        startPeriodicLocationTracking();
                    }
                }, 2000);
                
            } else {
                console.warn('üìç Geolocation is not available');
                updateLocationTrackingStatus('error', '‚ùå Location not supported');
            }
        }

        // Enhanced getCurrentLocation with better error handling
        function getCurrentLocationEnhanced() {
            updateLocationTrackingStatus('loading', 'üìç Getting current position...');
            
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 5 * 60 * 1000 // 5 minutes
            };
            
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: new Date().toISOString()
                        };
                        
                        console.log('üìç Enhanced location obtained:', {
                            lat: currentLocation.latitude.toFixed(6),
                            lng: currentLocation.longitude.toFixed(6),
                            accuracy: Math.round(currentLocation.accuracy)
                        });
                        
                        updateLocationTrackingStatus('success', 'üìç Location ready');
                        updateEnhancedLocationStatus();
                        resolve(currentLocation);
                    },
                    (error) => {
                        console.error('üìç Enhanced location error:', error);
                        const errorMessage = getLocationErrorMessage(error);
                        updateLocationTrackingStatus('error', errorMessage);
                        reject(error);
                    },
                    options
                );
            });
        }

        function getLocationErrorMessage(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    return '‚ùå Location access denied';
                case error.POSITION_UNAVAILABLE:
                    return '‚ùå Location unavailable';
                case error.TIMEOUT:
                    return '‚ùå Location timeout';
                default:
                    return '‚ùå Location error';
            }
        }

        // Enhanced location status update function
        function updateEnhancedLocationStatus() {
            const statusElement = document.getElementById('locationStatusEnhanced');
            const accuracyElement = document.getElementById('locationAccuracy');
            const lastSyncElement = document.getElementById('locationLastSync');
            
            if (statusElement && currentLocation.latitude) {
                statusElement.classList.add('success');
                statusElement.querySelector('.location-main').textContent = 'üìç Location active';
                
                if (accuracyElement) {
                    accuracyElement.textContent = `Accuracy: ¬±${Math.round(currentLocation.accuracy)}m`;
                }
                
                if (lastSyncElement && lastLocationSync) {
                    lastSyncElement.textContent = `Last sync: ${lastLocationSync.toLocaleTimeString('id-ID', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    })}`;
                }
            }
        }

        // ===== ADMIN MONITORING FUNCTIONS =====
        async function getCurrentSalesmanPositions() {
            if (!window.firebaseDB) {
                console.warn('üö´ Firebase not available for position monitoring');
                return null;
            }

            try {
                const positionsRef = window.firebaseRef(window.firebaseDB, 'current_positions');
                const snapshot = await window.firebaseGet(positionsRef);
                
                if (snapshot.exists()) {
                    const positions = snapshot.val();
                    console.log('üìç Retrieved current positions for all salesmen:', Object.keys(positions).length);
                    return positions;
                } else {
                    console.log('üìç No current positions found');
                    return {};
                }
                
            } catch (error) {
                console.error('üìç Error retrieving positions:', error);
                return null;
            }
        }

        // Function to show all salesman positions (for admin)
        async function showAllSalesmanPositions() {
            try {
                const positions = await getCurrentSalesmanPositions();
                
                if (!positions) {
                    alert('‚ùå Unable to retrieve positions');
                    return;
                }
                
                let positionInfo = 'üë• Current Salesman Positions:\n\n';
                
                Object.entries(positions).forEach(([salesmanId, data]) => {
                    const timeAgo = new Date(data.timestamp);
                    const minutesAgo = Math.floor((Date.now() - timeAgo.getTime()) / (1000 * 60));
                    
                    positionInfo += `üë§ ${data.salesman_name || salesmanId}\n`;
                    positionInfo += `üìç ${data.latitude.toFixed(6)}, ${data.longitude.toFixed(6)}\n`;
                    positionInfo += `‚è∞ ${minutesAgo} minutes ago\n`;
                    positionInfo += `üéØ Accuracy: ¬±${Math.round(data.accuracy)}m\n`;
                    
                    if (data.visit_session?.is_active) {
                        positionInfo += `üè™ Visiting: ${data.visit_session.current_outlet || 'Unknown'}\n`;
                        if (data.visit_session.is_paused) {
                            positionInfo += `‚è∏Ô∏è Status: Paused\n`;
                        } else {
                            positionInfo += `‚úÖ Status: Active\n`;
                        }
                    } else {
                        positionInfo += `üì± Status: Available\n`;
                    }
                    
                    positionInfo += '\n';
                });
                
                alert(positionInfo);
                
            } catch (error) {
                console.error('‚ùå Error showing positions:', error);
                alert('‚ùå Error retrieving positions');
            }
        }

        // Check if user is admin and show position monitoring button
        function checkAdminAccess() {
            // Add your admin check logic here
            // For example, check if user ID is in admin list
            const adminIds = ['ADMIN001', 'SUPERVISOR001']; // Add your admin IDs
            
            if (adminIds.includes(currentSalesmanId)) {
                const adminBtn = document.getElementById('adminLocationBtn');
                if (adminBtn) {
                    adminBtn.classList.add('show');
                }
            }
        }

        // Manual location sync function (for testing)
        function forceSyncLocation() {
            console.log('üìç Manual location sync triggered');
            getCurrentLocationEnhanced().then(() => {
                syncCurrentLocationToFirebase();
            }).catch(error => {
                console.error('üìç Manual sync failed:', error);
            });
        }

        // ===== FIREBASE FUNCTIONS =====
        function updateFirebaseStatus(status, message) {
            const statusElement = document.getElementById('firebaseStatus');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `firebase-status ${status}`;
                
                if (status === 'success' || status === 'error') {
                    setTimeout(() => {
                        statusElement.classList.remove('success', 'error', 'syncing');
                    }, 3000);
                }
            }
        }

        async function syncVisitToFirebase(visitData) {
            if (!window.firebaseDB || !currentSalesmanId) {
                console.warn('üî• Firebase not initialized or no salesman ID');
                return false;
            }

            try {
                updateFirebaseStatus('syncing', 'üîÑ Syncing to Firebase...');
                
                const visitsRef = window.firebaseRef(window.firebaseDB, `visits/${currentSalesmanId}`);
                
                const visitDataWithTimestamp = {
                    ...visitData,
                    firebase_synced_at: window.firebaseServerTimestamp(),
                    firebase_sync_version: '1.1'
                };
                
                const newVisitRef = await window.firebasePush(visitsRef, visitDataWithTimestamp);
                
                console.log('üî• Visit data synced to Firebase:', newVisitRef.key);
                updateFirebaseStatus('success', '‚úÖ Synced to Firebase');
                
                await syncDailySummaryToFirebase(visitData);
                
                return newVisitRef.key;
                
            } catch (error) {
                console.error('üî• Firebase sync error:', error);
                updateFirebaseStatus('error', '‚ùå Firebase sync failed');
                return false;
            }
        }

        // ‚úÖ NEW FUNCTION: Update existing visit in Firebase
        async function updateVisitInFirebase(firebaseKey, updateData) {
            if (!window.firebaseDB || !currentSalesmanId || !firebaseKey) {
                console.warn('üî• Cannot update - missing Firebase DB, salesman ID, or Firebase key');
                return false;
            }

            try {
                updateFirebaseStatus('syncing', 'üîÑ Updating Firebase...');
                
                const visitRef = window.firebaseRef(window.firebaseDB, `visits/${currentSalesmanId}/${firebaseKey}`);
                
                const updateDataWithTimestamp = {
                    ...updateData,
                    firebase_updated_at: window.firebaseServerTimestamp(),
                    firebase_sync_version: '1.1'
                };
                
                // Get existing data first
                const snapshot = await window.firebaseGet(visitRef);
                if (snapshot.exists()) {
                    const existingData = snapshot.val();
                    // Merge with existing data
                    const mergedData = {
                        ...existingData,
                        ...updateDataWithTimestamp
                    };
                    await window.firebaseSet(visitRef, mergedData);
                    console.log('üî• Visit updated in Firebase:', firebaseKey);
                    updateFirebaseStatus('success', '‚úÖ Updated in Firebase');
                    return true;
                } else {
                    console.warn('üî• Visit not found in Firebase, creating new');
                    await window.firebaseSet(visitRef, updateDataWithTimestamp);
                    return true;
                }
                
            } catch (error) {
                console.error('üî• Firebase update error:', error);
                updateFirebaseStatus('error', '‚ùå Firebase update failed');
                return false;
            }
        }

        async function syncDailySummaryToFirebase(visitData) {
            try {
                // Skip summary update for started visits (only update on completion)
                if (visitData.visit_status === 'started') {
                    console.log('üî• Skipping daily summary update for started visit');
                    return;
                }
                
                const today = new Date().toISOString().split('T')[0];
                const summaryRef = window.firebaseRef(window.firebaseDB, `daily_summary/${currentSalesmanId}/${today}`);
                
                const snapshot = await window.firebaseGet(summaryRef);
                const existingSummary = snapshot.exists() ? snapshot.val() : {};
                
                // Validate and sanitize duration value
                const visitDuration = Number(visitData.total_duration_seconds) || 0;
                const existingDuration = Number(existingSummary.total_duration_seconds) || 0;
                const newTotalDuration = existingDuration + visitDuration;
                
                // Validate final value
                if (isNaN(newTotalDuration)) {
                    console.error('üî• Invalid duration calculation:', {
                        visitDuration,
                        existingDuration,
                        newTotalDuration
                    });
                    return;
                }
                
                const updatedSummary = {
                    salesman_id: currentSalesmanId,
                    salesman_name: currentSalesman,
                    date: today,
                    total_visits: (existingSummary.total_visits || 0) + 1,
                    total_duration_seconds: newTotalDuration,
                    visits_with_so: (existingSummary.visits_with_so || 0) + (visitData.order_status === 'ada_so' ? 1 : 0),
                    total_so_amount: (existingSummary.total_so_amount || 0) + (Number(visitData.so_amount) || 0),
                    visits_with_pauses: (existingSummary.visits_with_pauses || 0) + (visitData.pause_count > 0 ? 1 : 0),
                    total_pause_time: (existingSummary.total_pause_time || 0) + (Number(visitData.total_pause_duration) || 0),
                    last_updated: window.firebaseServerTimestamp()
                };
                
                await window.firebaseSet(summaryRef, updatedSummary);
                console.log('üî• Daily summary updated in Firebase');
                
            } catch (error) {
                console.error('üî• Daily summary sync error:', error);
            }
        }

        function getCurrentLocation() {
            updateLocationStatus('loading', 'üìç Getting location...');
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date().toISOString()
                    };
                    
                    console.log('üìç Location obtained:', currentLocation);
                    updateLocationStatus('success', 'üìç Location ready');
                },
                (error) => {
                    console.error('üìç Location error:', error);
                    updateLocationStatus('error', '‚ùå Location failed');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000
                }
            );
        }

        function startLocationTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
            
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    currentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date().toISOString()
                    };
                    
                    if (visitSession.isActive && !visitSession.isPaused) {
                        updateLocationStatus('success', 'üìç Tracking active');
                    }
                    
                    updateEnhancedLocationStatus();
                },
                (error) => {
                    console.warn('üìç Location tracking error:', error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 60000
                }
            );
        }

        function updateLocationStatus(status, message) {
            // Keep for compatibility
        }

        // ===== PAUSE/RESUME VISIT FUNCTIONS =====
        function showPauseVisitModal() {
            if (!visitSession.isActive || visitSession.isPaused) {
                console.warn('üö´ Cannot pause - no active session or already paused');
                return;
            }
            
            const duration = Math.floor(visitSession.accumulatedDuration + (Date.now() - visitSession.startTime) / 1000);
            const durationText = formatDuration(duration);
            
            document.getElementById('pauseModalCustomerName').textContent = visitSession.outletName;
            document.getElementById('pauseModalCustomerDetails').textContent = `Durasi saat ini: ${durationText}`;
            document.getElementById('pauseCurrentDuration').textContent = `${Math.floor(duration / 60)} menit`;
            
            document.getElementById('visitPauseModal').classList.add('show');
            
            console.log(`‚è∏Ô∏è Showing pause modal for: ${visitSession.outletName}`);
        }

        function cancelPauseVisit() {
            document.getElementById('visitPauseModal').classList.remove('show');
            console.log('‚ùå Pause cancelled, continuing visit');
        }

        async function confirmPauseVisit() {
            if (!visitSession.isActive || visitSession.isPaused) {
                console.warn('üö´ Cannot pause - invalid session state');
                return;
            }
            
            console.log(`‚è∏Ô∏è Pausing visit to: ${visitSession.outletName}`);
            
            // Calculate current session duration
            const currentSessionDuration = Math.floor((Date.now() - visitSession.startTime) / 1000);
            visitSession.accumulatedDuration += currentSessionDuration;
            visitSession.isPaused = true;
            visitSession.pauseTime = Date.now();
            
            // Add pause event to history
            visitSession.pauseHistory.push({
                type: 'pause',
                timestamp: new Date().toISOString(),
                location: { ...currentLocation },
                session_duration: currentSessionDuration,
                accumulated_duration: visitSession.accumulatedDuration
            });
            
            // Store paused visit data
            const pausedVisitData = {
                ...visitSession,
                paused_at: new Date().toISOString(),
                pause_location: { ...currentLocation }
            };
            
            pausedVisits.set(visitSession.outletName.toLowerCase(), pausedVisitData);
            savePausedVisitsToLocal();
            
            // IMPORTANT: Remove from visited customers since visit is not completed
            todayVisitedCustomers.delete(visitSession.outletName.toLowerCase());
            removeFromLocalVisitedStorage(visitSession.outletName);
            
            // Stop timer and update UI
            stopSessionTimer();
            visitSession.isActive = false; // Mark as inactive but keep data
            updateVisitSessionStatus();
            updateFloatingButtons();
            updateCustomerListPauseStatus();
            
            // Reset outlet selection
            const pelangganSelect = document.getElementById('pelanggan');
            if (pelangganSelect) {
                pelangganSelect.value = '';
                handlePelangganSelection();
            }
            
            document.getElementById('visitPauseModal').classList.remove('show');
            
            console.log(`‚úÖ Visit paused successfully. Accumulated duration: ${formatDuration(visitSession.accumulatedDuration)}`);
            
            // Save pause event to localStorage
            savePauseEventToLocal('pause', pausedVisitData);
            
            // ‚úÖ UPDATE STATUS TO 'PAUSED' IN FIREBASE
            if (visitSession.firebaseKey) {
                const pauseUpdateData = {
                    visit_status: 'paused',
                    paused_at: new Date().toISOString(),
                    pause_count: visitSession.pauseHistory.filter(e => e.type === 'pause').length,
                    total_pause_duration: calculateTotalPauseDuration(visitSession.pauseHistory),
                    pause_history: visitSession.pauseHistory,
                    pause_location: { ...currentLocation },
                    accumulated_duration: visitSession.accumulatedDuration
                };
                
                const updated = await updateVisitInFirebase(visitSession.firebaseKey, pauseUpdateData);
                if (updated) {
                    console.log('üî• Visit status updated to PAUSED in Firebase');
                } else {
                    console.log('‚è≥ Pause update will be synced later');
                }
            } else {
                console.warn('‚ö†Ô∏è No Firebase key found for this visit, cannot update pause status');
            }
        }
        
        // Helper function to calculate total pause duration
        function calculateTotalPauseDuration(pauseHistory) {
            let totalPauseDuration = 0;
            for (let i = 0; i < pauseHistory.length - 1; i += 2) {
                const pauseEvent = pauseHistory[i];
                const resumeEvent = pauseHistory[i + 1];
                
                if (pauseEvent && pauseEvent.type === 'pause' && resumeEvent && resumeEvent.type === 'resume') {
                    const pauseTime = new Date(pauseEvent.timestamp).getTime();
                    const resumeTime = new Date(resumeEvent.timestamp).getTime();
                    totalPauseDuration += (resumeTime - pauseTime) / 1000;
                }
            }
            return totalPauseDuration;
        }

        function showResumeVisitModal(outletName) {
            const pausedVisit = pausedVisits.get(outletName.toLowerCase());
            if (!pausedVisit) {
                console.warn('üö´ No paused visit found for:', outletName);
                return;
            }
            
            const pauseTime = new Date(pausedVisit.paused_at);
            const startTime = new Date(pausedVisit.startTime);
            const accumulatedDuration = pausedVisit.accumulatedDuration || 0;
            
            document.getElementById('resumeModalCustomerName').textContent = outletName;
            document.getElementById('resumeModalCustomerDetails').textContent = `Hari JKS: ${pausedVisit.pendingHari || 'Unknown'}`;
            document.getElementById('resumeStartTime').textContent = startTime.toLocaleTimeString('id-ID');
            document.getElementById('resumePauseTime').textContent = pauseTime.toLocaleTimeString('id-ID');
            document.getElementById('resumePrevDuration').textContent = formatDuration(accumulatedDuration);
            
            document.getElementById('visitResumeModal').classList.add('show');
            
            console.log(`üîÑ Showing resume modal for: ${outletName}`);
        }

        function startNewVisit() {
            const outletName = visitSession.pendingOutlet;
            
            // Remove paused visit
            pausedVisits.delete(outletName.toLowerCase());
            savePausedVisitsToLocal();
            updateCustomerListPauseStatus();
            
            // Clear pending data and start fresh
            visitSession.pendingOutlet = null;
            visitSession.pendingHari = null;
            
            document.getElementById('visitResumeModal').classList.remove('show');
            
            // Start new visit
            const hariSelect = document.getElementById('hari');
            startVisitSession(outletName, hariSelect.value);
            
            console.log(`üÜï Starting new visit for: ${outletName}`);
        }

        async function confirmResumeVisit() {
            const outletName = visitSession.pendingOutlet;
            const pausedVisit = pausedVisits.get(outletName.toLowerCase());
            
            if (!pausedVisit) {
                console.error('‚ùå Cannot resume - paused visit data not found');
                return;
            }
            
            console.log(`‚ñ∂Ô∏è Resuming visit to: ${outletName}`);
            
            // Restore visit session from paused data
            visitSession.isActive = true;
            visitSession.isPaused = false;
            visitSession.outletId = pausedVisit.outletId;
            visitSession.outletName = pausedVisit.outletName;
            visitSession.startTime = Date.now(); // New start time for this session
            visitSession.sessionId = pausedVisit.sessionId;
            visitSession.accumulatedDuration = pausedVisit.accumulatedDuration || 0;
            visitSession.startLocation = pausedVisit.startLocation;
            visitSession.pauseHistory = pausedVisit.pauseHistory || [];
            visitSession.resumeTime = Date.now();
            visitSession.firebaseKey = pausedVisit.firebaseKey || null; // ‚úÖ Restore Firebase key
            
            // Add resume event to history
            visitSession.pauseHistory.push({
                type: 'resume',
                timestamp: new Date().toISOString(),
                location: { ...currentLocation },
                pause_duration: Math.floor((Date.now() - new Date(pausedVisit.paused_at).getTime()) / 1000)
            });
            
            // Clear pending data
            visitSession.pendingOutlet = null;
            visitSession.pendingHari = null;
            
            // Update UI
            updateVisitSessionStatus();
            startSessionTimer();
            updateFloatingButtons();
            
            document.getElementById('visitResumeModal').classList.remove('show');
            
            console.log(`‚úÖ Visit resumed successfully. Previous duration: ${formatDuration(visitSession.accumulatedDuration)}`);
            
            // Save resume event to localStorage
            savePauseEventToLocal('resume', visitSession);
            
            // ‚úÖ UPDATE STATUS TO 'RESUMED' IN FIREBASE
            if (visitSession.firebaseKey) {
                const resumeUpdateData = {
                    visit_status: 'resumed',
                    resumed_at: new Date().toISOString(),
                    pause_count: visitSession.pauseHistory.filter(e => e.type === 'pause').length,
                    resume_count: visitSession.pauseHistory.filter(e => e.type === 'resume').length,
                    total_pause_duration: calculateTotalPauseDuration(visitSession.pauseHistory),
                    pause_history: visitSession.pauseHistory,
                    resume_location: { ...currentLocation }
                };
                
                const updated = await updateVisitInFirebase(visitSession.firebaseKey, resumeUpdateData);
                if (updated) {
                    console.log('üî• Visit status updated to RESUMED in Firebase');
                } else {
                    console.log('‚è≥ Resume update will be synced later');
                }
            } else {
                console.warn('‚ö†Ô∏è No Firebase key found for this visit, cannot update resume status');
            }
        }

        // ===== LOCAL STORAGE FOR PAUSED VISITS =====
        function loadPausedVisitsFromLocal() {
            if (!currentSalesmanId) return;
            
            try {
                const pausedKey = `paused_visits_${currentSalesmanId}`;
                const pausedData = localStorage.getItem(pausedKey);
                
                if (pausedData) {
                    const parsed = JSON.parse(pausedData);
                    pausedVisits = new Map(Object.entries(parsed));
                    console.log(`üìã Loaded ${pausedVisits.size} paused visits from local storage`);
                    updateCustomerListPauseStatus();
                }
            } catch (error) {
                console.error('‚ùå Error loading paused visits:', error);
                pausedVisits = new Map();
            }
        }

        function savePausedVisitsToLocal() {
            if (!currentSalesmanId) return;
            
            try {
                const pausedKey = `paused_visits_${currentSalesmanId}`;
                const pausedData = Object.fromEntries(pausedVisits);
                localStorage.setItem(pausedKey, JSON.stringify(pausedData));
                console.log('üíæ Paused visits saved to localStorage');
            } catch (error) {
                console.error('‚ùå Error saving paused visits:', error);
            }
        }

        function savePauseEventToLocal(eventType, sessionData) {
            try {
                const eventKey = `pause_events_${currentSalesmanId}`;
                const existingEvents = JSON.parse(localStorage.getItem(eventKey) || '[]');
                
                const pauseEvent = {
                    event_type: eventType,
                    timestamp: new Date().toISOString(),
                    outlet_name: sessionData.outletName,
                    session_id: sessionData.sessionId,
                    accumulated_duration: sessionData.accumulatedDuration || 0,
                    location: { ...currentLocation }
                };
                
                existingEvents.push(pauseEvent);
                localStorage.setItem(eventKey, JSON.stringify(existingEvents));
                
                console.log(`üíæ Pause event (${eventType}) saved to localStorage`);
            } catch (error) {
                console.error('‚ùå Error saving pause event:', error);
            }
        }

        function updateCustomerListPauseStatus() {
            const pelangganSelect = document.getElementById('pelanggan');
            if (!pelangganSelect) return;
            
            Array.from(pelangganSelect.options).forEach(option => {
                if (option.value && pausedVisits.has(option.value.toLowerCase())) {
                    option.textContent = `${option.value} ‚è∏Ô∏è (Kunjungan tertunda)`;
                    option.classList.add('customer-paused');
                    option.style.color = '#f59e0b';
                    option.style.backgroundColor = '#fef3c7';
                }
            });
        }

        function isPausedVisit(customerName) {
            return pausedVisits.has(customerName.toLowerCase());
        }

        // ===== PELANGGAN TIDAK AKTIF MANAGEMENT =====
        function getInactiveCustomers() {
            try {
                const data = localStorage.getItem('inactiveCustomers');
                return data ? JSON.parse(data) : [];
            } catch (error) {
                console.error('‚ùå Error loading inactive customers:', error);
                return [];
            }
        }

        function saveInactiveCustomer(customerId, customerName, reason) {
            let inactiveCustomers = getInactiveCustomers();
            let exists = inactiveCustomers.find(c => c.id === customerId || c.name === customerName);
            if (!exists) {
                inactiveCustomers.push({
                    id: customerId,
                    name: customerName,
                    reason: reason,
                    date: new Date().toISOString(),
                    salesman_id: currentSalesmanId
                });
                try {
                    localStorage.setItem('inactiveCustomers', JSON.stringify(inactiveCustomers));
                    console.log('üî¥ Customer marked as INACTIVE: ' + customerName + ' (Reason: ' + reason + ')');
                    return true;
                } catch (error) {
                    console.error('‚ùå Error saving inactive customer:', error);
                    return false;
                }
            }
            return false;
        }

        function removeInactiveCustomer(customerName) {
            let inactiveCustomers = getInactiveCustomers();
            inactiveCustomers = inactiveCustomers.filter(c => c.name !== customerName && c.name.toLowerCase() !== customerName.toLowerCase());
            try {
                localStorage.setItem('inactiveCustomers', JSON.stringify(inactiveCustomers));
                console.log('‚úÖ Customer removed from inactive list: ' + customerName);
                updateCustomerListInactiveStatus();
                return true;
            } catch (error) {
                console.error('‚ùå Error removing inactive customer:', error);
                return false;
            }
        }

        function updateCustomerListInactiveStatus() {
            const pelangganSelect = document.getElementById('pelanggan');
            if (!pelangganSelect) return;
            const inactiveCustomers = getInactiveCustomers();
            const inactiveNames = inactiveCustomers.map(c => c.name.toLowerCase());
            Array.from(pelangganSelect.options).forEach(option => {
                option.classList.remove('customer-inactive-option');
                if (option.textContent.includes(' üî¥ [TIDAK AKTIF]')) {
                    option.textContent = option.textContent.replace(' üî¥ [TIDAK AKTIF]', '');
                }
            });
            Array.from(pelangganSelect.options).forEach(option => {
                if (option.value && inactiveNames.includes(option.value.toLowerCase())) {
                    option.classList.add('customer-inactive-option');
                    option.style.color = '#dc2626';
                    option.style.backgroundColor = '#fee2e2';
                    option.style.fontWeight = '600';
                    if (!option.textContent.includes(' üî¥ [TIDAK AKTIF]')) {
                        option.textContent = option.value + ' üî¥ [TIDAK AKTIF]';
                    }
                }
            });
            console.log('üî¥ Updated inactive status for ' + inactiveNames.length + ' customers');
        }

        function isCustomerInactive(customerName) {
            const inactiveCustomers = getInactiveCustomers();
            return inactiveCustomers.some(c => c.name.toLowerCase() === customerName.toLowerCase());
        }

        function getInactiveCustomerInfo(customerName) {
            const inactiveCustomers = getInactiveCustomers();
            return inactiveCustomers.find(c => c.name.toLowerCase() === customerName.toLowerCase());
        }

        // ===== VISIT SESSION MANAGEMENT =====
        function loadTodayVisitedCustomers() {
            const today = new Date().toISOString().split('T')[0];
            const visitKey = `visited_${currentSalesmanId}_${today}`;
            const storedVisits = localStorage.getItem(visitKey);
            
            if (storedVisits) {
                try {
                    const visits = JSON.parse(storedVisits);
                    todayVisitedCustomers = new Set();
                    
                    visits.forEach(visit => {
                        if (typeof visit === 'string') {
                            // Legacy format: treat as completed visit
                            todayVisitedCustomers.add(visit.toLowerCase());
                        } else if (visit && visit.outlet_name) {
                            // New format: only add if visit is completed
                            if (visit.visit_completed === true) {
                                todayVisitedCustomers.add(visit.outlet_name.toLowerCase());
                            }
                        }
                    });
                    
                    console.log(`üìã Loaded ${todayVisitedCustomers.size} completed visits from local storage`);
                    updateCustomerListVisitStatus();
                } catch (error) {
                    console.error('‚ùå Error parsing localStorage visits:', error);
                    localStorage.removeItem(visitKey);
                    todayVisitedCustomers = new Set();
                }
            } else {
                console.log('üìã No completed visits today yet');
            }
        }

        function markCustomerAsVisited(outletName, sessionId, isCompleted = false) {
            // Only mark as visited if the visit is completed, not just started
            if (isCompleted) {
                todayVisitedCustomers.add(outletName.toLowerCase());
                
                const today = new Date().toISOString().split('T')[0];
                const visitKey = `visited_${currentSalesmanId}_${today}`;
                
                try {
                    const existingVisits = JSON.parse(localStorage.getItem(visitKey) || '[]');
                    
                    const visitRecord = {
                        outlet_name: outletName,
                        outlet_id: visitSession.outletId,
                        session_id: sessionId,
                        visit_time: new Date().toISOString(),
                        visit_completed: true,
                        order_status: visitSession.orderStatus || 'toko_tidak_order',  // ‚úÖ ADDED
                        so_amount: visitSession.soAmount || 0,  // ‚úÖ ADDED
                        salesman_id: currentSalesmanId,
                        salesman_name: currentSalesman
                    };
                    
                    console.log(`üìã Outlet ${outletName} marked as completed visit locally`);
                    console.log(`   Status: ${visitRecord.order_status}, SO Amount: ${visitRecord.so_amount}`);
                    existingVisits.push(visitRecord);
                    localStorage.setItem(visitKey, JSON.stringify(existingVisits));
                    
                } catch (error) {
                    console.error('‚ùå Error saving to localStorage:', error);
                }
            } else {
                console.log(`üìã Outlet ${outletName} visit started but not marked as completed yet`);
            }
        }

        function isCustomerAlreadyVisited(customerName) {
            // Check if customer has a completed visit today
            const hasCompletedVisit = todayVisitedCustomers.has(customerName.toLowerCase());
            
            // Check if customer has a paused visit (paused visits should be resumable)
            const hasPausedVisit = isPausedVisit(customerName);
            
            // Allow access if it's a paused visit, block if it's a completed visit
            if (hasPausedVisit) {
                console.log(`üìã ${customerName} has paused visit - allowing access`);
                return false; // Allow access to paused visits
            }
            
            return hasCompletedVisit;
        }

        function removeFromLocalVisitedStorage(outletName) {
            const today = new Date().toISOString().split('T')[0];
            const visitKey = `visited_${currentSalesmanId}_${today}`;
            
            try {
                const existingVisits = JSON.parse(localStorage.getItem(visitKey) || '[]');
                
                // Remove any incomplete visits for this outlet
                const filteredVisits = existingVisits.filter(visit => {
                    const visitOutlet = typeof visit === 'string' ? visit : visit.outlet_name;
                    return visitOutlet && visitOutlet.toLowerCase() !== outletName.toLowerCase() || visit.visit_completed === true;
                });
                
                localStorage.setItem(visitKey, JSON.stringify(filteredVisits));
                console.log(`üìã Removed incomplete visit for ${outletName} from localStorage`);
                
            } catch (error) {
                console.error('‚ùå Error removing from localStorage:', error);
            }
        }

        function updateCustomerListVisitStatus() {
            const pelangganSelect = document.getElementById('pelanggan');
            if (!pelangganSelect) return;
            
            Array.from(pelangganSelect.options).forEach(option => {
                // Reset option styling first
                option.disabled = false;
                option.classList.remove('customer-paused');
                option.style.color = '';
                option.style.backgroundColor = '';
                
                if (option.value) {
                    const outletName = option.value;
                    const isCompleted = isCustomerAlreadyVisited(outletName);
                    const isPaused = isPausedVisit(outletName);
                    
                    if (isCompleted) {
                        // Completed visit - block access
                        option.textContent = `${outletName} ‚úÖ (Sudah dikunjungi)`;
                        option.disabled = true;
                        option.style.color = '#10b981';
                        option.style.backgroundColor = '#f0fdf4';
                    } else if (isPaused) {
                        // Paused visit - allow access with indicator
                        option.textContent = `${outletName} ‚è∏Ô∏è (Kunjungan tertunda)`;
                        option.classList.add('customer-paused');
                        option.style.color = '#f59e0b';
                        option.style.backgroundColor = '#fef3c7';
                    } else {
                        // Reset to original name if no special status
                        option.textContent = outletName;
                    }
                }
            });
        }

        // ===== VISIT MODAL FUNCTIONS =====
        function showVisitStartModal(outletName, hariJKS) {
            // Check if this outlet has a paused visit
            if (isPausedVisit(outletName)) {
                visitSession.pendingOutlet = outletName;
                visitSession.pendingHari = hariJKS;
                showResumeVisitModal(outletName);
                return;
            }
            
            visitSession.pendingOutlet = outletName;
            visitSession.pendingHari = hariJKS;
            
            document.getElementById('startModalCustomerName').textContent = outletName;
            document.getElementById('startModalCustomerDetails').textContent = `Hari JKS: ${hariJKS}`;
            document.getElementById('visitStartModal').classList.add('show');
            
            console.log(`üè™ Showing start modal for: ${outletName}`);
        }

        function cancelVisitStart() {
            document.getElementById('visitStartModal').classList.remove('show');
            
            const pelangganSelect = document.getElementById('pelanggan');
            if (pelangganSelect) {
                pelangganSelect.value = '';
                handlePelangganSelection();
            }
            
            visitSession.pendingOutlet = null;
            visitSession.pendingHari = null;
            
            console.log('‚ùå Visit start cancelled');
        }

        function confirmVisitStart() {
            const outletName = visitSession.pendingOutlet;
            const hariJKS = visitSession.pendingHari;

            console.log(`üöÄ Starting visit confirmation for: ${outletName}`);

            if (isCustomerAlreadyVisited(outletName)) {
                alert(`‚ùå Error: Outlet "${outletName}" sudah dikunjungi hari ini!\n\nSistem mencegah duplikasi kunjungan.`);
                cancelVisitStart();
                return;
            }

            document.getElementById('visitStartModal').classList.remove('show');
            startVisitSession(outletName, hariJKS);
            
            visitSession.pendingOutlet = null;
            visitSession.pendingHari = null;
        }

        function showVisitEndModal() {
            if (!visitSession.isActive || visitSession.isPaused) {
                console.warn('üö´ End modal blocked - no active session or paused');
                return;
            }
            
            const currentSessionDuration = Math.floor((Date.now() - visitSession.startTime) / 1000);
            const totalDuration = visitSession.accumulatedDuration + currentSessionDuration;
            const durationText = formatDuration(totalDuration);
            
            document.getElementById('endModalCustomerName').textContent = visitSession.outletName;
            document.getElementById('endModalCustomerDetails').textContent = `Total Durasi: ${durationText}`;
            
            // Reset order status form
            document.getElementById('orderStatusSelect').value = '';
            document.getElementById('soAmountInput').value = '';
            document.getElementById('soAmountSection').classList.remove('show');
            document.getElementById('endVisitBtn').disabled = true;
            
            document.getElementById('visitEndModal').classList.add('show');
            
            console.log(`üèÅ Showing end modal for: ${visitSession.outletName}`);
        }

        function toggleSOAmountInput() {
            const orderStatus = document.getElementById('orderStatusSelect').value;
            const soAmountSection = document.getElementById('soAmountSection');
            const endVisitBtn = document.getElementById('endVisitBtn');
            
            if (orderStatus === 'ada_so') {
                soAmountSection.classList.add('show');
                endVisitBtn.disabled = false;
            } else if (orderStatus === 'toko_tidak_order' || orderStatus === 'toko_tutup') {
                soAmountSection.classList.remove('show');
                endVisitBtn.disabled = false;
            } else {
                soAmountSection.classList.remove('show');
                endVisitBtn.disabled = true;
            }
        }

        function cancelVisitEnd() {
            document.getElementById('visitEndModal').classList.remove('show');
            console.log('‚ùå Visit end cancelled, continuing visit');
        }

        function confirmVisitEnd() {
            const orderStatus = document.getElementById('orderStatusSelect').value;
            const soAmount = parseInt(unformatRupiah(document.getElementById('soAmountInput').value) || '0');
            
            if (!orderStatus) {
                alert('‚ùå Pilih status kunjungan terlebih dahulu!');
                return;
            }
            
            if (orderStatus === 'ada_so' && (!soAmount || parseFloat(soAmount) <= 0)) {
                alert('‚ùå Masukkan nominal Sales Order yang valid!');
                return;
            }
            
            visitSession.orderStatus = orderStatus;
            visitSession.soAmount = orderStatus === 'ada_so' ? parseFloat(soAmount) : 0;
            
            // ‚úÖ TANDAI PELANGGAN TIDAK AKTIF
            if (orderStatus === 'toko_tutup' || orderStatus === 'toko_tidak_order') {
                const outletName = visitSession.outletName;
                const outletId = visitSession.outletId;
                if (outletName) {
                    const reasonText = orderStatus === 'toko_tutup' ? 'Toko Tutup' : 'Toko Tidak Order';
                    saveInactiveCustomer(outletId, outletName, reasonText);
                }
            }
            
            document.getElementById('visitEndModal').classList.remove('show');
            endVisitSession();
        }

        async function startVisitSession(outletName, hariJKS) {
            if (visitSession.isActive) {
                await endVisitSession();
            }
            
            const outletRecord = detailsData.find(item => {
                const itemPelanggan = (item['Nama Pelanggan'] || '').toString().trim();
                return itemPelanggan.toLowerCase() === outletName.toLowerCase();
            });
            
            const outletId = outletRecord ? outletRecord['Id Pelanggan'] : `OUTLET_${Date.now()}`;
            const sessionId = `visit_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            const startLocation = {
                latitude: currentLocation.latitude,
                longitude: currentLocation.longitude,
                accuracy: currentLocation.accuracy,
                timestamp: new Date().toISOString()
            };
            
            visitSession.isActive = true;
            visitSession.isPaused = false;
            visitSession.outletId = outletId;
            visitSession.outletName = outletName;
            visitSession.startTime = Date.now();
            visitSession.endTime = null;
            visitSession.duration = 0;
            visitSession.accumulatedDuration = 0;
            visitSession.sessionId = sessionId;
            visitSession.startLocation = startLocation;
            visitSession.endLocation = null;
            visitSession.orderStatus = null;
            visitSession.soAmount = null;
            visitSession.pauseHistory = [];
            visitSession.firebaseKey = null; // Store Firebase key for updates
            
            // Mark as started but NOT completed yet
            markCustomerAsVisited(outletName, sessionId, false);
            
            updateVisitSessionStatus();
            startSessionTimer();
            updateFloatingButtons();
            
            console.log(`‚úÖ Visit session started: ${outletName} (ID: ${outletId})`);
            
            // Prepare data for Firebase
            const visitDataForFirebase = {
                outlet_id: outletId,
                outlet_name: outletName,
                hari_jks: hariJKS,
                session_id: sessionId,
                start_time: new Date().toISOString(),
                start_location: startLocation,
                visit_status: 'started', // ‚úÖ CRITICAL: Track started status
                pause_count: 0,
                total_pause_duration: 0,
                pause_history: [],
                salesman_id: currentSalesmanId,
                salesman_name: currentSalesman,
                created_at: new Date().toISOString(),
                local_id: `local_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
            };
            
            // Save to localStorage
            saveVisitSessionToLocal('session_start', visitDataForFirebase);
            
            // ‚úÖ SAVE TO FIREBASE IMMEDIATELY (status: started)
            const firebaseKey = await syncVisitToFirebase(visitDataForFirebase);
            
            if (firebaseKey) {
                visitSession.firebaseKey = firebaseKey; // Store key for future updates
                console.log(`üî• Visit started and saved to Firebase: ${firebaseKey}`);
            } else {
                console.log('‚è≥ Visit will be synced to Firebase later');
                saveToPendingFirebaseQueue(visitDataForFirebase);
            }
        }

        async function endVisitSession() {
            if (!visitSession.isActive) {
                console.warn('üö´ Cannot end session - not active');
                return;
            }
            
            const endLocation = {
                latitude: currentLocation.latitude,
                longitude: currentLocation.longitude,
                accuracy: currentLocation.accuracy,
                timestamp: new Date().toISOString()
            };
            
            const endTime = Date.now();
            const currentSessionDuration = Math.floor((endTime - visitSession.startTime) / 1000);
            const totalDuration = visitSession.accumulatedDuration + currentSessionDuration;
            
            visitSession.endTime = endTime;
            visitSession.duration = totalDuration;
            visitSession.endLocation = endLocation;
            
            // Calculate total pause time
            let totalPauseDuration = 0;
            let pauseCount = 0;
            
            for (let i = 0; i < visitSession.pauseHistory.length - 1; i += 2) {
                const pauseEvent = visitSession.pauseHistory[i];
                const resumeEvent = visitSession.pauseHistory[i + 1];
                
                if (pauseEvent && pauseEvent.type === 'pause' && resumeEvent && resumeEvent.type === 'resume') {
                    const pauseTime = new Date(pauseEvent.timestamp).getTime();
                    const resumeTime = new Date(resumeEvent.timestamp).getTime();
                    totalPauseDuration += (resumeTime - pauseTime) / 1000;
                    pauseCount++;
                }
            }
            
            console.log(`üèÅ Ending visit session: ${visitSession.outletName} (total duration: ${formatDuration(totalDuration)})`);
            
            // NOW mark as completed visit
            markCustomerAsVisited(visitSession.outletName, visitSession.sessionId, true);
            
            const visitDataForFirebase = {
                outlet_id: visitSession.outletId,
                outlet_name: visitSession.outletName,
                session_id: visitSession.sessionId,
                start_time: new Date(visitSession.startTime - visitSession.accumulatedDuration * 1000).toISOString(),
                end_time: new Date(endTime).toISOString(),
                total_duration_seconds: totalDuration,
                active_duration_seconds: totalDuration, // Time actually spent in store
                pause_count: pauseCount,
                total_pause_duration: totalPauseDuration,
                pause_history: visitSession.pauseHistory,
                start_location: visitSession.startLocation,
                end_location: endLocation,
                order_status: visitSession.orderStatus,
                so_amount: visitSession.soAmount || 0,
                visit_status: 'completed',
                salesman_id: currentSalesmanId,
                salesman_name: currentSalesman,
                created_at: new Date().toISOString(),
                local_id: `local_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
            };
            
            // Remove from paused visits if it was there
            pausedVisits.delete(visitSession.outletName.toLowerCase());
            savePausedVisitsToLocal();
            
            saveVisitSessionToLocal('session_end', visitDataForFirebase);
            
            // ‚úÖ UPDATE OR CREATE IN FIREBASE
            let firebaseSuccess = false;
            if (visitSession.firebaseKey) {
                // Update existing visit
                console.log(`üî• Updating existing visit in Firebase: ${visitSession.firebaseKey}`);
                firebaseSuccess = await updateVisitInFirebase(visitSession.firebaseKey, visitDataForFirebase);
            } else {
                // Create new visit (fallback for visits without initial sync)
                console.log('üî• Creating new visit in Firebase (no initial key)');
                const firebaseKey = await syncVisitToFirebase(visitDataForFirebase);
                firebaseSuccess = !!firebaseKey;
            }
            
            if (!firebaseSuccess) {
                console.log('‚è≥ Adding visit to pending Firebase sync queue...');
                saveToPendingFirebaseQueue(visitDataForFirebase);
            }
            
            // Also update daily summary
            if (firebaseSuccess) {
                await syncDailySummaryToFirebase(visitDataForFirebase);
            }
            
            // Reset session
            const endedOutlet = visitSession.outletName;
            const endedFirebaseKey = visitSession.firebaseKey; // Save for logging
            
            visitSession.isActive = false;
            visitSession.isPaused = false;
            visitSession.outletId = null;
            visitSession.outletName = null;
            visitSession.startTime = null;
            visitSession.endTime = null;
            visitSession.duration = 0;
            visitSession.accumulatedDuration = 0;
            visitSession.sessionId = null;
            visitSession.startLocation = null;
            visitSession.endLocation = null;
            visitSession.orderStatus = null;
            visitSession.soAmount = null;
            visitSession.pauseHistory = [];
            visitSession.firebaseKey = null;
            
            updateVisitSessionStatus();
            stopSessionTimer();
            updateFloatingButtons();
            updateCustomerListPauseStatus();
            updateCustomerListVisitStatus();
            updateCustomerListInactiveStatus();
            
            console.log(`‚úÖ Visit session ended successfully: ${endedOutlet}, total duration: ${formatDuration(totalDuration)}`);
            if (endedFirebaseKey) {
                console.log(`üî• Firebase key: ${endedFirebaseKey} - Status updated to COMPLETED`);
            }
        }

        function saveToPendingFirebaseQueue(visitData) {
            try {
                const pendingKey = `pending_firebase_visits_${currentSalesmanId}`;
                const existingPending = JSON.parse(localStorage.getItem(pendingKey) || '[]');
                
                existingPending.push(visitData);
                localStorage.setItem(pendingKey, JSON.stringify(existingPending));
                
                console.log('‚è≥ Visit saved to pending Firebase sync queue');
                updateFirebaseStatus('syncing', `‚è≥ ${existingPending.length} visits pending sync`);
                
            } catch (error) {
                console.error('‚ùå Error saving to pending queue:', error);
            }
        }

        function saveVisitSessionToLocal(eventType, sessionData) {
            try {
                const sessionKey = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const sessionRecord = {
                    event_type: eventType,
                    session_key: sessionKey,
                    timestamp: new Date().toISOString(),
                    ...sessionData
                };
                
                const keys = [
                    `visit_sessions_${currentSalesmanId}`,
                    `daily_sessions_${currentSalesmanId}_${new Date().toISOString().split('T')[0]}`
                ];
                
                keys.forEach(key => {
                    const existingSessions = JSON.parse(localStorage.getItem(key) || '[]');
                    existingSessions.push(sessionRecord);
                    localStorage.setItem(key, JSON.stringify(existingSessions));
                });
                
                console.log(`üíæ Session ${eventType} saved to localStorage: ${sessionKey}`);
                return sessionKey;
                
            } catch (error) {
                console.error('üíæ Error saving to localStorage:', error);
                return null;
            }
        }

        // ===== SESSION TIMER FUNCTIONS =====
        function startSessionTimer() {
            if (sessionTimer) {
                clearInterval(sessionTimer);
            }
            
            sessionTimer = setInterval(() => {
                if (visitSession.isActive && !visitSession.isPaused && visitSession.startTime) {
                    const currentSessionDuration = Math.floor((Date.now() - visitSession.startTime) / 1000);
                    visitSession.duration = visitSession.accumulatedDuration + currentSessionDuration;
                    updateSessionTimerDisplay();
                }
            }, 1000);
        }

        function stopSessionTimer() {
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
            }
        }

        function updateSessionTimerDisplay() {
            const timerElement = document.getElementById('sessionTimer');
            if (timerElement) {
                timerElement.textContent = formatDuration(visitSession.duration);
            }
        }

        function updateVisitSessionStatus() {
            const statusElement = document.getElementById('visitSessionStatus');
            const customerElement = document.getElementById('sessionCustomerName');
            const timerElement = document.getElementById('sessionTimer');
            const statusTextElement = document.getElementById('sessionStatusText');
            
            if (visitSession.isActive) {
                if (visitSession.isPaused) {
                    statusElement.classList.remove('active');
                    statusElement.classList.add('paused');
                    customerElement.textContent = `üè™ ${visitSession.outletName}`;
                    timerElement.textContent = formatDuration(visitSession.duration);
                    statusTextElement.textContent = 'DITUNDA';
                } else {
                    statusElement.classList.remove('paused');
                    statusElement.classList.add('active');
                    customerElement.textContent = `üè™ ${visitSession.outletName}`;
                    timerElement.textContent = formatDuration(visitSession.duration);
                    statusTextElement.textContent = 'AKTIF';
                }
            } else {
                statusElement.classList.remove('active', 'paused');
                customerElement.textContent = 'No Active Visit';
                timerElement.textContent = '00:00:00';
                statusTextElement.textContent = '';
            }
        }

        function updateFloatingButtons() {
            const floatingActions = document.getElementById('floatingActions');
            
            if (visitSession.isActive && !visitSession.isPaused) {
                floatingActions.classList.add('show');
            } else {
                floatingActions.classList.remove('show');
            }
        }

        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function formatNumber(num) {
            const number = Number(num);
            if (isNaN(number)) return '0';
            
            if (Math.abs(number) >= 1000000) {
                return (number / 1000000).toFixed(1) + 'M';
            } else if (Math.abs(number) >= 1000) {
                return (number / 1000).toFixed(0) + 'K';
            }
            
            // Check if number is whole (integer)
            if (Number.isInteger(number)) {
                return number.toString();
            }
            
            // For decimal numbers, show only 1 decimal place
            return number.toFixed(1);
        }

        // ===== UTILITY FUNCTIONS =====
        function parseJSONL(content) {
            const lines = content.trim().split('\n');
            const data = [];
            
            lines.forEach((line, index) => {
                try {
                    if (line.trim()) {
                        const obj = JSON.parse(line.trim());
                        data.push(obj);
                    }
                } catch (error) {
                    console.error(`Error parsing line ${index + 1}:`, line, error);
                }
            });
            
            return data;
        }

        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        function normalizeHariFormat(hariString) {
            if (!hariString) return '';
            const cleanHari = hariString.toString().replace(/^\[\d+\]/, '').trim().toUpperCase();
            return cleanHari;
        }

        function getCurrentDayInIndonesian() {
            const days = ['MINGGU', 'SENIN', 'SELASA', 'RABU', 'KAMIS', 'JUMAT', 'SABTU'];
            const today = new Date();
            return days[today.getDay()];
        }

        function updateDayIndicator() {
            const currentDay = getCurrentDayInIndonesian();
            const dayIndicator = document.getElementById('dayIndicator');
            if (dayIndicator) {
                dayIndicator.textContent = `üìÖ ${currentDay}`;
            }
            console.log(`üìÖ Current day: ${currentDay}`);
            return currentDay;
        }

        function filterHariByCurrentDay(hariList, currentDay) {
            const filtered = hariList.filter(hari => {
                return hari && hari.toUpperCase().includes(currentDay);
            });
            
            return filtered.sort((a, b) => a.localeCompare(b));
        }

        // ===== DATA LOADING FUNCTIONS =====
        async function loadSalesmanData() {
            try {
                console.log('üë§ Loading salesman data...');
                const response = await fetch('data/d.salesman.json');
                if (!response.ok) throw new Error('Failed to load salesman data');
                
                const content = await response.text();
                salesmanData = parseJSONL(content);
                window.salesmanData = salesmanData; // Expose to window for Hasil Visit
                
                updateSalesmanNameFromData();
                
            } catch (error) {
                console.error('Error loading salesman data:', error);
            }
        }

        async function loadPelangganData() {
            try {
                console.log('üè™ Loading pelanggan data...');
                const response = await fetch('data/d.skupelanggan.json');
                if (!response.ok) throw new Error('Failed to load pelanggan data');
                
                const content = await response.text();
                pelangganData = parseJSONL(content);
                window.pelangganData = pelangganData; // Expose to window for Hasil Visit
                
            } catch (error) {
                console.error('Error loading pelanggan data:', error);
            }
        }

        async function loadDetailsData() {
            try {
                console.log('üìä Loading details data...');
                const response = await fetch('data/d.details.json');
                if (!response.ok) throw new Error('Failed to load details data');
                
                const content = await response.text();
                detailsData = parseJSONL(content);
                window.detailsData = detailsData; // Expose to window for Hasil Visit
                
            } catch (error) {
                console.error('Error loading details data:', error);
            }
        }
        
        async function loadTPOMData() {
            try {
                console.log('üéØ Loading TPOM data...');
                const response = await fetch('data/d.tpom.json');
                if (!response.ok) throw new Error('Failed to load TPOM data');
                
                const content = await response.text();
                tpomData = parseJSONL(content);
                window.tpomData = tpomData; // Expose to window for Hasil Visit
                
                console.log(`‚úÖ TPOM data loaded: ${tpomData.length} records`);
                
            } catch (error) {
                console.error('Error loading TPOM data:', error);
            }
        }

        async function loadSKUData() {
            try {
                console.log('üì¶ Loading SKU master data...');
                const response = await fetch('data/d.sku.json');
                if (!response.ok) throw new Error('Failed to load SKU data');
                
                const content = await response.text();
                skuData = parseJSONL(content);
                
                console.log(`‚úÖ SKU master data loaded: ${skuData.length} records`);
                
            } catch (error) {
                console.error('Error loading SKU data:', error);
            }
        }

        async function loadProjectData() {
            try {
                console.log('üéØ Loading project data...');
                const response = await fetch('data/d.project.json');
                if (!response.ok) throw new Error('Failed to load project data');
                
                const content = await response.text();
                projectData = parseJSONL(content);
                
                console.log(`‚úÖ Project data loaded: ${projectData.length} records`);
                
                // Debug: Show sample data
                if (projectData.length > 0) {
                    console.log('   Sample record:', {
                        'CUST NAME': projectData[0]['CUST NAME'],
                        'ITG': projectData[0]['ITG'],
                        'T.MTD': projectData[0]['T.MTD'],
                        'A.MTD': projectData[0]['A.MTD']
                    });
                }
                
            } catch (error) {
                console.error('Error loading project data:', error);
            }
        }
        function getAchievementClass(percentage) {
            if (percentage >= 70) return 'ach-high';
            if (percentage >= 40) return 'ach-medium';
            return 'ach-low';
        }

        function getStatusClass(status) {
            const statusLower = (status || '').toLowerCase();
            if (statusLower === 'lanjut') return 'status-lanjut';
            if (statusLower === 'gugur') return 'status-gugur';
            return 'status-unknown';
        }

        function toggleProjectInfo() {
            const projectContent = document.getElementById('projectContent');
            const toggleIcon = document.getElementById('projectToggleIcon');
            
            if (!projectContent || !toggleIcon) {
                console.warn('Project info elements not found');
                return;
            }
            
            const isCollapsed = projectContent.classList.contains('collapsed');
            
            if (isCollapsed) {
                // Expand
                projectContent.classList.remove('collapsed');
                toggleIcon.classList.remove('collapsed');
                console.log('üéØ Project info expanded');
            } else {
                // Collapse
                projectContent.classList.add('collapsed');
                toggleIcon.classList.add('collapsed');
                console.log('üéØ Project info collapsed');
            }
        }

        function displayProjectInfo(customerName) {
            console.log('üéØ === displayProjectInfo Debug ===');
            console.log('   Customer:', customerName);
            console.log('   Project data loaded:', projectData.length, 'records');
            
            const projectInfoSection = document.getElementById('projectInfo');
            const projectContent = document.getElementById('projectContent');
            
            if (!projectInfoSection || !projectContent) {
                console.error('‚ùå Project info elements not found in DOM');
                return;
            }
            
            if (!projectData || projectData.length === 0) {
                console.log('   No project data available');
                projectInfoSection.style.display = 'none';
                return;
            }

            // Debug: Show first few customer names in project data
            const sampleNames = projectData.slice(0, 5).map(item => item['CUST NAME']);
            console.log('   Sample project customer names:', sampleNames);

            // Find project data for this customer
            const customerProjectData = projectData.filter(item => {
                const itemCustName = (item['CUST NAME'] || '').toString().trim();
                const matches = itemCustName.toLowerCase() === customerName.toLowerCase();
                if (matches) {
                    console.log('   ‚úì Match found:', itemCustName);
                }
                return matches;
            });

            console.log('   Filtered project records:', customerProjectData.length);

            if (customerProjectData.length === 0) {
                // Not a project outlet
                console.log('   This is not a project outlet');
                projectInfoSection.style.display = 'none';
                return;
            }

            console.log(`üéØ Project outlet detected: ${customerName}, records: ${customerProjectData.length}`);

            // Group projects by ITG
            const projectsByITG = {};
            customerProjectData.forEach(item => {
                const itg = item['ITG'] || 'Unknown Project';
                if (!projectsByITG[itg]) {
                    projectsByITG[itg] = [];
                }
                projectsByITG[itg].push(item);
            });

            // Render project data
            let html = '';

            Object.entries(projectsByITG).forEach(([itg, projects]) => {
                // Aggregate data for this ITG
                let totalTMTD = 0, totalAMTD = 0, totalGapMTD = 0;
                let totalTQ = 0, totalAQ = 0, totalGapQ = 0;
                let achMTD = 0, status = 'Unknown';

                projects.forEach(project => {
                    totalTMTD += Number(project['T.MTD']) || 0;
                    totalAMTD += Number(project['A.MTD']) || 0;
                    totalGapMTD += Number(project['Gap MTD']) || 0;
                    totalTQ += Number(project['T.Qrt']) || 0;
                    totalAQ += Number(project['A.Qrt']) || 0;
                    totalGapQ += Number(project['Gap Qrt']) || 0;
                    
                    // Use the status from the first project
                    if (project['Status']) {
                        status = project['Status'];
                    }
                });

                // Calculate achievement percentage
                achMTD = totalTMTD > 0 ? (totalAMTD / totalTMTD) * 100 : 0;

                // Format numbers - ITG SC dan ITG LOCK GBS gunakan format number biasa
                const formatITGNumber = (value) => {
                    // Khusus ITG SC dan ITG LOCK GBS: gunakan format number biasa
                    if (itg === 'ITG SC' || itg === 'ITG LOCK GBS') {
                        const val = parseFloat(value) || 0;
                        // Tampilkan dengan pemisah ribuan
                        return val.toLocaleString('id-ID', {
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        });
                    }
                    
                    // ITG lainnya: gunakan format currency (rb/jt/M)
                    const val = Math.abs(parseFloat(value) || 0);
                    if (val >= 1000000000) return `${(val/1000000000).toFixed(1)}M`;
                    if (val >= 1000000) return `${(val/1000000).toFixed(1)}jt`;
                    if (val >= 1000) return `${(val/1000).toFixed(0)}rb`;
                    return `${val.toFixed(0)}`;
                };

                html += `
                    <div class="project-group">
                        <div class="project-header">
                            üéØ ${itg}
                        </div>
                        
                        <!-- Row 1: T.MTD, A.MTD, Gap MTD, Ach MTD -->
                        <div class="project-cards">
                            <div class="project-card">
                                <div class="project-label">T.MTD</div>
                                <div class="project-value">${formatITGNumber(totalTMTD)}</div>
                            </div>
                            <div class="project-card">
                                <div class="project-label">A.MTD</div>
                                <div class="project-value">${formatITGNumber(totalAMTD)}</div>
                            </div>
                            <div class="project-card">
                                <div class="project-label">Gap MTD</div>
                                <div class="project-value ${totalGapMTD > 0 ? 'positive' : totalGapMTD < 0 ? 'negative' : 'neutral'}">${totalGapMTD > 0 ? '+' : ''}${formatITGNumber(totalGapMTD)}</div>
                            </div>
                            <div class="project-card">
                                <div class="project-label">Ach MTD</div>
                                <div class="project-value">
                                    <span class="achievement-badge ${getAchievementClass(achMTD)}">${achMTD.toFixed(1)}%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Row 2: T.Qrt, A.Qrt, Gap Qrt, Status (hanya untuk ITG selain LOCK GBS dan CLBK) -->
                        ${itg !== 'ITG LOCK GBS' && itg !== 'ITG CLBK' ? `
                        <div class="project-cards">
                            <div class="project-card">
                                <div class="project-label">T.Qrt</div>
                                <div class="project-value">${formatITGNumber(totalTQ)}</div>
                            </div>
                            <div class="project-card">
                                <div class="project-label">A.Qrt</div>
                                <div class="project-value">${formatITGNumber(totalAQ)}</div>
                            </div>
                            <div class="project-card">
                                <div class="project-label">Gap Qrt</div>
                                <div class="project-value ${totalGapQ > 0 ? 'positive' : totalGapQ < 0 ? 'negative' : 'neutral'}">${totalGapQ > 0 ? '+' : ''}${formatITGNumber(totalGapQ)}</div>
                            </div>
                            <div class="project-card">
                                <div class="project-label">Status</div>
                                <div class="project-value">
                                    <span class="status-badge ${getStatusClass(status)}">${status}</span>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
            });

            projectContent.innerHTML = html;
            
            // Ensure expanded state (remove collapsed class if present)
            projectContent.classList.remove('collapsed');
            const toggleIcon = document.getElementById('projectToggleIcon');
            if (toggleIcon) {
                toggleIcon.classList.remove('collapsed');
            }
            
            projectInfoSection.style.display = 'block';
            console.log('‚úÖ Project info displayed (expanded)');
        }


        function initializeSalesmanFromUrl() {
            currentSalesmanId = getUrlParameter('id') || getUrlParameter('user');
            window.currentSalesmanId = currentSalesmanId; // Expose to window for Hasil Visit
            
            if (currentSalesmanId) {
                console.log('üÜî Current Salesman ID: ' + currentSalesmanId);
            }
        }

        // ===== CLEAR OLD VISIT DATA WHEN LOGIN ON NEW DAY =====
        function clearOldVisitData() {
            if (!currentSalesmanId) {
                console.log('‚ö†Ô∏è No salesman ID, skipping old visit data cleanup');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            const lastLoginKey = 'last_login_date_' + currentSalesmanId;
            const lastLoginDate = localStorage.getItem(lastLoginKey);
            
            console.log('üóìÔ∏è Checking for old visit data...');
            console.log('   Today:', today);
            console.log('   Last login:', lastLoginDate || 'Never');
            
            // If last login was on a different day, clear old visit data
            if (lastLoginDate && lastLoginDate !== today) {
                console.log('üßπ Clearing visit data from previous days...');
                
                let keysCleared = 0;
                const keysToRemove = [];
                
                // Find all keys in localStorage
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    
                    if (key) {
                        // Clear visited_* keys for this salesman (but not today's)
                        if (key.startsWith('visited_' + currentSalesmanId + '_') && !key.endsWith(today)) {
                            keysToRemove.push(key);
                        }
                        // Clear sku_pom_checklist_* keys for this salesman (but not today's)
                        else if (key.startsWith('sku_pom_checklist_' + currentSalesmanId + '_') && !key.includes('_' + today)) {
                            keysToRemove.push(key);
                        }
                        // Clear old plan_dap_* keys (but not today's)
                        else if (key.startsWith('plan_dap_' + currentSalesmanId + '_') && !key.endsWith(today)) {
                            keysToRemove.push(key);
                        }
                    }
                }
                
                // Remove the keys
                keysToRemove.forEach(function(key) {
                    localStorage.removeItem(key);
                    keysCleared++;
                    console.log('   ‚úì Removed:', key);
                });
                
                console.log('‚úÖ Cleared ' + keysCleared + ' old visit data keys');
            } else if (!lastLoginDate) {
                console.log('üìù First login detected, no old data to clear');
            } else {
                console.log('‚úì Same day login, keeping existing visit data');
            }
            
            // Update last login date to today
            localStorage.setItem(lastLoginKey, today);
            console.log('üìÖ Last login date updated to:', today);
        }

        // Update fungsi updateSalesmanNameFromData untuk deteksi team
        function updateSalesmanNameFromData() {
            if (currentSalesmanId && salesmanData.length > 0) {
                const salesmanRecord = salesmanData.find(item => item.szEmployeeId.toString() === currentSalesmanId);
                if (salesmanRecord) {
                    currentSalesman = salesmanRecord.szname;
                    window.currentSalesman = currentSalesman; // Expose to window for Hasil Visit
                    
                    // Expose Tipe Salesman to window for Hasil Visit
                    window.currentSalesmanType = salesmanRecord['Tipe Salesman'] || '-';
                    console.log('   üìã Tipe Salesman exposed to window:', window.currentSalesmanType);
                    document.getElementById('salesmanName').textContent = currentSalesman;
                    
                    // ===== DETECT SALESMAN TEAM FROM "Tipe Salesman" FIELD =====
                    const tipeSalesman = (salesmanRecord['Tipe Salesman'] || '').toString().toUpperCase();
                    console.log('üîç Detecting salesman team...');
                    console.log('   Salesman ID:', currentSalesmanId);
                    console.log('   Salesman Name:', currentSalesman);
                    console.log('   Tipe Salesman (raw):', salesmanRecord['Tipe Salesman']);
                    console.log('   Tipe Salesman (uppercase):', tipeSalesman);
                    
                    if (tipeSalesman.includes('ARJUNA')) {
                        salesmanTeam = 'ARJUNA';
                    } else if (tipeSalesman.includes('BIMA')) {
                        salesmanTeam = 'BIMA';
                    } else if (tipeSalesman.includes('YUDISTIRA')) {
                        salesmanTeam = 'YUDISTIRA';
                    } else {
                        salesmanTeam = 'YUDISTIRA'; // Default to show all
                        console.warn('   ‚ö†Ô∏è Team not detected from Tipe Salesman, defaulting to YUDISTIRA');
                    }
                    
                    console.log('   ‚úÖ Detected Team:', salesmanTeam);
                    console.log('   üìã Filter Logic:');
                    if (salesmanTeam === 'ARJUNA') {
                        console.log('      ‚Üí Will show only ARJUNA team SKUs');
                    } else if (salesmanTeam === 'BIMA') {
                        console.log('      ‚Üí Will show only BIMA team SKUs');
                    } else if (salesmanTeam === 'YUDISTIRA') {
                        console.log('      ‚Üí Will show ARJUNA + BIMA team SKUs');
                    }
                }
            } else if (currentSalesmanId && pelangganData.length > 0) {
                const salesmanRecord = pelangganData.find(item => item.szEmployeeId === currentSalesmanId);
                if (salesmanRecord) {
                    currentSalesman = salesmanRecord.szname;
                    window.currentSalesman = currentSalesman; // Expose to window for Hasil Visit
                    document.getElementById('salesmanName').textContent = currentSalesman;
                    console.warn('‚ö†Ô∏è Team detection from pelangganData - may not have Tipe Salesman field');
                }
            }
        }

        // ===== TAB SWITCHING FUNCTIONS =====
        function switchTab(tabName) {
            // Remove active class from all tabs
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-content-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Add active class to selected tab
            if (tabName === 'dataSku') {
                document.querySelectorAll('.tab-button')[0].classList.add('active');
                document.getElementById('dataSku').classList.add('active');
            } else if (tabName === 'mssBelumAktif') {
                document.querySelectorAll('.tab-button')[1].classList.add('active');
                document.getElementById('mssBelumAktif').classList.add('active');
            }
            
            console.log(`üìë Switched to tab: ${tabName}`);
        }

        // Make switchTab available globally
        window.switchTab = switchTab;

        // ===== UPDATE MSS BADGE COUNTER =====
        function updateMSSBadge(count) {
            const badge = document.getElementById('mssBadge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'block';
                    console.log(`üî¢ MSS Badge updated: ${count} SKUs`);
                } else {
                    badge.style.display = 'none';
                    console.log('üî¢ MSS Badge hidden (0 SKUs)');
                }
            }
        }
        // ===== UPDATE GAP MSS BADGE =====
        function updateGapMSSBadge(gapValue) {
            const badge = document.getElementById('gapMssBadge');
            if (badge) {
                if (gapValue !== null && gapValue !== undefined) {
                    // Determine class and display
                    const badgeClass = gapValue < 0 ? 'negative' : 'positive';
                    const displayValue = gapValue < 0 ? gapValue : `+${gapValue}`;
                    
                    // Update badge using visibility (not display)
                    badge.className = `gap-badge-left ${badgeClass}`;
                    badge.textContent = displayValue;
                    badge.style.visibility = 'visible';
                    badge.style.opacity = '1';
                    
                    console.log(`üî¢ Gap MSS Badge updated: ${displayValue} (${badgeClass})`);
                    console.log('   ‚úÖ Badge should be VISIBLE now');
                } else {
                    // Hide badge
                    badge.classList.add('hidden');
                    badge.style.visibility = 'hidden';
                    badge.style.opacity = '0';
                    console.log('üî¢ Gap MSS Badge hidden (no data)');
                }
            } else {
                console.error('‚ùå Gap MSS Badge element not found!');
            }
        }



        function showMSSBelumAktif(customerName) {
            const mssContainer = document.getElementById('mssGridContainer');
            
            if (!customerName || !pelangganData.length) {
                mssContainer.innerHTML = `
                    <div class="mss-empty">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div>Pilih outlet untuk melihat SKU MSS yang belum aktif</div>
                    </div>
                `;
                updateMSSBadge(0); // Hide badge when no outlet selected
                updateGapMSSBadge(null); // Hide gap badge too
                return;
            }
            
            console.log('üîç === showMSSBelumAktif Debug ===');
            console.log('   Outlet:', customerName);
            console.log('   Salesman Team:', salesmanTeam);
            
            let gapMSS = 0;
            console.log('üîç === Gap MSS Debug ===');
            console.log('   detailsData length:', detailsData ? detailsData.length : 0);
            console.log('   currentSalesmanId:', currentSalesmanId);
            console.log('   customerName:', customerName);
            
            if (detailsData && detailsData.length > 0) {
                // Enhanced debugging
                console.log('   üîç Searching for match in detailsData...');
                
                const detailRecord = detailsData.find(item => {
                    const itemSalesman = (item.szEmployeeId || '').toString().trim();
                    const itemOutlet = (item['Nama Pelanggan'] || item.Nama_Pelanggan || '').toString().trim();
                    const itemOutletLower = itemOutlet.toLowerCase();
                    const customerNameLower = customerName.toLowerCase();
                    
                    const salesmanMatch = itemSalesman === currentSalesmanId;
                    const outletMatch = itemOutletLower === customerNameLower;
                    
                    // Debug first few records
                    if (detailsData.indexOf(item) < 3) {
                        console.log(`   Record ${detailsData.indexOf(item)}:`, {
                            szEmployeeId: itemSalesman,
                            'Nama Pelanggan (space)': item['Nama Pelanggan'],
                            'Nama_Pelanggan (underscore)': item.Nama_Pelanggan,
                            outlet: itemOutlet,
                            GapMSS: item.GapMSS,
                            salesmanMatch,
                            outletMatch
                        });
                    }
                    
                    return salesmanMatch && outletMatch;
                });
                
                if (detailRecord) {
                    gapMSS = Number(detailRecord.GapMSS || 0);
                    console.log('   ‚úÖ Gap MSS found:', {
                        outlet: detailRecord['Nama Pelanggan'] || detailRecord.Nama_Pelanggan,
                        GapMSS: detailRecord.GapMSS,
                        parsed: gapMSS
                    });
                    updateGapMSSBadge(gapMSS); // Update gap badge with value
                } else {
                    console.log('   ‚ùå No detail record found for this outlet');
                    // Show matching outlets for debugging
                    const matchingOutlets = detailsData
                        .filter(item => (item.szEmployeeId || '').toString().trim() === currentSalesmanId)
                        .map(item => ({
                            outlet: (item['Nama Pelanggan'] || item.Nama_Pelanggan || '').toString().trim(),
                            gapMSS: item.GapMSS
                        }))
                        .slice(0, 5);
                    console.log('   Available outlets for this salesman:', matchingOutlets);
                    updateGapMSSBadge(0); // No data, show 0
                }
            } else {
                console.log('   ‚ùå No detailsData available');
                updateGapMSSBadge(0); // No detailsData, show 0
            }
            console.log('üîç === End Gap MSS Debug ===');

            // Fase 1: Ambil SKU MSS yang belum aktif dari pelangganData (d.skupelanggan.json)
            const mssInactiveFromPelanggan = pelangganData.filter(item => {
                const itemSalesmanId = (item.szEmployeeId || '').toString().trim();
                const itemPelanggan = (item.Nama_Pelanggan || '').toString().trim();
                const stsMss = (item.Sts_MSS || '').toString().trim().toUpperCase();
                const caMss = Number(item.CA_MSS || 0);
                const team = (item.Team || '').toString().trim(); // ‚Üê JANGAN uppercase dulu
                
                const isSameSalesman = itemSalesmanId === currentSalesmanId;
                const isSameOutlet = itemPelanggan.toLowerCase() === customerName.toLowerCase();
                const isMSS = stsMss === 'MSS';
                const isInactive = caMss === 0;
                
                if (!isSameSalesman || !isSameOutlet || !isMSS || !isInactive) {
                    return false;
                }
                
                // ===== TEAM-BASED FILTER - CASE INSENSITIVE =====
                let teamMatch = false;
                const teamUpper = team.toUpperCase();
                const salesmanTeamUpper = salesmanTeam.toUpperCase();
                
                if (salesmanTeamUpper === 'ARJUNA') {
                    teamMatch = teamUpper === 'ARJUNA';
                } else if (salesmanTeamUpper === 'BIMA') {
                    teamMatch = teamUpper === 'BIMA';
                } else if (salesmanTeamUpper === 'YUDISTIRA') {
                    // Yudistira: show both Arjuna and Bima
                    teamMatch = teamUpper === 'ARJUNA' || teamUpper === 'BIMA';
                } else {
                    teamMatch = true; // Unknown team, show all
                }
                
                if (!teamMatch) {
                    console.log(`   ‚ùå Filtered out: ${item.SKU} (Team: "${team}", Required: ${salesmanTeam})`);
                }
                
                return teamMatch;
            });
            
            console.log(`   üìä Phase 1: ${mssInactiveFromPelanggan.length} inactive MSS SKUs from pelangganData`);
            
            // Fase 2: Ambil SKU MSS dari master data (d.sku.json) yang sesuai team
            const mssFromMasterData = skuData.filter(item => {
                const skuFokus = (item.SKU_Fokus || '').toString().trim().toUpperCase();
                const team = (item.Team || '').toString().trim(); // ‚Üê JANGAN uppercase dulu
                
                const isMSS = skuFokus === 'MSS';
                
                if (!isMSS) {
                    return false;
                }
                
                // ===== TEAM-BASED FILTER - CASE INSENSITIVE =====
                let teamMatch = false;
                const teamUpper = team.toUpperCase();
                const salesmanTeamUpper = salesmanTeam.toUpperCase();
                
                if (salesmanTeamUpper === 'ARJUNA') {
                    teamMatch = teamUpper === 'ARJUNA';
                } else if (salesmanTeamUpper === 'BIMA') {
                    teamMatch = teamUpper === 'BIMA';
                } else if (salesmanTeamUpper === 'YUDISTIRA') {
                    // Yudistira: show both Arjuna and Bima
                    teamMatch = teamUpper === 'ARJUNA' || teamUpper === 'BIMA';
                } else {
                    teamMatch = true; // Unknown team, show all
                }
                
                return teamMatch;
            });
            
            console.log(`   üìä Phase 2: ${mssFromMasterData.length} MSS SKUs from master data (filtered by team)`);
            
            // Log sample of teams in the data
            const sampleTeams = new Set();
            pelangganData.forEach(item => {
                const team = (item.Team || '').toString().trim();
                if (team) sampleTeams.add(team);
            });
            console.log('   üìã Available teams in pelangganData:', Array.from(sampleTeams).join(', '));
            
            const sampleMasterTeams = new Set();
            skuData.forEach(item => {
                const team = (item.Team || '').toString().trim();
                if (team) sampleMasterTeams.add(team);
            });
            console.log('   üìã Available teams in skuData:', Array.from(sampleMasterTeams).join(', '));
            
            // Fase 3: Untuk setiap SKU dari master data, cek apakah sudah aktif di outlet
            const mssToShow = new Map(); // Gunakan Map untuk menghindari duplikasi
            
            // Tambahkan SKU dari pelangganData yang inactive
            mssInactiveFromPelanggan.forEach(item => {
                const sku = item.SKU || 'N/A';
                const team = (item.Team || '').toString().trim();
                mssToShow.set(sku, { sku, team });
            });
            
            // Cek SKU dari master data
            mssFromMasterData.forEach(masterItem => {
                const masterSku = (masterItem.SKU || '').toString().trim();
                const masterTeam = (masterItem.Team || '').toString().trim();
                
                if (!masterSku) return;
                
                // Cek apakah SKU ini sudah ada di pelangganData untuk outlet ini
                const existingInOutlet = pelangganData.find(pelItem => {
                    const pelSku = (pelItem.SKU || '').toString().trim();
                    const pelOutlet = (pelItem.Nama_Pelanggan || '').toString().trim();
                    const pelSalesman = (pelItem.szEmployeeId || '').toString().trim();
                    
                    return pelSku === masterSku && 
                        pelOutlet.toLowerCase() === customerName.toLowerCase() &&
                        pelSalesman === currentSalesmanId;
                });
                
                if (!existingInOutlet) {
                    // SKU belum ada di outlet - tampilkan
                    if (!mssToShow.has(masterSku)) {
                        mssToShow.set(masterSku, { 
                            sku: masterSku, 
                            team: masterTeam
                        });
                    }
                } else {
                    // SKU ada di outlet - cek apakah sudah aktif
                    const caMss = Number(existingInOutlet.CA_MSS || 0);
                    if (caMss === 0) {
                        // Belum aktif - sudah ditambahkan dari fase 1
                    }
                }
            });
            
            const mssArray = Array.from(mssToShow.values());
            
            console.log(`   ‚úÖ Final result: ${mssArray.length} SKUs to display`);
            console.log('   üìã Team distribution:', mssArray.reduce((acc, item) => {
                acc[item.team] = (acc[item.team] || 0) + 1;
                return acc;
            }, {}));
            
            if (mssArray.length === 0) {
                mssContainer.innerHTML = `
                    <div class="mss-empty">
                        <div class="empty-state-icon">‚úÖ</div>
                        <div>Semua SKU MSS sudah aktif!</div>
                        <div style="font-size: 11px; margin-top: 8px; color: #059669;">Team: ${salesmanTeam}</div>
                    </div>
                `;
                return;
            }
                updateMSSBadge(0); // Hide badge when all SKUs active
            
            // Group by team (preserve original case for display)
            const groupedByTeam = {};
            mssArray.forEach(item => {
                const team = item.team || 'Unknown';
                if (!groupedByTeam[team]) {
                    groupedByTeam[team] = [];
                }
                groupedByTeam[team].push(item.sku);
            });
            
            // Build HTML - Grouped by team with comma-separated SKUs
            let html = '';
            
            // Sort teams: Arjuna, Bima, Yudistira, others
            const teamOrder = ['Arjuna', 'Bima', 'Yudistira'];
            const sortedTeams = Object.keys(groupedByTeam).sort((a, b) => {
                const indexA = teamOrder.indexOf(a);
                const indexB = teamOrder.indexOf(b);
                if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
            
            sortedTeams.forEach(team => {
                const skus = groupedByTeam[team];
                const skuList = skus.join(', ');
                
                html += `
                    <div class="mss-team-section">
                        <div class="mss-team-header">${team.toUpperCase()}</div>
                        <div class="mss-sku-list">${skuList}</div>
                    </div>
                `;
            });
            
            mssContainer.innerHTML = html;
            
            console.log(`üì¶ Displayed ${mssArray.length} MSS SKU(s) grouped by team`);
            
            // Update badge counter
            updateMSSBadge(mssArray.length);
        }
        // ===== SESSION PROTECTION FUNCTIONS =====
        function checkActiveSessionBeforeAction(actionType, targetName = '') {
            if (visitSession.isActive && !visitSession.isPaused) {
                const currentSessionDuration = Math.floor((Date.now() - visitSession.startTime) / 1000);
                const totalDuration = visitSession.accumulatedDuration + currentSessionDuration;
                const durationText = formatDuration(totalDuration);
                
                if (actionType === 'change_customer') {
                    showVisitEndModal();
                    return false;
                }
                
                let message = `‚ö†Ô∏è KUNJUNGAN SEDANG AKTIF!\n\n`;
                message += `Outlet: ${visitSession.outletName}\n`;
                message += `Durasi: ${durationText}\n\n`;
                message += `Silakan akhiri atau tunda kunjungan terlebih dahulu!`;
                
                alert(message);
                return false;
            }
            return true;
        }

        // ===== FILTER AND DATA DISPLAY FUNCTIONS =====
        function updatePelangganOptions() {
            if (visitSession.isActive && !visitSession.isPaused) {
                checkActiveSessionBeforeAction('change_hari');
                const hariSelect = document.getElementById('hari');
                hariSelect.value = '';
                return;
            }
            
            const hariSelect = document.getElementById('hari');
            const pelangganSelect = document.getElementById('pelanggan');
            
            pelangganSelect.innerHTML = '<option value="">üè™ Pilih Outlet</option>';
            clearDataDisplay();
            
            if (pelangganData.length > 0 && currentSalesmanId && hariSelect.value) {
                const selectedHari = hariSelect.value.trim().toUpperCase();
                
                // ===== CHECK PLAN DAP WHEN SELECTING JKS DAY =====
                if (!checkPlanDAP()) {
                    console.log('‚ö†Ô∏è Plan DAP not entered yet - showing popup');
                    showPlanDAPPopup();
                    // Reset hari selection
                    hariSelect.value = '';
                    return;
                }
                
                console.log(`üîç Filtering outlets for Salesman: ${currentSalesmanId}, Hari: ${selectedHari}`);
                
                const filteredPelanggan = [...new Set(pelangganData
                    .filter(item => {
                        const itemSalesmanId = (item.szEmployeeId || '').toString().trim();
                        const itemHari = normalizeHariFormat(item.Hari_Kunjungan);
                        
                        const salesmanMatch = itemSalesmanId === currentSalesmanId;
                        const hariMatch = itemHari === selectedHari;
                        
                        return salesmanMatch && hariMatch;
                    })
                    .map(item => item.Nama_Pelanggan)
                    .filter(pelanggan => pelanggan && pelanggan.toString().trim() !== '')
                )];

                console.log(`üìä Found ${filteredPelanggan.length} outlets:`, filteredPelanggan);

                filteredPelanggan.forEach(pelanggan => {
                    const option = document.createElement('option');
                    option.value = pelanggan;
                    option.textContent = pelanggan;
                    pelangganSelect.appendChild(option);
                });

                if (filteredPelanggan.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Tidak ada outlet untuk hari ini';
                    option.disabled = true;
                    pelangganSelect.appendChild(option);
                }
                
                updateCustomerListVisitStatus();
                updateCustomerListPauseStatus();
                updateCustomerListInactiveStatus();
            }
        }

        function handlePelangganSelection() {
            const selectedCustomer = document.getElementById('pelanggan').value.trim();
            
            if (visitSession.isActive && !visitSession.isPaused && visitSession.outletName !== selectedCustomer && selectedCustomer !== '') {
                showVisitEndModal();
                const pelangganSelect = document.getElementById('pelanggan');
                pelangganSelect.value = visitSession.outletName || '';
                return;
            }
            
            const hariSelect = document.getElementById('hari');
            const pelangganSelect = document.getElementById('pelanggan');
            const customerInfo = document.getElementById('customerInfo');
            
            if (pelangganSelect.value && hariSelect.value) {
                const selectedPelanggan = pelangganSelect.value.trim();
                const selectedHari = hariSelect.value.trim().toUpperCase();
                
                if (isCustomerAlreadyVisited(selectedPelanggan)) {
                    alert(`‚ùå Outlet "${selectedPelanggan}" sudah dikunjungi hari ini!\n\nSetiap outlet hanya boleh dikunjungi sekali per hari.`);
                    pelangganSelect.value = '';
                    customerInfo.style.display = 'none';
                    return;
                }
                
                console.log(`üë• Outlet selected: ${selectedPelanggan} for ${selectedHari}`);
                
                const detailRecord = detailsData.find(item => {
                    const itemPelanggan = (item['Nama Pelanggan'] || '').toString().trim();
                    return itemPelanggan.toLowerCase() === selectedPelanggan.toLowerCase();
                });

                let customerTypeText = `${selectedHari} Outlet`;
                let skuZeroText = 'Tidak ada';
                
                if (detailRecord) {
                    const channelGroup = detailRecord['Channel Group'] || 'Unknown';
                    const project = detailRecord.Project || 'Unknown';
                    customerTypeText = `${channelGroup} - ${project}`;
                    
                    // Get target SKU POM for this salesman from d.tpom.json
                    const targetSkuPom = tpomData
                        .filter(item => {
                            const itemSalesmanId = (item.szEmployeeId || '').toString().trim();
                            return itemSalesmanId === currentSalesmanId;
                        })
                        .map(item => (item.SKU || item.SKU_POM || '').toString().trim())
                        .filter(sku => sku !== '');

                    console.log(`üéØ Target SKU POM for salesman ${currentSalesmanId}:`, targetSkuPom);

                    // Check each target SKU POM against outlet data in d.skupelanggan.json
                    const skuPomBelumCA = [];

                    targetSkuPom.forEach(skuTarget => {
                        // Find this SKU for this outlet in pelangganData
                        const skuRecord = pelangganData.find(item => {
                            const itemPelanggan = (item.Nama_Pelanggan || '').toString().trim();
                            const itemSku = (item.SKU || '').toString().trim();
                            
                            return itemPelanggan.toLowerCase() === selectedPelanggan.toLowerCase() &&
                                itemSku === skuTarget;
                        });
                        
                        if (!skuRecord) {
                            // SKU tidak ada di outlet ‚Üí Belum CA
                            skuPomBelumCA.push(skuTarget);
                            console.log(`‚ùå SKU ${skuTarget}: Tidak ada di outlet`);
                        } else {
                            const caPom = Number(skuRecord.CA_POM || 0);
                            if (caPom === 0) {
                                // CA_POM = 0 ‚Üí Belum CA
                                skuPomBelumCA.push(skuTarget);
                                console.log(`‚ùå SKU ${skuTarget}: CA_POM = 0 (Belum CA)`);
                            } else {
                                console.log(`‚úÖ SKU ${skuTarget}: CA_POM = 1 (Sudah aktif)`);
                            }
                        }
                    });

                    skuZeroText = skuPomBelumCA.length > 0 
                        ? skuPomBelumCA.join(', ') 
                        : 'Semua SKU POM sudah aktif';
                    
                    console.log(`üìã Found outlet details: ID=${detailRecord['Id Pelanggan']}, Type=${customerTypeText}, SKU Zero=${skuZeroText}`);
                    displaySkuPomChecklist(selectedPelanggan, skuPomBelumCA);
                }
                
                customerInfo.style.display = 'block';
                document.getElementById('customerType').textContent = customerTypeText;
                document.getElementById('skuZeroList').textContent = skuZeroText;
                
                updateSummaryFromCustomer(selectedPelanggan);
                showVisitData(selectedPelanggan, selectedHari);
                showMSSBelumAktif(selectedPelanggan);
                displayProjectInfo(selectedPelanggan);
                
                showVisitStartModal(selectedPelanggan, selectedHari);
                
                console.log('‚úÖ Outlet setup complete:', {
                    outlet: selectedPelanggan,
                    hari: selectedHari,
                    type: customerTypeText,
                    id_pelanggan: detailRecord ? detailRecord['Id Pelanggan'] : 'Not found',
                    alreadyVisited: false,
                    isPaused: isPausedVisit(selectedPelanggan),
                    skuZero: skuZeroText
                });
                
            } else {
                customerInfo.style.display = 'none';
                clearDataDisplay();
            }
        }

        function clearDataDisplay() {
            const tableBody = document.getElementById('tableBody');
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìä</div>
                                <div>Pilih filter untuk melihat data</div>
                            </div>
                        </td>
                    </tr>
                `;
            }
            
            const mssContainer = document.getElementById('mssGridContainer');
            if (mssContainer) {
                mssContainer.innerHTML = `
                    <div class="mss-empty">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div>Pilih outlet untuk melihat SKU MSS yang belum aktif</div>
                    </div>
                `;
            }
            document.getElementById('summaryTarget').textContent = '-';
            document.getElementById('summaryActual').textContent = '-';
            document.getElementById('summaryGap').textContent = '-';
            document.getElementById('summaryGap').className = 'summary-value';
            
            const customerInfo = document.getElementById('customerInfo');
            if (customerInfo) {
                customerInfo.style.display = 'none';
            }
            
            const projectInfo = document.getElementById('projectInfo');
            if (projectInfo) {
                projectInfo.style.display = 'none';
                // Reset to expanded state for next display
                const projectContent = document.getElementById('projectContent');
                const toggleIcon = document.getElementById('projectToggleIcon');
                if (projectContent) {
                    projectContent.classList.remove('collapsed');
                }
                if (toggleIcon) {
                    toggleIcon.classList.remove('collapsed');
                }
            }
            
            clearSkuPomChecklist();
            window.currentFilteredData = [];
        }


        // ===== SKU POM FUNCTIONS =====
        
        function getSkuPomStorageKey(outletName) {
            const today = new Date().toISOString().split('T')[0];
            return 'sku_pom_checklist_' + currentSalesmanId + '_' + outletName + '_' + today;
        }

        function loadSkuPomChecklistStatus(outletName) {
            try {
                const storageKey = getSkuPomStorageKey(outletName);
                const saved = localStorage.getItem(storageKey);
                return saved ? JSON.parse(saved) : {};
            } catch (error) {
                console.error('Error loading SKU POM checklist:', error);
                return {};
            }
        }

        function saveSkuPomChecklistStatus(outletName, checklistStatus) {
            try {
                const storageKey = getSkuPomStorageKey(outletName);
                localStorage.setItem(storageKey, JSON.stringify(checklistStatus));
            } catch (error) {
                console.error('Error saving SKU POM checklist:', error);
            }
        }

        async function saveSkuPomChecklistToFirebase(outletName, checklistStatus) {
            if (!window.firebaseDB || !currentSalesmanId) return false;
            try {
                const today = new Date().toISOString().split('T')[0];
                const checklistRef = window.firebaseRef(window.firebaseDB, 'sku_pom_checklist/' + currentSalesmanId + '/' + today + '/' + outletName);
                const checklistData = {
                    salesman_id: currentSalesmanId,
                    salesman_name: currentSalesman,
                    outlet_name: outletName,
                    date: today,
                    checklist: checklistStatus,
                    last_updated: window.firebaseServerTimestamp()
                };
                await window.firebaseSet(checklistRef, checklistData);
                return true;
            } catch (error) {
                console.error('Firebase sync error:', error);
                return false;
            }
        }

        function displaySkuPomChecklist(selectedPelanggan, skuPomBelumCA) {
            const frame = document.getElementById('skuPomFrame');
            const container = document.getElementById('skuPomChipsContainer');
            const countBadge = document.getElementById('skuPomFrameCount');
            const skuZeroListOld = document.getElementById('skuZeroList');
            
            if (!skuPomBelumCA || skuPomBelumCA.length === 0) {
                if (frame) frame.style.display = 'none';
                if (skuZeroListOld) {
                    skuZeroListOld.textContent = 'Semua SKU POM sudah aktif';
                    skuZeroListOld.style.display = 'block';
                }
                return;
            }
            
            if (skuZeroListOld) skuZeroListOld.style.display = 'none';
            if (frame) frame.style.display = 'block';
            if (!container) return;
            if (countBadge) countBadge.textContent = skuPomBelumCA.length;
            
            container.innerHTML = '';
            const checklistStatus = loadSkuPomChecklistStatus(selectedPelanggan);
            
            skuPomBelumCA.forEach(function(sku) {
                const isChecked = checklistStatus[sku] === true;
                const chip = document.createElement('div');
                chip.className = 'sku-pom-chip' + (isChecked ? ' checked' : '');
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'sku-pom-chip-checkbox';
                checkbox.checked = isChecked;
                
                const codeSpan = document.createElement('span');
                codeSpan.className = 'sku-pom-chip-code';
                codeSpan.textContent = sku;
                
                chip.appendChild(checkbox);
                chip.appendChild(codeSpan);
                
                chip.addEventListener('click', function(e) {
                    if (e.target !== checkbox) checkbox.checked = !checkbox.checked;
                    toggleSkuPomChip(sku, selectedPelanggan, chip, checkbox);
                });
                
                checkbox.addEventListener('change', function(e) {
                    e.stopPropagation();
                    toggleSkuPomChip(sku, selectedPelanggan, chip, checkbox);
                });
                
                container.appendChild(chip);
            });
            
        }

        function toggleSkuPomChip(sku, outletName, chip, checkbox) {
            const isChecked = checkbox.checked;
            if (isChecked) {
                chip.classList.add('checked');
            } else {
                chip.classList.remove('checked');
            }
            
            const checklistStatus = loadSkuPomChecklistStatus(outletName);
            checklistStatus[sku] = isChecked;
            saveSkuPomChecklistStatus(outletName, checklistStatus);
            saveSkuPomChecklistToFirebase(outletName, checklistStatus);
            
            const targetSkuPom = tpomData
                .filter(function(item) {
                    return (item.szEmployeeId || '').toString().trim() === currentSalesmanId;
                })
                .map(function(item) {
                    return (item.SKU || item.SKU_POM || '').toString().trim();
                })
                .filter(function(sku) {
                    return sku !== '';
                });
            
            const skuPomBelumCA = [];
            targetSkuPom.forEach(function(skuTarget) {
                const skuRecord = pelangganData.find(function(item) {
                    const itemPelanggan = (item.Nama_Pelanggan || '').toString().trim();
                    const itemSku = (item.SKU || '').toString().trim();
                    return itemPelanggan.toLowerCase() === outletName.toLowerCase() && itemSku === skuTarget;
                });
                if (!skuRecord || Number(skuRecord.CA_POM || 0) === 0) {
                    skuPomBelumCA.push(skuTarget);
                }
            });
            
            // const counter = document.getElementById('skuPomFrameCounter');
            // Counter removed - no longer needed
        }


        function clearSkuPomChecklist() {
            const frame = document.getElementById('skuPomFrame');
            if (frame) frame.style.display = 'none';
            const container = document.getElementById('skuPomChipsContainer');
            if (container) container.innerHTML = '';
            const skuZeroListOld = document.getElementById('skuZeroList');
            if (skuZeroListOld) {
                skuZeroListOld.style.display = 'none';
                skuZeroListOld.textContent = '';
            }
        }

        function updateSummaryFromCustomer(selectedPelanggan) {
            const targetElement = document.getElementById('summaryTarget');
            const actualElement = document.getElementById('summaryActual');
            const gapElement = document.getElementById('summaryGap');
            
            if (!currentSalesman || !selectedPelanggan || detailsData.length === 0) {
                targetElement.textContent = '-';
                actualElement.textContent = '-';
                gapElement.textContent = '-';
                gapElement.className = 'summary-value';
                return;
            }
            
            const detailsSummaryData = detailsData.filter(item => {
                const itemSalesman = (item['szname'] || '').toString().trim();
                const itemPelanggan = (item['Nama Pelanggan'] || '').toString().trim();
                
                return itemSalesman === currentSalesman && 
                       itemPelanggan.toLowerCase() === selectedPelanggan.toLowerCase();
            });
            
            console.log(`üìä Summary data: ${detailsSummaryData.length} records for ${selectedPelanggan}`);
            
            if (detailsSummaryData.length === 0) {
                targetElement.textContent = '0';
                actualElement.textContent = '0';
                gapElement.textContent = '0';
                gapElement.className = 'summary-value neutral';
                return;
            }
            
            let totalTarget = 0;
            let totalActual = 0;
            let totalGap = 0;
            
            detailsSummaryData.forEach(item => {
                totalTarget += Number(item['T.MTD']) || 0;
                totalActual += Number(item['A.MTD']) || 0;
                totalGap += Number(item['Gap MTD']) || 0;
            });
            
            const formatNumber = (num) => {
                if (Math.abs(num) >= 1000000) {
                    return (num / 1000000).toFixed(1) + 'M';
                } else if (Math.abs(num) >= 1000) {
                    return (num / 1000).toFixed(0) + 'K';
                }
                return num.toFixed(0);
            };
            
            targetElement.textContent = formatNumber(totalTarget);
            actualElement.textContent = formatNumber(totalActual);
            gapElement.textContent = (totalGap > 0 ? '+' : '') + formatNumber(totalGap);
            
            if (totalGap > 0) {
                gapElement.className = 'summary-value positive';
            } else if (totalGap < 0) {
                gapElement.className = 'summary-value negative';
            } else {
                gapElement.className = 'summary-value neutral';
            }
        }

        function showVisitData(customerName, hariJKS) {
            const tableBody = document.getElementById('tableBody');
            
            if (!tableBody) {
                console.error('‚ùå Table body element not found');
                return;
            }
            
            console.log('üîç === showVisitData Debug ===');
            console.log('   Outlet:', customerName);
            console.log('   Hari JKS:', hariJKS);
            console.log('   Salesman Team:', salesmanTeam);
            
            const visitData = pelangganData.filter(item => {
                const itemSalesmanId = (item.szEmployeeId || '').toString().trim();
                const itemHari = normalizeHariFormat(item.Hari_Kunjungan);
                const itemPelanggan = (item.Nama_Pelanggan || '').toString().trim();
                const team = (item.Team || '').toString().trim(); // ‚Üê JANGAN uppercase dulu
                
                const basicMatch = itemSalesmanId === currentSalesmanId &&
                                itemHari === hariJKS &&
                                itemPelanggan.toLowerCase() === customerName.toLowerCase();
                
                if (!basicMatch) return false;
                
                // ===== TEAM-BASED FILTER - CASE INSENSITIVE =====
                let teamMatch = false;
                const teamUpper = team.toUpperCase();
                const salesmanTeamUpper = salesmanTeam.toUpperCase();
                
                if (salesmanTeamUpper === 'ARJUNA') {
                    teamMatch = teamUpper === 'ARJUNA';
                } else if (salesmanTeamUpper === 'BIMA') {
                    teamMatch = teamUpper === 'BIMA';
                } else if (salesmanTeamUpper === 'YUDISTIRA') {
                    // Yudistira: show all teams
                    teamMatch = true;
                } else {
                    teamMatch = true; // Unknown team, show all
                }
                
                return teamMatch;
            });
            
            console.log(`   ‚úÖ Filtered ${visitData.length} records (Team: ${salesmanTeam})`);
            
            if (visitData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9">
                            <div class="empty-state">
                                <div class="empty-state-icon">üî≠</div>
                                <div>Tidak ada data visit untuk ${customerName}</div>
                                <div style="font-size: 11px; margin-top: 8px; color: #64748b;">Team: ${salesmanTeam}</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            window.currentFilteredData = [...visitData];
            renderTableData(visitData);
        }

        // ===== TABLE RENDERING FUNCTIONS =====
        let currentFilteredData = [];
        let sortState = { column: null, direction: 'asc' };

        function sortTable(column) {
            if (!window.currentFilteredData || window.currentFilteredData.length === 0) {
                return;
            }

            if (sortState.column === column) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = column;
                sortState.direction = 'asc';
            }

            if (column === 'promo') {
                window.currentFilteredData.sort((a, b) => {
                    const promoA = (a.Promo || '').toLowerCase();
                    const promoB = (b.Promo || '').toLowerCase();
                    
                    if (sortState.direction === 'asc') {
                        return promoA.localeCompare(promoB);
                    } else {
                        return promoB.localeCompare(promoA);
                    }
                });
            }

            updateSortHeaders();
            renderTableData(window.currentFilteredData);
        }

        function updateSortHeaders() {
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.classList.remove('asc', 'desc');
            });

            if (sortState.column === 'promo') {
                const promoHeader = document.querySelector('.sortable-header');
                if (promoHeader) {
                    promoHeader.classList.add(sortState.direction);
                }
            }
        }

        function renderTableData(data) {
            const tableBody = document.getElementById('tableBody');
            
            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9">
                            <div class="empty-state">
                                <div class="empty-state-icon">üî≠</div>
                                <div>Tidak ada data untuk kriteria yang dipilih</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            let totalPlan = 0, totalMTD = 0;
            let mssInactiveCount = 0, mssActiveCount = 0;
            
            data.forEach((item, index) => {
                const no = index + 1;
                const promo = item.Promo || "Others";
                const sku = item.SKU || "N/A";
                const threeLM = Number(item.Unit3LM) || 0;
                const lm = Number(item.UnitLM) || 0;
                const plan = Number(item.Plan) || 0;
                const mtd = Number(item.UnitMTD) || 0;
                const gap = Number(item.Gap) || (mtd - plan);
                const rekomendasi = generateRecommendation(gap, plan, mtd);
                
                totalPlan += plan;
                totalMTD += mtd;
                
                const gapClass = gap > 0 ? 'positive' : gap < 0 ? 'negative' : 'neutral';
                const gapBadgeClass = gap > 0 ? 'gap-positive' : gap < 0 ? 'gap-negative' : 'gap-neutral';
                const promoClass = `promo-${promo.toLowerCase().replace(/\s+/g, '')}`;
                
                // Check MSS status for SKU coloring
                let skuClass = 'sku-code';
                const stsMss = (item.Sts_MSS || '').toString().trim().toUpperCase();
                const caMss = Number(item.CA_MSS || 0);
                
                if (stsMss === 'MSS') {
                    if (caMss === 0) {
                        skuClass = 'sku-code sku-mss-inactive'; // Yellow - MSS not active
                        mssInactiveCount++;
                    } else if (caMss === 1) {
                        skuClass = 'sku-code sku-mss-active'; // Green - MSS active
                        mssActiveCount++;
                    }
                }
                
                html += `
                    <tr>
                        <td>${no}</td>
                        <td><span class="promo-tag ${promoClass}">${promo}</span></td>
                        <td><span class="${skuClass}">${sku}</span></td>
                        <td><span class="gap-badge ${gapBadgeClass}">${gap > 0 ? '+' : ''}${formatNumber(gap)}</span></td>
                        <td class="metric-value">${formatNumber(plan)}</td>
                        <td class="metric-value">${formatNumber(mtd)}</td>
                        <td>${formatNumber(threeLM)}</td>
                        <td>${formatNumber(lm)}</td>
                        <td><span class="recommendation">${rekomendasi}</span></td>
                    </tr>
                `;
            });
            
            const totalGap = totalMTD - totalPlan;
            const totalGapBadgeClass = totalGap > 0 ? 'gap-positive' : totalGap < 0 ? 'gap-negative' : 'gap-neutral';
            
            html += `
                <tr class="summary-row">
                    <td></td>
                    <td><strong>TOTAL</strong></td>
                    <td></td>
                    <td><span class="gap-badge ${totalGapBadgeClass}"><strong>${totalGap > 0 ? '+' : ''}${formatNumber(totalGap)}</strong></span></td>
                    <td><strong>${formatNumber(totalPlan)}</strong></td>
                    <td><strong>${formatNumber(totalMTD)}</strong></td>
                    <td></td>
                    <td></td>
                    <td>-</td>
                </tr>
            `;
            
            tableBody.innerHTML = html;
            
            console.log(`üìä Table rendered: ${data.length} items with summary row and MSS status coloring`);
            if (mssInactiveCount > 0 || mssActiveCount > 0) {
                console.log(`üé® MSS Status: ${mssActiveCount} active (green), ${mssInactiveCount} inactive (yellow)`);
            }
        }

        function generateRecommendation(gap, plan, mtd) {
            if (mtd === 0 || mtd === null || mtd === undefined) {
                return "Belum Aktif";
            } else if (mtd > 0 && mtd < plan) {
                return "Under Plan";
            } else if (mtd > 0 && mtd >= plan) {
                return "Over Plan";
            }
            return "Belum Aktif";
        }

        // ===== UI FUNCTIONS =====
        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'flex' : 'none';
        }

        function showMainContent(show) {
            document.getElementById('mainContent').style.display = show ? 'block' : 'none';
        }

        // ===== INITIALIZATION =====
        async function initializeData() {
            try {
                showLoading(true);
                
                console.log('üöÄ Starting Firebase-enabled visit system with pause/resume & location tracking...');
                
                const currentDay = updateDayIndicator();
                
                console.log('üÜî Initializing salesman from URL...');
                initializeSalesmanFromUrl();
                
                if (currentSalesmanId) {
                    cleanupCorruptedLocalStorage();
                    clearOldVisitData();
                    loadPausedVisitsFromLocal();
                }
                
                console.log('üë§ Loading salesman data...');
                await loadSalesmanData();
                
                console.log('üè™ Loading pelanggan data...');
                await loadPelangganData();
                
                console.log('üìä Loading details data...');
                await loadDetailsData();

                console.log('üéØ Loading TPOM data...');
                await loadTPOMData();
                
                console.log('üì¶ Loading SKU master data...');
                await loadSKUData();
                
                console.log('üéØ Loading project data...');
                await loadProjectData();
                
                console.log('‚úÖ All data loaded successfully. Processing hari data...');
                
                if (pelangganData.length > 0 && currentSalesmanId) {
                    console.log('üîç Filtering hari data for salesman...');
                    
                    const filteredData = pelangganData.filter(item => {
                        const itemSalesmanId = (item.szEmployeeId || '').toString().trim();
                        return itemSalesmanId === currentSalesmanId;
                    });
                    
                    const uniqueHari = [...new Set(filteredData
                        .map(item => normalizeHariFormat(item.Hari_Kunjungan))
                        .filter(hari => hari && hari.trim() !== '')
                    )];
                    
                    const filteredByDay = filterHariByCurrentDay(uniqueHari, currentDay);
                    console.log(`üìÖ Hari filtered for ${currentDay}: ${filteredByDay.length}`, filteredByDay);
                    
                    if (filteredByDay.length > 0) {
                        hariData = filteredByDay.map(hari => ({ Hari_Kunjungan: hari }));
                    }
                }
                
                if (hariData.length === 0) {
                    console.log('‚ö†Ô∏è No hari data found, using current day fallback...');
                    hariData = [{ Hari_Kunjungan: currentDay }];
                }
                
                const hariSelect = document.getElementById('hari');
                hariSelect.innerHTML = '<option value="">üìÖ Pilih Hari JKS</option>';
                
                hariData.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.Hari_Kunjungan;
                    option.textContent = item.Hari_Kunjungan;
                    hariSelect.appendChild(option);
                });
                
                loadTodayVisitedCustomers();
                updateCustomerListInactiveStatus();
                
                if (window.firebaseDB) {
                    setTimeout(syncPendingVisitsToFirebase, 2000);
                }
                
                showLoading(false);
                showMainContent(true);
                
                console.log('‚úÖ Enhanced visit system with pause/resume & location tracking ready');
                console.log(`üìÖ Current day: ${currentDay}`);
                console.log(`üìä Available hari options: ${hariData.length}`);
                console.log(`‚è∏Ô∏è Paused visits loaded: ${pausedVisits.size}`);
                console.log('üìç 10-minute location tracking enabled');
                console.log('üè™ Order status tracking enabled');
                console.log('üíæ Local storage session management active');
                console.log('üî• Firebase sync enabled');
                console.log('üî¥ Inactive customer marking system enabled');
                console.log('üìë Tab system enabled: Data SKU & SKU MSS Belum Aktif'); // ‚Üê TAMBAHKAN
                console.log(`üë• Salesman Team Filter: ${salesmanTeam || 'Not set yet'}`);

            } catch (error) {
                console.error('‚ùå Critical error in initializeData:', error);
                showLoading(false);
                document.getElementById('errorMessage').style.display = 'block';
            }
        }

        function cleanupCorruptedLocalStorage() {
            if (!currentSalesmanId) return;
            
            const keyPrefix = `visited_${currentSalesmanId}`;
            const keysToCheck = [];
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith(keyPrefix)) {
                    keysToCheck.push(key);
                }
            }
            
            keysToCheck.forEach(key => {
                try {
                    const data = localStorage.getItem(key);
                    const parsed = JSON.parse(data);
                    
                    if (!Array.isArray(parsed)) {
                        console.warn(`‚ö†Ô∏è Removing invalid localStorage key: ${key}`);
                        localStorage.removeItem(key);
                        return;
                    }
                    
                    const isValid = parsed.every(item => {
                        return typeof item === 'object' && item.outlet_name;
                    });
                    
                    if (!isValid) {
                        console.warn(`‚ö†Ô∏è Removing corrupted localStorage key: ${key}`);
                        localStorage.removeItem(key);
                    }
                    
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Removing unparseable localStorage key: ${key}`);
                    localStorage.removeItem(key);
                }
            });
        }

        async function syncPendingVisitsToFirebase() {
            if (!window.firebaseDB || !currentSalesmanId) {
                return;
            }

            try {
                const pendingKey = `pending_firebase_visits_${currentSalesmanId}`;
                const pendingVisits = JSON.parse(localStorage.getItem(pendingKey) || '[]');
                
                if (pendingVisits.length === 0) {
                    return;
                }
                
                console.log(`üî• Syncing ${pendingVisits.length} pending visits to Firebase...`);
                
                const syncPromises = pendingVisits.map(async (visit) => {
                    try {
                        const firebaseKey = await syncVisitToFirebase(visit);
                        if (firebaseKey) {
                            return visit.local_id;
                        }
                    } catch (error) {
                        console.error('üî• Error syncing visit:', visit.local_id, error);
                        return null;
                    }
                });
                
                const syncedIds = (await Promise.all(syncPromises)).filter(id => id !== null);
                
                if (syncedIds.length > 0) {
                    const remainingVisits = pendingVisits.filter(visit => !syncedIds.includes(visit.local_id));
                    localStorage.setItem(pendingKey, JSON.stringify(remainingVisits));
                    console.log(`üî• ${syncedIds.length} visits synced, ${remainingVisits.length} remaining`);
                }
                
            } catch (error) {
                console.error('üî• Error syncing pending visits:', error);
            }
        }

        // Add manual sync button for testing
        function addManualSyncButton() {
            const floatingActions = document.getElementById('floatingActions');
            
            if (floatingActions && currentSalesmanId) {
                const manualSyncBtn = document.createElement('button');
                manualSyncBtn.className = 'floating-btn btn-manual-sync';
                manualSyncBtn.innerHTML = 'üìç Sync Location';
                manualSyncBtn.onclick = forceSyncLocation;
                
                floatingActions.appendChild(manualSyncBtn);
            }
        }

        // Enhanced initialization function
        function initializeEnhancedLocation() {
            initializeLocationTracking();
            
            // Update enhanced status every 30 seconds
            setInterval(updateEnhancedLocationStatus, 30000);
            
            // Check admin access
            setTimeout(checkAdminAccess, 1000);
        }

        // ===== EVENT LISTENERS =====
        document.addEventListener('DOMContentLoaded', function() {
            // Add null checks before adding event listeners
            const hariSelect = document.getElementById('hari');
            const pelangganSelect = document.getElementById('pelanggan');
            
            if (hariSelect) {
                hariSelect.addEventListener('change', updatePelangganOptions);
            } else {
                console.error('‚ùå Element #hari not found');
            }
            
            if (pelangganSelect) {
                pelangganSelect.addEventListener('change', handlePelangganSelection);
            } else {
                console.error('‚ùå Element #pelanggan not found');
            }

            updateVisitSessionStatus();
            updateFloatingButtons();
            
            // Initialize enhanced location tracking
            setTimeout(initializeEnhancedLocation, 1000);
            
            // Add manual sync button for testing
            setTimeout(addManualSyncButton, 2000);
            
            initializeData();

            setInterval(() => {
                if (window.firebaseDB && currentSalesmanId) {
                    syncPendingVisitsToFirebase();
                }
            }, 30000);

            setInterval(() => {
                updateFloatingButtons();
            }, 3000);
        });

        // ===== NAVIGATION FUNCTIONS WITH SESSION PROTECTION =====
        function goHome() {
            if (!checkActiveSessionBeforeAction('navigate_home')) return;
            window.location.href = 'dashboard.html'; 
        }
        
        function showVisitOutlet() { 
            window.location.href = 'visit.html';
        }
        
		function formatRupiah(angka) {
			if (!angka) return '';
			const number = angka.toString().replace(/[^0-9]/g, '');
			return number.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
		}

		// Remove format untuk mendapatkan angka asli
		function unformatRupiah(formatted) {
			return formatted.replace(/\./g, '');
		}

		// Auto-format saat user mengetik
		document.getElementById('soAmountInput').addEventListener('input', function(e) {
			let val = this.value.replace(/\D/g, '');
			let cursorPos = this.selectionStart;
			
			// Count dots before cursor in old value
			let oldDotsBeforeCursor = (this.value.substring(0, cursorPos).match(/\./g) || []).length;
			
			// Format
			if (val) {
				this.value = val.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
			} else {
				this.value = '';
			}
			
			// Count dots before cursor in new value
			let newVal = this.value;
			let newDotsBeforeCursor = 0;
			let digitsSeen = 0;
			
			for (let i = 0; i < newVal.length && digitsSeen < cursorPos - oldDotsBeforeCursor; i++) {
				if (newVal[i] === '.') {
					newDotsBeforeCursor++;
				} else {
					digitsSeen++;
				}
			}
			
			// Set cursor
			let newCursorPos = (cursorPos - oldDotsBeforeCursor) + newDotsBeforeCursor;
			this.setSelectionRange(newCursorPos, newCursorPos);
		});
        // ===== CLEANUP AND VISIBILITY HANDLING =====
        window.addEventListener('beforeunload', function (e) {
            if (visitSession.isActive && !visitSession.isPaused) {
                const confirmationMessage = `‚ö†Ô∏è Anda memiliki kunjungan aktif ke ${visitSession.outletName}.\n\nJika Anda meninggalkan halaman, kunjungan akan dianggap tidak selesai.`;
                
                e.preventDefault();
                e.returnValue = confirmationMessage;
                return confirmationMessage;
            }
            
            if (isLocationTrackingActive) {
                // Final location sync before leaving
                syncCurrentLocationToFirebase();
                stopPeriodicLocationTracking();
            }
        });

        // Visibility change handling for location tracking
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Page is hidden - maintain tracking
                console.log('üìç Page hidden - maintaining tracking');
            } else {
                // Page is visible - ensure tracking is active
                console.log('üìç Page visible - ensuring tracking is active');
                if (currentSalesmanId && !isLocationTrackingActive) {
                    initializeLocationTracking();
                }
            }
        });

        console.log('‚úÖ Enhanced Visit System with Pause/Resume & Location Tracking loaded');
        console.log('‚è∏Ô∏è Pause/Resume functionality enabled');
        console.log('üîÑ Visit session management with time tracking');
        console.log('üíæ Local storage + Firebase for comprehensive tracking');
        console.log('üó∫Ô∏è Location tracking for pause/resume events');
        console.log('üìä Enhanced visit analytics with pause data');
        console.log('üìç 10-minute periodic location sync to Firebase');
        console.log('üë• Admin position monitoring available');
        console.log('üõ°Ô∏è Improved session protection and data integrity');
        console.log('üé® SKU MSS status coloring enabled (Yellow=Inactive, Green=Active)');
        console.log('üîí Tab system: Data SKU & SKU MSS Belum Aktif with team filtering');
        console.log('üì¶ SKU MSS includes both outlet data and master SKU_Fokus=MSS data');
        console.log('üîç Smart deduplication: Shows MSS SKU from master if not in outlet or inactive');
        console.log('üë• Team-based filtering: ARJUNA (Arjuna only), BIMA (Bima only), YUDISTIRA (Arjuna + Bima)');

    </script>
</body>
</html>