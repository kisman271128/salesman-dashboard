<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>Location Compliance - Mobile Dashboard</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(180deg, #f8f9ff 0%, #e8ecff 100%);
            min-height: 100vh;
            color: #2c3e50;
            overflow-x: hidden;
            padding-bottom: 80px;
        }

        .mobile-container {
            max-width: 414px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        /* ===== HEADER ===== */
        .mobile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .header-title {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 8px;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .header-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .info-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .info-label {
            font-size: 10px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .info-value {
            font-size: 12px;
            font-weight: 600;
        }

        /* ===== STATUS BAR ===== */
        .status-bar {
            background: white;
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .location-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-active { background: #10b981; }
        .status-warning { background: #f59e0b; }
        .status-error { background: #ef4444; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .compliance-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-compliant {
            background: #ecfdf5;
            color: #10b981;
        }

        .badge-warning {
            background: #fef3c7;
            color: #f59e0b;
        }

        .badge-violation {
            background: #fef2f2;
            color: #ef4444;
        }

        /* ===== QUICK STATS ===== */
        .quick-stats {
            padding: 16px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .stat-card {
            background: white;
            padding: 12px 8px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #f1f5f9;
        }

        .stat-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 2px;
        }

        .stat-label {
            font-size: 9px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        /* ===== COMPLIANCE SECTIONS ===== */
        .compliance-section {
            margin: 16px;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-action {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
        }

        .section-content {
            padding: 16px;
        }

        /* ===== CURRENT VISIT CARD ===== */
        .current-visit {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .visit-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .visit-customer {
            font-size: 14px;
            font-weight: 600;
            color: #0369a1;
            margin-bottom: 4px;
        }

        .visit-time {
            font-size: 11px;
            color: #64748b;
        }

        .visit-distance {
            text-align: right;
        }

        .distance-value {
            font-size: 18px;
            font-weight: 700;
            color: #0369a1;
        }

        .distance-label {
            font-size: 9px;
            color: #64748b;
            text-transform: uppercase;
        }

        .visit-details {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .visit-detail {
            text-align: center;
            background: rgba(255, 255, 255, 0.5);
            padding: 8px;
            border-radius: 8px;
        }

        .detail-value {
            font-size: 12px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 2px;
        }

        .detail-label {
            font-size: 9px;
            color: #64748b;
            text-transform: uppercase;
        }

        /* ===== VISIT HISTORY ===== */
        .visit-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f8fafc;
        }

        .visit-item:last-child {
            border-bottom: none;
        }

        .visit-indicator {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 12px;
            color: white;
            font-weight: 600;
        }

        .indicator-compliant { background: #10b981; }
        .indicator-warning { background: #f59e0b; }
        .indicator-violation { background: #ef4444; }

        .visit-info {
            flex: 1;
        }

        .visit-customer-name {
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 2px;
        }

        .visit-meta {
            font-size: 11px;
            color: #64748b;
        }

        .visit-compliance {
            text-align: right;
        }

        .compliance-score {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .score-excellent { color: #10b981; }
        .score-good { color: #3b82f6; }
        .score-warning { color: #f59e0b; }
        .score-poor { color: #ef4444; }

        /* ===== MAP SECTION ===== */
        .map-section {
            height: 300px;
            margin: 16px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        #complianceMap {
            height: 100%;
            width: 100%;
        }

        .map-overlay {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 8px 12px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 11px;
        }

        .map-controls {
            position: absolute;
            bottom: 12px;
            right: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }

        .map-btn {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: none;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            color: #1e293b;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* ===== PERFORMANCE METRICS ===== */
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f8fafc;
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-size: 12px;
            color: #64748b;
        }

        .metric-value {
            font-size: 12px;
            font-weight: 600;
            color: #1e293b;
        }

        .metric-bar {
            width: 60px;
            height: 4px;
            background: #f1f5f9;
            border-radius: 2px;
            overflow: hidden;
            margin-left: 8px;
        }

        .metric-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.3s ease;
        }

        /* ===== ALERTS SECTION ===== */
        .alert-item {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .alert-item.error {
            background: #fef2f2;
            border-color: #ef4444;
        }

        .alert-item.success {
            background: #ecfdf5;
            border-color: #10b981;
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .alert-title {
            font-weight: 600;
            color: #92400e;
        }

        .alert-item.error .alert-title {
            color: #991b1b;
        }

        .alert-item.success .alert-title {
            color: #065f46;
        }

        .alert-time {
            font-size: 10px;
            opacity: 0.8;
        }

        .alert-message {
            color: #78350f;
        }

        .alert-item.error .alert-message {
            color: #7f1d1d;
        }

        .alert-item.success .alert-message {
            color: #064e3b;
        }

        /* ===== BOTTOM NAVIGATION ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 414px;
            background: white;
            border-top: 1px solid #f1f5f9;
            padding: 12px 16px;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #94a3b8;
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 12px;
            min-width: 60px;
        }

        .nav-item.active {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .nav-item:hover {
            color: #667eea;
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-label {
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        /* ===== RESPONSIVE & PWA ===== */
        @media (max-width: 414px) {
            .mobile-container {
                max-width: 100vw;
                box-shadow: none;
            }

            .quick-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .stat-card {
                padding: 16px 12px;
            }

            .visit-details {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-height: 700px) {
            .map-section {
                height: 200px;
            }
        }

        /* ===== LOADING STATES ===== */
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .fade-in {
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        /* ===== NOTIFICATION TOAST ===== */
        .toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 300px;
            text-align: center;
        }

        .toast.show {
            opacity: 1;
            top: 100px;
        }

        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        .toast.warning { background: #f59e0b; }
    </style>
</head>
<body>
    <div class="mobile-container">
        <!-- Header -->
        <div class="mobile-header">
            <div class="header-top">
                <div class="header-title">
                    📍 Location Compliance
                </div>
                <div class="header-actions">
                    <button class="header-btn" onclick="refreshCompliance()">🔄</button>
                    <button class="header-btn" onclick="showSettings()">⚙️</button>
                </div>
            </div>
            <div class="header-info">
                <div class="info-item">
                    <div class="info-label">Today's Score</div>
                    <div class="info-value" id="todayScore">94%</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Current Status</div>
                    <div class="info-value" id="currentStatus">Compliant</div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="location-status">
                <div class="status-dot status-active" id="locationDot"></div>
                <span id="locationText">Location Active</span>
            </div>
            <div class="compliance-badge badge-compliant" id="complianceBadge">
                Compliant
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="quick-stats">
            <div class="stat-card">
                <div class="stat-icon">✅</div>
                <div class="stat-value" id="compliantVisits">8</div>
                <div class="stat-label">Compliant</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">⚠️</div>
                <div class="stat-value" id="warningVisits">2</div>
                <div class="stat-label">Warning</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">❌</div>
                <div class="stat-value" id="violationVisits">0</div>
                <div class="stat-label">Violation</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">📊</div>
                <div class="stat-value" id="accuracyScore">96%</div>
                <div class="stat-label">Accuracy</div>
            </div>
        </div>

        <!-- Current Visit Section -->
        <div class="compliance-section">
            <div class="section-header">
                <div class="section-title">🎯 Current Visit</div>
                <button class="section-action" onclick="endCurrentVisit()">End Visit</button>
            </div>
            <div class="section-content">
                <div class="current-visit" id="currentVisitCard">
                    <div class="visit-header">
                        <div>
                            <div class="visit-customer" id="currentCustomer">Toko Sinar Jaya</div>
                            <div class="visit-time" id="visitStartTime">Started: 09:45 AM</div>
                        </div>
                        <div class="visit-distance">
                            <div class="distance-value" id="currentDistance">23m</div>
                            <div class="distance-label">Distance</div>
                        </div>
                    </div>
                    <div class="visit-details">
                        <div class="visit-detail">
                            <div class="detail-value" id="visitDuration">45:30</div>
                            <div class="detail-label">Duration</div>
                        </div>
                        <div class="visit-detail">
                            <div class="detail-value" id="locationAccuracy">±12m</div>
                            <div class="detail-label">Accuracy</div>
                        </div>
                        <div class="visit-detail">
                            <div class="detail-value" id="complianceStatus">Perfect</div>
                            <div class="detail-label">Status</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map Section -->
        <div class="map-section">
            <div id="complianceMap"></div>
            <div class="map-overlay" id="mapOverlay">
                📍 Real-time Location Tracking
            </div>
            <div class="map-controls">
                <button class="map-btn" onclick="centerOnLocation()">📍</button>
                <button class="map-btn" onclick="toggleMapType()">🗺️</button>
            </div>
        </div>

        <!-- Visit History Section -->
        <div class="compliance-section">
            <div class="section-header">
                <div class="section-title">📋 Today's Visits</div>
                <button class="section-action" onclick="showAllHistory()">View All</button>
            </div>
            <div class="section-content">
                <div id="visitHistoryList">
                    <div class="visit-item">
                        <div class="visit-indicator indicator-compliant">✓</div>
                        <div class="visit-info">
                            <div class="visit-customer-name">Warung Bu Sari</div>
                            <div class="visit-meta">08:30 - 09:15 • 15m distance</div>
                        </div>
                        <div class="visit-compliance">
                            <div class="compliance-score score-excellent">Excellent</div>
                        </div>
                    </div>
                    
                    <div class="visit-item">
                        <div class="visit-indicator indicator-warning">⚠</div>
                        <div class="visit-info">
                            <div class="visit-customer-name">Toko Makmur</div>
                            <div class="visit-meta">07:45 - 08:20 • 85m distance</div>
                        </div>
                        <div class="visit-compliance">
                            <div class="compliance-score score-warning">Good</div>
                        </div>
                    </div>
                    
                    <div class="visit-item">
                        <div class="visit-indicator indicator-compliant">✓</div>
                        <div class="visit-info">
                            <div class="visit-customer-name">Supermarket Jaya</div>
                            <div class="visit-meta">07:00 - 07:35 • 8m distance</div>
                        </div>
                        <div class="visit-compliance">
                            <div class="compliance-score score-excellent">Perfect</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="compliance-section">
            <div class="section-header">
                <div class="section-title">📈 Performance Metrics</div>
                <button class="section-action" onclick="showDetailedMetrics()">Details</button>
            </div>
            <div class="section-content">
                <div class="metric-row">
                    <div class="metric-label">Location Accuracy</div>
                    <div style="display: flex; align-items: center;">
                        <div class="metric-value">96%</div>
                        <div class="metric-bar">
                            <div class="metric-fill" style="width: 96%;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="metric-row">
                    <div class="metric-label">Visit Compliance</div>
                    <div style="display: flex; align-items: center;">
                        <div class="metric-value">89%</div>
                        <div class="metric-bar">
                            <div class="metric-fill" style="width: 89%;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="metric-row">
                    <div class="metric-label">Time Efficiency</div>
                    <div style="display: flex; align-items: center;">
                        <div class="metric-value">92%</div>
                        <div class="metric-bar">
                            <div class="metric-fill" style="width: 92%;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="metric-row">
                    <div class="metric-label">Data Quality</div>
                    <div style="display: flex; align-items: center;">
                        <div class="metric-value">98%</div>
                        <div class="metric-bar">
                            <div class="metric-fill" style="width: 98%;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts Section -->
        <div class="compliance-section">
            <div class="section-header">
                <div class="section-title">🔔 Recent Alerts</div>
                <button class="section-action" onclick="clearAlerts()">Clear</button>
            </div>
            <div class="section-content">
                <div id="alertsList">
                    <div class="alert-item success">
                        <div class="alert-header">
                            <div class="alert-title">Perfect Visit Completed</div>
                            <div class="alert-time">2 min ago</div>
                        </div>
                        <div class="alert-message">
                            Visit to Toko Sinar Jaya completed with 100% location accuracy
                        </div>
                    </div>
                    
                    <div class="alert-item">
                        <div class="alert-header">
                            <div class="alert-title">Location Accuracy Warning</div>
                            <div class="alert-time">1 hour ago</div>
                        </div>
                        <div class="alert-message">
                            Visit to Toko Makmur had 85m location deviation from master data
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="showComplianceTab()">
            <div class="nav-icon">📍</div>
            <div class="nav-label">Compliance</div>
        </div>
        <div class="nav-item" onclick="showMapTab()">
            <div class="nav-icon">🗺️</div>
            <div class="nav-label">Map</div>
        </div>
        <div class="nav-item" onclick="showReportsTab()">
            <div class="nav-icon">📊</div>
            <div class="nav-label">Reports</div>
        </div>
        <div class="nav-item" onclick="showSettingsTab()">
            <div class="nav-icon">⚙️</div>
            <div class="nav-label">Settings</div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

    <script>
        // ===== GLOBAL VARIABLES =====
        let complianceMap = null;
        let currentLocationMarker = null;
        let customerLocationMarker = null;
        let currentPosition = null;
        let currentCustomerCoords = null;
        let visitStartTime = null;
        let complianceData = {
            todayScore: 94,
            compliantVisits: 8,
            warningVisits: 2,
            violationVisits: 0,
            accuracyScore: 96
        };

        // ===== MOBILE COMPLIANCE TRACKER =====
        class MobileComplianceTracker {
            constructor() {
                this.isTracking = false;
                this.positionWatcher = null;
                this.complianceThreshold = 100; // meters
                this.warningThreshold = 50; // meters
                this.updateInterval = null;
                this.visitHistory = [];
                
                this.init();
            }
            
            init() {
                console.log('📱 Mobile Compliance Tracker initialized');
                
                this.initializeMap();
                this.startLocationTracking();
                this.loadTodayData();
                this.startUIUpdates();
            }
            
            initializeMap() {
                // Initialize map centered on Jakarta
                complianceMap = L.map('complianceMap', {
                    zoomControl: false,
                    attributionControl: false
                }).setView([-6.2088, 106.8456], 15);
                
                // Add map tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 18
                }).addTo(complianceMap);
                
                console.log('🗺️ Compliance map initialized');
            }
            
            startLocationTracking() {
                if (!navigator.geolocation) {
                    this.showToast('Geolocation not supported', 'error');
                    return;
                }
                
                this.updateLocationStatus('tracking', 'Getting location...');
                
                // Get initial position
                navigator.geolocation.getCurrentPosition(
                    (position) => this.handleLocationSuccess(position),
                    (error) => this.handleLocationError(error),
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 30000
                    }
                );
                
                // Start watching position
                this.positionWatcher = navigator.geolocation.watchPosition(
                    (position) => this.handleLocationUpdate(position),
                    (error) => this.handleLocationError(error),
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 60000
                    }
                );
                
                this.isTracking = true;
            }
            
            handleLocationSuccess(position) {
                currentPosition = position;
                this.updateLocationUI(position);
                this.updateLocationStatus('active', 'Location Active');
                this.updateMapPosition(position);
                
                console.log('📍 Location acquired:', position.coords);
            }
            
            handleLocationUpdate(position) {
                currentPosition = position;
                this.updateLocationUI(position);
                this.updateMapPosition(position);
                
                // Update current visit distance if in visit
                if (currentCustomerCoords) {
                    this.updateCurrentVisitDistance();
                }
            }
            
            handleLocationError(error) {
                let message = 'Location error';
                
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        message = 'Location access denied';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message = 'Location unavailable';
                        break;
                    case error.TIMEOUT:
                        message = 'Location timeout';
                        break;
                }
                
                this.updateLocationStatus('error', message);
                this.showToast(message, 'error');
            }
            
            updateLocationUI(position) {
                const accuracy = Math.round(position.coords.accuracy);
                document.getElementById('locationAccuracy').textContent = `±${accuracy}m`;
                
                // Update map overlay
                document.getElementById('mapOverlay').textContent = 
                    `📍 Accuracy: ±${accuracy}m | Updated: ${new Date().toLocaleTimeString()}`;
            }
            
            updateLocationStatus(status, message) {
                const dot = document.getElementById('locationDot');
                const text = document.getElementById('locationText');
                
                dot.className = `status-dot status-${status}`;
                text.textContent = message;
            }
            
            updateMapPosition(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                
                // Remove existing current location marker
                if (currentLocationMarker) {
                    complianceMap.removeLayer(currentLocationMarker);
                }
                
                // Add current location marker
                currentLocationMarker = L.circleMarker([lat, lng], {
                    radius: 8,
                    fillColor: '#3b82f6',
                    color: 'white',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(complianceMap);
                
                // Add accuracy circle
                const accuracyCircle = L.circle([lat, lng], {
                    radius: accuracy,
                    fillColor: '#3b82f6',
                    color: '#3b82f6',
                    weight: 1,
                    opacity: 0.3,
                    fillOpacity: 0.1
                }).addTo(complianceMap);
                
                // Center map on current location
                complianceMap.setView([lat, lng], complianceMap.getZoom());
            }
            
            startCurrentVisit(customerName, customerCoords) {
                currentCustomerCoords = customerCoords;
                visitStartTime = new Date();
                
                document.getElementById('currentCustomer').textContent = customerName;
                document.getElementById('visitStartTime').textContent = 
                    `Started: ${visitStartTime.toLocaleTimeString()}`;
                
                // Add customer location marker
                if (customerLocationMarker) {
                    complianceMap.removeLayer(customerLocationMarker);
                }
                
                customerLocationMarker = L.circleMarker([customerCoords.lat, customerCoords.lng], {
                    radius: 6,
                    fillColor: '#10b981',
                    color: 'white',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(complianceMap);
                
                // Fit map to show both locations
                if (currentPosition) {
                    const group = new L.featureGroup([currentLocationMarker, customerLocationMarker]);
                    complianceMap.fitBounds(group.getBounds().pad(0.2));
                }
                
                this.updateCurrentVisitDistance();
                this.showToast(`Started visit to ${customerName}`, 'success');
            }
            
            updateCurrentVisitDistance() {
                if (!currentPosition || !currentCustomerCoords) return;
                
                const distance = this.calculateDistance(
                    currentPosition.coords.latitude,
                    currentPosition.coords.longitude,
                    currentCustomerCoords.lat,
                    currentCustomerCoords.lng
                );
                
                document.getElementById('currentDistance').textContent = 
                    distance < 1000 ? `${Math.round(distance)}m` : `${(distance/1000).toFixed(2)}km`;
                
                // Update compliance status
                this.updateComplianceStatus(distance);
                
                // Update visit duration
                if (visitStartTime) {
                    const duration = Math.floor((Date.now() - visitStartTime.getTime()) / 1000);
                    document.getElementById('visitDuration').textContent = this.formatDuration(duration);
                }
            }
            
            updateComplianceStatus(distance) {
                let status, statusClass, badgeText, badgeClass;
                
                if (distance <= this.warningThreshold) {
                    status = 'Perfect';
                    statusClass = 'score-excellent';
                    badgeText = 'Compliant';
                    badgeClass = 'badge-compliant';
                } else if (distance <= this.complianceThreshold) {
                    status = 'Good';
                    statusClass = 'score-good';
                    badgeText = 'Compliant';
                    badgeClass = 'badge-compliant';
                } else if (distance <= 500) {
                    status = 'Warning';
                    statusClass = 'score-warning';
                    badgeText = 'Warning';
                    badgeClass = 'badge-warning';
                } else {
                    status = 'Poor';
                    statusClass = 'score-poor';
                    badgeText = 'Violation';
                    badgeClass = 'badge-violation';
                }
                
                document.getElementById('complianceStatus').textContent = status;
                document.getElementById('complianceStatus').className = `detail-value ${statusClass}`;
                
                const badge = document.getElementById('complianceBadge');
                badge.textContent = badgeText;
                badge.className = `compliance-badge ${badgeClass}`;
            }
            
            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371e3; // Earth's radius in meters
                const φ1 = lat1 * Math.PI/180;
                const φ2 = lat2 * Math.PI/180;
                const Δφ = (lat2-lat1) * Math.PI/180;
                const Δλ = (lon2-lon1) * Math.PI/180;
                
                const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                          Math.cos(φ1) * Math.cos(φ2) *
                          Math.sin(Δλ/2) * Math.sin(Δλ/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                
                return R * c;
            }
            
            formatDuration(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                
                if (hours > 0) {
                    return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                } else {
                    return `${minutes}:${secs.toString().padStart(2, '0')}`;
                }
            }
            
            loadTodayData() {
                // Load compliance data for today
                this.updateQuickStats();
                this.loadVisitHistory();
            }
            
            updateQuickStats() {
                document.getElementById('compliantVisits').textContent = complianceData.compliantVisits;
                document.getElementById('warningVisits').textContent = complianceData.warningVisits;
                document.getElementById('violationVisits').textContent = complianceData.violationVisits;
                document.getElementById('accuracyScore').textContent = complianceData.accuracyScore + '%';
                document.getElementById('todayScore').textContent = complianceData.todayScore + '%';
            }
            
            loadVisitHistory() {
                // History is already loaded in HTML for demo
                // In real implementation, this would load from localStorage
            }
            
            startUIUpdates() {
                // Update UI every second
                this.updateInterval = setInterval(() => {
                    if (visitStartTime) {
                        const duration = Math.floor((Date.now() - visitStartTime.getTime()) / 1000);
                        document.getElementById('visitDuration').textContent = this.formatDuration(duration);
                    }
                }, 1000);
            }
            
            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type}`;
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
            
            endCurrentVisit() {
                if (!visitStartTime) {
                    this.showToast('No active visit to end', 'warning');
                    return;
                }
                
                const duration = Math.floor((Date.now() - visitStartTime.getTime()) / 1000);
                const customerName = document.getElementById('currentCustomer').textContent;
                
                // Reset current visit
                visitStartTime = null;
                currentCustomerCoords = null;
                
                if (customerLocationMarker) {
                    complianceMap.removeLayer(customerLocationMarker);
                    customerLocationMarker = null;
                }
                
                // Update UI
                document.getElementById('currentCustomer').textContent = 'No active visit';
                document.getElementById('visitStartTime').textContent = 'Not started';
                document.getElementById('currentDistance').textContent = '-';
                document.getElementById('visitDuration').textContent = '00:00';
                document.getElementById('complianceStatus').textContent = '-';
                
                this.showToast(`Visit to ${customerName} ended (${this.formatDuration(duration)})`, 'success');
            }
        }

        // ===== GLOBAL TRACKER INSTANCE =====
        let complianceTracker = null;

        // ===== UI FUNCTIONS =====
        function refreshCompliance() {
            if (complianceTracker) {
                complianceTracker.loadTodayData();
                complianceTracker.showToast('Data refreshed', 'success');
            }
        }

        function showSettings() {
            // Navigate to settings or show settings modal
            alert('Settings panel would be shown here');
        }

        function endCurrentVisit() {
            if (complianceTracker) {
                complianceTracker.endCurrentVisit();
            }
        }

        function centerOnLocation() {
            if (complianceMap && currentPosition) {
                complianceMap.setView([
                    currentPosition.coords.latitude, 
                    currentPosition.coords.longitude
                ], 16);
                
                if (complianceTracker) {
                    complianceTracker.showToast('Map centered on your location', 'success');
                }
            }
        }

        function toggleMapType() {
            // Toggle between different map types
            if (complianceTracker) {
                complianceTracker.showToast('Map type toggled', 'success');
            }
        }

        function showAllHistory() {
            // Navigate to full history view
            alert('Full visit history would be shown here');
        }

        function showDetailedMetrics() {
            // Navigate to detailed metrics view
            alert('Detailed performance metrics would be shown here');
        }

        function clearAlerts() {
            const alertsList = document.getElementById('alertsList');
            alertsList.innerHTML = '<div style="text-align: center; color: #64748b; padding: 20px;">No alerts</div>';
            
            if (complianceTracker) {
                complianceTracker.showToast('Alerts cleared', 'success');
            }
        }

        // ===== NAVIGATION FUNCTIONS =====
        function showComplianceTab() {
            updateActiveNav(0);
            // Show compliance content (already visible)
        }

        function showMapTab() {
            updateActiveNav(1);
            // Focus on map
            if (complianceMap) {
                setTimeout(() => {
                    complianceMap.invalidateSize();
                    centerOnLocation();
                }, 100);
            }
        }

        function showReportsTab() {
            updateActiveNav(2);
            // Navigate to reports or show reports modal
            alert('Reports section would be shown here');
        }

        function showSettingsTab() {
            updateActiveNav(3);
            showSettings();
        }

        function updateActiveNav(activeIndex) {
            document.querySelectorAll('.nav-item').forEach((item, index) => {
                if (index === activeIndex) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // ===== INITIALIZATION =====
        function initializeMobileCompliance() {
            console.log('📱 Initializing Mobile Compliance Dashboard...');
            
            complianceTracker = new MobileComplianceTracker();
            
            // Demo: Start a sample visit after 3 seconds
            setTimeout(() => {
                complianceTracker.startCurrentVisit('Toko Sinar Jaya', {
                    lat: -6.2088,
                    lng: 106.8456
                });
            }, 3000);
            
            console.log('✅ Mobile Compliance Dashboard ready');
        }

        // ===== PAGE LOAD =====
        window.onload = function() {
            console.log('📱 Starting Mobile Location Compliance Dashboard...');
            console.log('📍 Features: Real-time tracking, compliance monitoring, visit management');
            
            initializeMobileCompliance();
        };

        // PWA: Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js').then(function(registration) {
                    console.log('ServiceWorker registration successful');
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }

        console.log('✅ Mobile Location Compliance Dashboard loaded');
        console.log('📱 Mobile-optimized with PWA capabilities');
    </script>
</body>
</html>