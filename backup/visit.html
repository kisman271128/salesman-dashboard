<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visit Outlet - Enhanced with Pause/Resume & Location Tracking</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(180deg, #f8f9ff 0%, #e8ecff 100%);
            min-height: 100vh;
            color: #2c3e50;
            padding-bottom: 100px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 0 0 30px 30px;
            color: white;
            margin-bottom: 20px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 10px;
            border-radius: 12px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(-2px);
        }

        .detail-title-container {
            text-align: center;
            flex: 1;
        }

        .detail-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .salesman-name {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 400;
        }

        .user-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 10px;
            border-radius: 12px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .user-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* ===== ENHANCED VISIT MODALS ===== */
        .visit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .visit-modal.show {
            display: flex;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .visit-modal-content {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 350px;
            width: 90%;
            text-align: center;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .visit-modal-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .visit-modal-subtitle {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 16px;
        }

        .visit-modal-customer {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
            border: 1px solid #cbd5e1;
        }

        .visit-modal-customer-name {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .visit-modal-customer-details {
            font-size: 12px;
            color: #64748b;
        }

        /* ===== PAUSE/RESUME SPECIFIC STYLES ===== */
        .visit-modal-pause {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 1px solid #f59e0b;
        }

        .visit-modal-resume {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            border: 1px solid #10b981;
        }

        .pause-info {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
            text-align: left;
        }

        .pause-info-item {
            font-size: 12px;
            color: #92400e;
            margin: 4px 0;
        }

        .pause-info-item strong {
            color: #78350f;
        }

        .resume-info {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
            text-align: left;
        }

        .resume-info-item {
            font-size: 12px;
            color: #065f46;
            margin: 4px 0;
        }

        .resume-info-item strong {
            color: #047857;
        }

        /* ===== ORDER STATUS SELECTION ===== */
        .order-status-section {
            margin: 16px 0;
            text-align: left;
        }

        .order-status-label {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
            display: block;
        }

        .order-status-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            color: #2d3748;
            margin-bottom: 12px;
        }

        .order-status-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .so-amount-section {
            display: none;
            margin-top: 12px;
        }

        .so-amount-section.show {
            display: block;
            animation: fadeInDown 0.3s ease;
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .so-amount-label {
            font-size: 13px;
            font-weight: 600;
            color: #059669;
            margin-bottom: 6px;
            display: block;
        }

        .so-amount-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #10b981;
            border-radius: 8px;
            font-size: 14px;
            background: #f0fdf4;
            color: #065f46;
            font-weight: 600;
        }

        .so-amount-input:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .visit-modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .visit-modal-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .visit-modal-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .visit-modal-btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .visit-modal-btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .visit-modal-btn-secondary {
            background: #f1f5f9;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }

        .visit-modal-btn-secondary:hover {
            background: #e2e8f0;
        }

        .visit-modal-btn-pause {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .visit-modal-btn-pause:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }

        .visit-modal-btn-resume {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .visit-modal-btn-resume:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        /* ===== FIREBASE SYNC STATUS ===== */
        .firebase-status {
            position: fixed;
            top: 80px;
            right: 10px;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            z-index: 1001;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            display: none;
        }

        .firebase-status.syncing {
            background: rgba(245, 158, 11, 0.9);
            display: block;
        }

        .firebase-status.success {
            background: rgba(16, 185, 129, 0.9);
            display: block;
        }

        .firebase-status.error {
            background: rgba(239, 68, 68, 0.9);
            display: block;
        }

        /* ===== ENHANCED VISIT SESSION STATUS ===== */
        .visit-session-status {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(16, 185, 129, 0.95);
            color: white;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            min-width: 140px;
        }

        .visit-session-status.active {
            display: block;
            animation: pulse 2s infinite;
        }

        .visit-session-status.paused {
            background: rgba(245, 158, 11, 0.95);
            display: block;
            animation: pausePulse 3s infinite;
        }

        .visit-session-customer {
            font-size: 10px;
            opacity: 0.9;
            margin-bottom: 2px;
        }

        .visit-session-timer {
            font-size: 12px;
            font-weight: 700;
        }

        .visit-session-status-text {
            font-size: 9px;
            opacity: 0.8;
            margin-top: 2px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.95; }
            50% { opacity: 1; }
        }

        @keyframes pausePulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        /* ===== ENHANCED LOCATION STATUS ===== */
        .location-status-enhanced {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(245, 158, 11, 0.95);
            color: white;
            padding: 8px 12px;
            border-radius: 16px;
            font-size: 10px;
            font-weight: 600;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.2);
            min-width: 100px;
        }

        .location-status-enhanced.success {
            background: rgba(16, 185, 129, 0.95);
        }

        .location-status-enhanced.error {
            background: rgba(239, 68, 68, 0.95);
        }

        .location-accuracy {
            font-size: 8px;
            opacity: 0.8;
        }

        .location-last-sync {
            font-size: 8px;
            opacity: 0.9;
            margin-top: 2px;
        }

        /* ===== LOCATION TRACKING STATUS ===== */
        .location-tracking-status {
            position: fixed;
            top: 110px;
            right: 10px;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 9px;
            font-weight: 600;
            z-index: 1001;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            min-width: 120px;
            text-align: center;
        }

        .location-tracking-status.active {
            background: rgba(16, 185, 129, 0.9);
            animation: trackingPulse 3s infinite;
        }

        .location-tracking-status.syncing {
            background: rgba(245, 158, 11, 0.9);
        }

        .location-tracking-status.success {
            background: rgba(16, 185, 129, 0.9);
        }

        .location-tracking-status.error {
            background: rgba(239, 68, 68, 0.9);
        }

        .location-tracking-status.stopped {
            background: rgba(107, 114, 128, 0.9);
        }

        @keyframes trackingPulse {
            0%, 100% { opacity: 0.9; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.02); }
        }

        /* ===== DAY INDICATOR ===== */
        .day-indicator {
            position: fixed;
            top: 50px;
            right: 10px;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            z-index: 1001;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        /* Admin position monitoring button */
        .admin-location-btn {
            position: fixed;
            bottom: 120px;
            left: 15px;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 998;
        }

        .admin-location-btn:hover {
            background: rgba(59, 130, 246, 1);
            transform: translateY(-1px);
        }

        .admin-location-btn.show {
            display: block;
        }

        /* Continue with rest of existing styles... */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            flex-direction: column;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.3);
            color: #e74c3c;
            padding: 16px;
            border-radius: 12px;
            margin: 20px;
            text-align: center;
        }

        .content-section {
            padding: 0 16px;
            margin-bottom: 20px;
        }

        .frames-container {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .frame {
            flex: 1;
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .frame-title {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 12px;
            text-align: center;
        }

        .filter-item {
            position: relative;
            margin-bottom: 12px;
        }

        .filter-item:last-child {
            margin-bottom: 0;
        }

        .filter-item select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 12px;
            background: white;
            color: #2d3748;
            appearance: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-item select:disabled {
            background: #f7fafc;
            color: #a0aec0;
            cursor: not-allowed;
            border-color: #e2e8f0;
        }

        .filter-item select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .summary-item {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px;
            text-align: center;
        }

        .summary-label {
            font-size: 10px;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-value {
            font-size: 14px;
            font-weight: 700;
            color: #1e293b;
        }

        .summary-value.positive {
            color: #10b981;
        }

        .summary-value.negative {
            color: #ef4444;
        }

        .summary-value.neutral {
            color: #64748b;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 400px;
            background: white;
            border-top: 1px solid #f1f2f6;
            padding: 15px 0;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #bdc3c7;
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 8px 6px;
            border-radius: 12px;
            min-width: 50px;
        }

        .nav-item.active {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .nav-item:hover {
            color: #667eea;
            transform: translateY(-2px);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 4px;
            font-size: 12px;
        }

        .nav-icon.home { background: #3b82f6; color: white; }
        .nav-icon.visit { background: #ef4444; color: white; }
        .nav-icon.incentive { background: #f59e0b; color: white; }
        .nav-icon.profile { background: #10b981; color: white; }

        .nav-label {
            font-size: 10px;
            font-weight: 500;
        }

        /* Customer Info Display */
        .customer-info {
            margin-top: 8px;
            padding: 6px 8px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            display: none;
        }

        .customer-info-label {
            font-size: 10px;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .customer-info-value {
            font-size: 11px;
            color: #1e293b;
            font-weight: 600;
        }

        .customer-info-row {
            margin-bottom: 4px;
        }

        .customer-info-row:last-child {
            margin-bottom: 0;
        }

        .sku-zero-list {
            font-size: 10px;
            color: #ef4444;
            font-weight: 500;
            background: #fef2f2;
            padding: 2px 4px;
            border-radius: 4px;
            border: 1px solid #fecaca;
        }

        /* ===== FLOATING ACTION BUTTONS ===== */
        .floating-actions {
            position: fixed;
            bottom: 90px;
            right: 15px;
            z-index: 999;
            display: none;
            flex-direction: column;
            gap: 10px;
        }

        .floating-actions.show {
            display: flex;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .floating-btn {
            border: none;
            padding: 12px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .floating-btn:hover {
            transform: translateY(-1px);
        }

        .btn-pause-visit {
            background: #f59e0b;
            color: white;
        }

        .btn-pause-visit:hover {
            background: #d97706;
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4);
        }

        .btn-end-visit {
            background: #ef4444;
            color: white;
        }

        .btn-end-visit:hover {
            background: #dc2626;
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }

        .btn-manual-sync {
            background: #3b82f6;
            color: white;
        }

        .btn-manual-sync:hover {
            background: #2563eb;
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }

        /* Pause indicator for customer list */
        .customer-paused {
            color: #f59e0b !important;
            background: #fef3c7 !important;
            font-style: italic;
        }

        /* Table styles - keeping existing styles */
        .table-section {
            padding: 0 16px;
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 16px;
        }

        .table-wrapper {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .table-container {
            overflow-x: auto;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            position: relative;
            max-height: calc(100vh - 500px);
            width: 100%;
            scroll-behavior: smooth;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            table-layout: auto;
        }

        #dataTable {
            min-width: auto;
        }

        #dataTable th {
            background: #6b7280;
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            position: sticky;
            top: 0;
            z-index: 50;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .sortable-header {
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            position: relative;
        }

        .sortable-header:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
            transform: translateY(-1px);
        }

        #dataTable td {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
            font-size: 11px;
        }

        .positive {
            color: #10b981;
            font-weight: 600;
        }

        .negative {
            color: #ef4444;
            font-weight: 600;
        }

        .neutral {
            color: #64748b;
        }

        .sku-code {
            font-family: 'Courier New', monospace;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }

        /* ===== PROMO TAG STYLING ===== */
        .promo-tag {
            font-weight: 600;
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 4px;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .promo-biscuit, .promo-bisc { 
            background: linear-gradient(135deg, #dc2626, #ef4444);
        }
        .promo-snack, .promo-snackfood { 
            background: linear-gradient(135deg, #7c3aed, #8b5cf6);
        }
        .promo-bev { 
            background: linear-gradient(135deg, #059669, #10b981);
        }
        .promo-others, .promo-sf, .promo-gen, .promo-go { 
            background: linear-gradient(135deg, #0369a1, #0284c7);
        }
        .promo-gbs { 
            background: linear-gradient(135deg, #7c2d12, #ea580c);
        }
        .promo-solmed { 
            background: linear-gradient(135deg, #d97706, #f59e0b);
        }
        .promo-rans, .promo-gbev, .promo-mbr { 
            background: linear-gradient(135deg, #23A0AD, #CBE030);
        }

        /* ===== GAP BADGE STYLING ===== */
        .gap-badge {
            padding: 2px 4px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .gap-positive {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .gap-negative {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .gap-neutral {
            background: linear-gradient(135deg, #64748b, #475569);
        }

        /* ===== TABLE ROW STYLING ===== */
        .summary-row {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-top: 2px solid #667eea;
        }

        .summary-row td {
            font-weight: 700;
            color: #1e293b;
            padding: 12px 6px;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        }

        tr:hover {
            background-color: #f8fafc;
        }

        .metric-value {
            font-weight: 600;
            font-size: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Enhanced Location Status -->
        <div class="location-status-enhanced" id="locationStatusEnhanced">
            <div class="location-main">üìç Mendapatkan lokasi...</div>
            <div class="location-accuracy" id="locationAccuracy">Akurasi: --</div>
            <div class="location-last-sync" id="locationLastSync">Sinkron terakhir: --</div>
        </div>

        <!-- Day Indicator -->
        <div class="day-indicator" id="dayIndicator">
            üìÖ Loading...
        </div>

        <!-- Firebase Sync Status -->
        <div class="firebase-status" id="firebaseStatus">
            üîÑ Sinkronisasi...
        </div>

        <!-- Location Tracking Status -->
        <div class="location-tracking-status" id="locationTrackingStatus">
            üåê Inisialisasi tracking...
        </div>

        <!-- Enhanced Visit Session Status -->
        <div class="visit-session-status" id="visitSessionStatus">
            <div class="visit-session-customer" id="sessionCustomerName">Tidak Ada Kunjungan Aktif</div>
            <div class="visit-session-timer" id="sessionTimer">00:00:00</div>
            <div class="visit-session-status-text" id="sessionStatusText"></div>
        </div>

        <!-- Admin Position Monitoring Button -->
        <button class="admin-location-btn" id="adminLocationBtn" onclick="showAllSalesmanPositions()">
            üë• Lihat Semua Posisi
        </button>

        <div class="detail-header">
            <a href="dashboard.html" class="back-btn">‚Üê</a>
            <div class="detail-title-container">
                <div class="detail-title">Kunjungan Outlet Enhanced</div>
                <div class="salesman-name" id="salesmanName">Loading...</div>
            </div>
            <button class="user-btn" onclick="forceSyncLocation()">üìç</button>
        </div>

        <!-- Loading State -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
            <div>Memuat data...</div>
        </div>

        <!-- Error State -->
        <div class="error-message" id="errorMessage" style="display: none;">
            <h3>üö® Error Memuat Data</h3>
            <p>Tidak dapat memuat data kunjungan. Periksa koneksi Anda.</p>
            <button onclick="initializeData()" style="margin-top: 10px; padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">Coba Lagi</button>
        </div>

        <!-- Main Content -->
        <div id="mainContent" style="display: none;">
            <!-- Visit Tab Content -->
            <div id="visitTab" class="tab-content">
                <!-- Two Frame Layout -->
                <div class="content-section">
                    <div class="frames-container">
                        <!-- Left Frame - Filters -->
                        <div class="frame">
                            <div class="frame-title">üîç Pilih Filter</div>
                            <div class="filter-item">
                                <select id="hari">
                                    <option value="">üìÖ Pilih Hari JKS</option>
                                </select>
                            </div>
                            
                            <div class="filter-item">
                                <select id="pelanggan">
                                    <option value="">üè™ Pilih Outlet</option>
                                </select>
                            </div>
                            
                            <!-- Customer Info Display -->
                            <div id="customerInfo" class="customer-info">
                                <div class="customer-info-row">
                                    <div class="customer-info-label">Tipe Outlet:</div>
                                    <div id="customerType" class="customer-info-value"></div>
                                </div>
                                <div class="customer-info-row">
                                    <div class="customer-info-label">SKU POM (Belum CA):</div>
                                    <div id="skuZeroList" class="customer-info-value sku-zero-list"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Frame - Summary -->
                        <div class="frame">
                            <div class="frame-title">üìä Ringkasan</div>
                            <div class="summary-grid">
                                <div class="summary-item">
                                    <div class="summary-label">Target</div>
                                    <div class="summary-value" id="summaryTarget">-</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-label">Aktual</div>
                                    <div class="summary-value" id="summaryActual">-</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-label">Gap</div>
                                    <div class="summary-value" id="summaryGap">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Visit Data Table -->
                <div class="content-section">
                    <div class="table-section">
                        <div class="section-title">üìä Data Kunjungan:</div>
                        <div class="table-wrapper">
                            <div class="table-container">
                                <table id="dataTable">
                                    <thead>
                                        <tr>
                                            <th>No</th>
                                            <th class="sortable-header" onclick="sortTable('promo')">Promo</th>
                                            <th>SKU</th>
                                            <th>Gap</th>
                                            <th>Plan</th>
                                            <th>MTD</th>
                                            <th>3LM</th>
                                            <th>LM</th>
                                            <th>Rec</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableBody">
                                        <tr>
                                            <td colspan="9">
                                                <div class="empty-state">
                                                    <div class="empty-state-icon">üìä</div>
                                                    <div>Pilih filter untuk melihat data</div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Visit Start Confirmation Modal -->
        <div class="visit-modal" id="visitStartModal">
            <div class="visit-modal-content">
                <div class="visit-modal-title">üè™ Mulai Kunjungan?</div>
                <div class="visit-modal-subtitle">Anda akan memulai kunjungan ke outlet berikut:</div>
                <div class="visit-modal-customer">
                    <div class="visit-modal-customer-name" id="startModalCustomerName">Nama Outlet</div>
                    <div class="visit-modal-customer-details" id="startModalCustomerDetails">Detail</div>
                </div>
                <div class="visit-modal-buttons">
                    <button class="visit-modal-btn visit-modal-btn-secondary" onclick="cancelVisitStart()">
                        ‚ùå Tidak
                    </button>
                    <button class="visit-modal-btn visit-modal-btn-primary" onclick="confirmVisitStart()">
                        ‚úÖ Ya, Mulai
                    </button>
                </div>
            </div>
        </div>

        <!-- Resume Visit Modal -->
        <div class="visit-modal" id="visitResumeModal">
            <div class="visit-modal-content">
                <div class="visit-modal-title">üîÑ Lanjutkan Kunjungan?</div>
                <div class="visit-modal-subtitle">Outlet ini memiliki kunjungan yang tertunda:</div>
                <div class="visit-modal-customer visit-modal-resume">
                    <div class="visit-modal-customer-name" id="resumeModalCustomerName">Nama Outlet</div>
                    <div class="visit-modal-customer-details" id="resumeModalCustomerDetails">Detail</div>
                </div>
                <div class="resume-info" id="resumeInfo">
                    <div class="resume-info-item"><strong>Waktu Mulai:</strong> <span id="resumeStartTime">-</span></div>
                    <div class="resume-info-item"><strong>Waktu Tunda:</strong> <span id="resumePauseTime">-</span></div>
                    <div class="resume-info-item"><strong>Durasi Sebelumnya:</strong> <span id="resumePrevDuration">-</span></div>
                </div>
                <div class="visit-modal-buttons">
                    <button class="visit-modal-btn visit-modal-btn-secondary" onclick="startNewVisit()">
                        üÜï Mulai Baru
                    </button>
                    <button class="visit-modal-btn visit-modal-btn-resume" onclick="confirmResumeVisit()">
                        ‚ñ∂Ô∏è Lanjutkan
                    </button>
                </div>
            </div>
        </div>

        <!-- Pause Visit Modal -->
        <div class="visit-modal" id="visitPauseModal">
            <div class="visit-modal-content">
                <div class="visit-modal-title">‚è∏Ô∏è Tunda Kunjungan?</div>
                <div class="visit-modal-subtitle">Anda akan menunda kunjungan ke:</div>
                <div class="visit-modal-customer visit-modal-pause">
                    <div class="visit-modal-customer-name" id="pauseModalCustomerName">Outlet Saat Ini</div>
                    <div class="visit-modal-customer-details" id="pauseModalCustomerDetails">Durasi: 00:00:00</div>
                </div>
                <div class="pause-info">
                    <div class="pause-info-item"><strong>Alasan:</strong> Pemilik toko tidak ada / sibuk</div>
                    <div class="pause-info-item"><strong>Durasi saat ini:</strong> <span id="pauseCurrentDuration">0 menit</span></div>
                    <div class="pause-info-item"><strong>Status:</strong> Kunjungan akan disimpan dan dapat dilanjutkan nanti</div>
                </div>
                <div class="visit-modal-buttons">
                    <button class="visit-modal-btn visit-modal-btn-secondary" onclick="cancelPauseVisit()">
                        ‚ùå Lanjutkan
                    </button>
                    <button class="visit-modal-btn visit-modal-btn-pause" onclick="confirmPauseVisit()">
                        ‚è∏Ô∏è Ya, Tunda
                    </button>
                </div>
            </div>
        </div>

        <!-- Enhanced Visit End Modal with Order Status -->
        <div class="visit-modal" id="visitEndModal">
            <div class="visit-modal-content">
                <div class="visit-modal-title">üèÅ Akhiri Kunjungan?</div>
                <div class="visit-modal-subtitle">Anda sedang mengunjungi outlet:</div>
                <div class="visit-modal-customer">
                    <div class="visit-modal-customer-name" id="endModalCustomerName">Outlet Saat Ini</div>
                    <div class="visit-modal-customer-details" id="endModalCustomerDetails">Durasi: 00:00:00</div>
                </div>
                
                <!-- Order Status Selection -->
                <div class="order-status-section">
                    <label class="order-status-label">Status Kunjungan:</label>
                    <select class="order-status-select" id="orderStatusSelect" onchange="toggleSOAmountInput()">
                        <option value="">Pilih status kunjungan...</option>
                        <option value="ada_so">Ada SO (Sales Order)</option>
                        <option value="toko_tidak_order">Toko Tidak Order</option>
                        <option value="toko_tutup">Toko Tutup</option>
                    </select>
                    
                    <!-- SO Amount Input (shown only when "Ada SO" is selected) -->
                    <div class="so-amount-section" id="soAmountSection">
                        <label class="so-amount-label">Nominal Sales Order (Rp):</label>
                        <input type="number" class="so-amount-input" id="soAmountInput" 
                               placeholder="Masukkan nominal SO..." min="0" step="1000">
                    </div>
                </div>
                
                <div class="visit-modal-buttons">
                    <button class="visit-modal-btn visit-modal-btn-secondary" onclick="cancelVisitEnd()">
                        ‚ùå Lanjutkan
                    </button>
                    <button class="visit-modal-btn visit-modal-btn-primary" id="endVisitBtn" onclick="confirmVisitEnd()" disabled>
                        ‚úÖ Ya, Akhiri
                    </button>
                </div>
            </div>
        </div>

        <!-- Floating Action Buttons -->
        <div class="floating-actions" id="floatingActions">
            <button class="floating-btn btn-pause-visit" onclick="showPauseVisitModal()">
                ‚è∏Ô∏è Tunda Kunjungan
            </button>
            <button class="floating-btn btn-end-visit" onclick="showVisitEndModal()">
                üèÅ Akhiri Kunjungan
            </button>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item" onclick="goHome()">
                <div class="nav-icon home">üè†</div>
                <div class="nav-label">Home</div>
            </div>
            <div class="nav-item active" onclick="showVisitOutlet()">
                <div class="nav-icon visit">üè™</div>
                <div class="nav-label">Visit</div>
            </div>
            <div class="nav-item" onclick="showIncentive()">
                <div class="nav-icon incentive">üí∞</div>
                <div class="nav-label">Incentive</div>
            </div>
            <div class="nav-item" onclick="showProfile()">
                <div class="nav-icon profile">üë§</div>
                <div class="nav-label">Profile</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase configuration and initialization
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, get, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAoRV3qVAXQ14AEVA8Mo49HXfAyhMMm8Bs",
            authDomain: "salesman-route-tracker.firebaseapp.com",
            databaseURL: "https://salesman-route-tracker-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "salesman-route-tracker",
            storageBucket: "salesman-route-tracker.firebasestorage.app",
            messagingSenderId: "590789273516",
            appId: "1:590789273516:web:79abe0c7e4cbccfa44fc09",
            measurementId: "G-5RYSWKQ063"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const analytics = getAnalytics(app);

        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebasePush = push;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseServerTimestamp = serverTimestamp;

        console.log('üî• Firebase berhasil diinisialisasi');
    </script>

    <script>
        // ===== VARIABEL GLOBAL =====
        let currentSalesman = '';
        let currentSalesmanId = null;
        let hariData = [];
        let pelangganData = [];
        let detailsData = [];
        let salesmanData = [];
        
        // ===== LOCAL STORAGE UNTUK KUNJUNGAN =====
        let todayVisitedCustomers = new Set();

        // ===== VARIABEL PELACAKAN LOKASI =====
        let currentLocation = {
            latitude: null,
            longitude: null,
            accuracy: null,
            timestamp: null
        };

        let watchId = null;
        
        // ===== VARIABEL PELACAKAN LOKASI PERIODIK =====
        let locationTrackingTimer = null;
        let lastLocationSync = null;
        let isLocationTrackingActive = false;

        // ===== SESI KUNJUNGAN DENGAN PAUSE/RESUME =====
        let visitSession = {
            isActive: false,
            isPaused: false,
            outletId: null,
            outletName: null,
            startTime: null,
            endTime: null,
            duration: 0,
            accumulatedDuration: 0, // Total waktu yang dihabiskan di toko
            pauseTime: null,
            resumeTime: null,
            sessionId: null,
            startLocation: null,
            endLocation: null,
            orderStatus: null,
            soAmount: null,
            pendingOutlet: null,
            pendingHari: null,
            pauseHistory: [] // Melacak semua event pause/resume
        };

        let sessionTimer = null;

        // ===== MANAJEMEN PAUSE/RESUME =====
        let pausedVisits = new Map(); // Menyimpan kunjungan yang ditunda berdasarkan nama outlet

        // ===== FUNGSI PELACAKAN LOKASI PERIODIK =====
        function startPeriodicLocationTracking() {
            if (!currentSalesmanId) {
                console.warn('üö´ Tidak dapat memulai pelacakan lokasi - tidak ada ID salesman');
                return;
            }

            if (locationTrackingTimer) {
                clearInterval(locationTrackingTimer);
            }

            isLocationTrackingActive = true;
            console.log('üåê Memulai pelacakan lokasi periodik (interval 10 menit)');
            
            // Sinkronisasi langsung saat mulai
            syncCurrentLocationToFirebase();
            
            // Kemudian sinkronisasi setiap 10 menit
            locationTrackingTimer = setInterval(() => {
                if (isLocationTrackingActive && currentSalesmanId) {
                    syncCurrentLocationToFirebase();
                }
            }, 10 * 60 * 1000); // 10 menit dalam milidetik
            
            updateLocationTrackingStatus('active', 'üåê Pelacakan posisi aktif');
        }

        function stopPeriodicLocationTracking() {
            if (locationTrackingTimer) {
                clearInterval(locationTrackingTimer);
                locationTrackingTimer = null;
            }
            
            isLocationTrackingActive = false;
            console.log('üåê Pelacakan lokasi periodik dihentikan');
            updateLocationTrackingStatus('stopped', 'üåê Pelacakan posisi dihentikan');
        }

        async function syncCurrentLocationToFirebase() {
            if (!window.firebaseDB || !currentSalesmanId || !currentLocation.latitude) {
                console.warn('üåê Tidak dapat sinkronisasi lokasi - persyaratan tidak terpenuhi');
                return false;
            }

            try {
                updateLocationTrackingStatus('syncing', 'üåê Sinkronisasi posisi...');
                
                const now = new Date();
                const locationData = {
                    salesman_id: currentSalesmanId,
                    salesman_name: currentSalesman,
                    latitude: currentLocation.latitude,
                    longitude: currentLocation.longitude,
                    accuracy: currentLocation.accuracy,
                    timestamp: now.toISOString(),
                    last_updated: window.firebaseServerTimestamp(),
                    device_info: {
                        user_agent: navigator.userAgent,
                        platform: navigator.platform,
                        online: navigator.onLine
                    },
                    // Konteks tambahan
                    visit_session: {
                        is_active: visitSession.isActive,
                        is_paused: visitSession.isPaused,
                        current_outlet: visitSession.outletName || null,
                        session_duration: visitSession.isActive ? visitSession.duration : 0
                    }
                };

                // Simpan ke Firebase - ini akan menimpa data sebelumnya untuk salesman ini
                const positionRef = window.firebaseRef(window.firebaseDB, `current_positions/${currentSalesmanId}`);
                await window.firebaseSet(positionRef, locationData);
                
                lastLocationSync = now;
                console.log('üåê Lokasi disinkronkan ke Firebase:', {
                    lat: currentLocation.latitude.toFixed(6),
                    lng: currentLocation.longitude.toFixed(6),
                    accuracy: Math.round(currentLocation.accuracy),
                    time: now.toLocaleTimeString('id-ID')
                });
                
                updateLocationTrackingStatus('success', `üåê Posisi disinkronkan pada ${now.toLocaleTimeString('id-ID')}`);
                
                // Juga simpan ke local storage sebagai backup
                saveLocationToLocalStorage(locationData);
                
                return true;
                
            } catch (error) {
                console.error('üåê Error sinkronisasi lokasi Firebase:', error);
                updateLocationTrackingStatus('error', '‚ùå Sinkronisasi posisi gagal');
                return false;
            }
        }

        function saveLocationToLocalStorage(locationData) {
            try {
                const locationKey = `current_location_${currentSalesmanId}`;
                localStorage.setItem(locationKey, JSON.stringify(locationData));
                
                // Simpan riwayat lokasi (hanya 24 jam terakhir)
                const historyKey = `location_history_${currentSalesmanId}`;
                const existingHistory = JSON.parse(localStorage.getItem(historyKey) || '[]');
                
                // Tambahkan lokasi saat ini ke riwayat
                existingHistory.push(locationData);
                
                // Hapus entri yang lebih lama dari 24 jam
                const cutoffTime = new Date(Date.now() - 24 * 60 * 60 * 1000);
                const filteredHistory = existingHistory.filter(entry => 
                    new Date(entry.timestamp) > cutoffTime
                );
                
                // Simpan maksimal 144 entri (24 jam * 6 per jam = 144)
                const trimmedHistory = filteredHistory.slice(-144);
                localStorage.setItem(historyKey, JSON.stringify(trimmedHistory));
                
                console.log('üíæ Lokasi disimpan ke localStorage');
                
            } catch (error) {
                console.error('üíæ Error menyimpan lokasi ke localStorage:', error);
            }
        }

        function updateLocationTrackingStatus(status, message) {
            // Update elemen status lokasi yang ada
            const statusElement = document.getElementById('locationStatusEnhanced');
            if (statusElement) {
                statusElement.classList.remove('success', 'error');
                statusElement.classList.add(status);
                const mainElement = statusElement.querySelector('.location-main');
                if (mainElement) {
                    mainElement.textContent = message;
                }
            }
            
            // Juga update indikator tracking
            const trackingElement = document.getElementById('locationTrackingStatus');
            if (trackingElement) {
                trackingElement.textContent = message;
                trackingElement.className = `location-tracking-status ${status}`;
            }
            
            // Auto-hide pesan sukses/error setelah 5 detik
            if (status === 'success' || status === 'error') {
                setTimeout(() => {
                    if (statusElement) {
                        statusElement.classList.remove('success', 'error');
                    }
                    if (trackingElement) {
                        trackingElement.classList.remove('success', 'error');
                    }
                }, 5000);
            }
        }

        // ===== MANAJEMEN PELACAKAN LOKASI =====
        function initializeLocationTracking() {
            // Inisialisasi geolokasi yang ditingkatkan
            if ("geolocation" in navigator) {
                console.log('üåê Geolokasi tersedia');
                getCurrentLocationEnhanced();
                startLocationTracking();
                
                // Mulai pelacakan periodik setelah lokasi awal diperoleh
                setTimeout(() => {
                    if (currentLocation.latitude) {
                        startPeriodicLocationTracking();
                    }
                }, 2000);
                
            } else {
                console.warn('üåê Geolokasi tidak tersedia');
                updateLocationTrackingStatus('error', '‚ùå Lokasi tidak didukung');
            }
        }

        // Peningkatan getCurrentLocation dengan penanganan error yang lebih baik
        function getCurrentLocationEnhanced() {
            updateLocationTrackingStatus('loading', 'üåê Mendapatkan posisi saat ini...');
            
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 5 * 60 * 1000 // 5 menit
            };
            
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: new Date().toISOString()
                        };
                        
                        console.log('üåê Lokasi enhanced diperoleh:', {
                            lat: currentLocation.latitude.toFixed(6),
                            lng: currentLocation.longitude.toFixed(6),
                            accuracy: Math.round(currentLocation.accuracy)
                        });
                        
                        updateLocationTrackingStatus('success', 'üåê Lokasi siap');
                        updateEnhancedLocationStatus();
                        resolve(currentLocation);
                    },
                    (error) => {
                        console.error('üåê Error lokasi enhanced:', error);
                        const errorMessage = getLocationErrorMessage(error);
                        updateLocationTrackingStatus('error', errorMessage);
                        reject(error);
                    },
                    options
                );
            });
        }

        function getLocationErrorMessage(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    return '‚ùå Akses lokasi ditolak';
                case error.POSITION_UNAVAILABLE:
                    return '‚ùå Lokasi tidak tersedia';
                case error.TIMEOUT:
                    return '‚ùå Timeout lokasi';
                default:
                    return '‚ùå Error lokasi';
            }
        }

        // Fungsi update status lokasi enhanced
        function updateEnhancedLocationStatus() {
            const statusElement = document.getElementById('locationStatusEnhanced');
            const accuracyElement = document.getElementById('locationAccuracy');
            const lastSyncElement = document.getElementById('locationLastSync');
            
            if (statusElement && currentLocation.latitude) {
                statusElement.classList.add('success');
                statusElement.querySelector('.location-main').textContent = 'üìç Lokasi aktif';
                
                if (accuracyElement) {
                    accuracyElement.textContent = `Akurasi: ¬±${Math.round(currentLocation.accuracy)}m`;
                }
                
                if (lastSyncElement && lastLocationSync) {
                    lastSyncElement.textContent = `Sinkron terakhir: ${lastLocationSync.toLocaleTimeString('id-ID', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    })}`;
                }
            }
        }

        // ===== FUNGSI MONITORING ADMIN =====
        async function getCurrentSalesmanPositions() {
            if (!window.firebaseDB) {
                console.warn('üö´ Firebase tidak tersedia untuk monitoring posisi');
                return null;
            }

            try {
                const positionsRef = window.firebaseRef(window.firebaseDB, 'current_positions');
                const snapshot = await window.firebaseGet(positionsRef);
                
                if (snapshot.exists()) {
                    const positions = snapshot.val();
                    console.log('üåê Berhasil mengambil posisi semua salesman:', Object.keys(positions).length);
                    return positions;
                } else {
                    console.log('üåê Tidak ada posisi saat ini yang ditemukan');
                    return {};
                }
                
            } catch (error) {
                console.error('üåê Error mengambil posisi:', error);
                return null;
            }
        }

        // Fungsi untuk menampilkan semua posisi salesman (untuk admin)
        async function showAllSalesmanPositions() {
            try {
                const positions = await getCurrentSalesmanPositions();
                
                if (!positions) {
                    alert('‚ùå Tidak dapat mengambil posisi');
                    return;
                }
                
                let positionInfo = 'üë• Posisi Salesman Saat Ini:\n\n';
                
                Object.entries(positions).forEach(([salesmanId, data]) => {
                    const timeAgo = new Date(data.timestamp);
                    const minutesAgo = Math.floor((Date.now() - timeAgo.getTime()) / (1000 * 60));
                    
                    positionInfo += `üë§ ${data.salesman_name || salesmanId}\n`;
                    positionInfo += `üìç ${data.latitude.toFixed(6)}, ${data.longitude.toFixed(6)}\n`;
                    positionInfo += `‚è∞ ${minutesAgo} menit yang lalu\n`;
                    positionInfo += `üéØ Akurasi: ¬±${Math.round(data.accuracy)}m\n`;
                    
                    if (data.visit_session?.is_active) {
                        positionInfo += `üè™ Kunjungi: ${data.visit_session.current_outlet || 'Tidak diketahui'}\n`;
                        if (data.visit_session.is_paused) {
                            positionInfo += `‚è∏Ô∏è Status: Ditunda\n`;
                        } else {
                            positionInfo += `‚úÖ Status: Aktif\n`;
                        }
                    } else {
                        positionInfo += `üì± Status: Tersedia\n`;
                    }
                    
                    positionInfo += '\n';
                });
                
                alert(positionInfo);
                
            } catch (error) {
                console.error('‚ùå Error menampilkan posisi:', error);
                alert('‚ùå Error mengambil posisi');
            }
        }

        // Periksa apakah user adalah admin dan tampilkan tombol monitoring posisi
        function checkAdminAccess() {
            // Tambahkan logika pengecekan admin di sini
            // Misalnya, periksa apakah user ID ada dalam daftar admin
            const adminIds = ['ADMIN001', 'SUPERVISOR001']; // Tambahkan ID admin Anda
            
            if (adminIds.includes(currentSalesmanId)) {
                const adminBtn = document.getElementById('adminLocationBtn');
                if (adminBtn) {
                    adminBtn.classList.add('show');
                }
            }
        }

        // Fungsi sinkronisasi lokasi manual (untuk testing)
        function forceSyncLocation() {
            console.log('üåê Sinkronisasi lokasi manual dipicu');
            getCurrentLocationEnhanced().then(() => {
                syncCurrentLocationToFirebase();
            }).catch(error => {
                console.error('üåê Sinkronisasi manual gagal:', error);
            });
        }

        // ===== FUNGSI FIREBASE =====
        function updateFirebaseStatus(status, message) {
            const statusElement = document.getElementById('firebaseStatus');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `firebase-status ${status}`;
                
                if (status === 'success' || status === 'error') {
                    setTimeout(() => {
                        statusElement.classList.remove('success', 'error', 'syncing');
                    }, 3000);
                }
            }
        }

        async function syncVisitToFirebase(visitData) {
            if (!window.firebaseDB || !currentSalesmanId) {
                console.warn('üî• Firebase tidak diinisialisasi atau tidak ada ID salesman');
                return false;
            }

            try {
                updateFirebaseStatus('syncing', 'üîÑ Sinkronisasi ke Firebase...');
                
                const visitsRef = window.firebaseRef(window.firebaseDB, `visits/${currentSalesmanId}`);
                
                const visitDataWithTimestamp = {
                    ...visitData,
                    firebase_synced_at: window.firebaseServerTimestamp(),
                    firebase_sync_version: '1.1'
                };
                
                const newVisitRef = await window.firebasePush(visitsRef, visitDataWithTimestamp);
                
                console.log('üî• Data kunjungan disinkronkan ke Firebase:', newVisitRef.key);
                updateFirebaseStatus('success', '‚úÖ Tersinkronisasi ke Firebase');
                
                await syncDailySummaryToFirebase(visitData);
                
                return newVisitRef.key;
                
            } catch (error) {
                console.error('üî• Error sinkronisasi Firebase:', error);
                updateFirebaseStatus('error', '‚ùå Sinkronisasi Firebase gagal');
                return false;
            }
        }

        async function syncDailySummaryToFirebase(visitData) {
            try {
                const today = new Date().toISOString().split('T')[0];
                const summaryRef = window.firebaseRef(window.firebaseDB, `daily_summary/${currentSalesmanId}/${today}`);
                
                const snapshot = await window.firebaseGet(summaryRef);
                const existingSummary = snapshot.exists() ? snapshot.val() : {};
                
                const updatedSummary = {
                    salesman_id: currentSalesmanId,
                    salesman_name: currentSalesman,
                    date: today,
                    total_visits: (existingSummary.total_visits || 0) + 1,
                    total_duration_seconds: (existingSummary.total_duration_seconds || 0) + visitData.total_duration_seconds,
                    visits_with_so: (existingSummary.visits_with_so || 0) + (visitData.order_status === 'ada_so' ? 1 : 0),
                    total_so_amount: (existingSummary.total_so_amount || 0) + (visitData.so_amount || 0),
                    visits_with_pauses: (existingSummary.visits_with_pauses || 0) + (visitData.pause_count > 0 ? 1 : 0),
                    total_pause_time: (existingSummary.total_pause_time || 0) + (visitData.total_pause_duration || 0),
                    last_updated: window.firebaseServerTimestamp()
                };
                
                await window.firebaseSet(summaryRef, updatedSummary);
                console.log('üî• Ringkasan harian diperbarui di Firebase');
                
            } catch (error) {
                console.error('üî• Error sinkronisasi ringkasan harian:', error);
            }
        }

        function getCurrentLocation() {
            updateLocationStatus('loading', 'üåê Mendapatkan lokasi...');
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date().toISOString()
                    };
                    
                    console.log('üåê Lokasi diperoleh:', currentLocation);
                    updateLocationStatus('success', 'üåê Lokasi siap');
                },
                (error) => {
                    console.error('üåê Error lokasi:', error);
                    updateLocationStatus('error', '‚ùå Lokasi gagal');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000
                }
            );
        }

        function startLocationTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
            
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    currentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date().toISOString()
                    };
                    
                    if (visitSession.isActive && !visitSession.isPaused) {
                        updateLocationStatus('success', 'üåê Pelacakan aktif');
                    }
                    
                    updateEnhancedLocationStatus();
                },
                (error) => {
                    console.warn('üåê Error pelacakan lokasi:', error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 60000
                }
            );
        }

        function updateLocationStatus(status, message) {
            // Untuk kompatibilitas
        }

        // ===== FUNGSI PAUSE/RESUME KUNJUNGAN =====
        function showPauseVisitModal() {
            if (!visitSession.isActive || visitSession.isPaused) {
                console.warn('üö´ Tidak dapat pause - tidak ada sesi aktif atau sudah ditunda');
                return;
            }
            
            const duration = Math.floor(visitSession.accumulatedDuration + (Date.now() - visitSession.startTime) / 1000);
            const durationText = formatDuration(duration);
            
            document.getElementById('pauseModalCustomerName').textContent = visitSession.outletName;
            document.getElementById('pauseModalCustomerDetails').textContent = `Durasi saat ini: ${durationText}`;
            document.getElementById('pauseCurrentDuration').textContent = `${Math.floor(duration / 60)} menit`;
            
            document.getElementById('visitPauseModal').classList.add('show');
            
            console.log(`‚è∏Ô∏è Menampilkan modal pause untuk: ${visitSession.outletName}`);
        }

        function cancelPauseVisit() {
            document.getElementById('visitPauseModal').classList.remove('show');
            console.log('‚ùå Pause dibatalkan, lanjutkan kunjungan');
        }

        function confirmPauseVisit() {
            if (!visitSession.isActive || visitSession.isPaused) {
                console.warn('üö´ Tidak dapat pause - status sesi tidak valid');
                return;
            }
            
            console.log(`‚è∏Ô∏è Menunda kunjungan ke: ${visitSession.outletName}`);
            
            // Hitung durasi sesi saat ini
            const currentSessionDuration = Math.floor((Date.now() - visitSession.startTime) / 1000);
            visitSession.accumulatedDuration += currentSessionDuration;
            visitSession.isPaused = true;
            visitSession.pauseTime = Date.now();
            
            // Tambahkan event pause ke riwayat
            visitSession.pauseHistory.push({
                type: 'pause',
                timestamp: new Date().toISOString(),
                location: { ...currentLocation },
                session_duration: currentSessionDuration,
                accumulated_duration: visitSession.accumulatedDuration
            });
            
            // Simpan data kunjungan yang ditunda
            const pausedVisitData = {
                ...visitSession,
                paused_at: new Date().toISOString(),
                pause_location: { ...currentLocation }
            };
            
            pausedVisits.set(visitSession.outletName.toLowerCase(), pausedVisitData);
            savePausedVisitsToLocal();
            
            // PENTING: Hapus dari pelanggan yang dikunjungi karena kunjungan belum selesai
            todayVisitedCustomers.delete(visitSession.outletName.toLowerCase());
            removeFromLocalVisitedStorage(visitSession.outletName);
            
            // Hentikan timer dan update UI
            stopSessionTimer();
            visitSession.isActive = false; // Tandai sebagai tidak aktif tetapi simpan data
            updateVisitSessionStatus();
            updateFloatingButtons();
            updateCustomerListPauseStatus();
            
            // Reset pilihan outlet
            const pelangganSelect = document.getElementById('pelanggan');
            if (pelangganSelect) {
                pelangganSelect.value = '';
                handlePelangganSelection();
            }
            
            document.getElementById('visitPauseModal').classList.remove('show');
            
            console.log(`‚úÖ Kunjungan berhasil ditunda. Durasi terakumulasi: ${formatDuration(visitSession.accumulatedDuration)}`);
            
            // Simpan event pause ke localStorage
            savePauseEventToLocal('pause', pausedVisitData);
        }

        function showResumeVisitModal(outletName) {
            const pausedVisit = pausedVisits.get(outletName.toLowerCase());
            if (!pausedVisit) {
                console.warn('üö´ Tidak ada kunjungan yang ditunda untuk:', outletName);
                return;
            }
            
            const pauseTime = new Date(pausedVisit.paused_at);
            const startTime = new Date(pausedVisit.startTime);
            const accumulatedDuration = pausedVisit.accumulatedDuration || 0;
            
            document.getElementById('resumeModalCustomerName').textContent = outletName;
            document.getElementById('resumeModalCustomerDetails').textContent = `Hari JKS: ${pausedVisit.pendingHari || 'Tidak diketahui'}`;
            document.getElementById('resumeStartTime').textContent = startTime.toLocaleTimeString('id-ID');
            document.getElementById('resumePauseTime').textContent = pauseTime.toLocaleTimeString('id-ID');
            document.getElementById('resumePrevDuration').textContent = formatDuration(accumulatedDuration);
            
            document.getElementById('visitResumeModal').classList.add('show');
            
            console.log(`üîÑ Menampilkan modal resume untuk: ${outletName}`);
        }

        function startNewVisit() {
            const outletName = visitSession.pendingOutlet;
            
            // Hapus kunjungan yang ditunda
            pausedVisits.delete(outletName.toLowerCase());
            savePausedVisitsToLocal();
            updateCustomerListPauseStatus();
            
            // Bersihkan data pending dan mulai fresh
            visitSession.pendingOutlet = null;
            visitSession.pendingHari = null;
            
            document.getElementById('visitResumeModal').classList.remove('show');
            
            // Mulai kunjungan baru
            const hariSelect = document.getElementById('hari');
            startVisitSession(outletName, hariSelect.value);
            
            console.log(`üÜï Memulai kunjungan baru untuk: ${outletName}`);
        }

        function confirmResumeVisit() {
            const outletName = visitSession.pendingOutlet;
            const pausedVisit = pausedVisits.get(outletName.toLowerCase());
            
            if (!pausedVisit) {
                console.error('‚ùå Tidak dapat melanjutkan - data kunjungan yang ditunda tidak ditemukan');
                return;
            }
            
            console.log(`‚ñ∂Ô∏è Melanjutkan kunjungan ke: ${outletName}`);
            
            // Restore sesi kunjungan dari data yang ditunda
            visitSession.isActive = true;
            visitSession.isPaused = false;
            visitSession.outletId = pausedVisit.outletId;
            visitSession.outletName = pausedVisit.outletName;
            visitSession.startTime = Date.now(); // Waktu mulai baru untuk sesi ini
            visitSession.sessionId = pausedVisit.sessionId;
            visitSession.accumulatedDuration = pausedVisit.accumulatedDuration || 0;
            visitSession.startLocation = pausedVisit.startLocation;
            visitSession.pauseHistory = pausedVisit.pauseHistory || [];
            visitSession.resumeTime = Date.now();
            
            // Tambahkan event resume ke riwayat
            visitSession.pauseHistory.push({
                type: 'resume',
                timestamp: new Date().toISOString(),
                location: { ...currentLocation },
                pause_duration: Math.floor((Date.now() - new Date(pausedVisit.paused_at).getTime()) / 1000)
            });
            
            // Bersihkan data pending
            visitSession.pendingOutlet = null;
            visitSession.pendingHari = null;
            
            // Update UI
            updateVisitSessionStatus();
            startSessionTimer();
            updateFloatingButtons();
            
            document.getElementById('visitResumeModal').classList.remove('show');
            
            console.log(`‚úÖ Kunjungan berhasil dilanjutkan. Durasi sebelumnya: ${formatDuration(visitSession.accumulatedDuration)}`);
            
            // Simpan event resume ke localStorage
            savePauseEventToLocal('resume', visitSession);
        }

        // ===== LOCAL STORAGE UNTUK KUNJUNGAN YANG DITUNDA =====
        function loadPausedVisitsFromLocal() {
            if (!currentSalesmanId) return;
            
            try {
                const pausedKey = `paused_visits_${currentSalesmanId}`;
                const pausedData = localStorage.getItem(pausedKey);
                
                if (pausedData) {
                    const parsed = JSON.parse(pausedData);
                    pausedVisits = new Map(Object.entries(parsed));
                    console.log(`üìã Memuat ${pausedVisits.size} kunjungan yang ditunda dari local storage`);
                    updateCustomerListPauseStatus();
                }
            } catch (error) {
                console.error('‚ùå Error memuat kunjungan yang ditunda:', error);
                pausedVisits = new Map();
            }
        }

        function savePausedVisitsToLocal() {
            if (!currentSalesmanId) return;
            
            try {
                const pausedKey = `paused_visits_${currentSalesmanId}`;
                const pausedData = Object.fromEntries(pausedVisits);
                localStorage.setItem(pausedKey, JSON.stringify(pausedData));
                console.log('üíæ Kunjungan yang ditunda disimpan ke localStorage');
            } catch (error) {
                console.error('‚ùå Error menyimpan kunjungan yang ditunda:', error);
            }
        }

        function savePauseEventToLocal(eventType, sessionData) {
            try {
                const eventKey = `pause_events_${currentSalesmanId}`;
                const existingEvents = JSON.parse(localStorage.getItem(eventKey) || '[]');
                
                const pauseEvent = {
                    event_type: eventType,
                    timestamp: new Date().toISOString(),
                    outlet_name: sessionData.outletName,
                    session_id: sessionData.sessionId,
                    accumulated_duration: sessionData.accumulatedDuration || 0,
                    location: { ...currentLocation }
                };
                
                existingEvents.push(pauseEvent);
                localStorage.setItem(eventKey, JSON.stringify(existingEvents));
                
                console.log(`üíæ Pause event (${eventType}) disimpan ke localStorage`);
            } catch (error) {
                console.error('‚ùå Error menyimpan pause event:', error);
            }
        }

        function updateCustomerListPauseStatus() {
            const pelangganSelect = document.getElementById('pelanggan');
            if (!pelangganSelect) return;
            
            Array.from(pelangganSelect.options).forEach(option => {
                if (option.value && pausedVisits.has(option.value.toLowerCase())) {
                    option.textContent = `${option.value} ‚è∏Ô∏è (Kunjungan tertunda)`;
                    option.classList.add('customer-paused');
                    option.style.color = '#f59e0b';
                    option.style.backgroundColor = '#fef3c7';
                }
            });
        }

        function isPausedVisit(customerName) {
            return pausedVisits.has(customerName.toLowerCase());
        }

        // ===== MANAJEMEN SESI KUNJUNGAN =====
        function loadTodayVisitedCustomers() {
            const today = new Date().toISOString().split('T')[0];
            const visitKey = `visited_${currentSalesmanId}_${today}`;
            const storedVisits = localStorage.getItem(visitKey);
            
            if (storedVisits) {
                try {
                    const visits = JSON.parse(storedVisits);
                    todayVisitedCustomers = new Set();
                    
                    visits.forEach(visit => {
                        if (typeof visit === 'string') {
                            // Format lama: anggap sebagai kunjungan selesai
                            todayVisitedCustomers.add(visit.toLowerCase());
                        } else if (visit && visit.outlet_name) {
                            // Format baru: hanya tambahkan jika kunjungan selesai
                            if (visit.visit_completed === true) {
                                todayVisitedCustomers.add(visit.outlet_name.toLowerCase());
                            }
                        }
                    });
                    
                    console.log(`üìã Memuat ${todayVisitedCustomers.size} kunjungan selesai dari local storage`);
                    updateCustomerListVisitStatus();
                } catch (error) {
                    console.error('‚ùå Error parsing localStorage visits:', error);
                    localStorage.removeItem(visitKey);
                    todayVisitedCustomers = new Set();
                }
            } else {
                console.log('üìã Belum ada kunjungan selesai hari ini');
            }
        }

        function markCustomerAsVisited(outletName, sessionId, isCompleted = false) {
            // Hanya tandai sebagai dikunjungi jika kunjungan selesai, bukan hanya dimulai
            if (isCompleted) {
                todayVisitedCustomers.add(outletName.toLowerCase());
                
                const today = new Date().toISOString().split('T')[0];
                const visitKey = `visited_${currentSalesmanId}_${today}`;
                
                try {
                    const existingVisits = JSON.parse(localStorage.getItem(visitKey) || '[]');
                    
                    const visitRecord = {
                        outlet_name: outletName,
                        outlet_id: visitSession.outletId,
                        session_id: sessionId,
                        visit_time: new Date().toISOString(),
                        visit_completed: true,
                        salesman_id: currentSalesmanId,
                        salesman_name: currentSalesman
                    };
                    
                    existingVisits.push(visitRecord);
                    localStorage.setItem(visitKey, JSON.stringify(existingVisits));
                    console.log(`üìã Outlet ${outletName} ditandai sebagai kunjungan selesai secara lokal`);
                    
                } catch (error) {
                    console.error('‚ùå Error menyimpan ke localStorage:', error);
                }
            } else {
                console.log(`üìã Outlet ${outletName} kunjungan dimulai tetapi belum ditandai sebagai selesai`);
            }
        }

        function isCustomerAlreadyVisited(customerName) {
            // Periksa apakah pelanggan memiliki kunjungan selesai hari ini
            const hasCompletedVisit = todayVisitedCustomers.has(customerName.toLowerCase());
            
            // Periksa apakah pelanggan memiliki kunjungan yang ditunda (kunjungan yang ditunda harus dapat dilanjutkan)
            const hasPausedVisit = isPausedVisit(customerName);
            
            // Izinkan akses jika itu adalah kunjungan yang ditunda, blokir jika itu adalah kunjungan selesai
            if (hasPausedVisit) {
                console.log(`üìã ${customerName} memiliki kunjungan yang ditunda - mengizinkan akses`);
                return false; // Izinkan akses ke kunjungan yang ditunda
            }
            
            return hasCompletedVisit;
        }

        function removeFromLocalVisitedStorage(outletName) {
            const today = new Date().toISOString().split('T')[0];
            const visitKey = `visited_${currentSalesmanId}_${today}`;
            
            try {
                const existingVisits = JSON.parse(localStorage.getItem(visitKey) || '[]');
                
                // Hapus kunjungan yang tidak selesai untuk outlet ini
                const filteredVisits = existingVisits.filter(visit => {
                    const visitOutlet = typeof visit === 'string' ? visit : visit.outlet_name;
                    return visitOutlet && visitOutlet.toLowerCase() !== outletName.toLowerCase() || visit.visit_completed === true;
                });
                
                localStorage.setItem(visitKey, JSON.stringify(filteredVisits));
                console.log(`üìã Kunjungan tidak selesai untuk ${outletName} dihapus dari localStorage`);
                
            } catch (error) {
                console.error('‚ùå Error menghapus dari localStorage:', error);
            }
        }

        function updateCustomerListVisitStatus() {
            const pelangganSelect = document.getElementById('pelanggan');
            if (!pelangganSelect) return;
            
            Array.from(pelangganSelect.options).forEach(option => {
                // Reset styling option terlebih dahulu
                option.disabled = false;
                option.classList.remove('customer-paused');
                option.style.color = '';
                option.style.backgroundColor = '';
                
                if (option.value) {
                    const outletName = option.value;
                    const isCompleted = isCustomerAlreadyVisited(outletName);
                    const isPaused = isPausedVisit(outletName);
                    
                    if (isCompleted) {
                        // Kunjungan selesai - blokir akses
                        option.textContent = `${outletName} ‚úÖ (Sudah dikunjungi)`;
                        option.disabled = true;
                        option.style.color = '#10b981';
                        option.style.backgroundColor = '#f0fdf4';
                    } else if (isPaused) {
                        // Kunjungan ditunda - izinkan akses dengan indikator
                        option.textContent = `${outletName} ‚è∏Ô∏è (Kunjungan tertunda)`;
                        option.classList.add('customer-paused');
                        option.style.color = '#f59e0b';
                        option.style.backgroundColor = '#fef3c7';
                    } else {
                        // Reset ke nama asli jika tidak ada status khusus
                        option.textContent = outletName;
                    }
                }
            });
        }

        // ===== FUNGSI MODAL KUNJUNGAN =====
        function showVisitStartModal(outletName, hariJKS) {
            // Periksa apakah outlet ini memiliki kunjungan yang ditunda
            if (isPausedVisit(outletName)) {
                visitSession.pendingOutlet = outletName;
                visitSession.pendingHari = hariJKS;
                showResumeVisitModal(outletName);
                return;
            }
            
            visitSession.pendingOutlet = outletName;
            visitSession.pendingHari = hariJKS;
            
            document.getElementById('startModalCustomerName').textContent = outletName;
            document.getElementById('startModalCustomerDetails').textContent = `Hari JKS: ${hariJKS}`;
            document.getElementById('visitStartModal').classList.add('show');
            
            console.log(`üè™ Menampilkan modal start untuk: ${outletName}`);
        }

        function cancelVisitStart() {
            document.getElementById('visitStartModal').classList.remove('show');
            
            const pelangganSelect = document.getElementById('pelanggan');
            if (pelangganSelect) {
                pelangganSelect.value = '';
                handlePelangganSelection();
            }
            
            visitSession.pendingOutlet = null;
            visitSession.pendingHari = null;
            
            console.log('‚ùå Start kunjungan dibatalkan');
        }

        function confirmVisitStart() {
            const outletName = visitSession.pendingOutlet;
            const hariJKS = visitSession.pendingHari;

            console.log(`üöÄ Memulai konfirmasi kunjungan untuk: ${outletName}`);

            if (isCustomerAlreadyVisited(outletName)) {
                alert(`‚ùå Error: Outlet "${outletName}" sudah dikunjungi hari ini!\n\nSistem mencegah duplikasi kunjungan.`);
                cancelVisitStart();
                return;
            }

            document.getElementById('visitStartModal').classList.remove('show');
            startVisitSession(outletName, hariJKS);
            
            visitSession.pendingOutlet = null;
            visitSession.pendingHari = null;
        }

        function showVisitEndModal() {
            if (!visitSession.isActive || visitSession.isPaused) {
                console.warn('üö´ Modal akhir diblokir - tidak ada sesi aktif atau ditunda');
                return;
            }
            
            const currentSessionDuration = Math.floor((Date.now() - visitSession.startTime) / 1000);
            const totalDuration = visitSession.accumulatedDuration + currentSessionDuration;
            const durationText = formatDuration(totalDuration);
            
            document.getElementById('endModalCustomerName').textContent = visitSession.outletName;
            document.getElementById('endModalCustomerDetails').textContent = `Total Durasi: ${durationText}`;
            
            // Reset form status order
            document.getElementById('orderStatusSelect').value = '';
            document.getElementById('soAmountInput').value = '';
            document.getElementById('soAmountSection').classList.remove('show');
            document.getElementById('endVisitBtn').disabled = true;
            
            document.getElementById('visitEndModal').classList.add('show');
            
            console.log(`üèÅ Menampilkan modal akhir untuk: ${visitSession.outletName}`);
        }

        function toggleSOAmountInput() {
            const orderStatus = document.getElementById('orderStatusSelect').value;
            const soAmountSection = document.getElementById('soAmountSection');
            const endVisitBtn = document.getElementById('endVisitBtn');
            
            if (orderStatus === 'ada_so') {
                soAmountSection.classList.add('show');
                endVisitBtn.disabled = false;
            } else if (orderStatus === 'toko_tidak_order' || orderStatus === 'toko_tutup') {
                soAmountSection.classList.remove('show');
                endVisitBtn.disabled = false;
            } else {
                soAmountSection.classList.remove('show');
                endVisitBtn.disabled = true;
            }
        }

        function cancelVisitEnd() {
            document.getElementById('visitEndModal').classList.remove('show');
            console.log('‚ùå Akhir kunjungan dibatalkan, lanjutkan kunjungan');
        }

        function confirmVisitEnd() {
            const orderStatus = document.getElementById('orderStatusSelect').value;
            const soAmount = document.getElementById('soAmountInput').value;
            
            if (!orderStatus) {
                alert('‚ùå Pilih status kunjungan terlebih dahulu!');
                return;
            }
            
            if (orderStatus === 'ada_so' && (!soAmount || parseFloat(soAmount) <= 0)) {
                alert('‚ùå Masukkan nominal Sales Order yang valid!');
                return;
            }
            
            visitSession.orderStatus = orderStatus;
            visitSession.soAmount = orderStatus === 'ada_so' ? parseFloat(soAmount) : 0;
            
            document.getElementById('visitEndModal').classList.remove('show');
            endVisitSession();
        }

        function startVisitSession(outletName, hariJKS) {
            if (visitSession.isActive) {
                endVisitSession();
            }
            
            const outletRecord = detailsData.find(item => {
                const itemPelanggan = (item['Nama Pelanggan'] || '').toString().trim();
                return itemPelanggan.toLowerCase() === outletName.toLowerCase();
            });
            
            const outletId = outletRecord ? outletRecord['Id Pelanggan'] : `OUTLET_${Date.now()}`;
            const sessionId = `visit_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            const startLocation = {
                latitude: currentLocation.latitude,
                longitude: currentLocation.longitude,
                accuracy: currentLocation.accuracy,
                timestamp: new Date().toISOString()
            };
            
            visitSession.isActive = true;
            visitSession.isPaused = false;
            visitSession.outletId = outletId;
            visitSession.outletName = outletName;
            visitSession.startTime = Date.now();
            visitSession.endTime = null;
            visitSession.duration = 0;
            visitSession.accumulatedDuration = 0;
            visitSession.sessionId = sessionId;
            visitSession.startLocation = startLocation;
            visitSession.endLocation = null;
            visitSession.orderStatus = null;
            visitSession.soAmount = null;
            visitSession.pauseHistory = [];
            
            // Tandai sebagai dimulai tetapi BELUM selesai
            markCustomerAsVisited(outletName, sessionId, false);
            
            updateVisitSessionStatus();
            startSessionTimer();
            updateFloatingButtons();
            
            console.log(`‚úÖ Sesi kunjungan dimulai: ${outletName} (ID: ${outletId})`);
            
            saveVisitSessionToLocal('session_start', {
                outlet_id: outletId,
                outlet_name: outletName,
                hari_jks: hariJKS,
                session_id: sessionId,
                start_time: new Date().toISOString(),
                start_location: startLocation,
                visit_status: 'started',
                salesman_id: currentSalesmanId,
                salesman_name: currentSalesman
            });
        }

        async function endVisitSession() {
            if (!visitSession.isActive) {
                console.warn('üö´ Tidak dapat mengakhiri sesi - tidak aktif');
                return;
            }
            
            const endLocation = {
                latitude: currentLocation.latitude,
                longitude: currentLocation.longitude,
                accuracy: currentLocation.accuracy,
                timestamp: new Date().toISOString()
            };
            
            const endTime = Date.now();
            const currentSessionDuration = Math.floor((endTime - visitSession.startTime) / 1000);
            const totalDuration = visitSession.accumulatedDuration + currentSessionDuration;
            
            visitSession.endTime = endTime;
            visitSession.duration = totalDuration;
            visitSession.endLocation = endLocation;
            
            // Hitung total waktu pause
            let totalPauseDuration = 0;
            let pauseCount = 0;
            
            for (let i = 0; i < visitSession.pauseHistory.length - 1; i += 2) {
                const pauseEvent = visitSession.pauseHistory[i];
                const resumeEvent = visitSession.pauseHistory[i + 1];
                
                if (pauseEvent && pauseEvent.type === 'pause' && resumeEvent && resumeEvent.type === 'resume') {
                    const pauseTime = new Date(pauseEvent.timestamp).getTime();
                    const resumeTime = new Date(resumeEvent.timestamp).getTime();
                    totalPauseDuration += (resumeTime - pauseTime) / 1000;
                    pauseCount++;
                }
            }
            
            console.log(`üèÅ Mengakhiri sesi kunjungan: ${visitSession.outletName} (total durasi: ${formatDuration(totalDuration)})`);
            
            // SEKARANG tandai sebagai kunjungan selesai
            markCustomerAsVisited(visitSession.outletName, visitSession.sessionId, true);
            
            const visitDataForFirebase = {
                outlet_id: visitSession.outletId,
                outlet_name: visitSession.outletName,
                session_id: visitSession.sessionId,
                start_time: new Date(visitSession.startTime - visitSession.accumulatedDuration * 1000).toISOString(),
                end_time: new Date(endTime).toISOString(),
                total_duration_seconds: totalDuration,
                active_duration_seconds: totalDuration, // Waktu yang benar-benar dihabiskan di toko
                pause_count: pauseCount,
                total_pause_duration: totalPauseDuration,
                pause_history: visitSession.pauseHistory,
                start_location: visitSession.startLocation,
                end_location: endLocation,
                order_status: visitSession.orderStatus,
                so_amount: visitSession.soAmount || 0,
                visit_status: 'completed',
                salesman_id: currentSalesmanId,
                salesman_name: currentSalesman,
                created_at: new Date().toISOString(),
                local_id: `local_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
            };
            
            // Hapus dari kunjungan yang ditunda jika ada
            pausedVisits.delete(visitSession.outletName.toLowerCase());
            savePausedVisitsToLocal();
            
            saveVisitSessionToLocal('session_end', visitDataForFirebase);
            
            const firebaseKey = await syncVisitToFirebase(visitDataForFirebase);
            
            if (!firebaseKey) {
                console.log('‚è≥ Menambahkan kunjungan ke antrian sinkronisasi Firebase yang tertunda...');
                saveToPendingFirebaseQueue(visitDataForFirebase);
            }
            
            // Reset sesi
            const endedOutlet = visitSession.outletName;
            visitSession.isActive = false;
            visitSession.isPaused = false;
            visitSession.outletId = null;
            visitSession.outletName = null;
            visitSession.startTime = null;
            visitSession.endTime = null;
            visitSession.duration = 0;
            visitSession.accumulatedDuration = 0;
            visitSession.sessionId = null;
            visitSession.startLocation = null;
            visitSession.endLocation = null;
            visitSession.orderStatus = null;
            visitSession.soAmount = null;
            visitSession.pauseHistory = [];
            
            updateVisitSessionStatus();
            stopSessionTimer();
            updateFloatingButtons();
            updateCustomerListPauseStatus();
            updateCustomerListVisitStatus();
            
            console.log(`‚úÖ Sesi kunjungan berhasil diakhiri: ${endedOutlet}, total durasi: ${formatDuration(totalDuration)}`);
        }

        function saveToPendingFirebaseQueue(visitData) {
            try {
                const pendingKey = `pending_firebase_visits_${currentSalesmanId}`;
                const existingPending = JSON.parse(localStorage.getItem(pendingKey) || '[]');
                
                existingPending.push(visitData);
                localStorage.setItem(pendingKey, JSON.stringify(existingPending));
                
                console.log('‚è≥ Kunjungan disimpan ke antrian sinkronisasi Firebase yang tertunda');
                updateFirebaseStatus('syncing', `‚è≥ ${existingPending.length} kunjungan tertunda sinkronisasi`);
                
            } catch (error) {
                console.error('‚ùå Error menyimpan ke antrian tertunda:', error);
            }
        }

        function saveVisitSessionToLocal(eventType, sessionData) {
            try {
                const sessionKey = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const sessionRecord = {
                    event_type: eventType,
                    session_key: sessionKey,
                    timestamp: new Date().toISOString(),
                    ...sessionData
                };
                
                const keys = [
                    `visit_sessions_${currentSalesmanId}`,
                    `daily_sessions_${currentSalesmanId}_${new Date().toISOString().split('T')[0]}`
                ];
                
                keys.forEach(key => {
                    const existingSessions = JSON.parse(localStorage.getItem(key) || '[]');
                    existingSessions.push(sessionRecord);
                    localStorage.setItem(key, JSON.stringify(existingSessions));
                });
                
                console.log(`üíæ Sesi ${eventType} disimpan ke localStorage: ${sessionKey}`);
                return sessionKey;
                
            } catch (error) {
                console.error('üíæ Error menyimpan ke localStorage:', error);
                return null;
            }
        }

        // ===== FUNGSI TIMER SESI =====
        function startSessionTimer() {
            if (sessionTimer) {
                clearInterval(sessionTimer);
            }
            
            sessionTimer = setInterval(() => {
                if (visitSession.isActive && !visitSession.isPaused && visitSession.startTime) {
                    const currentSessionDuration = Math.floor((Date.now() - visitSession.startTime) / 1000);
                    visitSession.duration = visitSession.accumulatedDuration + currentSessionDuration;
                    updateSessionTimerDisplay();
                }
            }, 1000);
        }

        function stopSessionTimer() {
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
            }
        }

        function updateSessionTimerDisplay() {
            const timerElement = document.getElementById('sessionTimer');
            if (timerElement) {
                timerElement.textContent = formatDuration(visitSession.duration);
            }
        }

        function updateVisitSessionStatus() {
            const statusElement = document.getElementById('visitSessionStatus');
            const customerElement = document.getElementById('sessionCustomerName');
            const timerElement = document.getElementById('sessionTimer');
            const statusTextElement = document.getElementById('sessionStatusText');
            
            if (visitSession.isActive) {
                if (visitSession.isPaused) {
                    statusElement.classList.remove('active');
                    statusElement.classList.add('paused');
                    customerElement.textContent = `üè™ ${visitSession.outletName}`;
                    timerElement.textContent = formatDuration(visitSession.duration);
                    statusTextElement.textContent = 'DITUNDA';
                } else {
                    statusElement.classList.remove('paused');
                    statusElement.classList.add('active');
                    customerElement.textContent = `üè™ ${visitSession.outletName}`;
                    timerElement.textContent = formatDuration(visitSession.duration);
                    statusTextElement.textContent = 'AKTIF';
                }
            } else {
                statusElement.classList.remove('active', 'paused');
                customerElement.textContent = 'Tidak Ada Kunjungan Aktif';
                timerElement.textContent = '00:00:00';
                statusTextElement.textContent = '';
            }
        }

        function updateFloatingButtons() {
            const floatingActions = document.getElementById('floatingActions');
            
            if (visitSession.isActive && !visitSession.isPaused) {
                floatingActions.classList.add('show');
            } else {
                floatingActions.classList.remove('show');
            }
        }

        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // ===== FUNGSI UTILITAS =====
        function formatNumber(num) {
            if (num === null || num === undefined || num === '') {
                return '0';
            }
            
            const number = Number(num);
            
            if (isNaN(number)) {
                return '0';
            }
            
            // Format angka dengan K untuk ribuan, M untuk juta
            if (Math.abs(number) >= 1000000) {
                return (number / 1000000).toFixed(1) + 'M';
            } else if (Math.abs(number) >= 1000) {
                return (number / 1000).toFixed(0) + 'K';
            } else {
                return number.toFixed(0);
            }
        }

        function parseJSONL(content) {
            const lines = content.trim().split('\n');
            const data = [];
            
            lines.forEach((line, index) => {
                try {
                    if (line.trim()) {
                        const obj = JSON.parse(line.trim());
                        data.push(obj);
                    }
                } catch (error) {
                    console.error(`Error parsing line ${index + 1}:`, line, error);
                }
            });
            
            return data;
        }

        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        function normalizeHariFormat(hariString) {
            if (!hariString) return '';
            const cleanHari = hariString.toString().replace(/^\[\d+\]/, '').trim().toUpperCase();
            return cleanHari;
        }

        function getCurrentDayInIndonesian() {
            const days = ['MINGGU', 'SENIN', 'SELASA', 'RABU', 'KAMIS', 'JUMAT', 'SABTU'];
            const today = new Date();
            return days[today.getDay()];
        }

        function updateDayIndicator() {
            const currentDay = getCurrentDayInIndonesian();
            const dayIndicator = document.getElementById('dayIndicator');
            if (dayIndicator) {
                dayIndicator.textContent = `üìÖ ${currentDay}`;
            }
            console.log(`üìÖ Hari saat ini: ${currentDay}`);
            return currentDay;
        }

        function filterHariByCurrentDay(hariList, currentDay) {
            const filtered = hariList.filter(hari => {
                return hari && hari.toUpperCase().includes(currentDay);
            });
            
            return filtered.sort((a, b) => a.localeCompare(b));
        }

        // ===== FUNGSI MEMUAT DATA =====
        async function loadSalesmanData() {
            try {
                console.log('üë§ Memuat data salesman...');
                const response = await fetch('data/d.salesman.json');
                if (!response.ok) throw new Error('Gagal memuat data salesman');
                
                const content = await response.text();
                salesmanData = parseJSONL(content);
                
                updateSalesmanNameFromData();
                
            } catch (error) {
                console.error('Error memuat data salesman:', error);
            }
        }

        async function loadPelangganData() {
            try {
                console.log('üè™ Memuat data pelanggan...');
                const response = await fetch('data/d.skupelanggan.json');
                if (!response.ok) throw new Error('Gagal memuat data pelanggan');
                
                const content = await response.text();
                pelangganData = parseJSONL(content);
                
            } catch (error) {
                console.error('Error memuat data pelanggan:', error);
            }
        }

        async function loadDetailsData() {
            try {
                console.log('üìä Memuat data detail...');
                const response = await fetch('data/d.details.json');
                if (!response.ok) throw new Error('Gagal memuat data detail');
                
                const content = await response.text();
                detailsData = parseJSONL(content);
                
            } catch (error) {
                console.error('Error memuat data detail:', error);
            }
        }

        function initializeSalesmanFromUrl() {
            currentSalesmanId = getUrlParameter('id') || getUrlParameter('user');
            
            if (currentSalesmanId) {
                console.log('üÜî ID Salesman Saat Ini: ' + currentSalesmanId);
            }
        }

        function updateSalesmanNameFromData() {
            if (currentSalesmanId && salesmanData.length > 0) {
                const salesmanRecord = salesmanData.find(item => item.szEmployeeId.toString() === currentSalesmanId);
                if (salesmanRecord) {
                    currentSalesman = salesmanRecord.szname;
                    document.getElementById('salesmanName').textContent = currentSalesman;
                }
            } else if (currentSalesmanId && pelangganData.length > 0) {
                const salesmanRecord = pelangganData.find(item => item.szEmployeeId === currentSalesmanId);
                if (salesmanRecord) {
                    currentSalesman = salesmanRecord.szname;
                    document.getElementById('salesmanName').textContent = currentSalesman;
                }
            }
        }

        // ===== FUNGSI PROTEKSI SESI =====
        function checkActiveSessionBeforeAction(actionType, targetName = '') {
            if (visitSession.isActive && !visitSession.isPaused) {
                const currentSessionDuration = Math.floor((Date.now() - visitSession.startTime) / 1000);
                const totalDuration = visitSession.accumulatedDuration + currentSessionDuration;
                const durationText = formatDuration(totalDuration);
                
                if (actionType === 'change_customer') {
                    showVisitEndModal();
                    return false;
                }
                
                let message = `‚ö†Ô∏è KUNJUNGAN SEDANG AKTIF!\n\n`;
                message += `Outlet: ${visitSession.outletName}\n`;
                message += `Durasi: ${durationText}\n\n`;
                message += `Silakan akhiri atau tunda kunjungan terlebih dahulu!`;
                
                alert(message);
                return false;
            }
            return true;
        }

        // ===== FUNGSI FILTER DAN TAMPILAN DATA =====
        function updatePelangganOptions() {
            if (visitSession.isActive && !visitSession.isPaused) {
                checkActiveSessionBeforeAction('change_hari');
                const hariSelect = document.getElementById('hari');
                hariSelect.value = '';
                return;
            }
            
            const hariSelect = document.getElementById('hari');
            const pelangganSelect = document.getElementById('pelanggan');
            
            pelangganSelect.innerHTML = '<option value="">üè™ Pilih Outlet</option>';
            clearDataDisplay();
            
            if (pelangganData.length > 0 && currentSalesmanId && hariSelect.value) {
                const selectedHari = hariSelect.value.trim().toUpperCase();
                
                console.log(`üîç Memfilter outlet untuk Salesman: ${currentSalesmanId}, Hari: ${selectedHari}`);
                
                const filteredPelanggan = [...new Set(pelangganData
                    .filter(item => {
                        const itemSalesmanId = (item.szEmployeeId || '').toString().trim();
                        const itemHari = normalizeHariFormat(item.Hari_Kunjungan);
                        
                        const salesmanMatch = itemSalesmanId === currentSalesmanId;
                        const hariMatch = itemHari === selectedHari;
                        
                        return salesmanMatch && hariMatch;
                    })
                    .map(item => item.Nama_Pelanggan)
                    .filter(pelanggan => pelanggan && pelanggan.toString().trim() !== '')
                )];

                console.log(`üìä Ditemukan ${filteredPelanggan.length} outlet:`, filteredPelanggan);

                filteredPelanggan.forEach(pelanggan => {
                    const option = document.createElement('option');
                    option.value = pelanggan;
                    option.textContent = pelanggan;
                    pelangganSelect.appendChild(option);
                });

                if (filteredPelanggan.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Tidak ada outlet untuk hari ini';
                    option.disabled = true;
                    pelangganSelect.appendChild(option);
                }
                
                updateCustomerListVisitStatus();
                updateCustomerListPauseStatus();
            }
        }

        function handlePelangganSelection() {
            const selectedCustomer = document.getElementById('pelanggan').value.trim();
            
            if (visitSession.isActive && !visitSession.isPaused && visitSession.outletName !== selectedCustomer && selectedCustomer !== '') {
                showVisitEndModal();
                const pelangganSelect = document.getElementById('pelanggan');
                pelangganSelect.value = visitSession.outletName || '';
                return;
            }
            
            const hariSelect = document.getElementById('hari');
            const pelangganSelect = document.getElementById('pelanggan');
            const customerInfo = document.getElementById('customerInfo');
            
            if (pelangganSelect.value && hariSelect.value) {
                const selectedPelanggan = pelangganSelect.value.trim();
                const selectedHari = hariSelect.value.trim().toUpperCase();
                
                if (isCustomerAlreadyVisited(selectedPelanggan)) {
                    alert(`‚ùå Outlet "${selectedPelanggan}" sudah dikunjungi hari ini!\n\nSetiap outlet hanya boleh dikunjungi sekali per hari.`);
                    pelangganSelect.value = '';
                    customerInfo.style.display = 'none';
                    return;
                }
                
                console.log(`üë• Outlet dipilih: ${selectedPelanggan} untuk ${selectedHari}`);
                
                const detailRecord = detailsData.find(item => {
                    const itemPelanggan = (item['Nama Pelanggan'] || '').toString().trim();
                    return itemPelanggan.toLowerCase() === selectedPelanggan.toLowerCase();
                });

                let customerTypeText = `${selectedHari} Outlet`;
                let skuZeroText = 'Tidak ada';
                
                if (detailRecord) {
                    const channelGroup = detailRecord['Channel Group'] || 'Tidak diketahui';
                    const project = detailRecord.Project || 'Tidak diketahui';
                    customerTypeText = `${channelGroup} - ${project}`;
                    
                    // Ekstrak SKU POM dengan value 0
                    const skuPomKeys = ['CREAM8', 'GOTA8', 'OKKIOR20', 'PGFC8Z', 'MAXB2', 'RICH2', 'RUMUT5'];
                    const skuZeroList = skuPomKeys.filter(sku => {
                        const value = detailRecord[sku];
                        return value === 0 || value === '0';
                    });
                    
                    skuZeroText = skuZeroList.length > 0 ? skuZeroList.join(', ') : 'Semua SKU POM aktif';
                    
                    console.log(`üìã Detail outlet ditemukan: ID=${detailRecord['Id Pelanggan']}, Type=${customerTypeText}, SKU Zero=${skuZeroText}`);
                }
                
                customerInfo.style.display = 'block';
                document.getElementById('customerType').textContent = customerTypeText;
                document.getElementById('skuZeroList').textContent = skuZeroText;
                
                updateSummaryFromCustomer(selectedPelanggan);
                showVisitData(selectedPelanggan, selectedHari);
                
                showVisitStartModal(selectedPelanggan, selectedHari);
                
                console.log('‚úÖ Setup outlet selesai:', {
                    outlet: selectedPelanggan,
                    hari: selectedHari,
                    type: customerTypeText,
                    id_pelanggan: detailRecord ? detailRecord['Id Pelanggan'] : 'Tidak ditemukan',
                    alreadyVisited: false,
                    isPaused: isPausedVisit(selectedPelanggan),
                    skuZero: skuZeroText
                });
                
            } else {
                customerInfo.style.display = 'none';
                clearDataDisplay();
            }
        }

        function clearDataDisplay() {
            const tableBody = document.getElementById('tableBody');
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìä</div>
                                <div>Pilih filter untuk melihat data</div>
                            </div>
                        </td>
                    </tr>
                `;
            }
            
            document.getElementById('summaryTarget').textContent = '-';
            document.getElementById('summaryActual').textContent = '-';
            document.getElementById('summaryGap').textContent = '-';
            document.getElementById('summaryGap').className = 'summary-value';
            
            const customerInfo = document.getElementById('customerInfo');
            if (customerInfo) {
                customerInfo.style.display = 'none';
            }
            
            window.currentFilteredData = [];
        }

        function updateSummaryFromCustomer(selectedPelanggan) {
            const targetElement = document.getElementById('summaryTarget');
            const actualElement = document.getElementById('summaryActual');
            const gapElement = document.getElementById('summaryGap');
            
            if (!currentSalesman || !selectedPelanggan || detailsData.length === 0) {
                targetElement.textContent = '-';
                actualElement.textContent = '-';
                gapElement.textContent = '-';
                gapElement.className = 'summary-value';
                return;
            }
            
            const detailsSummaryData = detailsData.filter(item => {
                const itemSalesman = (item['szname'] || '').toString().trim();
                const itemPelanggan = (item['Nama Pelanggan'] || '').toString().trim();
                
                return itemSalesman === currentSalesman && 
                       itemPelanggan.toLowerCase() === selectedPelanggan.toLowerCase();
            });
            
            console.log(`üìä Data ringkasan: ${detailsSummaryData.length} records untuk ${selectedPelanggan}`);
            
            if (detailsSummaryData.length === 0) {
                targetElement.textContent = '0';
                actualElement.textContent = '0';
                gapElement.textContent = '0';
                gapElement.className = 'summary-value neutral';
                return;
            }
            
            let totalTarget = 0;
            let totalActual = 0;
            let totalGap = 0;
            
            detailsSummaryData.forEach(item => {
                totalTarget += Number(item['T.MTD']) || 0;
                totalActual += Number(item['A.MTD']) || 0;
                totalGap += Number(item['Gap MTD']) || 0;
            });
            
            const formatNumber = (num) => {
                if (Math.abs(num) >= 1000000) {
                    return (num / 1000000).toFixed(1) + 'M';
                } else if (Math.abs(num) >= 1000) {
                    return (num / 1000).toFixed(0) + 'K';
                }
                return num.toFixed(0);
            };
            
            targetElement.textContent = formatNumber(totalTarget);
            actualElement.textContent = formatNumber(totalActual);
            gapElement.textContent = (totalGap > 0 ? '+' : '') + formatNumber(totalGap);
            
            if (totalGap > 0) {
                gapElement.className = 'summary-value positive';
            } else if (totalGap < 0) {
                gapElement.className = 'summary-value negative';
            } else {
                gapElement.className = 'summary-value neutral';
            }
        }

        function showVisitData(customerName, hariJKS) {
            const tableBody = document.getElementById('tableBody');
            
            if (!tableBody) {
                console.error('‚ùå Elemen table body tidak ditemukan');
                return;
            }
            
            const visitData = pelangganData.filter(item => {
                const itemSalesmanId = (item.szEmployeeId || '').toString().trim();
                const itemHari = normalizeHariFormat(item.Hari_Kunjungan);
                const itemPelanggan = (item.Nama_Pelanggan || '').toString().trim();
                
                return itemSalesmanId === currentSalesmanId &&
                       itemHari === hariJKS &&
                       itemPelanggan.toLowerCase() === customerName.toLowerCase();
            });
            
            console.log(`üìã Data kunjungan untuk ${customerName}: ${visitData.length} records`);
            
            if (visitData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9">
                            <div class="empty-state">
                                <div class="empty-state-icon">üî≠</div>
                                <div>Tidak ada data kunjungan untuk ${customerName}</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            window.currentFilteredData = [...visitData];
            renderTableData(visitData);
        }

        // ===== FUNGSI RENDERING TABEL =====
        let currentFilteredData = [];
        let sortState = { column: null, direction: 'asc' };

        function sortTable(column) {
            if (!window.currentFilteredData || window.currentFilteredData.length === 0) {
                return;
            }

            if (sortState.column === column) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = column;
                sortState.direction = 'asc';
            }

            if (column === 'promo') {
                window.currentFilteredData.sort((a, b) => {
                    const promoA = (a.Promo || '').toLowerCase();
                    const promoB = (b.Promo || '').toLowerCase();
                    
                    if (sortState.direction === 'asc') {
                        return promoA.localeCompare(promoB);
                    } else {
                        return promoB.localeCompare(promoA);
                    }
                });
            }

            updateSortHeaders();
            renderTableData(window.currentFilteredData);
        }

        function updateSortHeaders() {
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.classList.remove('asc', 'desc');
            });

            if (sortState.column === 'promo') {
                const promoHeader = document.querySelector('.sortable-header');
                if (promoHeader) {
                    promoHeader.classList.add(sortState.direction);
                }
            }
        }

        function renderTableData(data) {
            const tableBody = document.getElementById('tableBody');
            
            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9">
                            <div class="empty-state">
                                <div class="empty-state-icon">üî≠</div>
                                <div>Tidak ada data untuk kriteria yang dipilih</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            let totalPlan = 0, totalMTD = 0;
            
            data.forEach((item, index) => {
                const no = index + 1;
                const promo = item.Promo || "Others";
                const sku = item.SKU || "N/A";
                const threeLM = Number(item.Unit3LM) || 0;
                const lm = Number(item.UnitLM) || 0;
                const plan = Number(item.Plan) || 0;
                const mtd = Number(item.UnitMTD) || 0;
                const gap = Number(item.Gap) || (mtd - plan);
                const rekomendasi = generateRecommendation(gap, plan, mtd);
                
                totalPlan += plan;
                totalMTD += mtd;
                
                const gapClass = gap > 0 ? 'positive' : gap < 0 ? 'negative' : 'neutral';
                const gapBadgeClass = gap > 0 ? 'gap-positive' : gap < 0 ? 'gap-negative' : 'gap-neutral';
                const promoClass = `promo-${promo.toLowerCase().replace(/\s+/g, '')}`;
                
                html += `
                    <tr>
                        <td>${no}</td>
                        <td><span class="promo-tag ${promoClass}">${promo}</span></td>
                        <td><span class="sku-code">${sku}</span></td>
                        <td><span class="gap-badge ${gapBadgeClass}">${gap > 0 ? '+' : ''}${formatNumber(gap)}</span></td>
                        <td class="metric-value">${formatNumber(plan)}</td>
                        <td class="metric-value">${formatNumber(mtd)}</td>
                        <td>${formatNumber(threeLM)}</td>
                        <td>${formatNumber(lm)}</td>
                        <td><span class="recommendation">${rekomendasi}</span></td>
                    </tr>
                `;
            });
            
            const totalGap = totalMTD - totalPlan;
            const totalGapBadgeClass = totalGap > 0 ? 'gap-positive' : totalGap < 0 ? 'gap-negative' : 'gap-neutral';
            
            html += `
                <tr class="summary-row">
                    <td></td>
                    <td><strong>TOTAL</strong></td>
                    <td></td>
                    <td><span class="gap-badge ${totalGapBadgeClass}"><strong>${totalGap > 0 ? '+' : ''}${formatNumber(totalGap)}</strong></span></td>
                    <td><strong>${formatNumber(totalPlan)}</strong></td>
                    <td><strong>${formatNumber(totalMTD)}</strong></td>
                    <td></td>
                    <td></td>
                    <td>-</td>
                </tr>
            `;
            
            tableBody.innerHTML = html;
            
            console.log(`üìä Tabel di-render: ${data.length} item dengan baris ringkasan`);
        }

        function generateRecommendation(gap, plan, mtd) {
            if (mtd === 0 || mtd === null || mtd === undefined) {
                return "Belum Aktif";
            } else if (mtd > 0 && mtd < plan) {
                return "Under Plan";
            } else if (mtd > 0 && mtd >= plan) {
                return "Over Plan";
            }
            return "Belum Aktif";
        }

        // ===== FUNGSI UI =====
        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'flex' : 'none';
        }

        function showMainContent(show) {
            document.getElementById('mainContent').style.display = show ? 'block' : 'none';
        }

        // ===== INISIALISASI =====
        async function initializeData() {
            try {
                showLoading(true);
                
                console.log('üöÄ Memulai sistem kunjungan Firebase dengan pause/resume & pelacakan lokasi...');
                
                const currentDay = updateDayIndicator();
                
                console.log('üÜî Inisialisasi salesman dari URL...');
                initializeSalesmanFromUrl();
                
                if (currentSalesmanId) {
                    cleanupCorruptedLocalStorage();
                    loadPausedVisitsFromLocal();
                }
                
                console.log('üë§ Memuat data salesman...');
                await loadSalesmanData();
                
                console.log('üè™ Memuat data pelanggan...');
                await loadPelangganData();
                
                console.log('üìä Memuat data detail...');
                await loadDetailsData();
                
                console.log('‚úÖ Semua data berhasil dimuat. Memproses data hari...');
                
                if (pelangganData.length > 0 && currentSalesmanId) {
                    console.log('üîç Memfilter data hari untuk salesman...');
                    
                    const filteredData = pelangganData.filter(item => {
                        const itemSalesmanId = (item.szEmployeeId || '').toString().trim();
                        return itemSalesmanId === currentSalesmanId;
                    });
                    
                    const uniqueHari = [...new Set(filteredData
                        .map(item => normalizeHariFormat(item.Hari_Kunjungan))
                        .filter(hari => hari && hari.trim() !== '')
                    )];
                    
                    const filteredByDay = filterHariByCurrentDay(uniqueHari, currentDay);
                    console.log(`üìÖ Hari difilter untuk ${currentDay}: ${filteredByDay.length}`, filteredByDay);
                    
                    if (filteredByDay.length > 0) {
                        hariData = filteredByDay.map(hari => ({ Hari_Kunjungan: hari }));
                    }
                }
                
                if (hariData.length === 0) {
                    console.log('‚ö†Ô∏è Tidak ada data hari ditemukan, menggunakan fallback hari saat ini...');
                    hariData = [{ Hari_Kunjungan: currentDay }];
                }
                
                const hariSelect = document.getElementById('hari');
                hariSelect.innerHTML = '<option value="">üìÖ Pilih Hari JKS</option>';
                
                hariData.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.Hari_Kunjungan;
                    option.textContent = item.Hari_Kunjungan;
                    hariSelect.appendChild(option);
                });
                
                loadTodayVisitedCustomers();
                
                if (window.firebaseDB) {
                    setTimeout(syncPendingVisitsToFirebase, 2000);
                }
                
                showLoading(false);
                showMainContent(true);
                
                console.log('‚úÖ Sistem kunjungan enhanced dengan pause/resume & pelacakan lokasi siap');
                console.log(`üìÖ Hari saat ini: ${currentDay}`);
                console.log(`üìä Opsi hari tersedia: ${hariData.length}`);
                console.log(`‚è∏Ô∏è Kunjungan tertunda dimuat: ${pausedVisits.size}`);
                console.log('üåê Pelacakan lokasi 10 menit diaktifkan');
                console.log('üè™ Pelacakan status pesanan diaktifkan');
                console.log('üíæ Manajemen sesi localStorage aktif');
                console.log('üî• Sinkronisasi Firebase diaktifkan');
                
            } catch (error) {
                console.error('‚ùå Error kritis di initializeData:', error);
                showLoading(false);
                document.getElementById('errorMessage').style.display = 'block';
            }
        }

        function cleanupCorruptedLocalStorage() {
            if (!currentSalesmanId) return;
            
            const keyPrefix = `visited_${currentSalesmanId}`;
            const keysToCheck = [];
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith(keyPrefix)) {
                    keysToCheck.push(key);
                }
            }
            
            keysToCheck.forEach(key => {
                try {
                    const data = localStorage.getItem(key);
                    const parsed = JSON.parse(data);
                    
                    if (!Array.isArray(parsed)) {
                        console.warn(`‚ö†Ô∏è Menghapus key localStorage yang tidak valid: ${key}`);
                        localStorage.removeItem(key);
                        return;
                    }
                    
                    const isValid = parsed.every(item => {
                        return typeof item === 'object' && item.outlet_name;
                    });
                    
                    if (!isValid) {
                        console.warn(`‚ö†Ô∏è Menghapus key localStorage yang rusak: ${key}`);
                        localStorage.removeItem(key);
                    }
                    
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Menghapus key localStorage yang tidak dapat di-parse: ${key}`);
                    localStorage.removeItem(key);
                }
            });
        }

        async function syncPendingVisitsToFirebase() {
            if (!window.firebaseDB || !currentSalesmanId) {
                return;
            }

            try {
                const pendingKey = `pending_firebase_visits_${currentSalesmanId}`;
                const pendingVisits = JSON.parse(localStorage.getItem(pendingKey) || '[]');
                
                if (pendingVisits.length === 0) {
                    return;
                }
                
                console.log(`üî• Sinkronisasi ${pendingVisits.length} kunjungan tertunda ke Firebase...`);
                
                const syncPromises = pendingVisits.map(async (visit) => {
                    try {
                        const firebaseKey = await syncVisitToFirebase(visit);
                        if (firebaseKey) {
                            return visit.local_id;
                        }
                    } catch (error) {
                        console.error('üî• Error sinkronisasi kunjungan:', visit.local_id, error);
                        return null;
                    }
                });
                
                const syncedIds = (await Promise.all(syncPromises)).filter(id => id !== null);
                
                if (syncedIds.length > 0) {
                    const remainingVisits = pendingVisits.filter(visit => !syncedIds.includes(visit.local_id));
                    localStorage.setItem(pendingKey, JSON.stringify(remainingVisits));
                    console.log(`üî• ${syncedIds.length} kunjungan tersinkronisasi, ${remainingVisits.length} tersisa`);
                }
                
            } catch (error) {
                console.error('üî• Error sinkronisasi kunjungan tertunda:', error);
            }
        }

        // Tambahan tombol sinkronisasi manual untuk testing
        function addManualSyncButton() {
            const floatingActions = document.getElementById('floatingActions');
            
            if (floatingActions && currentSalesmanId) {
                const manualSyncBtn = document.createElement('button');
                manualSyncBtn.className = 'floating-btn btn-manual-sync';
                manualSyncBtn.innerHTML = 'üåê Sinkron Lokasi';
                manualSyncBtn.onclick = forceSyncLocation;
                
                floatingActions.appendChild(manualSyncBtn);
            }
        }

        // Fungsi inisialisasi lokasi enhanced
        function initializeEnhancedLocation() {
            initializeLocationTracking();
            
            // Update status enhanced setiap 30 detik
            setInterval(updateEnhancedLocationStatus, 30000);
            
            // Periksa akses admin
            setTimeout(checkAdminAccess, 1000);
        }

        // ===== EVENT LISTENERS =====
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('hari').addEventListener('change', updatePelangganOptions);
            document.getElementById('pelanggan').addEventListener('change', handlePelangganSelection);

            updateVisitSessionStatus();
            updateFloatingButtons();
            
            // Inisialisasi pelacakan lokasi enhanced
            setTimeout(initializeEnhancedLocation, 1000);
            
            // Tambahan tombol sinkronisasi manual untuk testing
            setTimeout(addManualSyncButton, 2000);
            
            initializeData();

            setInterval(() => {
                if (window.firebaseDB && currentSalesmanId) {
                    syncPendingVisitsToFirebase();
                }
            }, 30000);

            setInterval(() => {
                updateFloatingButtons();
            }, 3000);
        });

        // ===== FUNGSI NAVIGASI DENGAN PROTEKSI SESI =====
        function goHome() {
            if (!checkActiveSessionBeforeAction('navigate_home')) return;
            window.location.href = 'dashboard.html'; 
        }
        
        function showVisitOutlet() { 
            window.location.href = 'visit.html';
        }
        
        function showIncentive() {
            if (!checkActiveSessionBeforeAction('navigate_incentive')) return;
            alert('üí∞ Fitur insentif segera hadir');
        }
        
        function showProfile() {
            if (!checkActiveSessionBeforeAction('navigate_profile')) return;
            alert('üë§ Fitur profil segera hadir');
        }

        // ===== CLEANUP DAN PENANGANAN VISIBILITY =====
        window.addEventListener('beforeunload', function (e) {
            if (visitSession.isActive && !visitSession.isPaused) {
                const confirmationMessage = `‚ö†Ô∏è Anda memiliki kunjungan aktif ke ${visitSession.outletName}.\n\nJika Anda meninggalkan halaman, kunjungan akan dianggap tidak selesai.`;
                
                e.preventDefault();
                e.returnValue = confirmationMessage;
                return confirmationMessage;
            }
            
            if (isLocationTrackingActive) {
                // Sinkronisasi lokasi terakhir sebelum keluar
                syncCurrentLocationToFirebase();
                stopPeriodicLocationTracking();
            }
        });

        // Penanganan perubahan visibility untuk pelacakan lokasi
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Halaman tersembunyi - pertahankan pelacakan
                console.log('üåê Halaman tersembunyi - mempertahankan pelacakan');
            } else {
                // Halaman terlihat - pastikan pelacakan aktif
                console.log('üåê Halaman terlihat - memastikan pelacakan aktif');
                if (currentSalesmanId && !isLocationTrackingActive) {
                    initializeLocationTracking();
                }
            }
        });

        console.log('‚úÖ Sistem Kunjungan Enhanced dengan Pause/Resume & Pelacakan Lokasi dimuat');
        console.log('‚è∏Ô∏è Fungsionalitas Pause/Resume diaktifkan');
        console.log('üîÑ Manajemen sesi kunjungan dengan pelacakan waktu');
        console.log('üíæ Local storage + Firebase untuk pelacakan komprehensif');
        console.log('üó∫Ô∏è Pelacakan lokasi untuk event pause/resume');
        console.log('üìä Analitik kunjungan enhanced dengan data pause');
        console.log('üåê Sinkronisasi lokasi periodik 10 menit ke Firebase');
        console.log('üë• Monitoring posisi admin tersedia');
        console.log('üõ°Ô∏è Proteksi sesi dan integritas data ditingkatkan');
    </script>
</body>
</html>