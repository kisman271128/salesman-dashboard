<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Insentif Sales</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 font-sans p-4 max-w-sm mx-auto">
    <!-- Loading State -->
    <div class="loading-spinner" id="loadingSpinner" style="display: flex; justify-content: center; align-items: center; height: 200px; flex-direction: column;">
      <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #0891b2; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px;"></div>
      <div style="color: #64748b;">Loading data insentif...</div>
    </div>

    <!-- Error State -->
    <div class="error-message" id="errorMessage" style="display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; padding: 16px; border-radius: 12px; margin: 20px 0; text-align: center;">
      <h3>üì° Error Loading Data</h3>
      <p>Tidak dapat memuat data insentif. Silakan coba lagi.</p>
      <button onclick="loadIncentiveData()" style="margin-top: 10px; padding: 8px 16px; background: #0891b2; color: white; border: none; border-radius: 8px; cursor: pointer;">Retry</button>
    </div>

    <!-- Main Content -->
    <div id="mainContent" style="display: none;">
    <!-- Header dengan Foto dan Info Salesman -->
    <header class="flex items-center bg-cyan-700 rounded-xl shadow p-4 mb-4">
      <div class="flex-shrink-0">
        <img id="salesmanPhoto" src="https://cdn-icons-png.flaticon.com/512/3048/3048122.png" alt="Foto Salesman" class="w-16 h-16 rounded-full border-4 border-white shadow-lg" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3048/3048122.png'" />
      </div>
      <div class="flex-1 ml-4">
        <h1 class="text-lg font-bold text-white" id="salesmanName">Nama Salesman</h1>
        <p class="text-sm font-medium text-white opacity-90" id="salesmanType">Tipe Salesman</p>
      </div>
      <div class="bg-white rounded-lg px-3 py-2 text-right">
        <p class="text-sm font-bold text-gray-800">Insentif</p>
        <p class="text-xs font-medium text-gray-600" id="periodInsentif">Periode<br>Juli 2025</p>
      </div>
    </header>

    <!-- Ringkasan Total: 2 Kolom Grid -->
    <section class="grid grid-cols-2 gap-3 mb-4">
      <div class="bg-white shadow rounded-xl p-3 flex flex-col">
        <p class="text-sm text-yellow-600 font-medium flex items-center gap-1">
          <span>üèÖ</span> Insentif Sales
        </p>
        <p class="text-green-600 font-bold text-lg" id="insentifSalesTotal">Rp 0</p>
      </div>

      <div class="bg-white shadow rounded-xl p-3 flex flex-col">
        <p class="text-sm text-gray-700 font-medium flex items-center gap-1">
          <span>‚öôÔ∏è</span> Insentif Proses
        </p>
        <p class="text-blue-600 font-bold text-lg" id="insentifProsesTotal">Rp 0</p>
      </div>

      <div class="bg-white shadow rounded-xl p-3 flex flex-col">
        <p class="text-sm text-red-600 font-medium flex items-center gap-1">
          <span>‚ö†Ô∏è</span> Penalti AR
        </p>
        <p class="text-red-600 font-bold text-lg" id="penaltiARTotal">Rp 0</p>
      </div>

      <div class="bg-white shadow rounded-xl p-3 flex flex-col">
        <p class="text-sm text-indigo-700 font-medium flex items-center gap-1">
          <span>üìä</span> Total Bersih
        </p>
        <p class="text-indigo-700 font-bold text-lg" id="totalBersih">Rp 0</p>
      </div>
    </section>

    <!-- Insentif Sales -->
    <section class="mb-4">
      <h2 class="text-sm font-semibold text-gray-700 mb-2">üõçÔ∏è Insentif Sales</h2>
      <div id="insentifSalesDetail">
        <!-- Will be populated dynamically based on sales type -->
      </div>
    </section>

    <!-- Insentif Proses -->
    <section class="mb-4">
      <h2 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-1">
        ‚öôÔ∏è Insentif Proses
      </h2>
      <div class="grid grid-cols-3 gap-3" id="insentifProsesDetail">
        <!-- Will be populated dynamically -->
      </div>
    </section>

    <!-- Penalti AR -->
    <section class="mb-6" id="penaltiARSection" style="display: none;">
      <div class="bg-red-100 border border-red-300 p-3 rounded-xl">
        <p class="text-xs font-semibold text-red-700" id="penaltiARText">‚ö†Ô∏è AR saat ini hanya 87%</p>
        <p class="text-xs text-red-700" id="penaltiARDesc">Penalti dikenakan sebesar Rp 150.000</p>
      </div>
    </section>

    <!-- Back Button -->
    <section class="mb-4">
      <button onclick="goBack()" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-medium py-3 px-4 rounded-xl transition-colors duration-200 flex items-center justify-center gap-2">
        <span>‚Üê</span> Kembali ke Dashboard
      </button>
    </section>
    </div>

    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>

    <script>
      // Global variables
      let insentifData = [];
      let currentSalesmanId = null;

      // Get URL parameter
      function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        var results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
      }

      // Format currency to Indonesian Rupiah
      function formatCurrencyIDR(value) {
        try {
          const val = parseFloat(value) || 0;
          return new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
          }).format(val);
        } catch {
          return 'Rp 0';
        }
      }

      // üÜï NEW: Set salesman photo based on NIK
      function setSalesmanPhoto(nikSAC) {
        const photoElement = document.getElementById('salesmanPhoto');
        
        if (nikSAC) {
          // Try to load photo from photos folder based on NIK
          const photoPath = `photos/${nikSAC}.jpg`;
          
          // Create a new image to test if the photo exists
          const testImg = new Image();
          testImg.onload = function() {
            // Photo exists, use it
            photoElement.src = photoPath;
            console.log(`‚úÖ Photo loaded for NIK: ${nikSAC}`);
          };
          testImg.onerror = function() {
            // Photo doesn't exist, try .png extension
            const photoPngPath = `photos/${nikSAC}.png`;
            const testImgPng = new Image();
            testImgPng.onload = function() {
              photoElement.src = photoPngPath;
              console.log(`‚úÖ PNG Photo loaded for NIK: ${nikSAC}`);
            };
            testImgPng.onerror = function() {
              // Neither jpg nor png exists, use default
              console.log(`‚ö†Ô∏è No photo found for NIK: ${nikSAC}, using default`);
              photoElement.src = 'https://cdn-icons-png.flaticon.com/512/3048/3048122.png';
            };
            testImgPng.src = photoPngPath;
          };
          testImg.src = photoPath;
        } else {
          console.log('‚ö†Ô∏è No NIK provided, using default photo');
          photoElement.src = 'https://cdn-icons-png.flaticon.com/512/3048/3048122.png';
        }
      }

      // Load JSON data from file
      async function loadJSONData() {
        try {
          console.log('üìÇ Fetching data/d.insentif.json...');
          const response = await fetch('data/d.insentif.json');
          if (!response.ok) {
            throw new Error(`Failed to load incentive data: ${response.status} ${response.statusText}`);
          }
          const text = await response.text();
          
          if (!text.trim()) {
            throw new Error('Incentive data file is empty');
          }
          
          // Parse JSONL format (each line is a separate JSON object)
          insentifData = text.split('\n')
            .filter(line => line.trim())
            .map(line => {
              try {
                return JSON.parse(line);
              } catch (parseError) {
                console.error('‚ùå Error parsing line:', line, parseError);
                return null;
              }
            })
            .filter(item => item !== null);

          console.log(`‚úÖ Loaded ${insentifData.length} incentive records`);
          console.log('üìä Sample data:', insentifData[0]);
          return true;
        } catch (error) {
          console.error('‚ùå Error loading JSON data:', error);
          throw error;
        }
      }

      // Get salesman incentive data
      function getSalesmanIncentiveData(employeeId) {
        return insentifData.find(item => 
          item.szEmployeeId && item.szEmployeeId.toString() === employeeId.toString()
        );
      }

      // Update salesman profile
      function updateSalesmanProfile(incentiveData) {
        if (incentiveData) {
          // Handle names using correct field names from JSON
          const salesmanName = incentiveData.szname && incentiveData.szname.trim() !== '' 
            ? incentiveData.szname 
            : `Salesman ${incentiveData.szEmployeeId}`;
          
          const salesmanType = incentiveData["Tipe Salesman"] && incentiveData["Tipe Salesman"].trim() !== '' 
            ? incentiveData["Tipe Salesman"] 
            : 'Sales';
          
          document.getElementById('salesmanName').textContent = salesmanName;
          document.getElementById('salesmanType').textContent = salesmanType;
          
          // üÜï NEW: Set photo based on NIK SAC
          setSalesmanPhoto(incentiveData["NIK SAC"]);
          
          console.log(`‚úÖ Profile updated - Name: ${salesmanName}, Type: ${salesmanType}, NIK: ${incentiveData["NIK SAC"]}`);
        }
      }

      // Update summary cards
      function updateSummaryCards(incentiveData) {
        if (!incentiveData) return;

        // Use actual data fields from new JSON structure
        const insentifSales = incentiveData.Insentif_sales || 0;
        const insentifProses = incentiveData.Insentif_Proses || 0;
        const penaltiAR = incentiveData["AR Coll"] || 0; // AR Coll might be penalty
        const totalBersih = incentiveData.Total_Insentif || (insentifSales + insentifProses - Math.abs(penaltiAR));

        // Update UI
        document.getElementById('insentifSalesTotal').textContent = formatCurrencyIDR(insentifSales);
        document.getElementById('insentifProsesTotal').textContent = formatCurrencyIDR(insentifProses);
        document.getElementById('penaltiARTotal').textContent = formatCurrencyIDR(penaltiAR);
        document.getElementById('totalBersih').textContent = formatCurrencyIDR(totalBersih);
        
        // Debug logging
        console.log(`‚úÖ Summary updated - Sales: ${insentifSales}, Proses: ${insentifProses}, Penalti: ${penaltiAR}, Total: ${totalBersih}`);
      }

      // üÜï ENHANCED: Update incentive sales detail based on sales type
      function updateIncentiveSalesDetail(incentiveData) {
        if (!incentiveData) return;

        const salesType = incentiveData["Tipe Salesman"] || '';
        console.log(`üéØ Processing sales type: ${salesType}`);

        let html = '';

        if (salesType.includes('Sales Representative Retailer Bima')) {
          // Bima: GPPJ, GBS, MBR, HGJ, OTHERS, Avg SKU (6 items in 2x3 grid)
          // GEN and GP are disabled (silver color with "-")
          const salesDetails = [
            { name: 'GPPJ', value: incentiveData.GPPJ || 0, color: 'green', enabled: true },
            { name: 'GEN', value: 0, color: 'gray', enabled: false }, // Disabled for Bima
            { name: 'GBS', value: incentiveData.GBS || 0, color: 'yellow', enabled: true },
            { name: 'OTHERS', value: incentiveData.OTHERS || 0, color: 'yellow', enabled: true },
            { name: 'MBR', value: incentiveData.MBR || 0, color: 'blue', enabled: true },
            { name: 'HGJ', value: incentiveData.HGJ || 0, color: 'blue', enabled: true }
          ];

          html = '<div class="grid grid-cols-2 gap-2">';
          salesDetails.forEach(item => {
            if (item.enabled) {
              html += `
                <div class="bg-${item.color}-100 p-3 rounded-xl shadow">
                  <p class="text-xs font-medium">${item.name}</p>
                  <p class="text-${item.color}-700 font-bold text-sm">${formatCurrencyIDR(item.value)}</p>
                </div>
              `;
            } else {
              html += `
                <div class="bg-gray-100 p-3 rounded-xl shadow opacity-60">
                  <p class="text-xs font-medium text-gray-500">${item.name}</p>
                  <p class="text-gray-500 font-bold text-sm">-</p>
                </div>
              `;
            }
          });
          html += '</div>';

        } else if (salesType.includes('Sales Representative Mix Yudistira')) {
          // Yudistira: Only "GPPJ & GEN" and "GBS & OTHERS" (2 large items)
          const gppjGenValue = incentiveData["GPPJ & GEN"] || 0;
          const gbsOthersValue = incentiveData["GBS & OTHERS"] || 0;

          html = `
            <div class="grid grid-cols-1 gap-3">
              <div class="bg-green-100 p-4 rounded-xl shadow">
                <p class="text-sm font-medium text-green-800">GPPJ & GEN</p>
                <p class="text-green-700 font-bold text-xl">${formatCurrencyIDR(gppjGenValue)}</p>
              </div>
              <div class="bg-yellow-100 p-4 rounded-xl shadow">
                <p class="text-sm font-medium text-yellow-800">GBS & OTHERS</p>
                <p class="text-yellow-700 font-bold text-xl">${formatCurrencyIDR(gbsOthersValue)}</p>
              </div>
            </div>
          `;

        } else if (salesType.includes('Sales Representative Retailer Arjuna')) {
          // Arjuna: Only "GPPJ & GEN" (1 large item)
          const gppjGenValue = incentiveData["GPPJ & GEN"] || 0;

          html = `
            <div class="grid grid-cols-1 gap-3">
              <div class="bg-green-100 p-5 rounded-xl shadow">
                <p class="text-base font-medium text-green-800">GPPJ & GEN</p>
                <p class="text-green-700 font-bold text-2xl">${formatCurrencyIDR(gppjGenValue)}</p>
              </div>
            </div>
          `;

        } else {
          // Default: Show all individual components (fallback)
          console.log('‚ö†Ô∏è Unknown sales type, showing default layout');
          
          // Calculate GEN from "GPPJ & GEN" minus "GPPJ"
          const gppjGenTotal = incentiveData["GPPJ & GEN"] || 0;
          const gppjValue = incentiveData.GPPJ || 0;
          const genValue = gppjGenTotal - gppjValue;

          const salesDetails = [
            { name: 'GPPJ', value: incentiveData.GPPJ || 0, color: 'green' },
            { name: 'GEN', value: genValue, color: 'green' },
            { name: 'GBS', value: incentiveData.GBS || 0, color: 'yellow' },
            { name: 'OTHERS', value: incentiveData.OTHERS || 0, color: 'yellow' },
            { name: 'MBR', value: incentiveData.MBR || 0, color: 'blue' },
            { name: 'HGJ', value: incentiveData.HGJ || 0, color: 'blue' }
          ];

          html = '<div class="grid grid-cols-2 gap-2">';
          salesDetails.forEach(item => {
            html += `
              <div class="bg-${item.color}-100 p-3 rounded-xl shadow">
                <p class="text-xs font-medium">${item.name}</p>
                <p class="text-${item.color}-700 font-bold text-sm">${formatCurrencyIDR(item.value)}</p>
              </div>
            `;
          });
          html += '</div>';
        }

        document.getElementById('insentifSalesDetail').innerHTML = html;
        console.log(`‚úÖ Sales detail updated for type: ${salesType}`);
      }

      // üÜï ENHANCED: Update incentive process detail based on sales type
      function updateIncentiveProcessDetail(incentiveData) {
        if (!incentiveData) return;

        const salesType = incentiveData["Tipe Salesman"] || '';

        // Process details based on actual data structure
        let processDetails = [];

        if (salesType.includes('Sales Representative Retailer Bima')) {
          // Bima: Avg SKU (enabled), GP (disabled with silver color)
          processDetails = [
            { name: 'Avg SKU', value: incentiveData["Avg SKU"] || 0, icon: 'üìä', enabled: true },
            { name: 'GP', value: 0, icon: 'üìà', enabled: false }, // Disabled for Bima
            { name: 'POM', value: incentiveData.POM || 0, icon: 'üõí', enabled: true }
          ];
        } else {
          // For Mix Yudistira and Arjuna: GP enabled, other metrics as available
          processDetails = [
            { name: 'Avg SKU', value: incentiveData["Avg SKU"] || 0, icon: 'üìä', enabled: true },
            { name: 'GP', value: incentiveData.GP || 0, icon: 'üìà', enabled: true },
            { name: 'POM', value: incentiveData.POM || 0, icon: 'üõí', enabled: true }
          ];
        }

        let html = '';
        processDetails.forEach(item => {
          if (item.enabled) {
            html += `
              <div class="bg-white p-3 shadow rounded-xl">
                <p class="text-xs font-medium flex items-center gap-1">
                  <span>${item.icon}</span> ${item.name}
                </p>
                <p class="text-indigo-700 font-bold text-sm">${formatCurrencyIDR(item.value)}</p>
              </div>
            `;
          } else {
            html += `
              <div class="bg-gray-100 p-3 shadow rounded-xl opacity-60">
                <p class="text-xs font-medium flex items-center gap-1 text-gray-500">
                  <span>${item.icon}</span> ${item.name}
                </p>
                <p class="text-gray-500 font-bold text-sm">-</p>
              </div>
            `;
          }
        });

        document.getElementById('insentifProsesDetail').innerHTML = html;
        console.log(`‚úÖ Process detail updated for type: ${salesType} with ${processDetails.length} items`);
      }

      // Update penalty AR section
      function updatePenaltySection(incentiveData) {
        const penaltiSection = document.getElementById('penaltiARSection');
        
        if (!incentiveData) {
          console.log('‚ö†Ô∏è No incentive data for penalty section');
          penaltiSection.style.display = 'none';
          return;
        }
        
        const penaltiAR = incentiveData["AR Coll"] || 0;
        
        console.log(`üîç Penalty check - AR Coll: ${penaltiAR}`);
        
        // Show penalty section if there's AR collection penalty
        if (penaltiAR != 0) {
          document.getElementById('penaltiARText').textContent = `‚ö†Ô∏è AR Collection Issue Detected`;
          document.getElementById('penaltiARDesc').textContent = 
            penaltiAR < 0 
              ? `Penalti dikenakan sebesar ${formatCurrencyIDR(Math.abs(penaltiAR))}`
              : `Adjustment sebesar ${formatCurrencyIDR(penaltiAR)}`;
          penaltiSection.style.display = 'block';
          console.log(`‚úÖ Penalty section shown - AR Coll: ${formatCurrencyIDR(penaltiAR)}`);
        } else {
          penaltiSection.style.display = 'none';
          console.log(`‚úÖ No AR penalty - AR Coll: ${penaltiAR} (Good performance)`);
        }
      }

      // Load incentive data
      async function loadIncentiveData() {
        try {
          showLoading(true);
          hideError();

          console.log('üîÑ Loading incentive data...');
          
          // Get salesman ID from URL
          currentSalesmanId = getUrlParameter('id');
          
          if (!currentSalesmanId) {
            throw new Error('No salesman ID specified');
          }

          console.log(`üìç Loading incentive data for salesman ID: ${currentSalesmanId}`);
          
          // Load JSON data
          await loadJSONData();
          
          // Debug: Show all available employee IDs
          const availableIds = insentifData.map(item => item.szEmployeeId);
          console.log(`üìã Available employee IDs: ${availableIds.join(', ')}`);
          
          // Get salesman incentive data
          const salesmanIncentive = getSalesmanIncentiveData(currentSalesmanId);

          if (!salesmanIncentive) {
            console.error(`‚ùå No data found for employee ID: ${currentSalesmanId}`);
            console.log('Available data preview:', insentifData.slice(0, 3));
            throw new Error(`No incentive data found for salesman: ${currentSalesmanId}`);
          }

          console.log(`‚úÖ Found incentive data for: ${salesmanIncentive.szname || currentSalesmanId}`);
          console.log('üìä Full incentive data:', salesmanIncentive);

          // Update UI
          updateSalesmanProfile(salesmanIncentive);
          updateSummaryCards(salesmanIncentive);
          updateIncentiveSalesDetail(salesmanIncentive);
          updateIncentiveProcessDetail(salesmanIncentive);
          updatePenaltySection(salesmanIncentive);
          
          showLoading(false);
          showMainContent(true);

        } catch (error) {
          console.error('‚ùå Error loading incentive data:', error);
          showLoading(false);
          showError(true, error.message);
        }
      }

      // UI control functions
      function showLoading(show) {
        document.getElementById('loadingSpinner').style.display = show ? 'flex' : 'none';
      }

      function showError(show, message = '') {
        const errorElement = document.getElementById('errorMessage');
        if (show) {
          errorElement.style.display = 'block';
          if (message) {
            errorElement.querySelector('p').textContent = message;
          }
        } else {
          errorElement.style.display = 'none';
        }
      }

      function hideError() {
        showError(false);
      }

      function showMainContent(show) {
        document.getElementById('mainContent').style.display = show ? 'block' : 'none';
      }

      // Navigation
      function goBack() {
        const referrer = document.referrer;
        if (referrer && referrer.includes('salesman-detail.html')) {
          window.history.back();
        } else {
          window.location.href = `salesman-detail.html?id=${currentSalesmanId}`;
        }
      }

      // Initialize page
      document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Initializing incentive dashboard...');
        loadIncentiveData();
      });

      console.log('‚úÖ Enhanced incentive dashboard script loaded with multi-type sales support');
    </script>
  </body>
</html>