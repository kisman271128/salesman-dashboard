<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>Activity - Administrator Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(180deg, #f8f9ff 0%, #e8ecff 100%);
            min-height: 100vh;
            color: #2c3e50;
            overflow-x: hidden;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .header-subtitle {
            font-size: 16px;
            opacity: 0.9;
            font-weight: 400;
        }

        /* Main Tab Navigation */
        .main-tabs {
            background: white;
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .main-tab-btn {
            flex: 1;
            padding: 20px 24px;
            background: #f8fafc;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .main-tab-btn.active {
            background: white;
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .main-tab-btn:hover:not(.active) {
            background: #f1f5f9;
            color: #475569;
        }

        /* Content Area */
        .content-area {
            min-height: calc(100vh - 200px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Analytics Content - Embedded */
        .analytics-content {
            padding: 0;
        }

        /* Project Content Layout */
        .project-content {
            display: flex;
            height: calc(100vh - 200px);
        }

        /* Project Sidebar */
        .project-sidebar {
            width: 200px;
            background: #f8fafc;
            border-right: 1px solid #e2e8f0;
            padding: 24px 0;
            flex-shrink: 0;
        }

        .project-menu-item {
            display: block;
            width: 100%;
            padding: 16px 24px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            border-left: 4px solid transparent;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .project-menu-item:hover {
            background: #f1f5f9;
            color: #475569;
            border-left-color: #cbd5e1;
        }

        .project-menu-item.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-left-color: #4c51bf;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        /* Project Main Area */
        .project-main {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .project-section {
            display: none;
        }

        .project-section.active {
            display: block;
        }

        .project-section h2 {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .project-section p {
            font-size: 16px;
            color: #64748b;
            line-height: 1.6;
            margin-bottom: 24px;
        }

        /* Project Cards */
        .project-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .project-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .project-card h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .project-card p {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 16px;
        }

        .project-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active {
            background: #ecfdf5;
            color: #10b981;
        }

        .status-planning {
            background: #fef3c7;
            color: #f59e0b;
        }

        .status-development {
            background: #dbeafe;
            color: #3b82f6;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                max-width: 100%;
            }

            .header h1 {
                font-size: 24px;
            }

            .header-subtitle {
                font-size: 14px;
            }

            .main-tab-btn {
                padding: 16px 12px;
                font-size: 14px;
            }

            .project-content {
                flex-direction: column;
                height: auto;
            }

            .project-sidebar {
                width: 100%;
                padding: 16px 0;
            }

            .project-menu-item {
                padding: 12px 16px;
                border-left: none;
                border-bottom: 2px solid transparent;
            }

            .project-menu-item.active {
                border-left: none;
                border-bottom-color: #667eea;
            }

            .project-main {
                padding: 16px;
            }

            .project-cards {
                grid-template-columns: 1fr;
            }
        }

        /* Analytics Embedded Styles */
        .analytics-embedded {
            width: 100%;
            min-height: calc(100vh - 200px);
        }

        .analytics-embedded .mobile-container {
            max-width: 100%;
            box-shadow: none;
            background: transparent;
        }

        .analytics-embedded .header {
            display: none;
        }

        .analytics-embedded .bottom-actions {
            position: relative;
            max-width: 100%;
            box-shadow: none;
            border-top: 1px solid #e2e8f0;
            margin-top: 20px;
        }

        /* Copy all the analytics styles here */
        /* Analytics Embedded Styles */
        .date-selector {
            background: white;
            margin: 16px;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .date-selector h3 {
            font-size: 14px;
            color: #4a5568;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .date-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .date-input-group {
            display: flex;
            flex-direction: column;
        }

        .date-input-group label {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .date-input-group input {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            background: #f8fafc;
            transition: all 0.3s ease;
            min-height: 44px;
        }

        .date-input-group input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-height: 44px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #4a5568;
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .stats-section {
            padding: 0 16px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 12px;
            padding-left: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
        }

        .stat-card {
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: all 0.3s ease;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .stat-card .icon {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }

        .stat-card h3 {
            font-size: 11px;
            color: #64748b;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1.2;
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .stat-card .change {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .change.positive { 
            background: #ecfdf5; 
            color: #10b981; 
        }
        .change.negative { 
            background: #fef2f2; 
            color: #ef4444; 
        }
        .change.neutral { 
            background: #f8fafc; 
            color: #64748b; 
        }

        .activity-section {
            padding: 0 16px;
            margin-bottom: 20px;
        }

        .activity-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 16px;
        }

        .activity-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .activity-list {
            max-height: 400px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .activity-item {
            padding: 16px;
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.2s ease;
        }

        .activity-item:hover {
            background: #f8fafc;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .loading, .no-data {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .bottom-actions {
            background: white;
            border-top: 1px solid #f1f2f6;
            padding: 12px 16px;
            display: flex;
            gap: 8px;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
            margin: 20px 16px 0 16px;
            border-radius: 12px;
        }

        .bottom-btn {
            flex: 1;
            padding: 12px 8px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            min-height: 50px;
        }

        .bottom-btn-export {
            background: #f1f5f9;
            color: #4a5568;
        }

        .bottom-btn-detail {
            background: #ecfdf5;
            color: #10b981;
        }

        .bottom-btn-clean {
            background: #fef2f2;
            color: #ef4444;
        }

        .bottom-btn:hover {
            transform: translateY(-2px);
        }

        .bottom-btn:active {
            transform: scale(0.95);
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 300px;
            text-align: center;
        }

        .toast.show {
            opacity: 1;
            bottom: 120px;
        }

        .toast.success {
            background: #10b981;
        }

        .toast.error {
            background: #ef4444;
        }

        .toast.neutral {
            background: #64748b;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🏢 Activity</h1>
            <div class="header-subtitle">Administrator</div>
        </div>

        <!-- Main Tab Navigation -->
        <div class="main-tabs">
            <button class="main-tab-btn active" onclick="showMainTab('analytics')">
                📊 Analytics
            </button>
            <button class="main-tab-btn" onclick="showMainTab('project')">
                🚀 Project
            </button>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Analytics Tab Content -->
            <div id="analyticsTab" class="tab-content active">
                <div class="analytics-content">
                    <div class="analytics-embedded">
                        <!-- Embedded Analytics Dashboard -->
                        <div class="mobile-container">
                            <!-- Date Selector -->
                            <div class="date-selector">
                                <h3>📅 Select Date Range</h3>
                                <div class="date-inputs">
                                    <div class="date-input-group">
                                        <label>From</label>
                                        <input type="date" id="dateFrom">
                                    </div>
                                    <div class="date-input-group">
                                        <label>To</label>
                                        <input type="date" id="dateTo">
                                    </div>
                                </div>
                                <div class="action-buttons">
                                    <button class="btn btn-primary" onclick="loadVisitAnalytics()">
                                        📈 Load Data
                                    </button>
                                    <button class="btn btn-secondary" onclick="loadTodayData()">
                                        📅 Today
                                    </button>
                                </div>
                            </div>

                            <!-- Enhanced Stats Overview -->
                            <div class="stats-section">
                                <div class="section-title">📊 Visit Overview</div>
                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <div class="icon">👥</div>
                                        <h3>Active Salesman</h3>
                                        <div class="value" id="totalSalesman">-</div>
                                        <div class="change neutral">Today</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="icon">⏰</div>
                                        <h3>Avg First Access</h3>
                                        <div class="value" id="avgFirstAccess" style="font-size: 16px;">-</div>
                                        <div class="change neutral">Time</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="icon">👨‍💼</div>
                                        <h3>Total Customers</h3>
                                        <div class="value" id="totalCustomers">-</div>
                                        <div class="change neutral">Viewed</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="icon">⌛</div>
                                        <h3>Avg Duration</h3>
                                        <div class="value" id="avgDuration" style="font-size: 16px;">-</div>
                                        <div class="change neutral">Per Customer</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Enhanced Visit Activity -->
                            <div class="activity-section">
                                <div class="section-title">👥 Detailed Visit Activity by Salesman</div>
                                <div class="activity-card">
                                    <div class="activity-header">
                                        📋 Visit Usage & Customer Duration Analysis
                                    </div>
                                    <div class="activity-list" id="activityList">
                                        <div class="loading">
                                            <div class="loading-spinner"></div>
                                            <div>Loading enhanced visit analytics...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Bottom Actions -->
                            <div class="bottom-actions">
                                <button class="bottom-btn bottom-btn-export" onclick="exportVisitData()">
                                    📤
                                    <span>Export Report</span>
                                </button>
                                <button class="bottom-btn bottom-btn-detail" onclick="showDetailedReport()">
                                    📊
                                    <span>Detailed View</span>
                                </button>
                                <button class="bottom-btn bottom-btn-clean" onclick="clearOldData()">
                                    🗑️
                                    <span>Cleanup</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Project Tab Content -->
            <div id="projectTab" class="tab-content">
                <div class="project-content">
                    <!-- Project Sidebar -->
                    <div class="project-sidebar">
                        <button class="project-menu-item active" onclick="showProjectSection('pom')">
                            POM
                        </button>
                        <button class="project-menu-item" onclick="showProjectSection('itg')">
                            ITG
                        </button>
                        <button class="project-menu-item" onclick="showProjectSection('category')">
                            By Category
                        </button>
                        <button class="project-menu-item" onclick="showProjectSection('channel')">
                            By Channel
                        </button>
                    </div>

                    <!-- Project Main Area -->
                    <div class="project-main">
                        <!-- POM Section -->
                        <div id="pomSection" class="project-section active">
                            <h2>📋 POM (Performance Optimization Management)</h2>
                            <p>Manage and monitor performance optimization metrics across all sales channels and product categories.</p>
                            
                            <div class="project-cards">
                                <div class="project-card">
                                    <h3>🎯 Sales Target Optimization</h3>
                                    <p>Real-time monitoring of sales targets vs actual performance with predictive analytics.</p>
                                    <span class="project-status status-active">Active</span>
                                </div>
                                <div class="project-card">
                                    <h3>📊 Performance Metrics Dashboard</h3>
                                    <p>Comprehensive dashboard showing KPIs, trends, and performance indicators.</p>
                                    <span class="project-status status-development">In Development</span>
                                </div>
                                <div class="project-card">
                                    <h3>⚡ Process Automation</h3>
                                    <p>Automated workflows for performance tracking and reporting processes.</p>
                                    <span class="project-status status-planning">Planning</span>
                                </div>
                            </div>
                        </div>

                        <!-- ITG Section -->
                        <div id="itgSection" class="project-section">
                            <h2>🔧 ITG (IT Governance & Infrastructure)</h2>
                            <p>IT infrastructure management, system governance, and technical project oversight.</p>
                            
                            <div class="project-cards">
                                <div class="project-card">
                                    <h3>🖥️ System Architecture</h3>
                                    <p>Design and implementation of scalable system architecture for enterprise solutions.</p>
                                    <span class="project-status status-active">Active</span>
                                </div>
                                <div class="project-card">
                                    <h3>🔐 Security Management</h3>
                                    <p>Comprehensive security protocols and access management systems.</p>
                                    <span class="project-status status-active">Active</span>
                                </div>
                                <div class="project-card">
                                    <h3>📱 Mobile App Infrastructure</h3>
                                    <p>Backend services and API management for mobile applications.</p>
                                    <span class="project-status status-development">In Development</span>
                                </div>
                            </div>
                        </div>

                        <!-- By Category Section -->
                        <div id="categorySection" class="project-section">
                            <h2>🏷️ By Category</h2>
                            <p>Project management and analytics organized by product categories and business segments.</p>
                            
                            <div class="project-cards">
                                <div class="project-card">
                                    <h3>🍪 Biscuit Category Management</h3>
                                    <p>Specialized tools and analytics for biscuit product line management.</p>
                                    <span class="project-status status-active">Active</span>
                                </div>
                                <div class="project-card">
                                    <h3>🥤 Beverage Category Analytics</h3>
                                    <p>Comprehensive beverage category performance tracking and optimization.</p>
                                    <span class="project-status status-active">Active</span>
                                </div>
                                <div class="project-card">
                                    <h3>🍿 Snackfood Operations</h3>
                                    <p>Operations management and performance tracking for snackfood categories.</p>
                                    <span class="project-status status-development">In Development</span>
                                </div>
                                <div class="project-card">
                                    <h3>🎁 General Products Hub</h3>
                                    <p>Unified management system for miscellaneous and general product categories.</p>
                                    <span class="project-status status-planning">Planning</span>
                                </div>
                            </div>
                        </div>

                        <!-- By Channel Section -->
                        <div id="channelSection" class="project-section">
                            <h2>📺 By Channel</h2>
                            <p>Channel-specific project management and performance optimization across distribution networks.</p>
                            
                            <div class="project-cards">
                                <div class="project-card">
                                    <h3>🏪 Traditional Trade</h3>
                                    <p>Traditional trade channel optimization and relationship management systems.</p>
                                    <span class="project-status status-active">Active</span>
                                </div>
                                <div class="project-card">
                                    <h3>🏬 Modern Trade</h3>
                                    <p>Modern retail channel management with advanced POS integration.</p>
                                    <span class="project-status status-active">Active</span>
                                </div>
                                <div class="project-card">
                                    <h3>🌐 E-Commerce Platform</h3>
                                    <p>Digital commerce channel management and online marketplace optimization.</p>
                                    <span class="project-status status-development">In Development</span>
                                </div>
                                <div class="project-card">
                                    <h3>🚚 Direct Distribution</h3>
                                    <p>Direct-to-consumer distribution channel management and logistics optimization.</p>
                                    <span class="project-status status-planning">Planning</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div class="toast" id="toast"></div>
    </div>

    <script>
        // ===== MAIN TAB MANAGEMENT =====
        function showMainTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.main-tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Show/hide tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tabName === 'analytics') {
                document.getElementById('analyticsTab').classList.add('active');
                // Load analytics data when tab is opened
                setTimeout(() => {
                    if (typeof loadTodayData === 'function') {
                        loadTodayData();
                    } else {
                        initializeAnalytics();
                    }
                }, 100);
            } else if (tabName === 'project') {
                document.getElementById('projectTab').classList.add('active');
            }
        }

        // ===== PROJECT SUB MENU MANAGEMENT =====
        function showProjectSection(sectionName) {
            // Update menu buttons
            document.querySelectorAll('.project-menu-item').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Show/hide sections
            document.querySelectorAll('.project-section').forEach(section => section.classList.remove('active'));
            
            const sectionMap = {
                'pom': 'pomSection',
                'itg': 'itgSection', 
                'category': 'categorySection',
                'channel': 'channelSection'
            };
            
            const targetSection = document.getElementById(sectionMap[sectionName]);
            if (targetSection) {
                targetSection.classList.add('active');
            }
        }

        // ===== 🔧 FIXED ENHANCED ANALYTICS MODULE - READS PER SALESMAN DATA =====
        class EnhancedVisitAnalytics {
            constructor() {
                this.visitData = [];
                this.dailyData = {};
                this.salesmanData = {};
                this.isInitialized = false;
                
                this.init();
            }
            
            init() {
                if (this.isInitialized) return;
                console.log('🚀 Enhanced Visit Analytics initialized in Activity page (Per Salesman)');
                this.isInitialized = true;
            }
            
            // 🔧 FIXED: Load data with salesman isolation
            loadVisitData(dateFrom, dateTo) {
                this.visitData = [];
                this.dailyData = {};
                this.salesmanData = {};
                
                let currentDate = new Date(dateFrom);
                const endDate = new Date(dateTo);
                
                console.log(`📊 Loading visit data from ${dateFrom} to ${dateTo}`);
                
                while (currentDate <= endDate) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    
                    // Get all possible salesman IDs from localStorage keys
                    const salesmanIds = this.getAllSalesmanIdsForDate(dateStr);
                    
                    console.log(`📅 Found ${salesmanIds.length} salesman for ${dateStr}:`, salesmanIds);
                    
                    salesmanIds.forEach(salesmanId => {
                        // Load analytics events for specific salesman
                        const analyticsKey = `visit_analytics_${dateStr}_${salesmanId}`;
                        const analyticsData = JSON.parse(localStorage.getItem(analyticsKey) || '[]');
                        
                        // Load daily summary data for specific salesman
                        const dailyKey = `visit_daily_${dateStr}_${salesmanId}`;
                        const dailyInfo = JSON.parse(localStorage.getItem(dailyKey) || '{}');
                        
                        if (analyticsData.length > 0 || Object.keys(dailyInfo).length > 0) {
                            // Store by salesman and date
                            const key = `${salesmanId}_${dateStr}`;
                            this.dailyData[key] = {
                                salesman_id: salesmanId,
                                date: dateStr,
                                analytics: analyticsData,
                                daily: dailyInfo
                            };
                            
                            console.log(`📦 Loaded ${analyticsData.length} events for ${salesmanId} on ${dateStr}`);
                            
                            // Process analytics data
                            analyticsData.forEach(event => {
                                this.visitData.push(event);
                                
                                // Aggregate by salesman
                                if (!this.salesmanData[salesmanId]) {
                                    this.salesmanData[salesmanId] = {
                                        salesman_id: salesmanId,
                                        salesman_name: event.salesman_name || dailyInfo.salesman_name || 'Unknown',
                                        first_access_times: {},
                                        customers: {},
                                        total_duration: 0,
                                        session_count: 0,
                                        events: []
                                    };
                                }
                                
                                this.salesmanData[salesmanId].events.push(event);
                            });
                        }
                    });
                    
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                // Process daily data for first access times and customer durations
                this.processDailyData();
                
                console.log(`✅ Loaded visit data: ${this.visitData.length} events, ${Object.keys(this.salesmanData).length} salesman`);
                console.log('📋 Salesman found:', Object.keys(this.salesmanData).map(id => `${id}: ${this.salesmanData[id].salesman_name}`));
            }
            
            // 🔧 NEW: Get all salesman IDs that have data for a specific date
            getAllSalesmanIdsForDate(dateStr) {
                const salesmanIds = new Set();
                
                // Check localStorage for keys matching the pattern
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    
                    // Check for analytics keys: visit_analytics_${date}_${salesmanId}
                    const analyticsPattern = new RegExp(`^visit_analytics_${dateStr.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}_(.+)$`);
                    const analyticsMatch = key?.match(analyticsPattern);
                    if (analyticsMatch) {
                        salesmanIds.add(analyticsMatch[1]);
                    }
                    
                    // Check for daily keys: visit_daily_${date}_${salesmanId}
                    const dailyPattern = new RegExp(`^visit_daily_${dateStr.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}_(.+)$`);
                    const dailyMatch = key?.match(dailyPattern);
                    if (dailyMatch) {
                        salesmanIds.add(dailyMatch[1]);
                    }
                }
                
                return Array.from(salesmanIds);
            }
            
            processDailyData() {
                Object.keys(this.dailyData).forEach(key => {
                    const { salesman_id, date, daily: dailyInfo } = this.dailyData[key];
                    
                    if (dailyInfo.date && this.salesmanData[salesman_id]) {
                        // Process first access time
                        if (dailyInfo.firstAccess) {
                            this.salesmanData[salesman_id].first_access_times[date] = dailyInfo.firstAccess;
                        }
                        
                        // Process customer durations
                        if (dailyInfo.customers && Object.keys(dailyInfo.customers).length > 0) {
                            Object.keys(dailyInfo.customers).forEach(customerName => {
                                const customerData = dailyInfo.customers[customerName];
                                
                                if (!this.salesmanData[salesman_id].customers[customerName]) {
                                    this.salesmanData[salesman_id].customers[customerName] = {
                                        name: customerName,
                                        total_duration: 0,
                                        visit_count: 0,
                                        sessions: []
                                    };
                                }
                                
                                const existingCustomer = this.salesmanData[salesman_id].customers[customerName];
                                existingCustomer.total_duration += customerData.totalDuration || 0;
                                existingCustomer.visit_count += customerData.visitCount || 0;
                                
                                if (customerData.sessions) {
                                    existingCustomer.sessions.push(...customerData.sessions);
                                }
                                
                                this.salesmanData[salesman_id].total_duration += customerData.totalDuration || 0;
                            });
                        }
                    }
                });
            }
            
            getSummaryStats() {
                const totalSalesman = Object.keys(this.salesmanData).length;
                let totalCustomers = 0;
                let totalDuration = 0;
                let firstAccessTimes = [];
                
                Object.values(this.salesmanData).forEach(salesman => {
                    totalCustomers += Object.keys(salesman.customers).length;
                    totalDuration += salesman.total_duration;
                    
                    Object.values(salesman.first_access_times).forEach(time => {
                        if (time) {
                            firstAccessTimes.push(new Date(time));
                        }
                    });
                });
                
                const avgFirstAccess = firstAccessTimes.length > 0 ? 
                    this.calculateAverageTime(firstAccessTimes) : null;
                
                const avgDuration = totalCustomers > 0 ? 
                    Math.floor(totalDuration / totalCustomers) : 0;
                
                return {
                    totalSalesman,
                    totalCustomers,
                    avgFirstAccess: avgFirstAccess ? this.formatTime(avgFirstAccess) : 'N/A',
                    avgDuration: this.formatDuration(avgDuration)
                };
            }
            
            calculateAverageTime(times) {
                if (times.length === 0) return null;
                
                const totalMinutes = times.reduce((sum, time) => {
                    return sum + (time.getHours() * 60 + time.getMinutes());
                }, 0);
                
                const avgMinutes = Math.floor(totalMinutes / times.length);
                const avgHours = Math.floor(avgMinutes / 60);
                const remainingMinutes = avgMinutes % 60;
                
                const avgDate = new Date();
                avgDate.setHours(avgHours, remainingMinutes, 0, 0);
                
                return avgDate;
            }
            
            formatTime(date) {
                return date.toLocaleTimeString('id-ID', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            
            formatDuration(seconds) {
                if (seconds <= 0) return '00:00';
                
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                
                if (hours > 0) {
                    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                } else {
                    return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                }
            }
            
            getSalesmanData() {
                return Object.values(this.salesmanData).sort((a, b) => {
                    // Sort by most recent first access
                    const aLatestAccess = Math.max(...Object.keys(a.first_access_times).map(d => new Date(d).getTime()));
                    const bLatestAccess = Math.max(...Object.keys(b.first_access_times).map(d => new Date(d).getTime()));
                    
                    return bLatestAccess - aLatestAccess;
                });
            }
        }

        // ===== GLOBAL VARIABLES =====
        let visitAnalytics = new EnhancedVisitAnalytics();

        // ===== ANALYTICS FUNCTIONS =====
        function initializeAnalytics() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateFrom').value = today;
            document.getElementById('dateTo').value = today;
            loadTodayData();
        }

        function loadTodayData() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateFrom').value = today;
            document.getElementById('dateTo').value = today;
            loadVisitAnalytics();
        }

        function loadVisitAnalytics() {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            if (!dateFrom || !dateTo) {
                showToast('Please select date range', 'error');
                return;
            }

            console.log('📊 Loading enhanced visit analytics for:', dateFrom, 'to', dateTo);
            showLoading();
            
            setTimeout(() => {
                visitAnalytics.loadVisitData(dateFrom, dateTo);
                
                updateStatsOverview();
                updateActivityList();
                
                const totalEvents = visitAnalytics.visitData.length;
                showToast(`Loaded ${totalEvents} visit events`, 'success');
            }, 800);
        }

        function showLoading() {
            document.getElementById('activityList').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>Loading enhanced visit analytics...</div>
                </div>
            `;
        }

        function updateStatsOverview() {
            const stats = visitAnalytics.getSummaryStats();
            
            animateValue('totalSalesman', 0, stats.totalSalesman, 1000);
            document.getElementById('avgFirstAccess').textContent = stats.avgFirstAccess;
            animateValue('totalCustomers', 0, stats.totalCustomers, 1000);
            document.getElementById('avgDuration').textContent = stats.avgDuration;
        }

        function animateValue(elementId, start, end, duration) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const range = end - start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                element.textContent = current;
                if (current === end) {
                    clearInterval(timer);
                }
            }, stepTime);
        }

        function updateActivityList() {
            const activityList = document.getElementById('activityList');
            const salesmanData = visitAnalytics.getSalesmanData();
            
            if (salesmanData.length === 0) {
                activityList.innerHTML = `
                    <div class="no-data">
                        <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;">📭</div>
                        <div>No visit data available for selected date range</div>
                        <div style="font-size: 12px; margin-top: 8px; opacity: 0.7;">Salesman need to access visit.html to generate data</div>
                    </div>
                `;
                return;
            }

            let html = '';
            
            salesmanData.forEach(salesman => {
                const initials = salesman.salesman_name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                
                // Get first access times
                const firstAccessTimes = Object.entries(salesman.first_access_times)
                    .map(([date, time]) => ({
                        date: date,
                        time: new Date(time).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
                    }))
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                const firstAccessDisplay = firstAccessTimes.length > 0 ? 
                    firstAccessTimes[0].time : 'Not recorded';
                
                // Get customer data
                const customers = Object.values(salesman.customers);
                const totalCustomers = customers.length;
                const totalDuration = salesman.total_duration;
                
                html += `
                    <div class="activity-item">
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; flex-shrink: 0;">
                                ${initials}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 14px; color: #1e293b; margin-bottom: 4px;">
                                    ${salesman.salesman_name} <span style="font-size: 11px; color: #64748b; font-weight: 400;">(ID: ${salesman.salesman_id})</span>
                                </div>
                                <div style="font-size: 12px; color: #64748b; margin-bottom: 8px;">
                                    <strong>First Access:</strong> ${firstAccessDisplay}
                                    ${firstAccessTimes.length > 0 ? `<span style="background: #fef3c7; color: #92400e; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; margin-left: 8px;">${firstAccessTimes[0].date}</span>` : ''}
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                    <div style="background: #f8fafc; padding: 6px 8px; border-radius: 6px; text-align: center; border: 1px solid #e2e8f0;">
                                        <div style="font-size: 9px; color: #64748b; text-transform: uppercase; margin-bottom: 2px;">Customers</div>
                                        <div style="font-size: 12px; font-weight: 700; color: #1e293b;">${totalCustomers}</div>
                                    </div>
                                    <div style="background: #f8fafc; padding: 6px 8px; border-radius: 6px; text-align: center; border: 1px solid #e2e8f0;">
                                        <div style="font-size: 9px; color: #64748b; text-transform: uppercase; margin-bottom: 2px;">Total Time</div>
                                        <div style="font-size: 12px; font-weight: 700; color: #1e293b;">${visitAnalytics.formatDuration(totalDuration)}</div>
                                    </div>
                                </div>
                                
                                ${customers.length > 0 ? `
                                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 8px; margin-top: 8px;">
                                        <div style="font-size: 11px; font-weight: 600; color: #0369a1; margin-bottom: 6px; display: flex; align-items: center; gap: 4px;">
                                            ⏱️ Customer Duration Breakdown
                                        </div>
                                        <div style="display: flex; flex-direction: column; gap: 4px;">
                                            ${customers.slice(0, 3).map(customer => `
                                                <div style="display: flex; justify-content: space-between; align-items: center; background: white; padding: 4px 8px; border-radius: 4px; font-size: 10px;">
                                                    <span style="font-weight: 500; color: #1e293b; flex: 1; margin-right: 8px;">${customer.name}</span>
                                                    <span style="font-weight: 700; color: #0369a1; font-family: 'Courier New', monospace;">${visitAnalytics.formatDuration(customer.total_duration)}</span>
                                                </div>
                                            `).join('')}
                                            ${customers.length > 3 ? `
                                                <div style="display: flex; justify-content: space-between; align-items: center; background: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-style: italic; opacity: 0.7;">
                                                    <span style="font-weight: 500; color: #1e293b; flex: 1; margin-right: 8px;">... and ${customers.length - 3} more</span>
                                                    <span style="font-weight: 700; color: #0369a1; font-family: 'Courier New', monospace;">+${visitAnalytics.formatDuration(customers.slice(3).reduce((sum, c) => sum + c.total_duration, 0))}</span>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            activityList.innerHTML = html;
        }

        function exportVisitData() {
            const salesmanData = visitAnalytics.getSalesmanData();
            
            if (salesmanData.length === 0) {
                showToast('No visit data to export', 'error');
                return;
            }
            
            showToast('Preparing enhanced visit report...', 'neutral');
            
            // Enhanced CSV with customer duration details
            const csvHeaders = [
                'Date', 'Salesman_ID', 'Salesman_Name', 'First_Access_Time', 
                'Customer_Name', 'Customer_Duration_Seconds', 'Customer_Duration_Formatted', 
                'Visit_Count', 'Total_Customers', 'Total_Duration_Seconds'
            ];
            
            const csvRows = [];
            
            salesmanData.forEach(salesman => {
                const customers = Object.values(salesman.customers);
                const firstAccessEntries = Object.entries(salesman.first_access_times);
                
                if (customers.length > 0) {
                    customers.forEach(customer => {
                        firstAccessEntries.forEach(([date, firstAccess]) => {
                            csvRows.push([
                                date,
                                salesman.salesman_id,
                                salesman.salesman_name,
                                new Date(firstAccess).toLocaleTimeString('id-ID'),
                                customer.name,
                                customer.total_duration,
                                visitAnalytics.formatDuration(customer.total_duration),
                                customer.visit_count,
                                customers.length,
                                salesman.total_duration
                            ]);
                        });
                    });
                } else {
                    firstAccessEntries.forEach(([date, firstAccess]) => {
                        csvRows.push([
                            date,
                            salesman.salesman_id,
                            salesman.salesman_name,
                            new Date(firstAccess).toLocaleTimeString('id-ID'),
                            'No Customers',
                            0,
                            '00:00',
                            0,
                            0,
                            0
                        ]);
                    });
                }
            });
            
            const csvContent = [csvHeaders, ...csvRows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `enhanced_visit_analytics_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showToast('Enhanced visit report exported successfully!', 'success');
        }

        function showDetailedReport() {
            // Open detailed report in new window
            window.open('analytics.html', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
        }

        function clearOldData() {
            if (!confirm('Are you sure you want to clear old visit analytics data? This cannot be undone.')) {
                return;
            }
            
            showToast('Cleaning up old visit analytics data...', 'neutral');
            
            let deletedCount = 0;
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - 30);
            
            for (let i = localStorage.length - 1; i >= 0; i--) {
                const key = localStorage.key(i);
                if (key && (key.startsWith('visit_analytics_') || key.startsWith('visit_daily_'))) {
                    // Extract date from key (format: visit_analytics_YYYY-MM-DD_salesmanId or visit_daily_YYYY-MM-DD_salesmanId)
                    const dateMatch = key.match(/visit_(analytics|daily)_(\d{4}-\d{2}-\d{2})_/);
                    if (dateMatch) {
                        const dateStr = dateMatch[2];
                        const date = new Date(dateStr);
                        if (date < cutoffDate) {
                            localStorage.removeItem(key);
                            deletedCount++;
                        }
                    }
                }
            }
            
            showToast(`Cleaned up ${deletedCount} old visit analytics entries`, 'success');
        }

        function showToast(message, type = 'neutral') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ===== PAGE INITIALIZATION =====
        window.onload = function() {
            console.log('✅ Activity Administrator Dashboard loaded with Per-Salesman Analytics');
            console.log('📊 Features: Enhanced Analytics + Project Management + Isolated Data per Salesman');
            
            // Initialize analytics when page loads
            initializeAnalytics();
        };
    </script>
</body>
</html>