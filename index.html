<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Sales Performance Dashboard - Login">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Login - Salesman Dashboard</title>
    <style>
        /* CSS tetap sama seperti sebelumnya */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: linear-gradient(135deg, 
                #667eea 0%, 
                #764ba2 25%, 
                #f093fb 50%, 
                #f5576c 75%, 
                #4facfe 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            position: relative;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .floating-elements {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
        }

        .floating-circle {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            animation: float 20s infinite linear;
        }

        .circle-1 { width: 80px; height: 80px; top: 20%; left: 10%; animation-delay: 0s; }
        .circle-2 { width: 120px; height: 120px; top: 60%; left: 80%; animation-delay: 5s; }
        .circle-3 { width: 60px; height: 60px; top: 80%; left: 20%; animation-delay: 10s; }
        .circle-4 { width: 100px; height: 100px; top: 30%; left: 70%; animation-delay: 15s; }

        @keyframes float {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            position: relative;
            z-index: 2;
            padding: 20px;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideUp 1s ease-out;
            position: relative;
            overflow: hidden;
        }

        .login-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

		.logo {
			width: 70px;
			height: 70px;
			background: white;
			border-radius: 50%;
			margin: 0 auto 15px;
			display: flex;
			align-items: center;
			justify-content: center;
			box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
			animation: pulse 2s infinite;
			background-image: url('photos/logo.png');
			background-size: 200%;  /* Logo 80% dari ukuran lingkaran - ada padding */
			background-repeat: no-repeat;
			background-position: center;
			border: 3px solid rgba(255, 255, 255, 0.9);
			padding: 5px;  /* Extra padding untuk memastikan logo tidak terpotong */
		}

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .login-title {
            color: white;
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 6px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .login-subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 20px;
            font-weight: 400;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .input-group {
            position: relative;
        }

        .input-field {
            width: 100%;
            padding: 16px 20px 16px 50px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 15px;
            outline: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .input-field:focus {
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .input-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: rgba(255, 255, 255, 0.6);
            transition: color 0.3s ease;
        }

        .input-field:focus + .input-icon {
            color: white;
        }

        .login-button {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 15px rgba(102, 126, 234, 0.3);
        }

        .login-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .login-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .login-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(102, 126, 234, 0.4);
        }

        .login-button:hover::before {
            left: 100%;
        }

        .remember-forgot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
        }

        .remember-me {
            display: flex;
            align-items: center;
            gap: 6px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
        }

        .checkbox {
            width: 16px;
            height: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkbox:checked {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }

        .login-footer {
            text-align: center;
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .version-info {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            font-weight: 500;
        }

        .loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ‚úÖ UPDATED: Notification Frame (replacing demo-info) */
        .notification-frame {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .notification-frame.hidden {
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
        }

        .notification-frame.error {
            background: rgba(231, 76, 60, 0.2);
            border-color: rgba(231, 76, 60, 0.4);
            animation: shake 0.5s ease-in-out;
        }

        .notification-frame.success {
            background: rgba(46, 213, 115, 0.2);
            border-color: rgba(46, 213, 115, 0.4);
            animation: slideUpNotification 0.5s ease-out;
        }

        .notification-frame.loading {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes slideUpNotification {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .notification-icon {
            font-size: 32px;
            margin-bottom: 10px;
            display: block;
        }

        .notification-title {
            color: white;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .notification-message {
            color: rgba(255, 255, 255, 0.9);
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .notification-info {
            color: rgba(255, 255, 255, 0.7);
            font-size: 11px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Loading spinner for notification frame */
        .notification-spinner {
            width: 25px;
            height: 25px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        /* ‚úÖ Dashboard Selection Modal */
        .dashboard-selection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .selection-modal {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            animation: slideUpModal 0.5s ease-out;
        }

        @keyframes slideUpModal {
            from { 
                opacity: 0; 
                transform: translateY(30px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        .selection-title {
            color: white;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .selection-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .dashboard-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .dashboard-option {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 25px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .dashboard-option:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .dashboard-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .dashboard-option:hover::before {
            left: 100%;
        }

        .option-icon {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }

        .option-title {
            color: white;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .option-description {
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            line-height: 1.4;
        }

        .auto-detect-info {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 13px;
            text-align: center;
        }

        .auto-detect-info strong {
            color: white;
            display: block;
            margin-bottom: 5px;
        }

        .selection-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .selection-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-cancel:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .btn-auto {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-auto:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        /* ‚úÖ RESPONSIVE FOR MOBILE */
        @media (max-width: 580px) {
            .dashboard-options {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .selection-modal {
                padding: 30px 25px;
                margin: 20px;
            }
            
            .selection-title {
                font-size: 20px;
            }
            
            .option-icon {
                font-size: 40px;
                margin-bottom: 12px;
            }
            
            .option-title {
                font-size: 16px;
            }
            
            .selection-buttons {
                flex-direction: column;
            }
        }

        /* ‚úÖ HIDE ELEMENTS DURING TRANSITION */
        .transitioning {
            opacity: 0.7;
            pointer-events: none;
        }

        .transition-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease-out;
        }

        .transition-content {
            text-align: center;
            color: white;
        }

        .transition-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .transition-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .transition-subtext {
            font-size: 14px;
            opacity: 0.8;
        }

        @media (max-width: 480px) {
            .login-card {
                padding: 30px 25px;
                margin: 20px;
                border-radius: 20px;
            }
            .login-title { font-size: 22px; }
            .logo { 
                width: 60px; 
                height: 60px; 
            }
        }
    </style>
</head>
<body>
    <div class="floating-elements">
        <div class="floating-circle circle-1"></div>
        <div class="floating-circle circle-2"></div>
        <div class="floating-circle circle-3"></div>
        <div class="floating-circle circle-4"></div>
    </div>

    <!-- ‚úÖ Dashboard Selection Modal -->
    <div class="dashboard-selection" id="dashboardSelection">
        <div class="selection-modal">
            <h2 class="selection-title">Pilih Tampilan Dashboard</h2>
            <p class="selection-subtitle">
                Selamat datang! Pilih versi dashboard yang sesuai dengan perangkat Anda untuk pengalaman terbaik.
            </p>
            
            <div class="auto-detect-info" id="autoDetectInfo">
                <strong>üîç Auto Detection:</strong>
                <span id="detectedDevice">Detecting your device...</span>
            </div>
            
            <div class="dashboard-options">
                <div class="dashboard-option" onclick="selectDashboard('mobile')">
                    <span class="option-icon">üì±</span>
                    <div class="option-title">Versi Mobile</div>
                    <div class="option-description">
                        Optimal untuk smartphone dan tablet<br>
                        Layout kompak dengan bottom navigation
                    </div>
                </div>
                
                <div class="dashboard-option" onclick="selectDashboard('desktop')">
                    <span class="option-icon">üíª</span>
                    <div class="option-title">Versi Desktop</div>
                    <div class="option-description">
                        Optimal untuk laptop dan PC<br>
                        Layout luas dengan sidebar navigation
                    </div>
                </div>
            </div>
            
            <div class="selection-buttons">
                <button class="selection-btn btn-cancel" onclick="hideDashboardSelection()">
                    Batal
                </button>
                <button class="selection-btn btn-auto" onclick="autoSelectDashboard()">
                    Auto Select
                </button>
            </div>
        </div>
    </div>

    <!-- ‚úÖ TRANSITION OVERLAY -->
    <div class="transition-overlay" id="transitionOverlay">
        <div class="transition-content">
            <div class="transition-spinner"></div>
            <div class="transition-text" id="transitionText">Loading Dashboard...</div>
            <div class="transition-subtext" id="transitionSubtext">Preparing your workspace...</div>
        </div>
    </div>

    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="logo"></div>
                <h1 class="login-title">Sales Dashboard</h1>
                <p class="login-subtitle">Depo Tanjung - Region Kalimantan</p>
            </div>

            <form class="login-form" id="loginForm">
                <div class="input-group">
                    <input type="text" class="input-field" id="nikInput" placeholder="Username/NIK" required>
                    <span class="input-icon">üë§</span>
                </div>

                <div class="input-group">
                    <input type="password" class="input-field" id="password" placeholder="Password" required>
                    <span class="input-icon">üîí</span>
                </div>

                <div class="remember-forgot">
                    <label class="remember-me">
                        <input type="checkbox" class="checkbox" id="rememberMe">
                        Remember me
                    </label>
                </div>

                <button type="submit" class="login-button" id="loginButton">
                    <span id="buttonText">Sign In</span>
                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                    </div>
                </button>
            </form>

            <!-- ‚úÖ NEW: Notification Frame (replaces demo-info) -->
            <div class="notification-frame hidden" id="notificationFrame">
                <div class="notification-spinner" id="notificationSpinner" style="display: none;"></div>
                <span class="notification-icon" id="notificationIcon">üìã</span>
                <div class="notification-title" id="notificationTitle">Sistem Login</div>
                <div class="notification-message" id="notificationMessage">
                    Masukkan username (admin/NIK) dan password untuk mengakses dashboard
                </div>
                <div class="notification-info" id="notificationInfo">
                    <div style="font-size: 14px; font-weight: 600; color: rgba(255, 255, 255, 0.95);">
                        <span>üìÖ Last Update: </span>
                        <span id="lastUpdateTime" style="color: white; font-weight: 700;">Loading...</span>
                    </div>
                </div>
            </div>

            <div class="login-footer">
                <p class="version-info">Sales Dashboard v2.0 | Powered by RSF - Q'sman</p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let validUsers = {};
        let isLoading = false;
        let usersLoaded = false;
        let detectedDeviceType = 'unknown';

        // DOM Elements
        const loginForm = document.getElementById('loginForm');
        const nikInput = document.getElementById('nikInput');
        const passwordInput = document.getElementById('password');
        const rememberMe = document.getElementById('rememberMe');
        const loginButton = document.getElementById('loginButton');
        const dashboardSelection = document.getElementById('dashboardSelection');
        const transitionOverlay = document.getElementById('transitionOverlay');
        const buttonText = document.getElementById('buttonText');
        const loading = document.getElementById('loading');

        // Notification frame elements
        const notificationFrame = document.getElementById('notificationFrame');
        const notificationSpinner = document.getElementById('notificationSpinner');
        const notificationIcon = document.getElementById('notificationIcon');
        const notificationTitle = document.getElementById('notificationTitle');
        const notificationMessage = document.getElementById('notificationMessage');
        const notificationInfo = document.getElementById('notificationInfo');

        // ‚úÖ DEVICE DETECTION FUNCTION
        function detectDevice() {
            const userAgent = navigator.userAgent.toLowerCase();
            const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
            const isTablet = /ipad|android(?!.*mobile)/i.test(userAgent);
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            
            console.log('üîç Device Detection:', {
                userAgent: userAgent.substring(0, 50) + '...',
                isMobile,
                isTablet,
                screenWidth,
                screenHeight
            });
            
            // Determine device type based on multiple factors
            if (isMobile && !isTablet && screenWidth < 768) {
                detectedDeviceType = 'mobile';
                return {
                    type: 'mobile',
                    description: 'Smartphone detected - Mobile version recommended'
                };
            } else if (isTablet || (screenWidth >= 768 && screenWidth < 1024)) {
                detectedDeviceType = 'tablet';
                return {
                    type: 'tablet',
                    description: 'Tablet detected - Both versions available'
                };
            } else if (screenWidth >= 1024) {
                detectedDeviceType = 'desktop';
                return {
                    type: 'desktop',
                    description: 'Desktop/Laptop detected - Desktop version recommended'
                };
            } else {
                detectedDeviceType = 'unknown';
                return {
                    type: 'unknown',
                    description: 'Device type unclear - Please choose manually'
                };
            }
        }

        // ‚úÖ NOTIFICATION FRAME FUNCTIONS
        function showNotification(type, icon, title, message, showInfo = true) {
            notificationFrame.className = `notification-frame ${type}`;
            notificationIcon.textContent = icon;
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            notificationInfo.style.display = showInfo ? 'block' : 'none';
            
            // Show spinner for loading type
            if (type === 'loading') {
                notificationSpinner.style.display = 'block';
                notificationIcon.style.display = 'none';
            } else {
                notificationSpinner.style.display = 'none';
                notificationIcon.style.display = 'block';
            }
        }

        function hideNotification() {
            notificationFrame.className = 'notification-frame hidden';
        }

        function showLoadingNotification() {
            showNotification('loading', '', 'Memverifikasi Login', 'Sedang memproses data login Anda...', false);
        }

        function showSuccessNotification(userName) {
            showNotification('success', '‚úÖ', 'Login Berhasil!', `Selamat datang, ${userName}! Memilih dashboard terbaik untuk Anda...`, false);
        }

        function showErrorNotification(message) {
            showNotification('error', '‚ùå', 'Login Gagal', message, false);
        }

        function showDefaultNotification() {
            showNotification('', 'üìã', 'Sistem Login', 'Masukkan username (admin/NIK) dan password untuk mengakses dashboard', true);
        }

        // ‚úÖ SHOW DASHBOARD SELECTION
        function showDashboardSelection(userName) {
            const device = detectDevice();
            
            document.getElementById('detectedDevice').textContent = device.description;
            dashboardSelection.style.display = 'flex';
            
            console.log('üì± Showing dashboard selection for:', userName);
            console.log('üîç Detected device:', device);
        }

        // ‚úÖ HIDE DASHBOARD SELECTION
        function hideDashboardSelection() {
            dashboardSelection.style.display = 'none';
        }

        // ‚úÖ SELECT DASHBOARD MANUALLY
        function selectDashboard(type) {
            console.log(`üì± Manual dashboard selection: ${type}`);
            
            const dashboardUrl = type === 'desktop' ? 'dashboard-desktop.html' : 'dashboard.html';
            const dashboardName = type === 'desktop' ? 'Desktop Dashboard' : 'Mobile Dashboard';
            
            // Store user preference
            localStorage.setItem('preferredDashboard', type);
            
            redirectToDashboard(dashboardUrl, dashboardName);
        }

        // ‚úÖ AUTO SELECT DASHBOARD BASED ON DETECTION
        function autoSelectDashboard() {
            console.log('ü§ñ Auto selecting dashboard based on detection');
            
            let selectedType = 'mobile'; // default fallback
            
            switch (detectedDeviceType) {
                case 'mobile':
                    selectedType = 'mobile';
                    break;
                case 'tablet':
                    // For tablets, check user preference or default to mobile
                    selectedType = localStorage.getItem('preferredDashboard') || 'mobile';
                    break;
                case 'desktop':
                    selectedType = 'desktop';
                    break;
                default:
                    // Unknown device, check screen size
                    selectedType = window.innerWidth >= 1024 ? 'desktop' : 'mobile';
            }
            
            selectDashboard(selectedType);
        }

        // ‚úÖ REDIRECT TO DASHBOARD WITH TRANSITION
        function redirectToDashboard(url, name) {
            hideDashboardSelection();
            
            // Show transition overlay
            document.getElementById('transitionText').textContent = `Loading ${name}...`;
            document.getElementById('transitionSubtext').textContent = 'Preparing your workspace...';
            transitionOverlay.style.display = 'flex';
            
            // Add some delay for better UX
            setTimeout(() => {
                console.log(`üöÄ Redirecting to: ${url}`);
                window.location.href = url;
            }, 2000);
        }

        // ‚úÖ UPDATED: Load last update info from chart_data.json
        // Get last date where DO > 0 and combine with period
        async function loadLastUpdateInfo() {
            try {
                console.log('üìÖ Loading last update info from chart_data.json...');
                
                // Set loading state
                document.getElementById('lastUpdateTime').textContent = 'Loading...';
                
                const response = await fetch('data/chart_data.json');
                console.log('üìä Chart data fetch response:', response.status, response.ok);
                
                if (response.ok) {
                    const chartData = await response.json();
                    console.log('üìä Chart data structure:', {
                        hasPeriod: !!chartData.period,
                        hasDoData: !!chartData.do_data,
                        hasLabels: !!chartData.labels,
                        period: chartData.period
                    });
                    
                    // Find last date where DO > 0
                    if (chartData.do_data && chartData.labels && chartData.period) {
                        const doData = chartData.do_data;
                        const labels = chartData.labels;
                        const period = chartData.period;
                        
                        // Loop from end to find last DO > 0
                        let lastDateLabel = null;
                        for (let i = doData.length - 1; i >= 0; i--) {
                            if (doData[i] > 0) {
                                lastDateLabel = labels[i];
                                console.log(`üìÖ Found last DO > 0 at index ${i}: DO=${doData[i]}, Date=${lastDateLabel}`);
                                break;
                            }
                        }
                        
                        if (lastDateLabel) {
                            // Combine date with period
                            // Example: "25" + "Oktober 2025" = "25 Oktober 2025"
                            const lastUpdateText = `${lastDateLabel} ${period}`;
                            
                            document.getElementById('lastUpdateTime').textContent = lastUpdateText;
                            console.log('‚úÖ Last update info loaded:', lastUpdateText);
                        } else {
                            console.warn('‚ö†Ô∏è No DO data > 0 found');
                            document.getElementById('lastUpdateTime').textContent = period || 'Data not available';
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Missing required fields in chart_data.json');
                        console.log('üìä Available fields:', Object.keys(chartData));
                        document.getElementById('lastUpdateTime').textContent = chartData.period || 'Data not available';
                    }
                } else {
                    console.warn('‚ö†Ô∏è Could not load chart_data.json:', response.status, response.statusText);
                    
                    // Show fallback
                    document.getElementById('lastUpdateTime').textContent = 'Data not available';
                }
            } catch (error) {
                console.error('‚ùå Error loading last update info:', error);
                
                // Show fallback
                document.getElementById('lastUpdateTime').textContent = 'Data not available';
            }
        }

        // ‚úÖ UPDATED: Load valid users with new password "tanjung2025"
        async function loadValidUsers() {
            try {
                console.log('üîÑ Loading valid users from Firebase...');
                
                // Try to load from Firebase "users" collection first
                let usersFromFirebase = null;
                
                if (window.firebaseDB && window.firebaseRef && window.firebaseGet) {
                    try {
                        const usersRef = window.firebaseRef(window.firebaseDB, 'users');
                        const snapshot = await window.firebaseGet(usersRef);
                        
                        if (snapshot.exists()) {
                            usersFromFirebase = snapshot.val();
                            console.log('‚úÖ Users loaded from Firebase:', Object.keys(usersFromFirebase));
                            
                            // Convert Firebase data to validUsers format
                            validUsers = {};
                            for (const [userId, userData] of Object.entries(usersFromFirebase)) {
                                validUsers[userId] = {
                                    password: userData.password || 'tanjung2025',
                                    name: userData.name || userData.nama || userId,
                                    role: userData.role || 'salesman'
                                };
                            }
                            
                            console.log('‚úÖ Users processed from Firebase:', Object.keys(validUsers).length, 'users');
                        } else {
                            console.warn('‚ö†Ô∏è Firebase "users" collection is empty, using fallback');
                        }
                    } catch (firebaseError) {
                        console.warn('‚ö†Ô∏è Firebase fetch error, using fallback:', firebaseError.message);
                    }
                } else {
                    console.warn('‚ö†Ô∏è Firebase not initialized yet, using fallback');
                }
                
                // If Firebase failed or empty, use fallback hardcoded users
                if (!usersFromFirebase || Object.keys(validUsers).length === 0) {
                    console.log('üìã Using fallback hardcoded users...');
                    
                    // Set default users first (fallback)
                    validUsers = {
                        'admin': { password: 'rastamania271128', name: 'Administrator', role: 'admin' }
                    };

                    try {
                        // Try to load salesman data from JSON
                        const response = await fetch('data/salesman_list.json');
                        if (response.ok) {
                            const salesmanList = await response.json();
                            
                            // Add all salesman from JSON
                            salesmanList.forEach(salesman => {
                                validUsers[salesman.id] = {
                                    password: 'tanjung2025',
                                    name: salesman.name,
                                    role: 'salesman'
                                };
                            });
                            console.log('‚úÖ Salesman data loaded from JSON');
                        } else {
                            console.warn('‚ö†Ô∏è Could not load salesman_list.json, using minimal fallback');
                            // Add minimal fallback salesman users
                            const fallbackSalesman = {
                                '17210032876': { password: 'tanjung2025', name: 'Asman', role: 'salesman' },
                                '17210036369': { password: 'tanjung2025', name: 'Muhammad Tamrin', role: 'salesman' },
                                '17210037632': { password: 'tanjung2025', name: 'Robianor', role: 'salesman' },
                                '17210037897': { password: 'tanjung2025', name: 'Hindra', role: 'salesman' },
                                '17210041467': { password: 'tanjung2025', name: 'Doli Purnama Sari', role: 'salesman' },
                                '17210042412': { password: 'tanjung2025', name: 'Muhammad Rizky Algifari', role: 'salesman' },
								'17210042423': { password: 'tanjung2025', name: 'Siti Fatimah Hadijah', role: 'salesman' }
                            };
                            Object.assign(validUsers, fallbackSalesman);
                        }
                    } catch (fetchError) {
                        console.warn('‚ö†Ô∏è Fetch error, using minimal fallback:', fetchError);
                        // Add minimal fallback salesman users
                        const fallbackSalesman = {
                            '17210032876': { password: 'tanjung2025', name: 'Asman', role: 'salesman' },
                            '17210036369': { password: 'tanjung2025', name: 'Muhammad Tamrin', role: 'salesman' },
                            '17210037632': { password: 'tanjung2025', name: 'Robianor', role: 'salesman' },
                            '17210041467': { password: 'tanjung2025', name: 'Doli Purnama Sari', role: 'salesman' },
                            '17210037897': { password: 'tanjung2025', name: 'Hindra', role: 'salesman' },
                            '17210042412': { password: 'tanjung2025', name: 'Muhammad Rizky Algifari', role: 'salesman' },
							'17210042423': { password: 'tanjung2025', name: 'Siti Fatimah Hadijah', role: 'salesman' }
                        };
                        Object.assign(validUsers, fallbackSalesman);
                    }
                }

                // Load saved passwords from localStorage (if any custom passwords were set)
                const storedPasswords = JSON.parse(localStorage.getItem('userPasswords')) || {};
                for (const nik in storedPasswords) {
                    if (validUsers[nik]) {
                        validUsers[nik].password = storedPasswords[nik];
                    }
                }
                
                usersLoaded = true;
                loginButton.disabled = false;
                
                console.log('‚úÖ Valid users loaded:', Object.keys(validUsers).length, 'total users');
                console.log('üìã User IDs:', Object.keys(validUsers).slice(0, 10).join(', '), '...');
                
            } catch (error) {
                console.error('‚ùå Error loading valid users:', error);
                usersLoaded = true; // Still enable login with fallback users
                loginButton.disabled = false;
            }
        }

        // ‚úÖ Initialize on page load
        window.addEventListener('load', async function() {
            console.log('üöÄ Initializing Sales Dashboard login system...');
            
            // Disable login button until users are loaded
            loginButton.disabled = true;
            buttonText.textContent = 'Loading...';
            
            // Show default notification
            showDefaultNotification();
            
            // Load users and last update info in parallel
            await Promise.all([
                loadValidUsers(),
                loadLastUpdateInfo()
            ]);
            
            // Reset button text
            buttonText.textContent = 'Sign In';
            
            // Check for remembered user
            const rememberedUser = localStorage.getItem('rememberedUser');
            if (rememberedUser) {
                nikInput.value = rememberedUser;
                rememberMe.checked = true;
            }
            
            console.log('‚úÖ Sales Dashboard login system ready with new password');
        });

        // ‚úÖ Enhanced Login Form Handler
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (isLoading || !usersLoaded) {
                console.log('‚è≥ Still loading or already processing...');
                return;
            }
            
            const nik = nikInput.value.trim();
            const password = passwordInput.value.trim();
            
            // Validation
            if (!nik || !password) {
                showErrorNotification('Username dan password harus diisi!');
                return;
            }
            
            console.log(`üîç Attempting login for: ${nik}`);
            
            // Show loading notification
            showLoadingNotification();
            
            // Show loading on button
            setLoading(true);
            
            // Add delay for better UX
            setTimeout(() => {
                validateLogin(nik, password);
            }, 800);
        });

        // ‚úÖ Validate login with device authentication
        async function validateLogin(nik, password) {
            console.log(`üîç Validating login for: ${nik}`);
            console.log(`üìã Available users:`, Object.keys(validUsers));
            
            const user = validUsers[nik];
            
            if (user && user.password === password) {
                console.log(`‚úÖ Password correct for: ${user.name} (${user.role})`);
                
                // ===== DEVICE VALIDATION =====
                // Check if DeviceAuth is available
                if (typeof DeviceAuth === 'undefined') {
                    console.warn('‚ö†Ô∏è DeviceAuth not loaded, skipping device validation');
                    console.log('üîì Proceeding with login without device check (fallback mode)');
                    proceedWithLogin(nik, user);
                    return;
                }
                
                try {
                    // Validate device (admin bypass enabled)
                    console.log('üîê Checking device authentication...');
                    const deviceCheck = await DeviceAuth.validateDevice(nik, user.role);
                    
                    if (deviceCheck && deviceCheck.success === true) {
                        if (deviceCheck.isBypass) {
                            console.log(`üëë Device authentication bypassed: ${deviceCheck.bypassReason}`);
                        } else if (deviceCheck.isNewRegistration) {
                            console.log(`üÜï New device registered (${deviceCheck.deviceNumber}/${deviceCheck.totalDevices})`);
                            // Show brief notification for new device
                            const deviceInfo = deviceCheck.currentDevice?.info ? 
                                `${deviceCheck.currentDevice.info.device} - ${deviceCheck.currentDevice.info.browser}` : 
                                'Device baru';
                            console.log(`‚úÖ ${deviceInfo} berhasil didaftarkan sebagai device #${deviceCheck.deviceNumber}`);
                        } else {
                            console.log('‚úÖ Device validated successfully');
                        }
                        proceedWithLogin(nik, user);
                    } else {
                        console.warn('‚ùå Device validation failed:', deviceCheck?.message || 'Unknown error');
                        
                        // Show device error with details
                        const currentDeviceInfo = deviceCheck?.currentDevice?.info ? 
                            `${deviceCheck.currentDevice.info.device} - ${deviceCheck.currentDevice.info.browser} (${deviceCheck.currentDevice.info.os})` : 
                            'Unknown';
                        
                        let errorMessage = `üö´ Batas Device Tercapai\n\n`;
                        errorMessage += `Device Anda saat ini:\n${currentDeviceInfo}\n\n`;
                        
                        if (deviceCheck?.maxDevices) {
                            errorMessage += `Akun Anda sudah terdaftar di ${deviceCheck.maxDevices} device:\n\n`;
                            
                            if (deviceCheck.registeredDevices && deviceCheck.registeredDevices.length > 0) {
                                deviceCheck.registeredDevices.forEach((dev, idx) => {
                                    const devInfo = `${dev.info.device} - ${dev.info.browser} (${dev.info.os})`;
                                    const regDate = new Date(dev.registeredAt).toLocaleDateString('id-ID', {
                                        day: '2-digit',
                                        month: 'short',
                                        year: 'numeric'
                                    });
                                    errorMessage += `${idx + 1}. ${devInfo}\n   Terdaftar: ${regDate}\n\n`;
                                });
                            }
                            
                            errorMessage += `Silakan hubungi administrator untuk:\n`;
                            errorMessage += `‚Ä¢ Menghapus salah satu device yang terdaftar, atau\n`;
                            errorMessage += `‚Ä¢ Mendaftarkan device baru ini`;
                        } else {
                            errorMessage += `Akun Anda sudah terdaftar di device lain.\n`;
                            errorMessage += `Silakan hubungi administrator untuk mendaftarkan device baru ini.`;
                        }
                        
                        showErrorNotification(errorMessage);
                        setLoading(false);
                    }
                } catch (error) {
                    console.error('‚ùå Device validation error:', error);
                    console.log('üîì Proceeding with login despite error (fail-open)');
                    proceedWithLogin(nik, user);
                }
                
            } else {
                console.log(`‚ùå Login failed for: ${nik}`);
                console.log(`‚ùå User exists: ${!!user}, Password match: ${user ? user.password === password : false}`);
                
                showErrorNotification('Username atau password salah. Periksa kembali data login Anda.');
                setLoading(false);
            }
        }
        
        // Proceed with successful login
        function proceedWithLogin(nik, user) {
            // Remember user if checkbox is checked
            if (rememberMe.checked) {
                localStorage.setItem('rememberedUser', nik);
            } else {
                localStorage.removeItem('rememberedUser');
            }
            
            // Store login session
            sessionStorage.setItem('isLoggedIn', 'true');
            sessionStorage.setItem('currentUser', nik);
            sessionStorage.setItem('userName', user.name);
            sessionStorage.setItem('userRole', user.role);
            
            // Show success notification
            showSuccessNotification(user.name);
            
            // Show dashboard selection after delay
            setTimeout(() => {
                showDashboardSelection(user.name);
                setLoading(false);
            }, 2000);
        }

        // ‚úÖ UI Functions
        let loadingTimeout;
        function setLoading(loading) {
            isLoading = loading;
            loginButton.disabled = loading;
            buttonText.style.display = loading ? 'none' : 'block';
            document.getElementById('loading').style.display = loading ? 'block' : 'none';
            
            // Clear any existing timeout
            if (loadingTimeout) {
                clearTimeout(loadingTimeout);
                loadingTimeout = null;
            }
            
            // Set timeout to detect stuck loading (10 seconds)
            if (loading) {
                loadingTimeout = setTimeout(() => {
                    console.error('‚è±Ô∏è Loading timeout - stuck for 10 seconds!');
                    console.log('üîß Forcing reset...');
                    
                    // Force reset loading state
                    isLoading = false;
                    loginButton.disabled = false;
                    buttonText.style.display = 'block';
                    document.getElementById('loading').style.display = 'none';
                    
                    // Show error notification
                    showErrorNotification(
                        '‚ö†Ô∏è Login Timeout\n\n' +
                        'Proses login terlalu lama. Kemungkinan ada masalah dengan koneksi atau sistem.\n\n' +
                        'Silakan coba lagi atau hubungi administrator jika masalah berlanjut.'
                    );
                }, 10000); // 10 seconds timeout
            }
        }

        // ‚úÖ Input field enhancements
        nikInput.addEventListener('input', function(e) {
            // Highlight if user exists
            if (validUsers[this.value]) {
                this.style.borderColor = 'rgba(46, 213, 115, 0.6)';
                this.style.boxShadow = '0 0 10px rgba(46, 213, 115, 0.3)';
            } else {
                this.style.borderColor = 'rgba(255, 255, 255, 0.25)';
                this.style.boxShadow = 'none';
            }
        });

        // Input animations
        const inputFields = document.querySelectorAll('.input-field');
        inputFields.forEach(field => {
            field.addEventListener('focus', function() {
                this.parentElement.style.transform = 'translateY(-2px)';
            });
            
            field.addEventListener('blur', function() {
                this.parentElement.style.transform = 'translateY(0)';
            });
        });

        // ‚úÖ KEYBOARD NAVIGATION FOR DASHBOARD SELECTION
        document.addEventListener('keydown', function(e) {
            if (dashboardSelection.style.display === 'flex') {
                if (e.key === 'Escape') {
                    hideDashboardSelection();
                } else if (e.key === '1') {
                    selectDashboard('mobile');
                } else if (e.key === '2') {
                    selectDashboard('desktop');
                } else if (e.key === 'Enter') {
                    autoSelectDashboard();
                }
            }
        });

        console.log('üîß Sales Dashboard login script loaded with notification frame and new password "tanjung2025"');
    </script>
    
    <!-- Device Authentication System -->
    <script src="device-auth.js" onerror="console.error('‚ùå Failed to load device-auth.js'); window.deviceAuthLoadError = true;"></script>
    <script>
        // Check if device-auth.js loaded successfully
        setTimeout(() => {
            if (typeof DeviceAuth === 'undefined') {
                console.warn('‚ö†Ô∏è DeviceAuth not available - device validation will be skipped');
                console.log('üí° Login will proceed without device restrictions (fallback mode)');
            } else {
                console.log('‚úÖ DeviceAuth module loaded and ready');
            }
        }, 100);
    </script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Use relative path for GitHub Pages compatibility
                const swPath = './service-worker.js';
                
                navigator.serviceWorker.register(swPath)
                    .then((registration) => {
                        console.log('‚úÖ Service Worker registered successfully:', registration.scope);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('üîÑ New version available! Refresh to update.');
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.warn('‚ö†Ô∏è Service Worker registration failed:', error);
                    });
            });
        }
        
        // Show install prompt for PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('üì± PWA install prompt available');
            
            // You can show a custom install button here if needed
            // For now, we'll just log it
        });
        
        // Track PWA installation
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ PWA installed successfully');
            deferredPrompt = null;
        });
        
        // Log PWA status
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('üì± Running as PWA (standalone mode)');
        } else {
            console.log('üåê Running in browser mode');
        }
    </script>
    
    <!-- Firebase SDK for User Authentication -->
    
    <!-- Firebase v8 (for DeviceAuth compatibility) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- Firebase v9 (modular) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBLGwid71jAnsh4DrivbBYSTsuDAP0Zjuw",
            authDomain: "salesman-route-tracker-default-rtdb.asia-southeast1.firebasedatabase.app",
            databaseURL: "https://salesman-route-tracker-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "salesman-route-tracker",
            storageBucket: "salesman-route-tracker.appspot.com",
            messagingSenderId: "288785787565",
            appId: "1:288785787565:web:9e4f8e1e1e1e1e1e1e1e1e"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Make functions globally available for loadValidUsers
        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebaseGet = get;
        
        console.log('üî• Firebase initialized for user authentication');
        
        // Initialize DeviceAuth with Firebase v8
        if (typeof firebase !== 'undefined' && typeof DeviceAuth !== 'undefined') {
            try {
                // Initialize Firebase v8 app if not already initialized
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                // Initialize DeviceAuth with Firebase v8 database
                DeviceAuth.init(firebase.database());
                console.log('‚úÖ DeviceAuth initialized with Firebase');
            } catch (error) {
                console.warn('‚ö†Ô∏è DeviceAuth initialization error:', error);
            }
        } else {
            console.warn('‚ö†Ô∏è DeviceAuth not loaded or Firebase v8 not available');
        }
    </script>
</body>
</html>